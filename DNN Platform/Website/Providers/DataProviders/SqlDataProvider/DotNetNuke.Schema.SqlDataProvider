/************************************************************/
/*****              SqlDataProvider                     *****/
/*****                                                  *****/
/*****                                                  *****/
/***** Note: To manually execute this script you must   *****/
/*****       perform a search and replace operation     *****/
/*****       for {databaseOwner} and {objectQualifier}  *****/
/*****                                                  *****/
/************************************************************/

PRINT N'Creating {databaseOwner}[{objectQualifier}Authentication]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Authentication]
(
[AuthenticationID] [int] NOT NULL IDENTITY(1, 1),
[PackageID] [int] NOT NULL DEFAULT ((-1)),
[AuthenticationType] [nvarchar] (100) NOT NULL,
[IsEnabled] [bit] NOT NULL DEFAULT ((0)),
[SettingsControlSrc] [nvarchar] (250) NOT NULL,
[LoginControlSrc] [nvarchar] (250) NOT NULL,
[LogoffControlSrc] [nvarchar] (250) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Authentication] on {databaseOwner}[{objectQualifier}Authentication]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Authentication] ADD CONSTRAINT [PK_{objectQualifier}Authentication] PRIMARY KEY CLUSTERED  ([AuthenticationID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEnabledAuthenticationServices]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEnabledAuthenticationServices]
AS
	SELECT *
		FROM   {databaseOwner}{objectQualifier}Authentication
		WHERE  IsEnabled = 1
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabModules]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabModules]
(
[TabModuleID] [int] NOT NULL IDENTITY(1, 1),
[TabID] [int] NOT NULL,
[ModuleID] [int] NOT NULL,
[PaneName] [nvarchar] (50) NOT NULL,
[ModuleOrder] [int] NOT NULL,
[CacheTime] [int] NOT NULL,
[Alignment] [nvarchar] (10) NULL,
[Color] [nvarchar] (20) NULL,
[Border] [nvarchar] (1) NULL,
[IconFile] [nvarchar] (100) NULL,
[Visibility] [int] NOT NULL,
[ContainerSrc] [nvarchar] (200) NULL,
[DisplayTitle] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}TabModules_DisplayTitle] DEFAULT ((1)),
[DisplayPrint] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}TabModules_DisplayPrint] DEFAULT ((1)),
[DisplaySyndicate] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}TabModules_DisplaySyndicate] DEFAULT ((1)),
[IsWebSlice] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}abModules_IsWebSlice] DEFAULT ((0)),
[WebSliceTitle] [nvarchar] (256) NULL,
[WebSliceExpiryDate] [datetime] NULL,
[WebSliceTTL] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL CONSTRAINT [DF_{objectQualifier}TabModules_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL CONSTRAINT [DF_{objectQualifier}TabModules_LastModifiedOnDate] DEFAULT (getdate()),
[IsDeleted] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}TabModules_IsDeleted] DEFAULT ((0)),
[CacheMethod] [varchar] (50) NULL,
[ModuleTitle] [nvarchar] (256) NULL,
[Header] [nvarchar] (max) NULL,
[Footer] [nvarchar] (max) NULL,
[CultureCode] [nvarchar] (10) NULL,
[UniqueId] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}TabModules_Guid] DEFAULT (newid()),
[VersionGuid] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}TabModules_VersionGuid] DEFAULT (newid()),
[DefaultLanguageGuid] [uniqueidentifier] NULL,
[LocalizedVersionGuid] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}TabModules_LocalizedVersionGuid] DEFAULT (newid())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabModules] on {databaseOwner}[{objectQualifier}TabModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabModules] ADD CONSTRAINT [PK_{objectQualifier}TabModules] PRIMARY KEY CLUSTERED  ([TabModuleID])
GO
PRINT N'Creating index [IX_{objectQualifier}TabModules_ModuleID] on {databaseOwner}[{objectQualifier}TabModules]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}TabModules_ModuleID] ON {databaseOwner}[{objectQualifier}TabModules] ([ModuleID], [TabID]) INCLUDE ([Alignment], [Border], [CacheMethod], [CacheTime], [Color], [ContainerSrc], [CultureCode], [DefaultLanguageGuid], [DisplayPrint], [DisplaySyndicate], [DisplayTitle], [Footer], [Header], [IconFile], [IsDeleted], [IsWebSlice], [LocalizedVersionGuid], [ModuleOrder], [ModuleTitle], [PaneName], [TabModuleID], [UniqueId], [VersionGuid], [Visibility], [WebSliceExpiryDate], [WebSliceTitle], [WebSliceTTL])
GO
PRINT N'Creating index [IX_{objectQualifier}TabModules_ModuleOrder] on {databaseOwner}[{objectQualifier}TabModules]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}TabModules_ModuleOrder] ON {databaseOwner}[{objectQualifier}TabModules] ([TabID], [PaneName], [ModuleOrder]) INCLUDE ([Alignment], [Border], [CacheMethod], [CacheTime], [Color], [ContainerSrc], [CreatedByUserID], [CreatedOnDate], [CultureCode], [DefaultLanguageGuid], [DisplayPrint], [DisplaySyndicate], [DisplayTitle], [Footer], [Header], [IconFile], [IsDeleted], [IsWebSlice], [LastModifiedByUserID], [LastModifiedOnDate], [LocalizedVersionGuid], [ModuleID], [ModuleTitle], [TabModuleID], [UniqueId], [VersionGuid], [Visibility], [WebSliceExpiryDate], [WebSliceTitle], [WebSliceTTL])
GO
PRINT N'Creating index [IX_{objectQualifier}TabModules_TabID] on {databaseOwner}[{objectQualifier}TabModules]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}TabModules_TabID] ON {databaseOwner}[{objectQualifier}TabModules] ([TabID], [ModuleID]) INCLUDE ([CultureCode], [IsDeleted], [ModuleTitle])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}TabModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabModules] ADD CONSTRAINT [IX_{objectQualifier}TabModules_UniqueId] UNIQUE NONCLUSTERED  ([UniqueId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModuleOrder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModuleOrder]
	@TabId    int, 			-- Not Null
	@PaneName nvarchar(50)  -- Not Null
AS
BEGIN
	SELECT *
	FROM {objectQualifier}TabModules 
	WHERE TabId    = @TabId 
	  AND PaneName = @PaneName
	ORDER BY TabId, PaneName, ModuleOrder -- optimized for index used
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchCommonWords]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SearchCommonWords]
(
[CommonWordID] [int] NOT NULL IDENTITY(1, 1),
[CommonWord] [nvarchar] (255) NOT NULL,
[Locale] [nvarchar] (10) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SearchCommonWords] on {databaseOwner}[{objectQualifier}SearchCommonWords]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SearchCommonWords] ADD CONSTRAINT [PK_{objectQualifier}SearchCommonWords] PRIMARY KEY CLUSTERED  ([CommonWordID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSearchCommonWordsByLocale]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSearchCommonWordsByLocale]
	@Locale nvarchar(10)
	
AS

SELECT
	[CommonWordID],
	[CommonWord],
	[Locale]
FROM
	{databaseOwner}{objectQualifier}SearchCommonWords
WHERE
	[Locale] = @Locale
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserProfile]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UserProfile]
(
[ProfileID] [int] NOT NULL IDENTITY(1, 1),
[UserID] [int] NOT NULL,
[PropertyDefinitionID] [int] NOT NULL,
[PropertyValue] [nvarchar] (3750) NULL,
[PropertyText] [nvarchar] (max) NULL,
[Visibility] [int] NOT NULL DEFAULT ((0)),
[LastUpdatedDate] [datetime] NOT NULL,
[ExtendedVisibility] [varchar] (400) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UserProfile] on {databaseOwner}[{objectQualifier}UserProfile]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserProfile] ADD CONSTRAINT [PK_{objectQualifier}UserProfile] PRIMARY KEY CLUSTERED  ([ProfileID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserProfile_PropertyDefinitionID] on {databaseOwner}[{objectQualifier}UserProfile]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserProfile_PropertyDefinitionID] ON {databaseOwner}[{objectQualifier}UserProfile] ([PropertyDefinitionID]) INCLUDE ([ProfileID], [PropertyValue], [UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserProfile_Visibility] on {databaseOwner}[{objectQualifier}UserProfile]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserProfile_Visibility] ON {databaseOwner}[{objectQualifier}UserProfile] ([UserID], [ProfileID]) INCLUDE ([ExtendedVisibility], [LastUpdatedDate], [PropertyDefinitionID], [PropertyText], [PropertyValue], [Visibility])
GO
PRINT N'Creating index [IX_{objectQualifier}UserProfile_LastUpdatedDate] on {databaseOwner}[{objectQualifier}UserProfile]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserProfile_LastUpdatedDate] ON {databaseOwner}[{objectQualifier}UserProfile] ([LastUpdatedDate] DESC) INCLUDE ([UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserProfile] on {databaseOwner}[{objectQualifier}UserProfile]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserProfile] ON {databaseOwner}[{objectQualifier}UserProfile] ([UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserProfile_UserID_PropertyDefinitionID] on {databaseOwner}[{objectQualifier}UserProfile]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserProfile_UserID_PropertyDefinitionID] ON {databaseOwner}[{objectQualifier}UserProfile] ([UserID], [PropertyDefinitionID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateUserProfileProperty]'
GO
CREATE PROC {databaseOwner}[{objectQualifier}UpdateUserProfileProperty] 

	@ProfileID				int,
	@UserID					int,
	@PropertyDefinitionID	int,
	@PropertyValue			ntext,
	@Visibility				int,
	@ExtendedVisibility		varchar(400),
	@LastUpdatedDate		datetime

AS
	IF @ProfileID IS NULL OR @ProfileID = -1
		-- Try the UserID/PropertyDefinitionID to see if the Profile property exists
		SELECT @ProfileID = ProfileID
			FROM   {databaseOwner}{objectQualifier}UserProfile
			WHERE  UserID = @UserID AND PropertyDefinitionID = @PropertyDefinitionID
	 
	IF @ProfileID IS NOT NULL
		-- Update Property
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}UserProfile
				SET PropertyValue = case when (DATALENGTH(@PropertyValue) > 7500) then NULL else @PropertyValue end,
					PropertyText = case when (DATALENGTH(@PropertyValue) > 7500) then @PropertyValue else NULL end,
					Visibility = @Visibility,
					ExtendedVisibility = @ExtendedVisibility,
					LastUpdatedDate = @LastUpdatedDate
				WHERE  ProfileID = @ProfileID
			SELECT @ProfileID
		END
	ELSE
		-- Insert New Property
		BEGIN
			INSERT INTO {databaseOwner}{objectQualifier}UserProfile (
				UserID,
				PropertyDefinitionID,
				PropertyValue,
				PropertyText,
				Visibility,
				ExtendedVisibility,
				LastUpdatedDate
			  )
			VALUES (
				@UserID,
				@PropertyDefinitionID,
				case when (DATALENGTH(@PropertyValue) > 7500) then NULL else @PropertyValue end,
				case when (DATALENGTH(@PropertyValue) > 7500) then @PropertyValue else NULL end,
				@Visibility,
				@ExtendedVisibility,
				@LastUpdatedDate
			  )

		SELECT SCOPE_IDENTITY()
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Lists]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Lists]
(
[EntryID] [int] NOT NULL IDENTITY(1, 1),
[ListName] [nvarchar] (50) NOT NULL,
[Value] [nvarchar] (100) NOT NULL,
[Text] [nvarchar] (150) NOT NULL,
[ParentID] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Lists_ParentID] DEFAULT ((0)),
[Level] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Lists_Level] DEFAULT ((0)),
[SortOrder] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Lists_SortOrder] DEFAULT ((0)),
[DefinitionID] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Lists_DefinitionID] DEFAULT ((0)),
[Description] [nvarchar] (500) NULL,
[PortalID] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Lists_PortalID] DEFAULT ((-1)),
[SystemList] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Lists_SystemList] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Lists] on {databaseOwner}[{objectQualifier}Lists]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Lists] ADD CONSTRAINT [PK_{objectQualifier}Lists] PRIMARY KEY CLUSTERED  ([EntryID])
GO
PRINT N'Creating index [IX_{objectQualifier}Lists_ListName_ParentID] on {databaseOwner}[{objectQualifier}Lists]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Lists_ListName_ParentID] ON {databaseOwner}[{objectQualifier}Lists] ([ListName], [ParentID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Lists]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Lists] ADD CONSTRAINT [IX_{objectQualifier}Lists_ListName_Value_Text_ParentID] UNIQUE NONCLUSTERED  ([ListName], [Value], [Text], [ParentID])
GO
PRINT N'Creating index [IX_{objectQualifier}Lists_ParentID] on {databaseOwner}[{objectQualifier}Lists]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Lists_ParentID] ON {databaseOwner}[{objectQualifier}Lists] ([ParentID], [ListName], [Value]) INCLUDE ([DefinitionID], [SortOrder], [Text])
GO
PRINT N'Creating index [IX_{objectQualifier}Lists_SortOrder] on {databaseOwner}[{objectQualifier}Lists]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Lists_SortOrder] ON {databaseOwner}[{objectQualifier}Lists] ([PortalID], [ParentID], [ListName], [SortOrder]) INCLUDE ([DefinitionID], [Text], [Value])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetListParentKey]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetListParentKey]
(
	@ParentID AS int,
	@ListName as nvarchar(500),
	@Type as nvarchar(50),
	@Count as int 
)
RETURNS nvarchar(2000)

AS
	BEGIN
		DECLARE @KeyValue nvarchar(2000)
		DECLARE @ListValue nvarchar(2000)
		DECLARE @TextValue nvarchar(2000)
		DECLARE @ReturnValue nvarchar(2000)
		DECLARE @Key nvarchar(2000)
		
		IF @ParentID = 0
			IF @Count = 0
				SET @ReturnValue = ''
			ELSE
				SET @ReturnValue = @ListName
		ELSE
			BEGIN
				SELECT	@KeyValue = ListName + '.' + [Value],
						@TextValue = ListName + '.' + [Text], 
						@ListValue = ListName, 
						@ParentID = ParentID  
					FROM {databaseOwner}{objectQualifier}Lists 
					WHERE EntryID = @ParentID
				If @Type = 'ParentKey' Or (@Type = 'ParentList' AND @Count > 0)
					SET @ReturnValue = @KeyValue
				ELSE 
					IF @Type = 'ParentList'
						SET @ReturnValue = @ListValue
					ELSE
						SET @ReturnValue = @TextValue
				IF @Count > 0
					If @Count = 1 AND @Type = 'ParentList'
						SET @ReturnValue = @ReturnValue + ':' + @ListName
					ELSE
						SET @ReturnValue = @ReturnValue + '.' + @ListName
				SET @ReturnValue = {databaseOwner}{objectQualifier}GetListParentKey(@ParentID, @ReturnValue, @Type, @Count+1)
			END

		RETURN    @ReturnValue
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_Lists]'
GO
-- optimized
CREATE VIEW {databaseOwner}[{objectQualifier}vw_Lists]
AS
	SELECT  L.EntryID, 
		L.ListName, 
		L.[Value], 
		L.Text, 
		L.[Level], 
		L.SortOrder, 
		L.DefinitionID, 
		L.ParentID, 
		L.Description, 
		L.PortalID, 
		L.SystemList, 
		{databaseOwner}[{objectQualifier}GetListParentKey](L.ParentID, L.ListName, N'ParentKey',  0) AS ParentKey, 
		{databaseOwner}[{objectQualifier}GetListParentKey](L.ParentID, L.ListName, N'Parent',     0) AS Parent, 
		{databaseOwner}[{objectQualifier}GetListParentKey](L.ParentID, L.ListName, N'ParentList', 0) AS ParentList,
		S.MaxSortOrder,
		S.EntryCount,
		CASE WHEN EXISTS (SELECT 1 FROM {databaseOwner}[{objectQualifier}Lists] WHERE (ParentID = L.EntryID)) THEN 1 ELSE 0 END AS HasChildren, 
		L.CreatedByUserID, 
		L.CreatedOnDate, 
		L.LastModifiedByUserID, 
		L.LastModifiedOnDate
	FROM {databaseOwner}[{objectQualifier}Lists] AS L
	LEFT JOIN (SELECT ListName, ParentID, Max(SortOrder) AS MaxSortOrder, Count(1) AS EntryCount 
			   FROM {databaseOwner}[{objectQualifier}Lists] GROUP BY ListName, ParentID) S 		ON L.ParentID = S.ParentId AND L.ListName = S.ListName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_UserPreferences]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_UserPreferences]
(
[UserPreferenceId] [int] NOT NULL IDENTITY(1, 1),
[PortalId] [int] NOT NULL,
[UserId] [int] NOT NULL,
[MessagesEmailFrequency] [int] NOT NULL,
[NotificationsEmailFrequency] [int] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_UserPreferences] on {databaseOwner}[{objectQualifier}CoreMessaging_UserPreferences]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_UserPreferences] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_UserPreferences] PRIMARY KEY CLUSTERED  ([UserPreferenceId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_Messages]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Messages]
(
[MessageID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[NotificationTypeID] [int] NULL,
[To] [nvarchar] (2000) NULL,
[From] [nvarchar] (200) NULL,
[Subject] [nvarchar] (400) NULL,
[Body] [nvarchar] (max) NULL,
[ConversationID] [int] NULL,
[ReplyAllAllowed] [bit] NULL,
[SenderUserID] [int] NULL,
[ExpirationDate] [datetime] NULL,
[Context] [nvarchar] (200) NULL,
[IncludeDismissAction] [bit] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_Messages] on {databaseOwner}[{objectQualifier}CoreMessaging_Messages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Messages] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_Messages] PRIMARY KEY CLUSTERED  ([MessageID])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_Messages_Send_MessageID_PortalID_NotificationTypeID_ExpirationDate] on {databaseOwner}[{objectQualifier}CoreMessaging_Messages]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_Messages_Send_MessageID_PortalID_NotificationTypeID_ExpirationDate] ON {databaseOwner}[{objectQualifier}CoreMessaging_Messages] ([MessageID], [PortalID], [NotificationTypeID], [ExpirationDate] DESC) INCLUDE ([Body], [Context], [ConversationID], [CreatedByUserID], [CreatedOnDate], [From], [IncludeDismissAction], [LastModifiedByUserID], [LastModifiedOnDate], [ReplyAllAllowed], [SenderUserID], [Subject], [To])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_Messages_SenderUserID] on {databaseOwner}[{objectQualifier}CoreMessaging_Messages]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_Messages_SenderUserID] ON {databaseOwner}[{objectQualifier}CoreMessaging_Messages] ([SenderUserID], [CreatedOnDate] DESC)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
(
[RecipientID] [int] NOT NULL IDENTITY(1, 1),
[MessageID] [int] NOT NULL,
[UserID] [int] NOT NULL,
[Read] [bit] NOT NULL DEFAULT ((0)),
[Archived] [bit] NOT NULL DEFAULT ((0)),
[EmailSent] [bit] NOT NULL DEFAULT ((0)),
[EmailSentDate] [datetime] NULL,
[EmailSchedulerInstance] [uniqueidentifier] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[SendToast] [bit] NOT NULL DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_MessageRecipients] on {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_MessageRecipients] PRIMARY KEY CLUSTERED  ([RecipientID])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_MessageRecipients_UserID_MessageID_Read_SendToast] on {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_MessageRecipients_UserID_MessageID_Read_SendToast] ON {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] ([MessageID], [UserID], [Read], [SendToast])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_MessageRecipients_UserID] on {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_MessageRecipients_UserID] ON {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] ([UserID], [Read] DESC, [Archived])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_MessagesForDispatch]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_MessagesForDispatch]
AS
	SELECT CMR.RecipientID
	,CMR.MessageID
	,CMR.UserID
	,CMR.[Read]
	,CMR.Archived
	,CMR.EmailSent
	,CMR.EmailSentDate
	,CMR.EmailSchedulerInstance
	,CMR.CreatedByUserID
	,CMR.CreatedOnDate
	,CMR.LastModifiedByUserID
	,CMR.LastModifiedOnDate
	,CMR.SendToast
	,CM.NotificationTypeID	
    ,CASE 
		WHEN CM.NotificationTypeID IS NULL		
		THEN				
			ISNULL ((SELECT UP.[MessagesEmailFrequency] AS Expr1
					FROM          {databaseOwner}{objectQualifier}CoreMessaging_UserPreferences UP
					WHERE      (UP.UserId = CMR.UserID) AND (UP.PortalId = CM.PortalID)), 0)
		ELSE			
			ISNULL ((SELECT UP.[NotificationsEmailFrequency] AS Expr1
					FROM          {databaseOwner}{objectQualifier}CoreMessaging_UserPreferences UP
					WHERE      (UP.UserId = CMR.UserID) AND (UP.PortalId = CM.PortalID)), 2)
	END EmailFrequency
FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients AS CMR 
	INNER JOIN
    {databaseOwner}{objectQualifier}CoreMessaging_Messages AS CM 
		ON CMR.MessageID = CM.MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PortalGroups]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PortalGroups]
(
[PortalGroupID] [int] NOT NULL IDENTITY(1, 1),
[MasterPortalID] [int] NULL,
[PortalGroupName] [nvarchar] (100) NULL,
[PortalGroupDescription] [nvarchar] (2000) NULL,
[AuthenticationDomain] [nvarchar] (200) NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PortalGroup] on {databaseOwner}[{objectQualifier}PortalGroups]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalGroups] ADD CONSTRAINT [PK_{objectQualifier}PortalGroup] PRIMARY KEY CLUSTERED  ([PortalGroupID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalGroup]
	@PortalGroupID				int,
	@PortalGroupName			nvarchar(100),
	@PortalGroupDescription		nvarchar(2000),
	@AuthenticationDomain		nvarchar(200),
	@LastModifiedByUserID		int
AS 
	BEGIN
		UPDATE {databaseOwner}{objectQualifier}PortalGroups 
			SET 
				PortalGroupName = @PortalGroupName,
				PortalGroupDescription = @PortalGroupDescription,
				AuthenticationDomain = @AuthenticationDomain,
				LastModifiedByUserID = @LastModifiedByUserID,
				LastModifiedOnDate = getdate()
			WHERE PortalGroupID = @PortalGroupID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchIndexer]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SearchIndexer]
(
[SearchIndexerID] [int] NOT NULL IDENTITY(1, 1),
[SearchIndexerAssemblyQualifiedName] [char] (200) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SearchIndexer] on {databaseOwner}[{objectQualifier}SearchIndexer]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SearchIndexer] ADD CONSTRAINT [PK_{objectQualifier}SearchIndexer] PRIMARY KEY CLUSTERED  ([SearchIndexerID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSearchIndexers]'
GO
create procedure {databaseOwner}[{objectQualifier}GetSearchIndexers]

as

select {databaseOwner}{objectQualifier}SearchIndexer.*
from {databaseOwner}{objectQualifier}SearchIndexer
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Users]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Users]
(
[UserID] [int] NOT NULL IDENTITY(1, 1),
[Username] [nvarchar] (100) NOT NULL,
[FirstName] [nvarchar] (50) NOT NULL,
[LastName] [nvarchar] (50) NOT NULL,
[IsSuperUser] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Users_IsSuperUser] DEFAULT ((0)),
[AffiliateId] [int] NULL,
[Email] [nvarchar] (256) NULL,
[DisplayName] [nvarchar] (128) NOT NULL CONSTRAINT [DF_{objectQualifier}Users_DisplayName] DEFAULT (''),
[UpdatePassword] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Users_UpdatePassword] DEFAULT ((0)),
[LastIPAddress] [nvarchar] (50) NULL,
[IsDeleted] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Users_IsDeleted] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[PasswordResetToken] [uniqueidentifier] NULL,
[PasswordResetExpiration] [datetime] NULL,
[LowerEmail] AS (lower([Email])) PERSISTED
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Users] on {databaseOwner}[{objectQualifier}Users]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Users] ADD CONSTRAINT [PK_{objectQualifier}Users] PRIMARY KEY CLUSTERED  ([UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}Users_IsDeleted_DisplayName] on {databaseOwner}[{objectQualifier}Users]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Users_IsDeleted_DisplayName] ON {databaseOwner}[{objectQualifier}Users] ([IsDeleted], [DisplayName]) INCLUDE ([Email], [IsSuperUser], [UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}Users_LastModifiedOnDate] on {databaseOwner}[{objectQualifier}Users]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Users_LastModifiedOnDate] ON {databaseOwner}[{objectQualifier}Users] ([LastModifiedOnDate] DESC) INCLUDE ([IsSuperUser], [UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}Users_UserName_UserID] on {databaseOwner}[{objectQualifier}Users]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Users_UserName_UserID] ON {databaseOwner}[{objectQualifier}Users] ([Username], [UserID]) INCLUDE ([AffiliateId], [CreatedByUserID], [CreatedOnDate], [DisplayName], [Email], [FirstName], [IsDeleted], [IsSuperUser], [LastIPAddress], [LastModifiedByUserID], [LastModifiedOnDate], [LastName], [PasswordResetExpiration], [PasswordResetToken], [UpdatePassword])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Users]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Users] ADD CONSTRAINT [IX_{objectQualifier}Users] UNIQUE NONCLUSTERED  ([Username])
GO
PRINT N'Creating index [IX_{objectQualifier}Users_Email] on {databaseOwner}[{objectQualifier}Users]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Users_Email] ON {databaseOwner}[{objectQualifier}Users] ([Email])
GO
PRINT N'Creating index [IX_{objectQualifier}Users_LowerEmail] on {databaseOwner}[{objectQualifier}Users]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Users_LowerEmail] ON {databaseOwner}[{objectQualifier}Users] ([Email])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Tabs]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Tabs]
(
[TabID] [int] NOT NULL IDENTITY(0, 1),
[TabOrder] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_TabOrder] DEFAULT ((0)),
[PortalID] [int] NULL,
[TabName] [nvarchar] (200) NOT NULL,
[IsVisible] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_IsVisible] DEFAULT ((1)),
[ParentId] [int] NULL,
[IconFile] [nvarchar] (255) NULL,
[DisableLink] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_DisableLink] DEFAULT ((0)),
[Title] [nvarchar] (200) NULL,
[Description] [nvarchar] (500) NULL,
[KeyWords] [nvarchar] (500) NULL,
[IsDeleted] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_IsDeleted] DEFAULT ((0)),
[Url] [nvarchar] (255) NULL,
[SkinSrc] [nvarchar] (200) NULL,
[ContainerSrc] [nvarchar] (200) NULL,
[StartDate] [datetime] NULL,
[EndDate] [datetime] NULL,
[RefreshInterval] [int] NULL,
[PageHeadText] [nvarchar] (max) NULL,
[IsSecure] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_IsSecure] DEFAULT ((0)),
[PermanentRedirect] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_PermanentRedirect] DEFAULT ((0)),
[SiteMapPriority] [float] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_SiteMapPriority] DEFAULT ((0.5)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[IconFileLarge] [nvarchar] (255) NULL,
[CultureCode] [nvarchar] (10) NULL,
[ContentItemID] [int] NULL,
[UniqueId] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_Guid] DEFAULT (newid()),
[VersionGuid] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_VersionGuid] DEFAULT (newid()),
[DefaultLanguageGuid] [uniqueidentifier] NULL,
[LocalizedVersionGuid] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Tabs_LocalizedVersionGuid] DEFAULT (newid()),
[Level] [int] NOT NULL DEFAULT ((0)),
[TabPath] [nvarchar] (255) NOT NULL DEFAULT (''),
[HasBeenPublished] [bit] NOT NULL DEFAULT ((0)),
[IsSystem] [bit] NOT NULL DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Tabs] on {databaseOwner}[{objectQualifier}Tabs]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Tabs] ADD CONSTRAINT [PK_{objectQualifier}Tabs] PRIMARY KEY CLUSTERED  ([TabID])
GO
PRINT N'Creating index [IX_{objectQualifier}Tabs_ContentID] on {databaseOwner}[{objectQualifier}Tabs]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Tabs_ContentID] ON {databaseOwner}[{objectQualifier}Tabs] ([ContentItemID]) INCLUDE ([CultureCode], [IsDeleted], [IsVisible], [TabID], [TabName], [Title], [UniqueId]) WHERE ([ContentItemId] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}Tabs_PortalLevelParentOrder] on {databaseOwner}[{objectQualifier}Tabs]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Tabs_PortalLevelParentOrder] ON {databaseOwner}[{objectQualifier}Tabs] ([PortalID], [Level], [ParentId], [TabOrder], [IsDeleted]) INCLUDE ([ContainerSrc], [ContentItemID], [CreatedByUserID], [CreatedOnDate], [CultureCode], [DefaultLanguageGuid], [Description], [DisableLink], [EndDate], [IconFile], [IconFileLarge], [IsSecure], [IsVisible], [KeyWords], [LastModifiedByUserID], [LastModifiedOnDate], [LocalizedVersionGuid], [PageHeadText], [PermanentRedirect], [RefreshInterval], [SiteMapPriority], [SkinSrc], [StartDate], [TabID], [TabName], [TabPath], [Title], [UniqueId], [Url], [VersionGuid])
GO
PRINT N'Creating index [IX_{objectQualifier}Tabs_ParentId_IsDeleted] on {databaseOwner}[{objectQualifier}Tabs]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Tabs_ParentId_IsDeleted] ON {databaseOwner}[{objectQualifier}Tabs] ([ParentId], [IsDeleted]) INCLUDE ([CreatedOnDate])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Tabs]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Tabs] ADD CONSTRAINT [IX_{objectQualifier}Tabs_UniqueId] UNIQUE NONCLUSTERED  ([UniqueId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabPermission]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabPermission]
(
[TabPermissionID] [int] NOT NULL IDENTITY(1, 1),
[TabID] [int] NOT NULL,
[PermissionID] [int] NOT NULL,
[AllowAccess] [bit] NOT NULL,
[RoleID] [int] NULL,
[UserID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabPermission] on {databaseOwner}[{objectQualifier}TabPermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabPermission] ADD CONSTRAINT [PK_{objectQualifier}TabPermission] PRIMARY KEY CLUSTERED  ([TabPermissionID])
GO
PRINT N'Creating index [IX_{objectQualifier}TabPermission_Roles] on {databaseOwner}[{objectQualifier}TabPermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}TabPermission_Roles] ON {databaseOwner}[{objectQualifier}TabPermission] ([RoleID], [TabID], [PermissionID]) INCLUDE ([AllowAccess]) WHERE ([RoleID] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}TabPermission_Tabs] on {databaseOwner}[{objectQualifier}TabPermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}TabPermission_Tabs] ON {databaseOwner}[{objectQualifier}TabPermission] ([TabID], [PermissionID], [RoleID], [UserID]) INCLUDE ([AllowAccess])
GO
PRINT N'Creating index [IX_{objectQualifier}TabPermission_Users] on {databaseOwner}[{objectQualifier}TabPermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}TabPermission_Users] ON {databaseOwner}[{objectQualifier}TabPermission] ([UserID], [TabID], [PermissionID]) INCLUDE ([AllowAccess]) WHERE ([UserID] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}TabPermission_Permission] on {databaseOwner}[{objectQualifier}TabPermission]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}TabPermission_Permission] ON {databaseOwner}[{objectQualifier}TabPermission] ([PermissionID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Roles]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Roles]
(
[RoleID] [int] NOT NULL IDENTITY(0, 1),
[PortalID] [int] NULL,
[RoleName] [nvarchar] (50) NOT NULL,
[Description] [nvarchar] (1000) NULL,
[ServiceFee] [money] NULL CONSTRAINT [DF_{objectQualifier}Roles_ServiceFee] DEFAULT ((0)),
[BillingFrequency] [char] (1) NULL,
[TrialPeriod] [int] NULL,
[TrialFrequency] [char] (1) NULL,
[BillingPeriod] [int] NULL,
[TrialFee] [money] NULL,
[IsPublic] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Roles_IsPublic] DEFAULT ((0)),
[AutoAssignment] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Roles_AutoAssignment] DEFAULT ((0)),
[RoleGroupID] [int] NULL,
[RSVPCode] [nvarchar] (50) NULL,
[IconFile] [nvarchar] (100) NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[Status] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Roles_Status] DEFAULT ((1)),
[SecurityMode] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Roles_SecurityMode] DEFAULT ((0)),
[IsSystemRole] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Roles_IsSystemRole] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Roles] on {databaseOwner}[{objectQualifier}Roles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Roles] ADD CONSTRAINT [PK_{objectQualifier}Roles] PRIMARY KEY CLUSTERED  ([RoleID])
GO
PRINT N'Creating index [IX_{objectQualifier}Roles_RoleName] on {databaseOwner}[{objectQualifier}Roles]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Roles_RoleName] ON {databaseOwner}[{objectQualifier}Roles] ([PortalID], [RoleName]) INCLUDE ([RoleID])
GO
PRINT N'Creating index [IX_{objectQualifier}Roles_RoleGroup] on {databaseOwner}[{objectQualifier}Roles]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Roles_RoleGroup] ON {databaseOwner}[{objectQualifier}Roles] ([RoleGroupID], [RoleName]) INCLUDE ([RoleID])
GO
PRINT N'Creating index [IX_{objectQualifier}Roles_RoleID_Status] on {databaseOwner}[{objectQualifier}Roles]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Roles_RoleID_Status] ON {databaseOwner}[{objectQualifier}Roles] ([RoleID], [Status]) INCLUDE ([AutoAssignment], [BillingFrequency], [BillingPeriod], [Description], [IconFile], [IsPublic], [PortalID], [RoleGroupID], [RoleName], [RSVPCode], [SecurityMode], [ServiceFee], [TrialFee], [TrialFrequency], [TrialPeriod])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Roles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Roles] ADD CONSTRAINT [IX_{objectQualifier}RoleName] UNIQUE NONCLUSTERED  ([PortalID], [RoleName])
GO
PRINT N'Creating index [IX_{objectQualifier}Roles] on {databaseOwner}[{objectQualifier}Roles]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Roles] ON {databaseOwner}[{objectQualifier}Roles] ([BillingFrequency])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Permission]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Permission]
(
[PermissionID] [int] NOT NULL IDENTITY(1, 1),
[PermissionCode] [varchar] (50) NOT NULL,
[ModuleDefID] [int] NOT NULL,
[PermissionKey] [varchar] (50) NOT NULL,
[PermissionName] [varchar] (50) NOT NULL,
[ViewOrder] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Permission_ViewOrder] DEFAULT ((9999)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Permission] on {databaseOwner}[{objectQualifier}Permission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Permission] ADD CONSTRAINT [PK_{objectQualifier}Permission] PRIMARY KEY CLUSTERED  ([PermissionID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Permission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Permission] ADD CONSTRAINT [IX_{objectQualifier}Permission] UNIQUE NONCLUSTERED  ([PermissionCode], [ModuleDefID], [PermissionKey])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_TabPermissions]'
GO
-- use new FK
CREATE VIEW {databaseOwner}[{objectQualifier}vw_TabPermissions]
AS
SELECT  TP.TabPermissionID,
        T.TabID,
        T.PortalId,
        P.PermissionID,
        TP.RoleID,
        R.RoleName,
        TP.AllowAccess,
        TP.UserID,
        U.Username,
        U.DisplayName,
        P.PermissionCode,
        P.ModuleDefID,
        P.PermissionKey,
        P.PermissionName,
        TP.CreatedByUserID,
        TP.CreatedOnDate,
        TP.LastModifiedByUserID,
        TP.LastModifiedOnDate
FROM        {databaseOwner}[{objectQualifier}TabPermission]    AS TP
 INNER JOIN {databaseOwner}[{objectQualifier}Tabs]             AS T  ON TP.TabId        = T.TabId
 INNER JOIN {databaseOwner}[{objectQualifier}Permission]       AS P  ON TP.PermissionID = P.PermissionID
 LEFT  JOIN {databaseOwner}[{objectQualifier}Roles]            AS R  ON TP.RoleID       = R.RoleID
 LEFT  JOIN {databaseOwner}[{objectQualifier}Users]            AS U  ON TP.UserID       = U.UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabPermissionsByPortal]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}GetTabPermissionsByPortal]
	
	@PortalID int

AS

	IF @portalid is not null
		BEGIN 
			SELECT *
				FROM {databaseOwner}{objectQualifier}vw_TabPermissions
				WHERE PortalID = @PortalID
		END
	ELSE
		BEGIN
			SELECT *
				FROM {databaseOwner}{objectQualifier}vw_TabPermissions
				WHERE PortalID IS NULL 
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PortalSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PortalSettings]
(
[PortalSettingID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NOT NULL,
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (2000) NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[CultureCode] [nvarchar] (10) NULL
)
GO
PRINT N'Creating index [IX_{objectQualifier}PortalSettings] on {databaseOwner}[{objectQualifier}PortalSettings]'
GO
CREATE UNIQUE CLUSTERED INDEX [IX_{objectQualifier}PortalSettings] ON {databaseOwner}[{objectQualifier}PortalSettings] ([PortalID], [CultureCode], [SettingName])
GO
PRINT N'Creating primary key [PK_{objectQualifier}PortalSettings] on {databaseOwner}[{objectQualifier}PortalSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalSettings] ADD CONSTRAINT [PK_{objectQualifier}PortalSettings] PRIMARY KEY NONCLUSTERED  ([PortalSettingID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Folders]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Folders]
(
[FolderID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[FolderPath] [nvarchar] (300) NOT NULL,
[StorageLocation] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Folders_StorageLocation] DEFAULT ((0)),
[IsProtected] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Folders_IsProtected] DEFAULT ((0)),
[IsCached] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Folders_IsCached] DEFAULT ((0)),
[LastUpdated] [datetime] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[UniqueId] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Folders_UniqueId] DEFAULT (newid()),
[VersionGuid] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Folders_VersionGuid] DEFAULT (newid()),
[FolderMappingID] [int] NOT NULL,
[ParentID] [int] NULL,
[IsVersioned] [bit] NOT NULL DEFAULT ((0)),
[WorkflowID] [int] NULL,
[MappedPath] [nvarchar] (300) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Folders] on {databaseOwner}[{objectQualifier}Folders]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Folders] ADD CONSTRAINT [PK_{objectQualifier}Folders] PRIMARY KEY CLUSTERED  ([FolderID])
GO
PRINT N'Creating index [IX_{objectQualifier}Folders_FolderID] on {databaseOwner}[{objectQualifier}Folders]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Folders_FolderID] ON {databaseOwner}[{objectQualifier}Folders] ([FolderID]) INCLUDE ([FolderMappingID], [FolderPath], [IsCached], [PortalID], [StorageLocation])
GO
PRINT N'Creating index [IX_{objectQualifier}Folders_ParentID] on {databaseOwner}[{objectQualifier}Folders]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Folders_ParentID] ON {databaseOwner}[{objectQualifier}Folders] ([PortalID], [ParentID], [FolderPath]) INCLUDE ([FolderID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Folders]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Folders] ADD CONSTRAINT [IX_{objectQualifier}FolderPath] UNIQUE NONCLUSTERED  ([PortalID], [FolderPath])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Folders]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Folders] ADD CONSTRAINT [IX_{objectQualifier}Folders_UniqueId] UNIQUE NONCLUSTERED  ([UniqueId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileFolderFunc]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetFileFolderFunc](@FolderD INT)
RETURNS nvarchar(246) 
AS
BEGIN
    DECLARE @folderPath nvarchar(246)
    select @folderPath=folderpath from {databaseOwner}[{objectQualifier}Folders] where folderid=@FolderD
return @folderPath
  
END;
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Files]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Files]
(
[FileId] [int] NOT NULL IDENTITY(1, 1),
[PortalId] [int] NULL,
[FileName] [nvarchar] (246) NOT NULL,
[Extension] [nvarchar] (100) NOT NULL,
[Size] [int] NOT NULL,
[Width] [int] NULL,
[Height] [int] NULL,
[ContentType] [nvarchar] (200) NOT NULL,
[FolderID] [int] NOT NULL,
[Content] [image] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[UniqueId] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Files_UniqueId] DEFAULT (newid()),
[VersionGuid] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Files_VersionGuid] DEFAULT (newid()),
[SHA1Hash] [varchar] (40) NULL,
[LastModificationTime] [datetime] NOT NULL DEFAULT (getdate()),
[Folder] AS ({databaseOwner}[{objectQualifier}GetFileFolderFunc]([FolderID])),
[Title] [nvarchar] (256) NULL,
[StartDate] [date] NOT NULL DEFAULT (getdate()),
[EnablePublishPeriod] [bit] NOT NULL DEFAULT ((0)),
[EndDate] [date] NULL,
[PublishedVersion] [int] NOT NULL DEFAULT ((1)),
[ContentItemID] [int] NULL,
[HasBeenPublished] [bit] NOT NULL DEFAULT ((1))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}File] on {databaseOwner}[{objectQualifier}Files]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Files] ADD CONSTRAINT [PK_{objectQualifier}File] PRIMARY KEY CLUSTERED  ([FileId])
GO
PRINT N'Creating index [IX_{objectQualifier}Files_ContentID] on {databaseOwner}[{objectQualifier}Files]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Files_ContentID] ON {databaseOwner}[{objectQualifier}Files] ([ContentItemID]) INCLUDE ([FileId], [FileName], [FolderID], [PublishedVersion]) WHERE ([ContentItemId] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}Files_FileID] on {databaseOwner}[{objectQualifier}Files]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Files_FileID] ON {databaseOwner}[{objectQualifier}Files] ([FileId]) INCLUDE ([FileName], [FolderID], [PortalId], [PublishedVersion]) WHERE ([ContentItemId] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}Files_PortalID] on {databaseOwner}[{objectQualifier}Files]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Files_PortalID] ON {databaseOwner}[{objectQualifier}Files] ([PortalId], [FolderID], [FileName]) INCLUDE ([FileId], [PublishedVersion])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Files]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Files] ADD CONSTRAINT [IX_{objectQualifier}Files_UniqueId] UNIQUE NONCLUSTERED  ([UniqueId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_Files]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_Files]
AS
    SELECT    fi.FileId, 
            fi.PortalId, 
            fi.FileName, 
            fi.Extension, 
            fi.Size, 
            fi.Width, 
            fi.Height, 
            fi.ContentType, 
            fi.FolderID, 
            fi.[Content], 
            fi.CreatedByUserID, 
            fi.CreatedOnDate, 
            fi.LastModifiedByUserID, 
            fi.LastModifiedOnDate, 
            fi.UniqueId, 
            fi.VersionGuid, 
            fi.SHA1Hash, 
            fi.LastModificationTime, 
            fi.Title, 
            fi.StartDate, 
            fi.EnablePublishPeriod, 
            fi.EndDate, 
            fi.ContentItemID, 
            fi.PublishedVersion, 
            fo.FolderPath AS Folder,
            fo.IsCached,
            fo.FolderMappingID,
            fo.StorageLocation,
            fi.HasBeenPublished
    FROM         {databaseOwner}[{objectQualifier}Files] AS fi 
    INNER JOIN {databaseOwner}[{objectQualifier}Folders] AS fo 
        ON fi.FolderID = fo.FolderID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FilePath]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}FilePath]
(
    @StrMayContainFileId nVarChar(255)
)
	RETURNS 			 nVarChar(500)
AS
	BEGIN
		DECLARE @Path AS nVarChar(500);

		IF ISNULL(@StrMayContainFileId,'') = ''
			SET @Path = ''
		 ELSE IF Lower(@StrMayContainFileId) LIKE 'fileid=%'
			SELECT @Path = IsNull(Folder, '') + FileName FROM {databaseOwner}[{objectQualifier}vw_Files]
			 WHERE fileid = CAST(SUBSTRING(@StrMayContainFileId, 8, 10) AS Int)
		 ELSE
			SET @Path = @StrMayContainFileId
		RETURN @Path -- never Null!
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalSetting]
    @PortalID    Int,		    -- Not Null
    @SettingName nVarChar(50),	-- Not Null
    @CultureCode nVarChar(50)	-- Null|-1 for neutral language
AS
BEGIN
	SELECT TOP (1)
		SettingName,
		CASE WHEN Lower(SettingValue) Like 'fileid=%'
		 THEN {databaseOwner}[{objectQualifier}FilePath](SettingValue)
		 ELSE SettingValue 
		END   AS SettingValue,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate,
		CultureCode
	 FROM  {databaseOwner}[{objectQualifier}PortalSettings]
	 WHERE PortalID    = @PortalID
	   AND SettingName = @SettingName
	   AND COALESCE(CultureCode, @CultureCode,'') = IsNull(@CultureCode,'')
	 ORDER BY IsNull(CultureCode,'') DESC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNextMessagesForInstantDispatch]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNextMessagesForInstantDispatch]
	@SchedulerInstance UNIQUEIDENTIFIER ,
	@BatchSize INT
AS 
	BEGIN
		UPDATE  {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
		SET     EmailSchedulerInstance = @SchedulerInstance
		WHERE   RecipientID IN (
				SELECT TOP ( @BatchSize )
						RecipientID 
				FROM    {databaseOwner}[{objectQualifier}vw_MessagesForDispatch] MFD
				WHERE   EmailSent = 0
						AND [Read] = 0
						AND Archived = 0
						AND EmailFrequency = 0
						AND ( ( EmailSchedulerInstance IS NULL
								AND EmailSentDate IS NULL
							  )
							  OR EmailSchedulerInstance = '00000000-0000-0000-0000-000000000000'
							)
				ORDER BY MFD.CreatedOnDate DESC ,
						UserID )

		SELECT  *
		FROM    {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] CMR
				INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] CMM ON CMR.MessageID = CMM.MessageID
		WHERE   EmailSent = 0
				AND EmailSentDate IS NULL
				AND [Read] = 0
				AND Archived = 0
				AND ( EmailSchedulerInstance = @SchedulerInstance )
		ORDER BY UserID ,
				CMM.CreatedOnDate DESC	
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FolderMappingsSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}FolderMappingsSettings]
(
[FolderMappingID] [int] NOT NULL,
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (2000) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}FolderMappingsSettings] on {databaseOwner}[{objectQualifier}FolderMappingsSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderMappingsSettings] ADD CONSTRAINT [PK_{objectQualifier}FolderMappingsSettings] PRIMARY KEY CLUSTERED  ([FolderMappingID], [SettingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderMappingsSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderMappingsSetting]
	@FolderMappingID int,
	@SettingName nvarchar(50)
AS
BEGIN
	SELECT *
	FROM {databaseOwner}[{objectQualifier}FolderMappingsSettings]
	WHERE FolderMappingID = @FolderMappingID AND SettingName = @SettingName
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FileVersions]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}FileVersions]
(
[FileId] [int] NOT NULL,
[Version] [int] NOT NULL,
[FileName] [nvarchar] (246) NOT NULL,
[Extension] [nvarchar] (100) NOT NULL,
[Size] [int] NOT NULL,
[Width] [int] NULL,
[Height] [int] NULL,
[ContentType] [nvarchar] (200) NOT NULL,
[Content] [image] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[SHA1Hash] [varchar] (40) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}FileVersions] on {databaseOwner}[{objectQualifier}FileVersions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FileVersions] ADD CONSTRAINT [PK_{objectQualifier}FileVersions] PRIMARY KEY CLUSTERED  ([FileId], [Version])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileVersionContent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFileVersionContent]

	@FileId		int,
	@Version	int

AS
	SELECT Content
	FROM {databaseOwner}[{objectQualifier}FileVersions]
	WHERE FileId = @FileId
		AND Version = @Version
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_CoreMessaging_Messages]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_CoreMessaging_Messages]
AS
	SELECT
		M.MessageID, 
		M.PortalID, 
		M.NotificationTypeID, 
		M.[To], 
		M.[From],
		M.Subject,
		M.Body,
		M.ConversationID, 
		M.ReplyAllAllowed, 
		M.SenderUserID,
		M.ExpirationDate, 
        M.Context, 
		M.IncludeDismissAction,
		M.CreatedByUserID, 
		M.CreatedOnDate, 
		M.LastModifiedByUserID, 
		M.LastModifiedOnDate, 
		MR.RecipientID,
		MR.UserID, 
        MR.[Read], 
		MR.Archived, 
		MR.EmailSent, 
		MR.EmailSentDate, 
		MR.EmailSchedulerInstance
	FROM       {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR
	INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages]          M ON mr.MessageID = m.MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNextMessagesForDigestDispatch]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNextMessagesForDigestDispatch]
	@Frequency INT ,
	@SchedulerInstance UNIQUEIDENTIFIER ,
	@BatchSize INT
AS 
	BEGIN
		UPDATE  {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
		SET     EmailSchedulerInstance = @SchedulerInstance
		WHERE   RecipientID IN (
				SELECT 
						RecipientID
				FROM    {databaseOwner}[{objectQualifier}vw_MessagesForDispatch] MFD
				WHERE UserID IN (
							SELECT TOP ( @BatchSize  )
									UserID
							FROM    {databaseOwner}[{objectQualifier}vw_MessagesForDispatch] MFD
							WHERE   EmailSent = 0
									AND [Read] = 0
									AND Archived = 0
									AND EmailFrequency = @Frequency
									AND ( ( EmailSchedulerInstance IS NULL
											AND EmailSentDate IS NULL
										  )
										  OR EmailSchedulerInstance = '00000000-0000-0000-0000-000000000000'
										)        
							GROUP BY UserID
							ORDER BY UserID      
						)  
						AND EmailSent = 0
						AND [Read] = 0
						AND Archived = 0
						AND EmailFrequency = @Frequency
						AND ( ( EmailSchedulerInstance IS NULL
								AND EmailSentDate IS NULL
							  )
							  OR EmailSchedulerInstance = '00000000-0000-0000-0000-000000000000'
							))

		SELECT  *
		FROM    {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] CMR
				INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] CMM ON CMR.MessageID = CMM.MessageID
		WHERE   EmailSent = 0
				AND EmailSentDate IS NULL
				AND [Read] = 0
				AND Archived = 0
				AND ( EmailSchedulerInstance = @SchedulerInstance )
		ORDER BY UserID ,
				CMM.CreatedOnDate DESC                      
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetListEntry]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetListEntry]

	@ListName nvarchar(50),
	@Value nvarchar(200),
	@EntryID int

AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}vw_Lists
	WHERE ([ListName] = @ListName OR @ListName='')
		AND ([EntryID]=@EntryID OR @EntryID = -1)
		AND ([Value]=@Value OR @Value = '')
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserPortals]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UserPortals]
(
[UserId] [int] NOT NULL,
[PortalId] [int] NOT NULL,
[UserPortalId] [int] NOT NULL IDENTITY(1, 1),
[CreatedDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}UserPortals_CreatedDate] DEFAULT (getdate()),
[Authorised] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}UserPortals_Authorised] DEFAULT ((1)),
[IsDeleted] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}UserPortals_IsDeleted] DEFAULT ((0)),
[RefreshRoles] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}UserPortals_RefreshRoles] DEFAULT ((0)),
[VanityUrl] [nvarchar] (100) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UserPortals] on {databaseOwner}[{objectQualifier}UserPortals]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserPortals] ADD CONSTRAINT [PK_{objectQualifier}UserPortals] PRIMARY KEY CLUSTERED  ([UserId], [PortalId])
GO
PRINT N'Creating index [IX_{objectQualifier}UserPortals_VanityUrl] on {databaseOwner}[{objectQualifier}UserPortals]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserPortals_VanityUrl] ON {databaseOwner}[{objectQualifier}UserPortals] ([VanityUrl]) INCLUDE ([PortalId], [UserId])
GO
PRINT N'Creating index [IX_{objectQualifier}UserPortals] on {databaseOwner}[{objectQualifier}UserPortals]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserPortals] ON {databaseOwner}[{objectQualifier}UserPortals] ([PortalId])
GO
PRINT N'Creating index [IX_{objectQualifier}UserPortals_PortalId_IsDeleted] on {databaseOwner}[{objectQualifier}UserPortals]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserPortals_PortalId_IsDeleted] ON {databaseOwner}[{objectQualifier}UserPortals] ([PortalId], [IsDeleted])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_Users]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_Users]
AS
	SELECT  U.UserId,
        UP.PortalId,
        U.Username,
        U.FirstName,
        U.LastName,
        U.DisplayName,
        U.IsSuperUser,
        U.Email,
        UP.VanityUrl,
        U.AffiliateId,
        IsNull(UP.IsDeleted, U.IsDeleted) AS IsDeleted,
        UP.RefreshRoles,
        U.LastIPAddress,
        U.UpdatePassword,
        U.PasswordResetToken,
        U.PasswordResetExpiration,
        UP.Authorised,
        U.CreatedByUserId,
        U.CreatedOnDate,
        U.LastModifiedByUserId,
        U.LastModifiedOnDate
	FROM       {databaseOwner}[{objectQualifier}Users]       AS U
		LEFT JOIN {databaseOwner}[{objectQualifier}UserPortals] AS UP 
			ON CASE WHEN U.IsSuperuser = 1 THEN 0 ELSE U.UserId END = UP.UserId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserByVanityUrl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserByVanityUrl]

	@PortalID int,
	@VanityUrl nvarchar(100)

AS
	SELECT * FROM {databaseOwner}{objectQualifier}vw_Users
	WHERE  VanityUrl = @VanityUrl
		AND  ((@PortalId IS NULL) OR (PortalId = @PortalID) OR IsSuperUser = 1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments]
(
[MessageAttachmentID] [int] NOT NULL IDENTITY(1, 1),
[MessageID] [int] NOT NULL,
[FileID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_MessageAttachments] on {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_MessageAttachments] PRIMARY KEY CLUSTERED  ([MessageAttachmentID])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_MessageAttachments_MessageID] on {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_MessageAttachments_MessageID] ON {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments] ([MessageID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessageAttachment]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessageAttachment]
    @MessageAttachmentID int
AS
	DELETE FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments
	WHERE  [MessageAttachmentID] = @MessageAttachmentID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Schedule]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Schedule]
(
[ScheduleID] [int] NOT NULL IDENTITY(1, 1),
[TypeFullName] [varchar] (200) NOT NULL,
[TimeLapse] [int] NOT NULL,
[TimeLapseMeasurement] [varchar] (2) NOT NULL,
[RetryTimeLapse] [int] NOT NULL,
[RetryTimeLapseMeasurement] [varchar] (2) NOT NULL,
[RetainHistoryNum] [int] NOT NULL,
[AttachToEvent] [varchar] (50) NOT NULL,
[CatchUpEnabled] [bit] NOT NULL,
[Enabled] [bit] NOT NULL,
[ObjectDependencies] [varchar] (300) NOT NULL,
[Servers] [nvarchar] (2000) NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[FriendlyName] [nvarchar] (200) NULL,
[ScheduleStartDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Schedule] on {databaseOwner}[{objectQualifier}Schedule]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Schedule] ADD CONSTRAINT [PK_{objectQualifier}Schedule] PRIMARY KEY CLUSTERED  ([ScheduleID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetScheduleByScheduleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetScheduleByScheduleID]
@ScheduleID int
AS
SELECT S.*
FROM {databaseOwner}{objectQualifier}Schedule S
WHERE S.ScheduleID = @ScheduleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePortalSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePortalSetting]
	@PortalID      Int,          -- Not Null
	@SettingName   nVarChar(50), -- Not Null
	@CultureCode   nVarChar(10)  -- Null|'' for all languages and neutral settings
AS
BEGIN
	DELETE FROM {databaseOwner}[{objectQualifier}PortalSettings]
	 WHERE (PortalID    = @PortalID)
	   AND (SettingName = @SettingName)
	   AND (CultureCode = @CultureCode OR IsNull(@CultureCode, '') = '')
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CheckReplyHasRecipients]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CheckReplyHasRecipients]
	@ConversationId Int, -- Not Null
	@UserId 		Int  -- Not Null
AS 
BEGIN
	SELECT COUNT(M.UserID)
	FROM       {databaseOwner}{objectQualifier}vw_CoreMessaging_Messages AS M
	INNER JOIN {databaseOwner}{objectQualifier}vw_Users AS U ON M.UserID = U.UserID AND M.PortalID = IsNull(U.PortalID, M.PortalID)
	WHERE (M.MessageID = @ConversationId) 
	  AND (M.UserID   <> @UserId) 
	  AND (U.IsDeleted = 0)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}IPFilter]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}IPFilter]
(
[IPFilterID] [int] NOT NULL IDENTITY(1, 1),
[IPAddress] [nvarchar] (50) NULL,
[SubnetMask] [nvarchar] (50) NULL,
[RuleType] [tinyint] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}IPFilter] on {databaseOwner}[{objectQualifier}IPFilter]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}IPFilter] ADD CONSTRAINT [PK_{objectQualifier}IPFilter] PRIMARY KEY CLUSTERED  ([IPFilterID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetIPFilter]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetIPFilter]
@InputFilter int
AS 
	SELECT * FROM {databaseOwner}{objectQualifier}IPFilter where IPFilterID=@InputFilter
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SkinControls]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SkinControls]
(
[SkinControlID] [int] NOT NULL IDENTITY(1, 1),
[PackageID] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}SkinControls_PackageID] DEFAULT ((-1)),
[ControlKey] [nvarchar] (50) NULL,
[ControlSrc] [nvarchar] (256) NULL,
[IconFile] [nvarchar] (100) NULL,
[HelpUrl] [nvarchar] (200) NULL,
[SupportsPartialRendering] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}SkinControls_SupportsPartialRendering] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SkinControls] on {databaseOwner}[{objectQualifier}SkinControls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SkinControls] ADD CONSTRAINT [PK_{objectQualifier}SkinControls] PRIMARY KEY CLUSTERED  ([SkinControlID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSkinControl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddSkinControl]
	
	@PackageID					int,
	@ControlKey                 nvarchar(50),
	@ControlSrc                 nvarchar(256),
	@SupportsPartialRendering   bit,
	@CreatedByUserID	int

AS
	INSERT INTO {databaseOwner}{objectQualifier}SkinControls (
	  PackageID,
	  ControlKey,
	  ControlSrc,
      SupportsPartialRendering,
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	)
	VALUES (
	  @PackageID,
	  @ControlKey,
	  @ControlSrc,
      @SupportsPartialRendering,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePortalSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePortalSettings]
	@PortalID      Int,          -- Not Null
	@CultureCode   nVarChar(10)  -- Null|'' for all languages and neutral settings

AS
BEGIN
	DELETE FROM {databaseOwner}[{objectQualifier}PortalSettings]
	 WHERE (PortalID    = @PortalID)
	   AND (CultureCode = @CultureCode OR IsNull(@CultureCode, '') = '')
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageConversations]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageConversations]
	@UserID int,
	@PortalID int,
	@AfterMessageID int,
	@NumberOfRecords int,
	@SortField nvarchar(25) = 'CreatedOnDate',
	@SortAscending bit = 0,
	@Read bit = 0,
	@Archived bit = 0,
	@SentOnly bit = 0
AS
BEGIN
	--Get the top message for each conversation
	;WITH RollUpMessageIDs AS
	(
		SELECT MAX(m.MessageID) AS TopMessageID
		FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] mr
		INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] m ON mr.MessageID = m.MessageID
		WHERE ((Archived = @Archived) or (@Archived is null AND [Archived] IS NOT null))
		AND (([Read] = @Read) or (@Read is null AND [READ] IS NOT null))
		AND ((@SentOnly = 1 AND SenderUserID = @UserID) or (@SentOnly is NULL AND UserID = @UserID) or (@SentOnly = 0 AND UserID = @UserID))
		AND m.NotificationTypeID IS NULL AND m.PortalID=@PortalID
		GROUP BY ConversationID
	)
	,Conversations  AS
	(
		SELECT  DISTINCT [MessageID], [ConversationID], [Subject], convert(nvarchar(50), [Body]) AS Body,
				[To], [From], [ReplyAllAllowed], [SenderUserID],
				[CreatedByUserID], [CreatedOnDate],
				[LastModifiedByUserID], [LastModifiedOnDate],
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages WHERE ConversationID = m.ConversationID)) AS AttachmentCount,
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages WHERE ConversationID = m.ConversationID) AND UserID = @UserID AND [READ] = 0) AS NewThreadCount,
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages WHERE ConversationID = m.ConversationID) AND UserID = @UserID) AS ThreadCount,
				ROW_NUMBER() OVER(ORDER BY
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 1 THEN [CreatedOnDate] END ASC,
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 0 THEN [CreatedOnDate] END DESC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 1 THEN [From] END ASC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 0 THEN [From] END DESC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 1 THEN [Subject] END ASC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 0 THEN [Subject] END DESC
					) AS RowNumber
		FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages AS m
		WHERE MessageID IN (SELECT TopMessageID FROM RollUpMessageIDs)
	)
	SELECT * FROM Conversations
	WHERE (@AfterMessageID > 0 AND RowNumber BETWEEN (SELECT RowNumber + 1 FROM Conversations WHERE [MessageID] = @AfterMessageID) AND (SELECT RowNumber + @NumberOfRecords FROM Conversations WHERE [MessageID] = @AfterMessageID)) OR
	(@AfterMessageID = -1 AND RowNumber BETWEEN 1 AND @NumberOfRecords)
	ORDER BY RowNumber ASC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAuthenticationServiceByType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAuthenticationServiceByType]

	@AuthenticationType nvarchar(100)

AS
	SELECT *
		FROM  {databaseOwner}{objectQualifier}Authentication
		WHERE AuthenticationType = @AuthenticationType
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DesktopModules]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}DesktopModules]
(
[DesktopModuleID] [int] NOT NULL IDENTITY(1, 1),
[FriendlyName] [nvarchar] (128) NOT NULL,
[Description] [nvarchar] (2000) NULL,
[Version] [nvarchar] (8) NULL,
[IsPremium] [bit] NOT NULL,
[IsAdmin] [bit] NOT NULL,
[BusinessControllerClass] [nvarchar] (200) NULL,
[FolderName] [nvarchar] (128) NOT NULL,
[ModuleName] [nvarchar] (128) NOT NULL,
[SupportedFeatures] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}DesktopModules_SupportedFeatures] DEFAULT ((0)),
[CompatibleVersions] [nvarchar] (500) NULL,
[Dependencies] [nvarchar] (400) NULL,
[Permissions] [nvarchar] (400) NULL,
[PackageID] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}DesktopModules_PackageID] DEFAULT ((-1)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[ContentItemId] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}DesktopModules_ContentItemId] DEFAULT ((-1)),
[Shareable] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}DesktopModules_Shareable] DEFAULT ((0)),
[AdminPage] [nvarchar] (128) NULL,
[HostPage] [nvarchar] (128) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}DesktopModules] on {databaseOwner}[{objectQualifier}DesktopModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModules] ADD CONSTRAINT [PK_{objectQualifier}DesktopModules] PRIMARY KEY CLUSTERED  ([DesktopModuleID])
GO
PRINT N'Creating index [IX_{objectQualifier}DesktopModules_FriendlyName] on {databaseOwner}[{objectQualifier}DesktopModules]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}DesktopModules_FriendlyName] ON {databaseOwner}[{objectQualifier}DesktopModules] ([FriendlyName])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}DesktopModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModules] ADD CONSTRAINT [IX_{objectQualifier}DesktopModules_ModuleName] UNIQUE NONCLUSTERED  ([ModuleName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentItems]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentItems]
(
[ContentItemID] [int] NOT NULL IDENTITY(1, 1),
[Content] [nvarchar] (max) NULL,
[ContentTypeID] [int] NOT NULL,
[TabID] [int] NOT NULL,
[ModuleID] [int] NOT NULL,
[ContentKey] [nvarchar] (250) NULL,
[Indexed] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}ContentItems_Indexed] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[StateID] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentItems] on {databaseOwner}[{objectQualifier}ContentItems]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems] ADD CONSTRAINT [PK_{objectQualifier}ContentItems] PRIMARY KEY CLUSTERED  ([ContentItemID])
GO
PRINT N'Creating index [IX_{objectQualifier}ContentItems_TabID] on {databaseOwner}[{objectQualifier}ContentItems]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ContentItems_TabID] ON {databaseOwner}[{objectQualifier}ContentItems] ([TabID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_DesktopModules]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_DesktopModules]
AS
	SELECT
		DM.DesktopModuleID,
		DM.FriendlyName,
		DM.Description,
		DM.Version,
		DM.IsPremium,
		DM.IsAdmin,
		DM.BusinessControllerClass,
		DM.FolderName,
		DM.ModuleName,
		DM.SupportedFeatures,
		DM.CompatibleVersions,
		DM.Dependencies,
		DM.Permissions,
		DM.PackageID,
		DM.CreatedByUserID,
		DM.CreatedOnDate,
		DM.LastModifiedByUserID,
		DM.LastModifiedOnDate,
		CI.ContentItemID,
		CI.[Content],
		CI.ContentTypeID,
		CI.TabID,
		CI.ModuleID,
		CI.ContentKey,
		CI.Indexed,
		DM.Shareable,
		DM.AdminPage,
		DM.HostPage
	FROM {databaseOwner}[{objectQualifier}DesktopModules] AS DM
		LEFT OUTER JOIN {databaseOwner}[{objectQualifier}ContentItems] AS CI ON DM.ContentItemId = CI.ContentItemID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PortalDesktopModules]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PortalDesktopModules]
(
[PortalDesktopModuleID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NOT NULL,
[DesktopModuleID] [int] NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PortalDesktopModules] on {databaseOwner}[{objectQualifier}PortalDesktopModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalDesktopModules] ADD CONSTRAINT [PK_{objectQualifier}PortalDesktopModules] PRIMARY KEY CLUSTERED  ([PortalDesktopModuleID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}PortalDesktopModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalDesktopModules] ADD CONSTRAINT [IX_{objectQualifier}PortalDesktopModules] UNIQUE NONCLUSTERED  ([PortalID], [DesktopModuleID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDesktopModulesByPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDesktopModulesByPortal]
	@PortalId int 
AS 
	SELECT DISTINCT DM.* 
	FROM {databaseOwner}{objectQualifier}vw_DesktopModules DM 
	WHERE ( IsPremium = 0 ) 
	OR  ( DesktopModuleID IN ( 
		SELECT DesktopModuleID 
		FROM {databaseOwner}{objectQualifier}PortalDesktopModules PDM 
		WHERE PDM.PortalId = @PortalId ) ) 
	ORDER BY FriendlyName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddUserPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddUserPortal]

	@PortalID		int,
	@UserID			int
AS

	IF not exists ( SELECT 1 FROM {databaseOwner}{objectQualifier}UserPortals WHERE UserID = @UserID AND PortalID = @PortalID ) AND @PortalID > -1
		BEGIN
			INSERT INTO {databaseOwner}{objectQualifier}UserPortals (
				UserID,
				PortalID,
				Authorised,
				CreatedDate
			)
			VALUES (
				@UserID,
				@PortalID,
				1,
				getdate()
			)
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPortalDesktopModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPortalDesktopModule]
	@PortalID			int,
	@DesktopModuleId	int,
	@CreatedByUserID	int

as

insert into {databaseOwner}{objectQualifier}PortalDesktopModules ( 
	PortalId,
	DesktopModuleId,
	CreatedByUserID,
	CreatedOnDate,
	LastModifiedByUserID,
	LastModifiedOnDate
)
values (
	@PortalID,
	@DesktopModuleId,
	@CreatedByUserID,
	getdate(),
	@CreatedByUserID,
	getdate()
)

select SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PortalLocalization]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PortalLocalization]
(
[PortalID] [int] NOT NULL,
[CultureCode] [nvarchar] (10) NOT NULL,
[PortalName] [nvarchar] (128) NOT NULL,
[LogoFile] [nvarchar] (50) NULL,
[FooterText] [nvarchar] (100) NULL,
[Description] [nvarchar] (500) NULL,
[KeyWords] [nvarchar] (500) NULL,
[BackgroundFile] [nvarchar] (50) NULL,
[HomeTabId] [int] NULL,
[LoginTabId] [int] NULL,
[UserTabId] [int] NULL,
[AdminTabId] [int] NULL,
[SplashTabId] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[RegisterTabId] [int] NULL,
[SearchTabId] [int] NULL,
[Custom404TabId] [int] NULL,
[Custom500TabId] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PortalLocalization] on {databaseOwner}[{objectQualifier}PortalLocalization]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalLocalization] ADD CONSTRAINT [PK_{objectQualifier}PortalLocalization] PRIMARY KEY CLUSTERED  ([PortalID], [CultureCode])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PortalLanguages]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PortalLanguages]
(
[PortalLanguageID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NOT NULL,
[LanguageID] [int] NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[IsPublished] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}PortalLanguages_IsPublished] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PortalLanguages] on {databaseOwner}[{objectQualifier}PortalLanguages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalLanguages] ADD CONSTRAINT [PK_{objectQualifier}PortalLanguages] PRIMARY KEY CLUSTERED  ([PortalLanguageID])
GO
PRINT N'Creating index [IX_{objectQualifier}PortalLanguages] on {databaseOwner}[{objectQualifier}PortalLanguages]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}PortalLanguages] ON {databaseOwner}[{objectQualifier}PortalLanguages] ([PortalID], [LanguageID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Languages]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Languages]
(
[LanguageID] [int] NOT NULL IDENTITY(1, 1),
[CultureCode] [nvarchar] (50) NOT NULL,
[CultureName] [nvarchar] (200) NOT NULL,
[FallbackCulture] [nvarchar] (50) NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Languages] on {databaseOwner}[{objectQualifier}Languages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Languages] ADD CONSTRAINT [PK_{objectQualifier}Languages] PRIMARY KEY CLUSTERED  ([LanguageID])
GO
PRINT N'Creating index [IX_{objectQualifier}Languages] on {databaseOwner}[{objectQualifier}Languages]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Languages] ON {databaseOwner}[{objectQualifier}Languages] ([CultureCode])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePortalLanguages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePortalLanguages]
    @PortalId   Int, -- Null ignored (use referential integrity to delete from all Portals)
    @LanguageId Int  -- Null ignored (use referential integrity to delete for all languages)
AS
BEGIN
    IF @PortalId Is Not Null AND IsNull(@LanguageId, -1) != -1 BEGIN
       DECLARE @CultureCode nVarchar(10);
       SELECT @CultureCode = CultureCode FROM {databaseOwner}[{objectQualifier}Languages] WHERE LanguageId = @LanguageId;
       DELETE FROM {databaseOwner}[{objectQualifier}PortalLanguages]    WHERE PortalId = @PortalId AND @LanguageId  = LanguageId;
       DELETE FROM {databaseOwner}[{objectQualifier}PortalLocalization] WHERE PortalId = @PortalId AND @CultureCode = CultureCode;
       DELETE FROM {databaseOwner}[{objectQualifier}PortalSettings]     WHERE PortalId = @PortalId AND @CultureCode = CultureCode;
    END
    -- ELSE rely on referential integrity (portal or language will be deleted as well)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAuthenticationService]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAuthenticationService]

	@AuthenticationID int

AS
	SELECT *
		FROM   {databaseOwner}{objectQualifier}Authentication
		WHERE AuthenticationID = @AuthenticationID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTab]
    @TabId Int  -- ID of tab to delete; Not Null and > 0
AS
BEGIN
    DECLARE @TabOrder Int
    DECLARE @ParentId Int
    DECLARE @ContentItemId Int
    SELECT @TabOrder = TabOrder, @ParentId = ParentID, @ContentItemID = ContentItemID FROM {databaseOwner}[{objectQualifier}Tabs] WHERE TabID = @TabId

    -- Delete Tab --
    DELETE FROM {databaseOwner}[{objectQualifier}Tabs] WHERE  TabID = @TabId

    -- Update TabOrder of remaining Tabs --
    UPDATE {databaseOwner}[{objectQualifier}Tabs]
        SET TabOrder = TabOrder - 2
        WHERE IsNull(ParentID, -1) = IsNull(@ParentId , -1) AND TabOrder > @TabOrder

    -- Delete Content Item --
    DELETE FROM {databaseOwner}[{objectQualifier}ContentItems] WHERE ContentItemID = @ContentItemId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePermission]
	@PermissionID int
AS

DELETE FROM {databaseOwner}{objectQualifier}Permission
WHERE
	[PermissionID] = @PermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserProfile]'
GO
CREATE PROC {databaseOwner}[{objectQualifier}GetUserProfile] 
	@UserID int
AS
	SELECT
		ProfileID,
		UserID,
		PropertyDefinitionID,
		CASE WHEN (PropertyValue Is Null) THEN PropertyText ELSE PropertyValue END AS 'PropertyValue',
		Visibility,
		ExtendedVisibility,
		LastUpdatedDate
	FROM	{databaseOwner}{objectQualifier}UserProfile
	WHERE   UserId = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteLanguage]
	@LanguageID		Int -- Not Null
AS
BEGIN
    DECLARE @CultureCode AS nVarChar(10);
    SELECT @CultureCode = CultureCode FROM {databaseOwner}[{objectQualifier}Languages] WHERE LanguageId = @LanguageId;
    DELETE FROM {databaseOwner}[{objectQualifier}PortalLocalization] WHERE @CultureCode = CultureCode;
    DELETE FROM {databaseOwner}[{objectQualifier}PortalSettings]     WHERE @CultureCode = CultureCode;
    DELETE FROM {databaseOwner}[{objectQualifier}Languages]          WHERE @LanguageID  = LanguageID;
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabUrls]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabUrls]
(
[TabId] [int] NOT NULL,
[SeqNum] [int] NOT NULL,
[Url] [nvarchar] (200) NOT NULL,
[QueryString] [nvarchar] (200) NULL,
[HttpStatus] [nvarchar] (50) NOT NULL,
[CultureCode] [nvarchar] (50) NULL,
[IsSystem] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}TabUrls_IsSystem] DEFAULT ((0)),
[PortalAliasId] [int] NULL,
[PortalAliasUsage] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabRedirect] on {databaseOwner}[{objectQualifier}TabUrls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabUrls] ADD CONSTRAINT [PK_{objectQualifier}TabRedirect] PRIMARY KEY CLUSTERED  ([TabId], [SeqNum])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PortalAlias]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PortalAlias]
(
[PortalAliasID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NOT NULL,
[HTTPAlias] [nvarchar] (200) NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[BrowserType] [nvarchar] (10) NULL,
[Skin] [nvarchar] (100) NULL,
[CultureCode] [nvarchar] (10) NULL,
[IsPrimary] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}PortalAlias_IsPrimary] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PortalAlias] on {databaseOwner}[{objectQualifier}PortalAlias]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalAlias] ADD CONSTRAINT [PK_{objectQualifier}PortalAlias] PRIMARY KEY CLUSTERED  ([PortalAliasID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}PortalAlias]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalAlias] ADD CONSTRAINT [IX_{objectQualifier}PortalAlias] UNIQUE NONCLUSTERED  ([HTTPAlias])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetCustomAliasesForTabs]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetCustomAliasesForTabs] 
AS
	SELECT HttpAlias
	FROM  {databaseOwner}[{objectQualifier}PortalAlias] pa 
	WHERE PortalAliasId IN (SELECT PortalAliasId FROM {databaseOwner}[{objectQualifier}TabUrls])
	ORDER BY HttpAlias
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Skins]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Skins]
(
[SkinID] [int] NOT NULL IDENTITY(1, 1),
[SkinPackageID] [int] NOT NULL,
[SkinSrc] [nvarchar] (250) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Skins] on {databaseOwner}[{objectQualifier}Skins]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Skins] ADD CONSTRAINT [PK_{objectQualifier}Skins] PRIMARY KEY CLUSTERED  ([SkinID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSkin]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSkin]

	@SkinID		int

AS

DELETE
	FROM	{databaseOwner}{objectQualifier}Skins
	WHERE   SkinID = @SkinID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]
(
[PropertyDefinitionID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[ModuleDefID] [int] NULL,
[Deleted] [bit] NOT NULL,
[DataType] [int] NOT NULL,
[DefaultValue] [ntext] NULL,
[PropertyCategory] [nvarchar] (50) NOT NULL,
[PropertyName] [nvarchar] (50) NOT NULL,
[Length] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}ProfilePropertyDefinition_Length] DEFAULT ((0)),
[Required] [bit] NOT NULL,
[ValidationExpression] [nvarchar] (2000) NULL,
[ViewOrder] [int] NOT NULL,
[Visible] [bit] NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[DefaultVisibility] [int] NULL,
[ReadOnly] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}ProfilePropertyDefinition_ReadOnly] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ProfilePropertyDefinition] on {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] ADD CONSTRAINT [PK_{objectQualifier}ProfilePropertyDefinition] PRIMARY KEY CLUSTERED  ([PropertyDefinitionID])
GO
PRINT N'Creating index [IX_{objectQualifier}ProfilePropertyDefinition] on {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}ProfilePropertyDefinition] ON {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] ([PortalID], [ModuleDefID], [PropertyName])
GO
PRINT N'Creating index [IX_{objectQualifier}ProfilePropertyDefinition_PropertyName] on {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ProfilePropertyDefinition_PropertyName] ON {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] ([PropertyName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPropertyDefinitionsByPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPropertyDefinitionsByPortal]

	@PortalID	int

AS
SELECT	{databaseOwner}{objectQualifier}ProfilePropertyDefinition.*
	FROM	{databaseOwner}{objectQualifier}ProfilePropertyDefinition
	WHERE  (PortalId = @PortalID OR (PortalId IS NULL AND @PortalID IS NULL))		
	ORDER BY ViewOrder
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Portals]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Portals]
(
[PortalID] [int] NOT NULL IDENTITY(0, 1),
[ExpiryDate] [datetime] NULL,
[UserRegistration] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_UserRegistration] DEFAULT ((0)),
[BannerAdvertising] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_BannerAdvertising] DEFAULT ((0)),
[AdministratorId] [int] NULL,
[Currency] [char] (3) NULL,
[HostFee] [money] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_HostFee] DEFAULT ((0)),
[HostSpace] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_HostSpace] DEFAULT ((0)),
[AdministratorRoleId] [int] NULL,
[RegisteredRoleId] [int] NULL,
[GUID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_GUID] DEFAULT (newid()),
[PaymentProcessor] [nvarchar] (50) NULL,
[ProcessorUserId] [nvarchar] (50) NULL,
[ProcessorPassword] [nvarchar] (50) NULL,
[SiteLogHistory] [int] NULL,
[DefaultLanguage] [nvarchar] (10) NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_DefaultLanguage] DEFAULT ('en-US'),
[TimezoneOffset] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_TimezoneOffset] DEFAULT ((-8)),
[HomeDirectory] [varchar] (100) NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_HomeDirectory] DEFAULT (''),
[PageQuota] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_PageQuota] DEFAULT ((0)),
[UserQuota] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Portals_UserQuota] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[PortalGroupID] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Portals] on {databaseOwner}[{objectQualifier}Portals]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Portals] ADD CONSTRAINT [PK_{objectQualifier}Portals] PRIMARY KEY CLUSTERED  ([PortalID])
GO
PRINT N'Creating index [IX_{objectQualifier}Portals_AdministratorId] on {databaseOwner}[{objectQualifier}Portals]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Portals_AdministratorId] ON {databaseOwner}[{objectQualifier}Portals] ([AdministratorId])
GO
PRINT N'Creating index [IX_{objectQualifier}Portals_DefaultLanguage] on {databaseOwner}[{objectQualifier}Portals]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Portals_DefaultLanguage] ON {databaseOwner}[{objectQualifier}Portals] ([DefaultLanguage])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}EnsureLocalizationExists]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}EnsureLocalizationExists]
	@PortalID       Int,
	@CultureCode	nvarchar(10)
AS
BEGIN
	DECLARE @MasterLanguage nvarchar(10) = Null;
	DECLARE @LocalizationExists bit = 0;

	IF NOT EXISTS (SELECT * FROM {databaseOwner}[{objectQualifier}Languages] L 
					JOIN {databaseOwner}[{objectQualifier}PortalLanguages] P ON L.LanguageID = P.LanguageID 
					WHERE P.PortalID = @PortalID AND L.CultureCode = @CultureCode)
		RETURN; -- language does not exist for this portal

	IF EXISTS (SELECT * FROM {databaseOwner}[{objectQualifier}PortalLocalization] 
				WHERE CultureCode = @CultureCode AND PortalID = @PortalID)
		RETURN; -- already localized
	
	IF EXISTS (SELECT * FROM {databaseOwner}[{objectQualifier}PortalLocalization] L
					JOIN {databaseOwner}[{objectQualifier}Portals] P ON L.PortalID = P.PortalID AND L.CultureCode = P.DefaultLanguage
					WHERE P.PortalID = @PortalID)
		SELECT @MasterLanguage = DefaultLanguage 
		FROM {databaseOwner}[{objectQualifier}Portals] 
		WHERE PortalID = @PortalID
	ELSE IF EXISTS (SELECT * FROM {databaseOwner}[{objectQualifier}PortalLocalization] 
					WHERE CultureCode = 'en-US' and PortalID = @PortalID)
		SET @MasterLanguage = 'en-US'
	ELSE -- neither default nor system language available: take the language that was assigned first
		SELECT TOP (1) CultureCode 
		FROM {databaseOwner}[{objectQualifier}PortalLocalization] 
		WHERE PortalID = @PortalID 
		ORDER BY PortalID ASC;

	IF NOT (@MasterLanguage Is Null OR @MasterLanguage LIKE @CultureCode) 
	BEGIN  -- copy localized values from (existing and different) master language:					
		INSERT INTO {databaseOwner}[{objectQualifier}PortalLocalization]
		(	PortalId,
			CultureCode,
			PortalName,
			LogoFile,
			FooterText,
			Description,
			KeyWords,
			BackgroundFile, 
			HomeTabId,
			LoginTabId,
			UserTabId,
			AdminTabId,
			RegisterTabId,
			SearchTabId,
			CreatedByUserID,
			CreatedOnDate,
			LastModifiedByUserID,
			LastModifiedOnDate
		) SELECT
			PortalId,
			@CultureCode,
			PortalName,
			LogoFile,
			FooterText,
			Description,
			KeyWords,
			BackgroundFile, 
			HomeTabId,
			LoginTabId,
			UserTabId,
			AdminTabId,
			RegisterTabId,
			SearchTabId,
			-1,
			GETDATE(),
			-1,
			GETDATE()
		 FROM {databaseOwner}[{objectQualifier}PortalLocalization] 
		 WHERE PortalID = @PortalID AND CultureCode = @MasterLanguage;
	
		-- copy missing localized settings:
		DECLARE	
			@LocalPortalSettings TABLE(
		    [PortalID]             INT             NOT NULL,
		    [CultureCode]          NVARCHAR (10)   NOT NULL,
		    [SettingName]          NVARCHAR (50)   NOT NULL,
		    [SettingValue]         NVARCHAR (2000) NULL
		);

		INSERT INTO @LocalPortalSettings
		(
			PortalID,
			CultureCode,
			SettingName,
			SettingValue
		)
		SELECT
			PortalID,
			CultureCode,
			SettingName,
			SettingValue
		FROM {databaseOwner}[{objectQualifier}PortalSettings]
		WHERE PortalID = @PortalID AND CultureCode = @CultureCode;

		MERGE INTO @LocalPortalSettings target
		USING (SELECT * FROM {databaseOwner}[{objectQualifier}PortalSettings]
				WHERE PortalId = @PortalID and CultureCode = @MasterLanguage) source 
		ON (target.SettingName = source.SettingName)
		WHEN NOT MATCHED THEN 
			INSERT (  
				PortalID,   
				CultureCode,   
				SettingName,   
				SettingValue) 
			VALUES (
				source.PortalID, 
				@CultureCode, 
				source.SettingName, 
				source.SettingValue
			);

		MERGE INTO {databaseOwner}[{objectQualifier}PortalSettings]  target
		USING (SELECT * FROM @LocalPortalSettings) source 
		ON (target.PortalID = source.PortalID AND 
			target.CultureCode = source.CultureCode AND 
			target.SettingName = source.SettingName)
		WHEN NOT MATCHED THEN 
			INSERT (  
				PortalID,   
				CultureCode,   
				SettingName,   
				SettingValue,
				CreatedByUserID, 
				CreatedOnDate, 
				LastModifiedByUserID, 
				LastModifiedOnDate) 
			VALUES (
				source.PortalID, 
				@CultureCode, 
				source.SettingName, 
				source.SettingValue,
				-1,
				GETDATE(),
				-1,
				GETDATE()
			);
	END;
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}HasChildTab]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}HasChildTab]
(
   @TabId   Int
) 
	RETURNS Bit
AS
BEGIN
    RETURN CASE WHEN EXISTS (SELECT 1 FROM {databaseOwner}{objectQualifier}Tabs WHERE ParentId = @TabId) THEN 1 ELSE 0 END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_Tabs]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_Tabs]
AS
    SELECT
        T.TabID,
        T.TabOrder,
        T.PortalID,
        T.TabName,
        T.ParentId,
        T.[Level],
        T.TabPath,
        T.UniqueId,
        T.VersionGuid,
        T.DefaultLanguageGuid,
        T.LocalizedVersionGuid,
        T.IsVisible,
		T.HasBeenPublished,
		 Case when t.IconFile LIKE 'fileid=%' 
			then (SELECT IsNull(Folder, '') + [FileName] FROM {databaseOwner}[{objectQualifier}vw_Files]
			 WHERE fileid = CAST(SUBSTRING(t.IconFile, 8, 10) AS Int))
			 else Coalesce(t.IconFile,'')
			 end as IconFile
		,
         Case when t.IconFileLarge LIKE 'fileid=%' 
			then (SELECT IsNull(Folder, '') + [FileName] FROM {databaseOwner}[{objectQualifier}vw_Files]
			 WHERE fileid = CAST(SUBSTRING(t.IconFileLarge, 8, 10) AS Int))
			 else Coalesce(t.IconFileLarge,'')
			 end as IconFileLarge
		,T.DisableLink,
        T.Title,
        T.Description,
        T.KeyWords,
        T.IsDeleted,
        T.SkinSrc,
        T.ContainerSrc,
        T.StartDate,
        T.EndDate,
        T.Url,
        CASE WHEN {databaseOwner}{objectQualifier}HasChildTab(T.TabID) = 1 THEN 'true' ELSE 'false' END AS HasChildren,
        T.RefreshInterval,
        T.PageHeadText,
        T.IsSecure,
        T.PermanentRedirect,
        T.SiteMapPriority,
        CI.ContentItemID,
        CI.[Content],
        CI.ContentTypeID,
        CI.ModuleID,
        CI.ContentKey,
        CI.Indexed,
        CI.StateID,
        T.CultureCode,
        T.CreatedByUserID,
        T.CreatedOnDate,
        T.LastModifiedByUserID,
        T.LastModifiedOnDate,
		T.IsSystem
    FROM       {databaseOwner}[{objectQualifier}Tabs]         AS T
    LEFT  JOIN {databaseOwner}[{objectQualifier}ContentItems] AS CI ON T.ContentItemID = CI.ContentItemID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabs]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabs]
	@PortalID Int  -- Null|-1 for host pages
AS
	SELECT *
	FROM   {databaseOwner}[{objectQualifier}vw_Tabs]
	WHERE  IsNull(PortalId, -1) = IsNull(@PortalID, -1)
	ORDER BY PortalId, [Level], ParentID, TabOrder -- PortalId added for query optimization
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFileVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFileVersion]
	@FileID			int,
    @VersionGuid	uniqueidentifier
AS
    UPDATE {databaseOwner}{objectQualifier}Files
        SET    VersionGuid = @VersionGuid
    WHERE  FileID = @FileID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Modules]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Modules]
(
[ModuleID] [int] NOT NULL IDENTITY(0, 1),
[ModuleDefID] [int] NOT NULL,
[AllTabs] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Modules_AllTabs] DEFAULT ((0)),
[IsDeleted] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Modules_IsDeleted] DEFAULT ((0)),
[InheritViewPermissions] [bit] NULL,
[StartDate] [datetime] NULL,
[EndDate] [datetime] NULL,
[PortalID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL CONSTRAINT [DF_{objectQualifier}Modules_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL CONSTRAINT [DF_{objectQualifier}Modules_LastModifiedOnDate] DEFAULT (getdate()),
[LastContentModifiedOnDate] [datetime] NULL,
[ContentItemID] [int] NULL,
[IsShareable] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Modules_IsShareable] DEFAULT ((1)),
[IsShareableViewOnly] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Modules_IsShareableViewOnly] DEFAULT ((1))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Modules] on {databaseOwner}[{objectQualifier}Modules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Modules] ADD CONSTRAINT [PK_{objectQualifier}Modules] PRIMARY KEY CLUSTERED  ([ModuleID])
GO
PRINT N'Creating index [IX_{objectQualifier}Modules_ModuleDefId] on {databaseOwner}[{objectQualifier}Modules]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Modules_ModuleDefId] ON {databaseOwner}[{objectQualifier}Modules] ([ModuleDefID], [ModuleID]) INCLUDE ([AllTabs], [CreatedByUserID], [CreatedOnDate], [EndDate], [InheritViewPermissions], [IsShareable], [IsShareableViewOnly], [LastContentModifiedOnDate], [LastModifiedByUserID], [LastModifiedOnDate], [PortalID], [StartDate])
GO
PRINT N'Creating index [IX_{objectQualifier}Modules_PortalId] on {databaseOwner}[{objectQualifier}Modules]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Modules_PortalId] ON {databaseOwner}[{objectQualifier}Modules] ([PortalID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ModuleDefinitions]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ModuleDefinitions]
(
[ModuleDefID] [int] NOT NULL IDENTITY(1, 1),
[FriendlyName] [nvarchar] (128) NOT NULL,
[DesktopModuleID] [int] NOT NULL,
[DefaultCacheTime] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}ModuleDefinitions_DefaultCacheTime] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[DefinitionName] [nvarchar] (128) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ModuleDefinitions] on {databaseOwner}[{objectQualifier}ModuleDefinitions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModuleDefinitions] ADD CONSTRAINT [PK_{objectQualifier}ModuleDefinitions] PRIMARY KEY CLUSTERED  ([ModuleDefID])
GO
PRINT N'Creating index [IX_{objectQualifier}ModuleDefinitions_1] on {databaseOwner}[{objectQualifier}ModuleDefinitions]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ModuleDefinitions_1] ON {databaseOwner}[{objectQualifier}ModuleDefinitions] ([DesktopModuleID])
GO
PRINT N'Creating index [IX_{objectQualifier}ModuleDefinitions] on {databaseOwner}[{objectQualifier}ModuleDefinitions]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}ModuleDefinitions] ON {databaseOwner}[{objectQualifier}ModuleDefinitions] ([DefinitionName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ModuleControls]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ModuleControls]
(
[ModuleControlID] [int] NOT NULL IDENTITY(1, 1),
[ModuleDefID] [int] NULL,
[ControlKey] [nvarchar] (50) NULL,
[ControlTitle] [nvarchar] (50) NULL,
[ControlSrc] [nvarchar] (256) NULL,
[IconFile] [nvarchar] (100) NULL,
[ControlType] [int] NOT NULL,
[ViewOrder] [int] NULL,
[HelpUrl] [nvarchar] (200) NULL,
[SupportsPartialRendering] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}ModuleControls_SupportsPartialRendering] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[SupportsPopUps] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}ModuleControls_SupportsPopUps] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ModuleControls] on {databaseOwner}[{objectQualifier}ModuleControls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModuleControls] ADD CONSTRAINT [PK_{objectQualifier}ModuleControls] PRIMARY KEY CLUSTERED  ([ModuleControlID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}ModuleControls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModuleControls] ADD CONSTRAINT [IX_{objectQualifier}ModuleControls] UNIQUE NONCLUSTERED  ([ModuleDefID], [ControlKey], [ControlSrc])
GO
PRINT N'Creating index [IX_{objectQualifier}ModuleControls_ControlKey_ViewOrder] on {databaseOwner}[{objectQualifier}ModuleControls]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ModuleControls_ControlKey_ViewOrder] ON {databaseOwner}[{objectQualifier}ModuleControls] ([ControlKey], [ViewOrder])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_Modules]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_Modules]
AS
    SELECT
        M.PortalID AS [OwnerPortalID],
        T.PortalID,
        TM.TabID,
        TM.TabModuleID,
        M.ModuleID,
        M.ModuleDefID,
        TM.ModuleOrder,
        TM.PaneName,
        TM.ModuleTitle,
        TM.CacheTime,
        TM.CacheMethod,
        TM.Alignment,
        TM.Color,
        TM.Border,
        Case when tm.IconFile LIKE 'fileid=%' 
			then (SELECT IsNull(Folder, '') + [FileName] FROM {databaseOwner}[{objectQualifier}vw_Files]
			 WHERE fileid = CAST(SUBSTRING(tm.IconFile, 8, 10) AS Int))
			 else Coalesce(tm.IconFile,'')
			 end as IconFile,
        M.AllTabs,
        TM.Visibility,
        TM.IsDeleted,
        TM.Header,
        TM.Footer,
        M.StartDate,
        M.EndDate,
        TM.ContainerSrc,
        TM.DisplayTitle,
        TM.DisplayPrint,
        TM.DisplaySyndicate,
        TM.IsWebSlice,
        TM.WebSliceTitle,
        TM.WebSliceExpiryDate,
        TM.WebSliceTTL,
        M.InheritViewPermissions,
        M.IsShareable,
        M.IsShareableViewOnly,
        MD.DesktopModuleID,
        MD.DefaultCacheTime,
        MC.ModuleControlID,
        DM.BusinessControllerClass,
        DM.IsAdmin,
        DM.SupportedFeatures,
        CI.ContentItemID,
        CI.Content,
        CI.ContentTypeID,
        CI.ContentKey,
        CI.Indexed,
        CI.StateID,
        M.CreatedByUserID,
        M.CreatedOnDate,
        M.LastModifiedByUserID,
        M.LastModifiedOnDate,
        M.LastContentModifiedOnDate,
        TM.UniqueId,
        TM.VersionGuid,
        TM.DefaultLanguageGuid,
        TM.LocalizedVersionGuid,
        TM.CultureCode
    FROM        {databaseOwner}[{objectQualifier}ModuleDefinitions] AS MD
     INNER JOIN {databaseOwner}[{objectQualifier}Modules]           AS M  ON MD.ModuleDefID = M.ModuleDefID
     INNER JOIN {databaseOwner}[{objectQualifier}ModuleControls]    AS MC ON MD.ModuleDefID = MC.ModuleDefID
     INNER JOIN {databaseOwner}[{objectQualifier}DesktopModules]    AS DM ON MD.DesktopModuleID = DM.DesktopModuleID
     LEFT  JOIN {databaseOwner}[{objectQualifier}ContentItems]      AS CI ON M.ContentItemID = CI.ContentItemID
     LEFT  JOIN {databaseOwner}[{objectQualifier}TabModules]       AS TM ON M.ModuleID = TM.ModuleID
     LEFT  JOIN {databaseOwner}[{objectQualifier}Tabs]              AS T  ON TM.TabID = T.TabID
    WHERE (MC.ControlKey IS NULL)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAllModules]

AS
SELECT	* 
FROM {databaseOwner}{objectQualifier}vw_Modules
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabsByModuleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabsByModuleID]
	@ModuleID Int -- NOT Null
AS
BEGIN
	SELECT * FROM {databaseOwner}[{objectQualifier}vw_Tabs] T
	WHERE IsDeleted = 0
	  AND TabID IN (SELECT TabID FROM {databaseOwner}[{objectQualifier}TabModules]
					WHERE ModuleID = @ModuleID AND IsDeleted = 0)
	ORDER BY PortalId, Level, ParentID, TabOrder -- PortalId added for query optimization
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SystemMessages]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SystemMessages]
(
[MessageID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[MessageName] [nvarchar] (50) NOT NULL,
[MessageValue] [ntext] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SystemMessages] on {databaseOwner}[{objectQualifier}SystemMessages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SystemMessages] ADD CONSTRAINT [PK_{objectQualifier}SystemMessages] PRIMARY KEY CLUSTERED  ([MessageID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}SystemMessages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SystemMessages] ADD CONSTRAINT [IX_{objectQualifier}SystemMessages] UNIQUE NONCLUSTERED  ([MessageName], [PortalID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSystemMessage]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteSystemMessage]

@PortalID     int,
@MessageName  nvarchar(50)

as

delete
from   {databaseOwner}{objectQualifier}SystemMessages
where  PortalID = @PortalID
and    MessageName = @MessageName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Packages]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Packages]
(
[PackageID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[Name] [nvarchar] (128) NOT NULL,
[FriendlyName] [nvarchar] (250) NOT NULL,
[Description] [nvarchar] (2000) NULL,
[PackageType] [nvarchar] (100) NOT NULL,
[Version] [nvarchar] (50) NOT NULL,
[License] [ntext] NULL,
[Manifest] [ntext] NULL,
[Owner] [nvarchar] (100) NULL,
[Organization] [nvarchar] (100) NULL,
[Url] [nvarchar] (250) NULL,
[Email] [nvarchar] (100) NULL,
[ReleaseNotes] [ntext] NULL,
[IsSystemPackage] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Packages_IsSystemPackage] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[FolderName] [nvarchar] (128) NULL,
[IconFile] [nvarchar] (100) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Packages] on {databaseOwner}[{objectQualifier}Packages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Packages] ADD CONSTRAINT [PK_{objectQualifier}Packages] PRIMARY KEY CLUSTERED  ([PackageID])
GO
PRINT N'Creating index [IX_{objectQualifier}Packages] on {databaseOwner}[{objectQualifier}Packages]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Packages] ON {databaseOwner}[{objectQualifier}Packages] ([Owner], [Name], [PackageType], [PortalID], [Version])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPackage]
	@PortalID			int,
	@Name			    nvarchar(128),
	@FriendlyName	    nvarchar(250),
	@Description	    nvarchar(2000),
	@PackageType	    nvarchar(50),
	@Version		    nvarchar(50),
	@License		    ntext,
	@Manifest		    ntext,
	@Owner				nvarchar(100),
	@Organization		nvarchar(100),
	@Url				nvarchar(250),
	@Email				nvarchar(100),
	@ReleaseNotes	    ntext,
	@IsSystemPackage    bit,
	@CreatedByUserID	int,
	@FolderName			nvarchar(127),
	@IconFile			nvarchar(100)
AS
	INSERT INTO {databaseOwner}{objectQualifier}Packages
	(
		PortalID,
		[Name],
		FriendlyName,
		[Description],
		PackageType,
		Version,
		License,
		Manifest,
		ReleaseNotes,
		[Owner],
		Organization,
		Url,
		Email,
		IsSystemPackage,
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate],
		FolderName,
		IconFile
	)
	VALUES (
		@PortalID,
		@Name,
		@FriendlyName,
		@Description,
		@PackageType,
		@Version,
		@License,
		@Manifest,
		@ReleaseNotes,
		@Owner,
		@Organization,
		@Url,
		@Email,
		@IsSystemPackage,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate(),
		@FolderName,
		@IconFile
	)
	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Taxonomy_ScopeTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Taxonomy_ScopeTypes]
(
[ScopeTypeID] [int] NOT NULL IDENTITY(1, 1),
[ScopeType] [nvarchar] (250) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ScopeTypes] on {databaseOwner}[{objectQualifier}Taxonomy_ScopeTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_ScopeTypes] ADD CONSTRAINT [PK_{objectQualifier}ScopeTypes] PRIMARY KEY CLUSTERED  ([ScopeTypeID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateScopeType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateScopeType] 
	@ScopeTypeId				int,
	@ScopeType					nvarchar(250)
AS
	UPDATE {databaseOwner}{objectQualifier}Taxonomy_ScopeTypes 
		SET 
			ScopeType = @ScopeType
	WHERE ScopeTypeId = @ScopeTypeId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DesktopModulePermission]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}DesktopModulePermission]
(
[DesktopModulePermissionID] [int] NOT NULL IDENTITY(1, 1),
[PortalDesktopModuleID] [int] NOT NULL,
[PermissionID] [int] NOT NULL,
[AllowAccess] [bit] NOT NULL,
[RoleID] [int] NULL,
[UserID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}DesktopModulePermission] on {databaseOwner}[{objectQualifier}DesktopModulePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModulePermission] ADD CONSTRAINT [PK_{objectQualifier}DesktopModulePermission] PRIMARY KEY CLUSTERED  ([DesktopModulePermissionID])
GO
PRINT N'Creating index [IX_{objectQualifier}DesktopModulePermission_DesktopModules] on {databaseOwner}[{objectQualifier}DesktopModulePermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}DesktopModulePermission_DesktopModules] ON {databaseOwner}[{objectQualifier}DesktopModulePermission] ([PortalDesktopModuleID], [PermissionID], [RoleID], [UserID]) INCLUDE ([AllowAccess])
GO
PRINT N'Creating index [IX_{objectQualifier}DesktopModulePermission_Roles] on {databaseOwner}[{objectQualifier}DesktopModulePermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}DesktopModulePermission_Roles] ON {databaseOwner}[{objectQualifier}DesktopModulePermission] ([RoleID], [PortalDesktopModuleID], [PermissionID]) INCLUDE ([AllowAccess]) WHERE ([RoleID] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}DesktopModulePermission_Users] on {databaseOwner}[{objectQualifier}DesktopModulePermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}DesktopModulePermission_Users] ON {databaseOwner}[{objectQualifier}DesktopModulePermission] ([UserID], [PortalDesktopModuleID], [PermissionID]) INCLUDE ([AllowAccess]) WHERE ([UserID] IS NOT NULL)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_DesktopModulePermissions]'
GO
-- use new FK
CREATE VIEW {databaseOwner}[{objectQualifier}vw_DesktopModulePermissions]
AS
SELECT  PP.DesktopModulePermissionID,
        PP.PortalDesktopModuleID,
        P.PermissionID,
        PP.RoleID,
        R.RoleName,
        PP.AllowAccess,
        PP.UserID,
        U.Username,
        U.DisplayName,
        P.PermissionCode,
        P.ModuleDefID,
        P.PermissionKey,
        P.PermissionName,
        PP.CreatedByUserID,
        PP.CreatedOnDate,
        PP.LastModifiedByUserID,
        PP.LastModifiedOnDate
FROM        {databaseOwner}[{objectQualifier}DesktopModulePermission] AS PP
 INNER JOIN {databaseOwner}[{objectQualifier}Permission]              AS P  ON PP.PermissionID = P.PermissionID
 LEFT  JOIN {databaseOwner}[{objectQualifier}Roles]                   AS R  ON PP.RoleID = R.RoleID
 LEFT  JOIN {databaseOwner}[{objectQualifier}Users]                   AS U  ON PP.UserID = U.UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDesktopModulePermissionsByPortalDesktopModuleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDesktopModulePermissionsByPortalDesktopModuleID]
	@PortalDesktopModuleID int
AS
    SELECT *
    FROM {databaseOwner}{objectQualifier}vw_DesktopModulePermissions
	WHERE   PortalDesktopModuleID = @PortalDesktopModuleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_Messages]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Messaging_Messages]
(
[MessageID] [bigint] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NOT NULL,
[FromUserID] [int] NOT NULL,
[ToUserName] [nvarchar] (50) NULL,
[FromUserName] [nvarchar] (50) NULL,
[ToUserID] [int] NULL,
[ToRoleID] [int] NULL,
[Status] [tinyint] NOT NULL,
[Subject] [nvarchar] (max) NULL,
[Body] [nvarchar] (max) NULL,
[Date] [datetime] NOT NULL,
[Conversation] [uniqueidentifier] NOT NULL,
[ReplyTo] [bigint] NULL,
[AllowReply] [bit] NOT NULL,
[SkipPortal] [bit] NOT NULL,
[EmailSent] [bit] NOT NULL,
[EmailSentDate] [datetime] NULL,
[EmailSchedulerInstance] [uniqueidentifier] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Messaging_Messages] on {databaseOwner}[{objectQualifier}Messaging_Messages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Messaging_Messages] ADD CONSTRAINT [PK_{objectQualifier}Messaging_Messages] PRIMARY KEY CLUSTERED  ([MessageID])
GO
PRINT N'Creating index [IX_{objectQualifier}Messaging_Messages_FromUserID_Status] on {databaseOwner}[{objectQualifier}Messaging_Messages]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Messaging_Messages_FromUserID_Status] ON {databaseOwner}[{objectQualifier}Messaging_Messages] ([FromUserID], [Status], [Date] DESC)
GO
PRINT N'Creating index [IX_{objectQualifier}Messaging_Messages_ToUserID_Status_SkipPortal] on {databaseOwner}[{objectQualifier}Messaging_Messages]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Messaging_Messages_ToUserID_Status_SkipPortal] ON {databaseOwner}[{objectQualifier}Messaging_Messages] ([ToUserID], [Status], [SkipPortal], [Date] DESC)
GO
PRINT N'Creating index [IX_{objectQualifier}Messaging_Messages_EmailSent_EmailSchedulerInstance_Status] on {databaseOwner}[{objectQualifier}Messaging_Messages]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Messaging_Messages_EmailSent_EmailSchedulerInstance_Status] ON {databaseOwner}[{objectQualifier}Messaging_Messages] ([EmailSent], [EmailSchedulerInstance], [Status], [Date] DESC)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteLegacyMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteLegacyMessage]
    @MessageID int
AS
	DELETE FROM {databaseOwner}{objectQualifier}Messaging_Messages
	WHERE  [MessageID] = @MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPermission]
	@ModuleDefID		int,
	@PermissionCode		varchar(50),
	@PermissionKey		varchar(50),
	@PermissionName		varchar(50),
	@CreatedByUserID	int
AS

INSERT INTO {databaseOwner}{objectQualifier}Permission (
	[ModuleDefID],
	[PermissionCode],
	[PermissionKey],
	[PermissionName],
	[CreatedByUserID],
	[CreatedOnDate],
	[LastModifiedByUserID],
	[LastModifiedOnDate]
) VALUES (
	@ModuleDefID,
	@PermissionCode,
	@PermissionKey,
	@PermissionName,
	@CreatedByUserID,
	getdate(),
	@CreatedByUserID,
	getdate()
)

select SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserRoles]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UserRoles]
(
[UserRoleID] [int] NOT NULL IDENTITY(1, 1),
[UserID] [int] NOT NULL,
[RoleID] [int] NOT NULL,
[ExpiryDate] [datetime] NULL,
[IsTrialUsed] [bit] NULL,
[EffectiveDate] [datetime] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[Status] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}UserRoles_Status] DEFAULT ((1)),
[IsOwner] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}UserRoles_IsOwner] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UserRoles] on {databaseOwner}[{objectQualifier}UserRoles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRoles] ADD CONSTRAINT [PK_{objectQualifier}UserRoles] PRIMARY KEY CLUSTERED  ([UserRoleID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserRoles_RoleID_UserID] on {databaseOwner}[{objectQualifier}UserRoles]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}UserRoles_RoleID_UserID] ON {databaseOwner}[{objectQualifier}UserRoles] ([RoleID], [UserID]) INCLUDE ([CreatedByUserID], [CreatedOnDate], [EffectiveDate], [ExpiryDate], [IsOwner], [IsTrialUsed], [LastModifiedByUserID], [LastModifiedOnDate], [Status], [UserRoleID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserRoles_RoleUser] on {databaseOwner}[{objectQualifier}UserRoles]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}UserRoles_RoleUser] ON {databaseOwner}[{objectQualifier}UserRoles] ([RoleID], [UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserRoles_UserRole] on {databaseOwner}[{objectQualifier}UserRoles]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}UserRoles_UserRole] ON {databaseOwner}[{objectQualifier}UserRoles] ([UserID], [RoleID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FolderPermission]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}FolderPermission]
(
[FolderPermissionID] [int] NOT NULL IDENTITY(1, 1),
[FolderID] [int] NOT NULL,
[PermissionID] [int] NOT NULL,
[AllowAccess] [bit] NOT NULL,
[RoleID] [int] NULL,
[UserID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}FolderPermission] on {databaseOwner}[{objectQualifier}FolderPermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderPermission] ADD CONSTRAINT [PK_{objectQualifier}FolderPermission] PRIMARY KEY CLUSTERED  ([FolderPermissionID])
GO
PRINT N'Creating index [IX_{objectQualifier}FolderPermission_Modules] on {databaseOwner}[{objectQualifier}FolderPermission]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}FolderPermission_Modules] ON {databaseOwner}[{objectQualifier}FolderPermission] ([FolderID])
GO
PRINT N'Creating index [IX_{objectQualifier}FolderPermission_Folders] on {databaseOwner}[{objectQualifier}FolderPermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}FolderPermission_Folders] ON {databaseOwner}[{objectQualifier}FolderPermission] ([FolderID], [PermissionID], [RoleID], [UserID]) INCLUDE ([AllowAccess])
GO
PRINT N'Creating index [IX_{objectQualifier}FolderPermission_Roles] on {databaseOwner}[{objectQualifier}FolderPermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}FolderPermission_Roles] ON {databaseOwner}[{objectQualifier}FolderPermission] ([RoleID], [FolderID], [PermissionID]) INCLUDE ([AllowAccess]) WHERE ([RoleID] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}FolderPermission_Users] on {databaseOwner}[{objectQualifier}FolderPermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}FolderPermission_Users] ON {databaseOwner}[{objectQualifier}FolderPermission] ([UserID], [FolderID], [PermissionID]) INCLUDE ([AllowAccess]) WHERE ([UserID] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}FolderPermission_Permission] on {databaseOwner}[{objectQualifier}FolderPermission]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}FolderPermission_Permission] ON {databaseOwner}[{objectQualifier}FolderPermission] ([PermissionID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFoldersByPermissions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFoldersByPermissions] 
	@PortalID int,
	@Permissions nvarchar(300),
	@UserID int,
	@FolderID int,
	@FolderPath nvarchar(300)

AS
	DECLARE @IsSuperUser BIT
	DECLARE @Admin BIT
	DECLARE @Read INT
	DECLARE @Write INT
	DECLARE @Browse INT
	DECLARE @Add INT

	--Determine Admin or SuperUser
	IF @UserId IN (
		SELECT UserId 
		FROM {databaseOwner}[{objectQualifier}UserRoles] 
		WHERE RoleId IN (
			SELECT RoleId 
			FROM {databaseOwner}[{objectQualifier}Roles] 
			WHERE PortalId = @PortalId 
			AND RoleName = 'Administrators')) 
	BEGIN 
		SET @Admin = 1 
	END;
	
	SELECT @IsSuperUser = IsSuperUser 
	FROM {databaseOwner}[{objectQualifier}Users] 
	WHERE UserId = @UserId;

	--Retrieve Permission Ids
	IF @Permissions LIKE '%READ%' BEGIN SELECT TOP 1 @Read = PermissionID FROM {databaseOwner}[{objectQualifier}Permission] WHERE PermissionCode = 'SYSTEM_FOLDER' AND PermissionKey = 'READ' END;
	IF @Permissions LIKE '%WRITE%' BEGIN SELECT TOP 1 @Write = PermissionID FROM {databaseOwner}[{objectQualifier}Permission] WHERE PermissionCode = 'SYSTEM_FOLDER' AND PermissionKey = 'WRITE' END;
	IF @Permissions LIKE '%BROWSE%' BEGIN SELECT TOP 1 @Browse = PermissionID FROM {databaseOwner}[{objectQualifier}Permission] WHERE PermissionCode = 'SYSTEM_FOLDER' AND PermissionKey = 'BROWSE' END;
	IF @Permissions LIKE '%ADD%' BEGIN SELECT TOP 1 @Add = PermissionID FROM {databaseOwner}[{objectQualifier}Permission] WHERE PermissionCode = 'SYSTEM_FOLDER' AND PermissionKey = 'ADD' END;

	IF @PortalID IS NULL
		BEGIN
			SELECT DISTINCT F.*
			FROM {databaseOwner}[{objectQualifier}Folders] F
			WHERE F.PortalID IS NULL
				AND (F.FolderID = @FolderID OR @FolderID = -1)
				AND (F.FolderPath = @FolderPath OR @FolderPath = '')
		  
			 ORDER BY F.FolderPath
		END
	ELSE
		BEGIN
			CREATE TABLE #Skip_Folders(folderid INT PRIMARY KEY(folderid))
			INSERT INTO #Skip_Folders
				 SELECT DISTINCT folderid FROM {databaseOwner}[{objectQualifier}FolderPermission] FP
									JOIN {databaseOwner}[{objectQualifier}Permission] P ON FP.PermissionID = P.PermissionID
									WHERE
										((P.PermissionKey = 'WRITE' OR @IsSuperUser=1 OR @Admin=1) OR
										FP.PermissionID = CASE WHEN @Read > 0 THEN @Read END OR
										FP.PermissionID = CASE WHEN @Write > 0 THEN @Write END OR
										FP.PermissionID = CASE WHEN @Browse > 0 THEN @Browse END OR
										FP.PermissionID = CASE WHEN @Add > 0 THEN @Add END)
										AND FP.FolderID NOT IN (SELECT DISTINCT folderid FROM {databaseOwner}[{objectQualifier}FolderPermission] WHERE allowaccess=0 AND (userid=@UserId OR roleid=-1 OR roleid IN (SELECT roleid FROM {databaseOwner}[{objectQualifier}UserRoles] WHERE UserID=@UserId)))		

			SELECT DISTINCT F.*
			FROM {databaseOwner}[{objectQualifier}Folders] F
				JOIN {databaseOwner}[{objectQualifier}FolderPermission] FP ON F.FolderId = FP.FolderID
				JOIN {databaseOwner}[{objectQualifier}Permission] P ON FP.PermissionID = P.PermissionID
				JOIN #Skip_Folders sf ON sf.folderid=f.folderid 
			WHERE ((F.PortalID = @PortalID) OR (F.PortalID IS NULL AND @PortalID IS NULL))
				AND (F.FolderID = @FolderID OR @FolderID = -1)
				AND (F.FolderPath = @FolderPath OR @FolderPath = '')
				AND 
					((P.PermissionKey = 'WRITE' OR @IsSuperUser=1 OR @Admin=1) OR
						FP.PermissionID = CASE WHEN @Read > 0 THEN @Read END OR
						FP.PermissionID = CASE WHEN @Write > 0 THEN @Write END OR
						FP.PermissionID = CASE WHEN @Browse > 0 THEN @Browse END OR
						FP.PermissionID = CASE WHEN @Add > 0 THEN @Add END)
				AND FP.AllowAccess = 1
			 ORDER BY F.FolderPath

			 DROP TABLE #Skip_Folders
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Relationships]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Relationships]
(
[RelationshipID] [int] NOT NULL IDENTITY(1, 1),
[RelationshipTypeID] [int] NOT NULL,
[Name] [nvarchar] (50) NOT NULL,
[Description] [nvarchar] (500) NULL,
[PortalID] [int] NULL,
[UserID] [int] NULL,
[DefaultResponse] [int] NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}Relationships_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}Relationships_LastModifiedOnDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Relationships] on {databaseOwner}[{objectQualifier}Relationships]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Relationships] ADD CONSTRAINT [PK_{objectQualifier}Relationships] PRIMARY KEY CLUSTERED  ([RelationshipID])
GO
PRINT N'Creating index [IX_{objectQualifier}Relationships_UserID] on {databaseOwner}[{objectQualifier}Relationships]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Relationships_UserID] ON {databaseOwner}[{objectQualifier}Relationships] ([UserID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRelationship]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRelationship] @RelationshipID INT
AS 
    SELECT  RelationshipID,
            RelationshipTypeID,            
            Name,            
            Description,
            UserID,
            PortalID,
            DefaultResponse,
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}Relationships    
	WHERE RelationshipID = @RelationshipID
	ORDER BY RelationshipID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FolderMappings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}FolderMappings]
(
[FolderMappingID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[MappingName] [nvarchar] (50) NOT NULL,
[FolderProviderType] [nvarchar] (50) NOT NULL,
[Priority] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}FolderMappings] on {databaseOwner}[{objectQualifier}FolderMappings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderMappings] ADD CONSTRAINT [PK_{objectQualifier}FolderMappings] PRIMARY KEY CLUSTERED  ([FolderMappingID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}FolderMappings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderMappings] ADD CONSTRAINT [IX_{objectQualifier}FolderMappings] UNIQUE NONCLUSTERED  ([PortalID], [MappingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddDefaultFolderTypes]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddDefaultFolderTypes]
	@PortalID int
AS
BEGIN
	INSERT INTO {databaseOwner}[{objectQualifier}FolderMappings] (PortalID, MappingName, FolderProviderType, Priority)
	SELECT @PortalID, 'Standard', 'StandardFolderProvider', 1
	UNION ALL
	SELECT @PortalID, 'Secure', 'SecureFolderProvider', 2
	UNION ALL
	SELECT @PortalID, 'Database', 'DatabaseFolderProvider', 3
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchDeletedItems]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SearchDeletedItems]
(
[SearchDeletedItemsID] [int] NOT NULL IDENTITY(1, 1),
[DateCreated] [datetime] NOT NULL DEFAULT (getutcdate()),
[Document] [nvarchar] (max) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SearchDeletedItems] on {databaseOwner}[{objectQualifier}SearchDeletedItems]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SearchDeletedItems] ADD CONSTRAINT [PK_{objectQualifier}SearchDeletedItems] PRIMARY KEY CLUSTERED  ([SearchDeletedItemsID])
GO
PRINT N'Creating index [IX_{objectQualifier}SearchDeletedItems_DateCreated] on {databaseOwner}[{objectQualifier}SearchDeletedItems]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}SearchDeletedItems_DateCreated] ON {databaseOwner}[{objectQualifier}SearchDeletedItems] ([DateCreated])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchDeletedItems_Select]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SearchDeletedItems_Select]
    @CutoffTime	DATETIME
AS
BEGIN
	SELECT document
	FROM {databaseOwner}{objectQualifier}SearchDeletedItems
	WHERE [DateCreated] < @CutoffTime
	ORDER BY [DateCreated]
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SuperUserTabID]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}SuperUserTabID]
() 
	RETURNS Int
AS
BEGIN
    DECLARE @HostTabId Int = Null
    SELECT  TOP (1) @HostTabId = TabID
		FROM  {databaseOwner}{objectQualifier}Tabs
		WHERE (PortalID IS NULL) AND (ParentId IS NULL)
		ORDER BY TabID
    RETURN @HostTabId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_Portals]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_Portals]
AS
    SELECT
        P.PortalID,
        P.PortalGroupID,
        PL.PortalName,
		 Case when PL.LogoFile LIKE 'fileid=%' 
			then (SELECT IsNull(Folder, '') + [FileName] FROM {databaseOwner}[{objectQualifier}vw_Files]
			 WHERE fileid = CAST(SUBSTRING(PL.LogoFile, 8, 10) AS Int))
			 else Coalesce(PL.LogoFile,'')
			 end as LogoFile,
        PL.FooterText,
        P.ExpiryDate,
        P.UserRegistration,
        P.BannerAdvertising,
        P.AdministratorId,
        P.Currency,
        P.HostFee,
        P.HostSpace,
        P.PageQuota,
        P.UserQuota,
        P.AdministratorRoleId,
        P.RegisteredRoleId,
        PL.Description,
        PL.KeyWords,
         Case when PL.BackgroundFile LIKE 'fileid=%' 
			then (SELECT IsNull(Folder, '') + [FileName] FROM {databaseOwner}[{objectQualifier}vw_Files]
			 WHERE fileid = CAST(SUBSTRING(PL.BackgroundFile, 8, 10) AS Int))
			 else Coalesce(PL.BackgroundFile,'')
			 end as BackgroundFile
		,
        P.GUID,
        P.PaymentProcessor,
        P.ProcessorUserId,
        P.ProcessorPassword,
        P.SiteLogHistory,
        U.Email,
        P.DefaultLanguage,
        P.TimezoneOffset,
        PL.AdminTabId,
        P.HomeDirectory,
        PL.SplashTabId,
       PL.HomeTabId,
        PL.LoginTabId,
        PL.RegisterTabId,
        PL.UserTabId,
        PL.SearchTabId,
        PL.Custom404TabId,
        PL.Custom500TabId,
        {databaseOwner}{objectQualifier}SuperUserTabID() AS SuperTabId,
        P.CreatedByUserID,
        P.CreatedOnDate,
        P.LastModifiedByUserID,
        P.LastModifiedOnDate,
        PL.CultureCode
    FROM       {databaseOwner}[{objectQualifier}Portals]            AS P
    INNER JOIN {databaseOwner}[{objectQualifier}PortalLocalization] AS PL ON P.PortalID = PL.PortalID
    LEFT  JOIN {databaseOwner}[{objectQualifier}Users]              AS U  ON P.AdministratorId = U.UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_PortalsDefaultLanguage]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_PortalsDefaultLanguage]
AS
    SELECT * FROM {databaseOwner}[{objectQualifier}vw_Portals] WHERE CultureCode = DefaultLanguage
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePortalAlias]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}DeletePortalAlias]
@PortalAliasID int

as

DELETE FROM {databaseOwner}{objectQualifier}PortalAlias 
WHERE PortalAliasID = @PortalAliasID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes]
(
[SubscriptionTypeId] [int] NOT NULL IDENTITY(1, 1),
[SubscriptionName] [nvarchar] (50) NOT NULL,
[FriendlyName] [nvarchar] (50) NOT NULL,
[DesktopModuleId] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_SubscriptionTypes] on {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_SubscriptionTypes] PRIMARY KEY CLUSTERED  ([SubscriptionTypeId])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_SubscriptionTypes_SubscriptionName] on {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_SubscriptionTypes_SubscriptionName] ON {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes] ([SubscriptionName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_AddSubscriptionType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_AddSubscriptionType]
	@SubscriptionName NVARCHAR(50) ,
	@FriendlyName NVARCHAR(50) ,
	@DesktopModuleId INT
AS 
	INSERT  {databaseOwner}{objectQualifier}CoreMessaging_SubscriptionTypes
			( SubscriptionName ,
			  FriendlyName ,
			  DesktopModuleId
			)
	VALUES  ( @SubscriptionName ,
			  @FriendlyName ,
			  @DesktopModuleId 
			)
	SELECT  SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabSettings]
(
[TabID] [int] NOT NULL,
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (2000) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating index [IX_{objectQualifier}TabSettings_TabID_SettingName] on {databaseOwner}[{objectQualifier}TabSettings]'
GO
CREATE UNIQUE CLUSTERED INDEX [IX_{objectQualifier}TabSettings_TabID_SettingName] ON {databaseOwner}[{objectQualifier}TabSettings] ([TabID], [SettingName])
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabSettings] on {databaseOwner}[{objectQualifier}TabSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabSettings] ADD CONSTRAINT [PK_{objectQualifier}TabSettings] PRIMARY KEY NONCLUSTERED  ([TabID], [SettingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTabSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTabSetting]
	@TabID				INT,
	@SettingName		NVARCHAR(50),
	@SettingValue		NVARCHAR(2000),
	@CreatedByUserID	INT

AS

	INSERT INTO {databaseOwner}{objectQualifier}TabSettings ( 
		TabID,
		SettingName,
		SettingValue,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	) 
	VALUES ( 
		@TabId, 
		@SettingName, 
		@SettingValue,
		@CreatedByUserID,
		GETDATE(),
		@CreatedByUserID,
		GETDATE()
	)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateLanguage]

	@LanguageID			    int,
	@CultureCode		    nvarchar(50),
	@CultureName            nvarchar(200),
	@FallbackCulture        nvarchar(50),
	@LastModifiedByUserID	int

AS
	UPDATE {databaseOwner}{objectQualifier}Languages
		SET
			CultureCode = @CultureCode,
			CultureName = @CultureName,
			FallbackCulture = @FallbackCulture,
			[LastModifiedByUserID] = @LastModifiedByUserID,	
			[LastModifiedOnDate] = getdate()
	WHERE LanguageID = @LanguageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalInfo]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalInfo]
	@PortalID				INT,
	@PortalGroupID			INT,
	@PortalName				NVARCHAR(128),
	@LogoFile				NVARCHAR(50),
	@FooterText				NVARCHAR(100),
	@ExpiryDate				DATETIME,
	@UserRegistration		INT,
	@BannerAdvertising		INT,
	@Currency				CHAR(3),
	@AdministratorId		INT,
	@HostFee				MONEY,
	@HostSpace				INT,
	@PageQuota				INT,
	@UserQuota				INT,
	@PaymentProcessor		NVARCHAR(50),
	@ProcessorUserId		NVARCHAR(50),
	@ProcessorPassword		NVARCHAR(50),
	@Description			NVARCHAR(500),
	@KeyWords				NVARCHAR(500),
	@BackgroundFile			NVARCHAR(50),
	@SiteLogHistory			INT,
	@SplashTabId			INT,
	@HomeTabId				INT,
	@LoginTabId				INT,
	@RegisterTabId			INT,
	@UserTabId				INT,
	@SearchTabId			INT,
    @Custom404TabId			INT,
    @Custom500TabId			INT,
	@DefaultLanguage		NVARCHAR(10),
	@HomeDirectory			VARCHAR(100),
	@LastModifiedByUserID	INT,
	@CultureCode			NVARCHAR(50)

AS

	UPDATE {databaseOwner}{objectQualifier}Portals
		SET    
		   PortalGroupID		= @PortalGroupID,
		   ExpiryDate			= @ExpiryDate,
		   UserRegistration		= @UserRegistration,
		   BannerAdvertising	= @BannerAdvertising,
		   Currency				= @Currency,
		   AdministratorId		= @AdministratorId,
		   HostFee				= @HostFee,
		   HostSpace			= @HostSpace,
		   PageQuota			= @PageQuota,
		   UserQuota			= @UserQuota,
		   PaymentProcessor		= @PaymentProcessor,
		   ProcessorUserId		= @ProcessorUserId,
		   ProcessorPassword	= @ProcessorPassword,
		   SiteLogHistory		= @SiteLogHistory,
		   DefaultLanguage		= @DefaultLanguage,
		   HomeDirectory		= @HomeDirectory,
		   LastModifiedByUserID = @LastModifiedByUserID,
		   LastModifiedOnDate	= GETDATE()
	WHERE  PortalId = @PortalID

    IF EXISTS (SELECT * FROM {databaseOwner}{objectQualifier}PortalLocalization WHERE PortalId = @PortalID AND CultureCode = @CultureCode)
	BEGIN 
		UPDATE {databaseOwner}{objectQualifier}PortalLocalization
			SET
				PortalName				= @PortalName,
				LogoFile				= @LogoFile,
				FooterText				= @FooterText,
				Description				= @Description,
				KeyWords				= @KeyWords,
				BackgroundFile			= @BackgroundFile,
				HomeTabId				= @HomeTabId,
				LoginTabId				= @LoginTabId,
				RegisterTabId			= @RegisterTabId,
				UserTabId				= @UserTabId,
				SplashTabId				= @SplashTabId,
				SearchTabId				= @SearchTabId,
                Custom404TabId			= @Custom404TabId,
                Custom500TabId			= @Custom500TabId,
				LastModifiedByUserID	= @LastModifiedByUserID,
				LastModifiedOnDate		= GETDATE()
		WHERE	PortalId = @PortalID 
			AND CultureCode = @CultureCode
	END 
ELSE
	BEGIN 
		DECLARE @AdminTabId int
		SET @AdminTabId = (SELECT AdminTabId 
								FROM {databaseOwner}{objectQualifier}PortalLocalization 
								WHERE PortalID = @PortalID AND CultureCode='en-US')

		INSERT INTO {databaseOwner}{objectQualifier}PortalLocalization (
			[PortalID],
			[CultureCode],
			[PortalName],
			[LogoFile],
			[FooterText],
			[Description],
			[KeyWords],
			[BackgroundFile],
			[HomeTabId],
			[LoginTabId],
			[UserTabId],
			[AdminTabId],
			[SplashTabId],
			[SearchTabId],
            [Custom404TabId],
            [Custom500TabId],
			[CreatedByUserID],
			[CreatedOnDate],
			[LastModifiedByUserID],
			[LastModifiedOnDate]
		)
		VALUES (
			@PortalID,
			@CultureCode,
			@PortalName,
			@LogoFile, 
			@FooterText,
			@Description,
			@KeyWords,
			@BackgroundFile,
			@HomeTabId ,
			@LoginTabId ,
			@UserTabId,
			@AdminTabid,
			@SplashTabId,
			@SearchTabId,
            @Custom404TabId,
            @Custom500TabId,
			-1,
			GETDATE(),
			-1,
			GETDATE()
		)
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetSubscriptionTypes]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetSubscriptionTypes]
AS 
	SELECT  *
	FROM    {databaseOwner}{objectQualifier}CoreMessaging_SubscriptionTypes
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountLegacyMessages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountLegacyMessages]    
AS
	--Return total records
	SELECT COUNT(*) AS TotalRecords
	FROM {databaseOwner}[{objectQualifier}Messaging_Messages]
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageThread]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageThread]
    @ConversationID int,
	@UserID int,
	@AfterMessageID int,
	@NumberOfRecords int,
	@SortField nvarchar(25) = 'CreatedOnDate',
	@SortAscending bit = 0
AS
BEGIN
	--Cannot return thread if user was not a recipient
	IF NOT EXISTS (SELECT MR.RecipientID FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] M ON MR.MessageID = M.MessageID WHERE MR.UserID = @UserID AND M.NotificationTypeID IS NULL) BEGIN
		SELECT 0
		RETURN
	END

	;WITH inboxItems  AS
	(
		SELECT  DISTINCT [RecipientID], [Subject], [Body], [SenderUserID],
				[Read], [Archived], [UserID], [To], [From], [ReplyAllAllowed], [ConversationID],
				m.[MessageID],
				m.[CreatedByUserID], m.[CreatedOnDate],
				m.[LastModifiedByUserID], m.[LastModifiedOnDate],
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments WHERE MessageID = mr.MessageID) AS AttachmentCount,
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages WHERE ConversationID = m.ConversationID) AND UserID = @UserID AND [READ] = 0) AS NewThreadCount,
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages WHERE ConversationID = m.ConversationID) AND UserID = @UserID) AS ThreadCount,
				ROW_NUMBER() OVER(ORDER BY
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 1 THEN m.[CreatedOnDate] END ASC,
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 0 THEN m.[CreatedOnDate] END DESC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 1 THEN [From] END ASC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 0 THEN [From] END DESC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 1 THEN [Subject] END ASC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 0 THEN [Subject] END DESC
					) AS RowNumber
		FROM	{databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients AS mr
		INNER JOIN {databaseOwner}{objectQualifier}CoreMessaging_Messages AS m ON mr.MessageID = m.MessageID
		WHERE mr.UserID = @UserID
		AND ConversationID = @ConversationID
	)
	SELECT * FROM inboxItems
	WHERE (@AfterMessageID > 0 AND RowNumber BETWEEN (SELECT RowNumber + 1 FROM inboxItems WHERE [MessageID] = @AfterMessageID) AND (SELECT RowNumber + @NumberOfRecords FROM inboxItems WHERE [MessageID] = @AfterMessageID)) OR
	(@AfterMessageID = -1 AND RowNumber BETWEEN 1 AND @NumberOfRecords)
	ORDER BY RowNumber ASC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalSetup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalSetup]
	@PortalId				INT,
	@AdministratorId		INT,
	@AdministratorRoleId	INT,
	@RegisteredRoleId		INT,
	@SplashTabId			INT,
	@HomeTabId				INT,
	@LoginTabId				INT,
	@RegisterTabId			INT,
	@UserTabId				INT,
	@SearchTabId            INT,
    @Custom404TabId         INT,
    @Custom500TabId         INT,
	@AdminTabId				INT,
	@CultureCode			NVARCHAR(50)

AS
	UPDATE {databaseOwner}{objectQualifier}Portals
		SET    
			AdministratorId = @AdministratorId, 
			AdministratorRoleId = @AdministratorRoleId, 
			RegisteredRoleId = @RegisteredRoleId
	WHERE  PortalId = @PortalId

	UPDATE {databaseOwner}{objectQualifier}PortalLocalization
		SET 
			HomeTabId = @HomeTabId,
			LoginTabId = @LoginTabId,
			UserTabId = @UserTabId,
			RegisterTabId = @RegisterTabId,
			AdminTabId = @AdminTabId,
			SplashTabId = @SplashTabId,
			SearchTabId = @SearchTabId,
            Custom404TabId = @Custom404TabId,
            Custom500TabId = @Custom500TabId
      WHERE portalID = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFolderVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFolderVersion]
	@FolderID		int,
    @VersionGuid	uniqueidentifier
AS
    UPDATE {databaseOwner}{objectQualifier}Folders
        SET    VersionGuid = @VersionGuid
    WHERE  FolderID = @FolderID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteSubscriptionType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteSubscriptionType]
	@SubscriptionTypeId int
AS
BEGIN
	DELETE FROM {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes] WHERE [SubscriptionTypeId] = @SubscriptionTypeId

	IF @@ROWCOUNT <> 0
		SELECT 0 AS [ResultStatus]
	ELSE
		SELECT -1 AS [ResultStatus]
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentTypes]
(
[ContentTypeID] [int] NOT NULL IDENTITY(1, 1),
[ContentType] [nvarchar] (100) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentTypes] on {databaseOwner}[{objectQualifier}ContentTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentTypes] ADD CONSTRAINT [PK_{objectQualifier}ContentTypes] PRIMARY KEY CLUSTERED  ([ContentTypeID])
GO
PRINT N'Creating index [IX_{objectQualifier}ContentTypes_ContentType] on {databaseOwner}[{objectQualifier}ContentTypes]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}ContentTypes_ContentType] ON {databaseOwner}[{objectQualifier}ContentTypes] ([ContentType])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddContentType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddContentType] 
	@ContentType	nvarchar(250)
AS
	INSERT INTO {databaseOwner}{objectQualifier}ContentTypes (
		ContentType
	)

	VALUES (
		@ContentType
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabModuleVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabModuleVersion]
    @TabModuleID	int,
    @VersionGuid	uniqueidentifier
AS
    UPDATE {databaseOwner}{objectQualifier}TabModules
        SET    VersionGuid = @VersionGuid
    WHERE  TabModuleID = @TabModuleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ScheduleHistory]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ScheduleHistory]
(
[ScheduleHistoryID] [int] NOT NULL IDENTITY(1, 1),
[ScheduleID] [int] NOT NULL,
[StartDate] [datetime] NOT NULL,
[EndDate] [datetime] NULL,
[Succeeded] [bit] NULL,
[LogNotes] [ntext] NULL,
[NextStart] [datetime] NULL,
[Server] [nvarchar] (150) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ScheduleHistory] on {databaseOwner}[{objectQualifier}ScheduleHistory]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ScheduleHistory] ADD CONSTRAINT [PK_{objectQualifier}ScheduleHistory] PRIMARY KEY CLUSTERED  ([ScheduleHistoryID])
GO
PRINT N'Creating index [IX_{objectQualifier}ScheduleHistory_NextStart] on {databaseOwner}[{objectQualifier}ScheduleHistory]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ScheduleHistory_NextStart] ON {databaseOwner}[{objectQualifier}ScheduleHistory] ([ScheduleID], [NextStart] DESC)
GO
PRINT N'Creating index [IX_{objectQualifier}ScheduleHistory_StartDate] on {databaseOwner}[{objectQualifier}ScheduleHistory]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ScheduleHistory_StartDate] ON {databaseOwner}[{objectQualifier}ScheduleHistory] ([ScheduleID], [StartDate] DESC)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateScheduleHistory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateScheduleHistory]
@ScheduleHistoryID int,
@EndDate datetime,
@Succeeded bit,
@LogNotes ntext,
@NextStart datetime
AS
UPDATE {databaseOwner}{objectQualifier}ScheduleHistory
SET	EndDate = @EndDate,
	Succeeded = @Succeeded,
	LogNotes = @LogNotes,
	NextStart = @NextStart
WHERE ScheduleHistoryID = @ScheduleHistoryID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPropertyDefinitionByName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPropertyDefinitionByName]
	@PortalID	int,
	@Name		nvarchar(50)

AS
SELECT	*
	FROM	{databaseOwner}{objectQualifier}ProfilePropertyDefinition
	WHERE  (PortalId = @PortalID OR (PortalId IS NULL AND @PortalID IS NULL))
		AND PropertyName = @Name
	ORDER BY ViewOrder
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comments]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Journal_Comments]
(
[CommentId] [int] NOT NULL IDENTITY(1, 1),
[JournalId] [int] NOT NULL,
[UserId] [int] NOT NULL,
[Comment] [nvarchar] (2000) NULL,
[DateCreated] [datetime] NOT NULL,
[DateUpdated] [datetime] NOT NULL,
[CommentXML] [xml] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Journal_Comments] on {databaseOwner}[{objectQualifier}Journal_Comments]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Comments] ADD CONSTRAINT [PK_{objectQualifier}Journal_Comments] PRIMARY KEY CLUSTERED  ([CommentId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comment_Like]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comment_Like]
		@JournalId int,
		@CommentId int,
		@UserId int,
		@UserName nvarchar(50)
	AS
	DECLARE @cxml xml
	SET @cxml = (SELECT CommentXML FROM {databaseOwner}{objectQualifier}Journal_Comments WHERE CommentId = @CommentId AND JournalId = @JournalId)
	IF @cxml IS NULL OR @cxml.exist('/root') = 0
		BEGIN
		DECLARE @x xml
			SET @x = '<root></root>';
			UPDATE {databaseOwner}{objectQualifier}Journal_Comments
				SET CommentXML = @x
				WHERE JournalId = @JournalId AND CommentId = @CommentId
		END
	IF EXISTS(SELECT CommentId
				FROM {databaseOwner}{objectQualifier}Journal_Comments
				WHERE JournalId = @JournalId AND CommentId = @CommentId
				AND CommentXML.exist('/root/likes/u[@uid=sql:variable("@userid")]') = 1)
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}Journal_Comments
				SET CommentXML.modify('delete (/root/likes/u[@uid=sql:variable("@UserId")])')
				WHERE JournalId = @JournalId AND CommentId = @CommentId
				AND CommentXML.exist('/root/likes/u[@uid=sql:variable("@UserId")]') = 1
		END
	ELSE
		BEGIN
			BEGIN
				IF NOT EXISTS(SELECT CommentId FROM {databaseOwner}{objectQualifier}Journal_Comments
								WHERE JournalId = @JournalId AND CommentId = @CommentID
								AND CommentXML.exist('/root/likes') = 1)
					BEGIN
						UPDATE {databaseOwner}{objectQualifier}Journal_Comments
						SET CommentXML.modify('insert <likes /> as last into (/root)[1]') 
						WHERE JournalId = @JournalId AND CommentId = @CommentId AND CommentXML.exist('/root') = 1
					END
			END
			BEGIN
				UPDATE {databaseOwner}{objectQualifier}Journal_Comments
				SET CommentXML.modify('insert <u uid="{xs:string(sql:variable("@UserId"))}" un="{xs:string(sql:variable("@UserName"))}" /> as last into (/root/likes)[1]')
				WHERE JournalId = @JournalId AND CommentId = @CommentId AND CommentXML.exist('/root/likes') = 1
			END
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions]
(
[SubscriptionId] [int] NOT NULL IDENTITY(1, 1),
[UserId] [int] NOT NULL,
[PortalId] [int] NULL,
[SubscriptionTypeId] [int] NOT NULL,
[ObjectKey] [nvarchar] (255) NULL,
[ObjectData] [nvarchar] (max) NULL,
[Description] [nvarchar] (255) NOT NULL,
[CreatedOnDate] [datetime] NOT NULL,
[ModuleId] [int] NULL,
[TabId] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_Subscriptions] on {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_Subscriptions] PRIMARY KEY CLUSTERED  ([SubscriptionId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteSubscription]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteSubscription]
	@SubscriptionId int
AS 
BEGIN
	DELETE FROM {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions] WHERE [SubscriptionId] = @SubscriptionId

	IF @@ROWCOUNT <> 0
		SELECT 0 AS [ResultStatus]
	ELSE
		SELECT -1 AS [ResultStatus]
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPortalAlias]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPortalAlias]
	@PortalID 			int,
	@HTTPAlias 			nvarchar(200),
	@CultureCode		nvarchar(10),
	@Skin				nvarchar(100),
	@BrowserType		nvarchar(10),
	@IsPrimary			bit,
	@CreatedByUserID	int

AS

	IF @IsPrimary = 1
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}PortalAlias
				SET IsPrimary = 0
				WHERE (CultureCode = @CultureCode OR (CultureCode IS NULL AND @CultureCode IS NULL))
					AND (BrowserType = @BrowserType OR (BrowserType IS NULL AND @BrowserType IS NULL))
					AND (PortalID = @PortalID)
		END

	INSERT INTO {databaseOwner}{objectQualifier}PortalAlias (
		PortalID, 
		HTTPAlias,
		CultureCode,
		BrowserTYpe,
		Skin,
		IsPrimary,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	)
	VALUES (
		@PortalID, 
		@HTTPAlias,
		@CultureCode,
		@BrowserTYpe,
		@Skin,
		@IsPrimary,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	 )

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentItems_Tags]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentItems_Tags]
(
[ContentItemTagID] [int] NOT NULL IDENTITY(1, 1),
[ContentItemID] [int] NOT NULL,
[TermID] [int] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentItems_Tags] on {databaseOwner}[{objectQualifier}ContentItems_Tags]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems_Tags] ADD CONSTRAINT [PK_{objectQualifier}ContentItems_Tags] PRIMARY KEY CLUSTERED  ([ContentItemTagID])
GO
PRINT N'Creating index [IX_{objectQualifier}ContentItems_Tags] on {databaseOwner}[{objectQualifier}ContentItems_Tags]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}ContentItems_Tags] ON {databaseOwner}[{objectQualifier}ContentItems_Tags] ([ContentItemID], [TermID])
GO
PRINT N'Creating index [IX_{objectQualifier}ContentItems_Tags_TermID] on {databaseOwner}[{objectQualifier}ContentItems_Tags]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ContentItems_Tags_TermID] ON {databaseOwner}[{objectQualifier}ContentItems_Tags] ([TermID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RemoveTermsFromContent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}RemoveTermsFromContent] 
	@ContentItemID	int
AS
	DELETE {databaseOwner}{objectQualifier}ContentItems_Tags 
	WHERE ContentItemID = @ContentItemID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRelationshipsByUserID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRelationshipsByUserID] @UserID INT
AS 
    SELECT  RelationshipID,
			RelationshipTypeID,            
            Name,            
            Description,
			UserID,
			PortalID,
			DefaultResponse,
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}Relationships    
	WHERE UserID = @UserID
	ORDER BY RelationshipID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUnIndexedContentItems]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUnIndexedContentItems] 
AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}ContentItems
	WHERE Indexed = 0
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalAlias]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalAlias]
	@PortalAliasID		int,
	@PortalID 			int,
	@HTTPAlias 			nvarchar(200),
	@CultureCode		nvarchar(10),
	@Skin				nvarchar(100),
	@BrowserType		nvarchar(10),
	@IsPrimary			bit,
	@LastModifiedByUserID	int

AS

	IF @IsPrimary = 1
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}PortalAlias
				SET IsPrimary = 0
				WHERE (CultureCode = @CultureCode OR (CultureCode IS NULL AND @CultureCode IS NULL))
					AND (BrowserType = @BrowserType OR (BrowserType IS NULL AND @BrowserType IS NULL))
					AND (PortalID = @PortalID)
		END

	UPDATE {databaseOwner}{objectQualifier}PortalAlias
		SET 
			HTTPAlias = @HTTPAlias,
			CultureCode = @CultureCode,
			Skin = @Skin,
			BrowserType = @BrowserType,
			IsPrimary = @IsPrimary,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
		WHERE PortalID = @PortalID
		AND	  PortalAliasID = @PortalAliasID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateListSortOrder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateListSortOrder]
(
	@EntryID	int, 
	@MoveUp		bit
)
AS
	DECLARE @EntryListName nvarchar(50)
	DECLARE @ParentID int
	DECLARE @CurrentSortValue int
	DECLARE @ReplaceSortValue int
	-- Get the current sort order
	SELECT @CurrentSortValue = [SortOrder], @EntryListName = [ListName], @ParentID = [ParentID] 
		FROM {databaseOwner}{objectQualifier}Lists WITH (nolock) 
		WHERE [EntryID] = @EntryID
	-- Move the item up or down?
	IF (@MoveUp = 1)
	  BEGIN
		IF (@CurrentSortValue != 1) -- we rearrange sort order only if list enable sort order - sortorder >= 1
		  BEGIN
			SET @ReplaceSortValue = @CurrentSortValue - 1
			UPDATE {databaseOwner}{objectQualifier}Lists 
				SET [SortOrder] = @CurrentSortValue 
				WHERE [SortOrder] = @ReplaceSortValue And [ListName] = @EntryListName And [ParentID] = @ParentID
			UPDATE {databaseOwner}{objectQualifier}Lists 
				SET [SortOrder] = @ReplaceSortValue 
				WHERE [EntryID] = @EntryID
		  END
	  END
	ELSE
	  BEGIN
		IF (@CurrentSortValue < (SELECT MAX([SortOrder]) FROM {databaseOwner}{objectQualifier}Lists))
		BEGIN
		  SET @ReplaceSortValue = @CurrentSortValue + 1
		  UPDATE {databaseOwner}{objectQualifier}Lists 
			SET [SortOrder] = @CurrentSortValue 
			WHERE SortOrder = @ReplaceSortValue And [ListName] = @EntryListName  And [ParentID] = @ParentID
		  UPDATE {databaseOwner}{objectQualifier}Lists 
			SET [SortOrder] = @ReplaceSortValue 
			WHERE EntryID = @EntryID
		END
	  END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comment_Delete]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comment_Delete]
@JournalId int,
@CommentId int
AS
DELETE FROM {databaseOwner}[{objectQualifier}Journal_Comments] 
	WHERE 
		(JournalId = @JournalId AND CommentId = @CommentId)
		OR
		(JournalId = @JournalId AND CommentId = -1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserAuthentication]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UserAuthentication]
(
[UserAuthenticationID] [int] NOT NULL IDENTITY(1, 1),
[UserID] [int] NOT NULL,
[AuthenticationType] [nvarchar] (100) NOT NULL,
[AuthenticationToken] [nvarchar] (1000) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UserAuthentication] on {databaseOwner}[{objectQualifier}UserAuthentication]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserAuthentication] ADD CONSTRAINT [PK_{objectQualifier}UserAuthentication] PRIMARY KEY CLUSTERED  ([UserAuthenticationID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserAuthentication] on {databaseOwner}[{objectQualifier}UserAuthentication]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}UserAuthentication] ON {databaseOwner}[{objectQualifier}UserAuthentication] ([UserID], [AuthenticationType])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddUserAuthentication]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddUserAuthentication]
	@UserID					int,
	@AuthenticationType     nvarchar(100),
	@AuthenticationToken    nvarchar(1000),
	@CreatedByUserID	int

AS
	INSERT INTO {databaseOwner}{objectQualifier}UserAuthentication (
		UserID,
		AuthenticationType,
		AuthenticationToken,
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]

	)
	values (
		@UserID,
		@AuthenticationType,
		@AuthenticationToken,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()

	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddFileVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddFileVersion] 
	@FileId					int,
	@UniqueId				uniqueidentifier,
	@VersionGuid			uniqueidentifier,
	@FileName				nvarchar(246),
	@Extension				nvarchar(100),
	@Size					int,
	@Width					int,
	@Height					int,
	@ContentType			nvarchar(200),
	@Folder					nvarchar(246),
	@FolderID				int,
	@UserID					int,
	@Hash					varchar(40),
	@LastModificationTime	datetime, 
	@Title					nvarchar(256),
	@EnablePublishPeriod	bit,
	@StartDate				datetime,
	@EndDate				datetime,
	@ContentItemID			int,
	@IsPublished			bit,
	@Content				image = NULL
AS
BEGIN

	DECLARE @Version INT

	--	Calculate the new version = Max(Files.PublishedVersion, FileVersions.Versions) + 1
	SELECT @Version = MAX([Version]) + 1
	FROM (SELECT [Version]
			FROM {databaseOwner}[{objectQualifier}FileVersions]
			WHERE FileId = @FileId
			UNION
			SELECT PublishedVersion [Version]
			FROM {databaseOwner}{objectQualifier}Files
			WHERE FileId = @FileId) v

	IF  @IsPublished = 1
		BEGIN
			INSERT {databaseOwner}[{objectQualifier}FileVersions]
						([FileId]
						,[Version]
						,[FileName]
						,[Extension]
						,[Size]
						,[Width]
						,[Height]
						,[ContentType]
						,[Content]
						,[CreatedByUserID]
						,[CreatedOnDate]
						,[LastModifiedByUserID]
						,[LastModifiedOnDate]
						,[SHA1Hash])
			SELECT		[FileId]
						,[PublishedVersion]  [Version]				
						,CONVERT(nvarchar, [FileId]) + '_' + CONVERT(nvarchar, [PublishedVersion]) +'.v.resources' 
						,[Extension]
						,[Size]
						,[Width]
						,[Height]
						,[ContentType]
						,[Content]
						,[CreatedByUserID]
						,[CreatedOnDate]
						,[LastModifiedByUserID]
						,[LastModifiedOnDate]
						,[SHA1Hash]					
			FROM {objectQualifier}Files
			WHERE FileId = @FileId

			-- Change PublishedVersion
			UPDATE {databaseOwner}[{objectQualifier}Files]
			SET	 [PublishedVersion] = @Version
			WHERE FileId = @FileId
		END
	ELSE
		BEGIN
			INSERT {databaseOwner}[{objectQualifier}FileVersions]
							([FileId]
							,[Version]
							,[FileName]
							,[Extension]
							,[Size]
							,[Width]
							,[Height]
							,[ContentType]
							,[Content]
							,[CreatedByUserID]
							,[CreatedOnDate]
							,[LastModifiedByUserID]
							,[LastModifiedOnDate]
							,[SHA1Hash])
			VALUES (@FileId
					,@Version
					,CONVERT(nvarchar, @FileId) + '_' + CONVERT(nvarchar, @Version) +'.v.resources'
					,@Extension
					,@Size
					,@Width
					,@Height
					,@ContentType
					,@Content
					,@UserID
					,GETDATE()
					,@UserID
					,GETDATE()
					,@Hash)
		END

	SELECT @Version
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_ConvertLegacyMessages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_ConvertLegacyMessages]    
	@PageIndex       int,
	@PageSize        int
AS

-- Set the page bounds
DECLARE @PageLowerBound INT, @PageUpperBound INT;

SET @PageLowerBound =  (@PageIndex * @PageSize) + 1
SET @PageUpperBound =  (@PageIndex * @PageSize) + @PageSize

	DECLARE @MessageID bigint	
	DECLARE @PortalID INT
	DECLARE @FromUserName nvarchar(50)
	DECLARE @FromUserID INT
	DECLARE @ToUserName nvarchar(50)
	DECLARE @ToUserID int
	DECLARE @Status tinyint
	DECLARE @Subject nvarchar(max)
	DECLARE @Body nvarchar(max)
	DECLARE @Date datetime
	DECLARE @EmailSent bit
	DECLARE @EmailSentDate datetime
	DECLARE @EmailSchedulerInstance UNIQUEIDENTIFIER
	DECLARE @RowNumber INT
	
	DECLARE @NewMessageID int	
	DECLARE @Counter int		

	DECLARE MessageList cursor FAST_FORWARD for

	WITH messageItems  AS
	(
		SELECT  [MessageID], [PortalID],[FromUserName],[FromUserID], [ToUserName], [ToUserID], [Status], [Subject], [Body], [Date], [EmailSent], [EmailSentDate], [EmailSchedulerInstance] 
				,ROW_NUMBER() OVER(ORDER BY MessageID ASC) AS RowNumber
		FROM	{databaseOwner}[{objectQualifier}Messaging_Messages]
	)
	
	SELECT * from messageItems where RowNumber BETWEEN @PageLowerBound AND @PageUpperBound
	ORDER BY RowNumber ASC
	OPEN MessageList
	FETCH NEXT FROM MessageList 
		INTO @MessageID, @PortalID, @FromUserName, @FromUserID, @ToUserName, @ToUserID, @Status, @Subject, @Body, @Date, @EmailSent, @EmailSentDate, @EmailSchedulerInstance, @RowNumber 

	WHILE @@FETCH_STATUS = 0
	BEGIN
			--Create SocialMessage Record
            INSERT {databaseOwner}[{objectQualifier}CoreMessaging_Messages](                    
  					[PortalID],
					[To],
					[From],					
					[Subject],
					[Body],
					[ConversationID],
					[ReplyAllAllowed],
					[SenderUserID],
                    [CreatedByUserID],
                    [CreatedOnDate],
                    [LastModifiedByUserID],
                    [LastModifiedOnDate]			        
                    )
            VALUES  (       
					@PortalID,
					@ToUserName,
					@FromUserName,
					@Subject,
					@Body,
					NULL,
					1, --ReplyAllAllowed,
					@FromUserID,
                    @FromUserID , -- CreatedBy - int
					dateadd(second, (-1 * datediff(second, getutcdate(), getdate())), @Date), -- CreatedOn - utc datetime
                    @FromUserID , -- LastModifiedBy - int
                    GETDATE() -- LastModifiedOn - datetime			        
                    )
            -- update conversation id                       
            SELECT  @NewMessageID = SCOPE_IDENTITY()
			UPDATE  {databaseOwner}[{objectQualifier}CoreMessaging_Messages] SET [ConversationID] = @NewMessageID WHERE [MessageID] = @NewMessageID 															
			
			--Create SocialRecipient Record for recipient and sender. 2 records total
			Set @Counter = 0 
			
			--No need to create two records if message sent to self	
			IF @ToUserID = @FromUserID BEGIN Set @Counter = 1 END
					
			WHILE @Counter < 2
			BEGIN
				SET @Counter = @Counter + 1
			
				INSERT {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients](
						[MessageID],
						[UserID],
						[Read],
						[Archived],
						[CreatedByUserID],
						[CreatedOnDate],
						[LastModifiedByUserID],
						[LastModifiedOnDate],
						[EmailSent],
						[EmailSentDate],
						[EmailSchedulerInstance]                    
						)
				VALUES  (
						@NewMessageID,
						CASE @Counter
							WHEN 1 THEN @ToUserID 
							ELSE @FromUserID 
						END,												
						CASE @Status
							WHEN 1 THEN 0 --Status 1 means Unread, 2 means Read, 3 means Deleted
							ELSE 1
						END,
						CASE @Status
							WHEN 3 THEN 1 --Status 1 means Unread, 2 means Read, 3 means Deleted
							ELSE 0
						END,
						@FromUserID , -- CreatedBy - int
						@Date , -- CreatedOn - datetime
						@FromUserID , -- LastModifiedBy - int
						@Date, -- LastModifiedOn - datetime
						@EmailSent,
						@EmailSentDate,
						@EmailSchedulerInstance
						)			
			END
		
		--Delete the Legacy record
		DELETE FROM {databaseOwner}[{objectQualifier}Messaging_Messages] WHERE MessageID = @MessageID
		
		FETCH NEXT FROM MessageList 
			INTO @MessageID,@PortalID, @FromUserName, @FromUserID, @ToUserName, @ToUserID, @Status, @Subject, @Body, @Date, @EmailSent, @EmailSentDate, @EmailSchedulerInstance, @RowNumber 
	END
	CLOSE MessageList
	DEALLOCATE MessageList
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comment_List]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comment_List]
@JournalId int
AS
SELECT jc.*, u.* FROM {databaseOwner}[{objectQualifier}Journal_Comments] as jc 
	INNER JOIN {databaseOwner}[{objectQualifier}Users] as u ON jc.UserId = u.UserId
WHERE jc.JournalId = @JournalId
ORDER BY jc.CommentId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserByAuthToken]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserByAuthToken]

	@PortalId	int,
	@UserToken	nvarchar(1000),
	@AuthType	nvarchar(100)

AS
	SELECT u.* 
		FROM {databaseOwner}{objectQualifier}vw_Users u
			INNER JOIN {databaseOwner}{objectQualifier}UserAuthentication ua ON u.UserID = ua.UserID
	WHERE  ua.AuthenticationToken = @UserToken
		AND ua.AuthenticationType = @AuthType
		AND    (PortalId = @PortalId OR IsSuperUser = 1 OR @PortalId is null)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SkinPackages]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SkinPackages]
(
[SkinPackageID] [int] NOT NULL IDENTITY(1, 1),
[PackageID] [int] NOT NULL,
[PortalID] [int] NULL,
[SkinName] [nvarchar] (50) NOT NULL,
[SkinType] [nvarchar] (20) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SkinPackages] on {databaseOwner}[{objectQualifier}SkinPackages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SkinPackages] ADD CONSTRAINT [PK_{objectQualifier}SkinPackages] PRIMARY KEY CLUSTERED  ([SkinPackageID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSkinPackageByPackageID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSkinPackageByPackageID]
	@PackageID int	
AS
BEGIN
 SELECT SP.*
  FROM  {databaseOwner}{objectQualifier}SkinPackages SP
  WHERE SP.PackageID = @PackageID

 SELECT I.*
  FROM  {databaseOwner}{objectQualifier}Skins I
 INNER JOIN {databaseOwner}{objectQualifier}SkinPackages S ON S.SkinPackageID = I.SkinPackageID
 WHERE S.PackageID = @PackageID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllFiles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAllFiles]
AS
BEGIN
	SELECT   
	  FileId,  
	  PortalId,  
	  [FileName],  
	  Extension,  
	  Size,  
	  Width,  
	  Height,  
	  ContentType,  
	  FolderID,  
	  Folder,  
	  StorageLocation,  
	  IsCached,
	  UniqueId,
	  VersionGuid,
	  SHA1Hash,
	  FolderMappingID,  
	  LastModificationTime,  
	  Title,  
	  EnablePublishPeriod,  
	  StartDate,  
	  EndDate,  
	  CreatedByUserID,  
	  CreatedOnDate,  
	  LastModifiedByUserID,  
	  LastModifiedOnDate,  
	  PublishedVersion,  
	  ContentItemID
	FROM {databaseOwner}[{objectQualifier}vw_Files] 	
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}WebServers]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}WebServers]
(
[ServerID] [int] NOT NULL IDENTITY(1, 1),
[ServerName] [nvarchar] (50) NOT NULL,
[CreatedDate] [datetime] NOT NULL,
[LastActivityDate] [datetime] NOT NULL,
[URL] [nvarchar] (255) NULL,
[IISAppName] [nvarchar] (200) NOT NULL CONSTRAINT [DF_{objectQualifier}WebServers_IISAppName] DEFAULT (''),
[Enabled] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}WebServers_Enabled] DEFAULT ((1)),
[ServerGroup] [nvarchar] (200) NULL,
[UniqueId] [nvarchar] (200) NULL,
[PingFailureCount] [int] NOT NULL DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}WebServers] on {databaseOwner}[{objectQualifier}WebServers]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}WebServers] ADD CONSTRAINT [PK_{objectQualifier}WebServers] PRIMARY KEY CLUSTERED  ([ServerID])
GO
PRINT N'Creating index [IX_{objectQualifier}WebServers_ServerName] on {databaseOwner}[{objectQualifier}WebServers]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}WebServers_ServerName] ON {databaseOwner}[{objectQualifier}WebServers] ([ServerName], [IISAppName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteServer]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteServer]
	@ServerID			int
AS
	DELETE FROM {databaseOwner}{objectQualifier}WebServers WHERE ServerID=@ServerID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileVersionsInFolder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFileVersionsInFolder]
@FolderId int
AS
BEGIN
	SELECT 
	   fv.[FileId]
      ,fv.[Version]
      ,fv.[FileName]
      ,fv.[Extension]
      ,fv.[Size]
      ,fv.[Width]
      ,fv.[Height]
      ,fv.[ContentType]
      ,fv.[CreatedByUserID]
      ,fv.[CreatedOnDate]
      ,fv.[LastModifiedByUserID]
      ,fv.[LastModifiedOnDate]
      ,fv.[SHA1Hash]
	FROM {databaseOwner}{objectQualifier}FileVersions fv, {databaseOwner}{objectQualifier}Files f
    WHERE fv.FileId = f.FileId and f.FolderId = @FolderId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabPermissionsByTabID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabPermissionsByTabID]
	@TabID int
AS

DELETE FROM {databaseOwner}{objectQualifier}TabPermission
WHERE
	[TabID] = @TabID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFolderMapping]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFolderMapping]
	@FolderMappingID int,
	@MappingName nvarchar(50),
	@Priority int,
	@LastModifiedByUserID int
AS
BEGIN
	UPDATE {databaseOwner}[{objectQualifier}FolderMappings]
	SET
		MappingName = @MappingName,
		Priority = @Priority,
		LastModifiedByUserID = @LastModifiedByUserID,
		LastModifiedOnDate = GETDATE()
	WHERE FolderMappingID = @FolderMappingID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ExceptionEvents]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ExceptionEvents]
(
[LogEventID] [bigint] NOT NULL,
[AssemblyVersion] [varchar] (20) NOT NULL,
[PortalId] [int] NULL,
[UserId] [int] NULL,
[TabId] [int] NULL,
[RawUrl] [nvarchar] (260) NULL,
[Referrer] [nvarchar] (260) NULL,
[UserAgent] [nvarchar] (260) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ExceptionEvents] on {databaseOwner}[{objectQualifier}ExceptionEvents]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ExceptionEvents] ADD CONSTRAINT [PK_{objectQualifier}ExceptionEvents] PRIMARY KEY CLUSTERED  ([LogEventID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddExceptionEvent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddExceptionEvent]
  @LogEventID bigint,
  @AssemblyVersion varchar(20),
  @PortalId int,
  @UserId int,
  @TabId int,
  @RawUrl nvarchar(260),
  @Referrer nvarchar(260),
  @UserAgent nvarchar(260)
AS

INSERT INTO {databaseOwner}[{objectQualifier}ExceptionEvents]
	(LogEventID,
	AssemblyVersion,
	PortalId,
	UserId,
	TabId,
	RawUrl,
 Referrer,
 UserAgent)
VALUES
	(@LogEventID,
	@AssemblyVersion,
	@PortalId,
	@UserId,
	@TabId,
	@RawUrl,
 @Referrer,
 @UserAgent)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSchedule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSchedule]
@ScheduleID int
AS
DELETE FROM {databaseOwner}{objectQualifier}Schedule
WHERE ScheduleID = @ScheduleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetUserPreference]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetUserPreference]
	@PortalId INT ,	
	@UserId INT
AS 
BEGIN
	SELECT PortalId, UserId, MessagesEmailFrequency, NotificationsEmailFrequency
	FROM {databaseOwner}{objectQualifier}CoreMessaging_UserPreferences UP
	WHERE	UP.PortalId = @PortalId
		AND
			UP.UserId = @UserId	
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies]
(
[VocabularyID] [int] NOT NULL IDENTITY(1, 1),
[VocabularyTypeID] [int] NOT NULL,
[Name] [nvarchar] (250) NOT NULL,
[Description] [nvarchar] (2500) NULL,
[Weight] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Taxonomy_Vocabularies_Weight] DEFAULT ((0)),
[ScopeID] [int] NULL,
[ScopeTypeID] [int] NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[IsSystem] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Taxonomy_Vocabularies_IsSystem] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Taxonomy_Vocabulary] on {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies] ADD CONSTRAINT [PK_{objectQualifier}Taxonomy_Vocabulary] PRIMARY KEY CLUSTERED  ([VocabularyID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddVocabulary]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddVocabulary] 
	@VocabularyTypeID	int,
	@Name				nvarchar(250),
	@Description		nvarchar(2500),
	@Weight				int,
	@ScopeID			int,
	@ScopeTypeID		int,
	@CreatedByUserID	int
AS
	INSERT INTO {databaseOwner}{objectQualifier}Taxonomy_Vocabularies (
		VocabularyTypeID,
		[Name],
		Description,
		Weight,
		ScopeID,
		ScopeTypeID,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	)

	VALUES (
		@VocabularyTypeID,
		@Name,
		@Description,
		@Weight,
		@ScopeID,
		@ScopeTypeID,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileVersions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFileVersions] 
@FileId int
AS
BEGIN
	SELECT 
	   [FileId]
      ,[Version]
      ,[FileName]
      ,[Extension]
      ,[Size]
      ,[Width]
      ,[Height]
      ,[ContentType]
      ,[CreatedByUserID]
      ,[CreatedOnDate]
      ,[LastModifiedByUserID]
      ,[LastModifiedOnDate]
      ,[SHA1Hash]
	FROM {databaseOwner}{objectQualifier}FileVersions fv
	WHERE fv.FileId = @FileId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Exceptions]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Exceptions]
(
[ExceptionHash] [varchar] (100) NOT NULL,
[Message] [nvarchar] (500) NOT NULL,
[StackTrace] [nvarchar] (max) NULL,
[InnerMessage] [nvarchar] (500) NULL,
[InnerStackTrace] [nvarchar] (max) NULL,
[Source] [nvarchar] (500) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Exceptions] on {databaseOwner}[{objectQualifier}Exceptions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Exceptions] ADD CONSTRAINT [PK_{objectQualifier}Exceptions] PRIMARY KEY CLUSTERED  ([ExceptionHash])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}EventLog]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}EventLog]
(
[LogGUID] [varchar] (36) NOT NULL,
[LogTypeKey] [nvarchar] (35) NOT NULL,
[LogConfigID] [int] NULL,
[LogUserID] [int] NULL,
[LogUserName] [nvarchar] (50) NULL,
[LogPortalID] [int] NULL,
[LogPortalName] [nvarchar] (100) NULL,
[LogCreateDate] [datetime] NOT NULL,
[LogServerName] [nvarchar] (50) NOT NULL,
[LogProperties] [xml] NULL,
[LogNotificationPending] [bit] NULL,
[LogEventID] [bigint] NOT NULL IDENTITY(1, 1),
[ExceptionHash] [varchar] (100) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}EventLogMaster] on {databaseOwner}[{objectQualifier}EventLog]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}EventLog] ADD CONSTRAINT [PK_{objectQualifier}EventLogMaster] PRIMARY KEY CLUSTERED  ([LogEventID])
GO
PRINT N'Creating index [IX_{objectQualifier}EventLog_LogGUID] on {databaseOwner}[{objectQualifier}EventLog]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}EventLog_LogGUID] ON {databaseOwner}[{objectQualifier}EventLog] ([LogGUID])
GO
PRINT N'Creating index [IX_{objectQualifier}EventLog_LogType] on {databaseOwner}[{objectQualifier}EventLog]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}EventLog_LogType] ON {databaseOwner}[{objectQualifier}EventLog] ([LogTypeKey], [LogPortalID])
GO
PRINT N'Creating index [IX_{objectQualifier}EventLog_LogConfigID] on {databaseOwner}[{objectQualifier}EventLog]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}EventLog_LogConfigID] ON {databaseOwner}[{objectQualifier}EventLog] ([LogConfigID], [LogNotificationPending], [LogCreateDate]) INCLUDE ([LogEventID])
GO
PRINT N'Creating index [IX_{objectQualifier}EventLog_LogCreateDate] on {databaseOwner}[{objectQualifier}EventLog]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}EventLog_LogCreateDate] ON {databaseOwner}[{objectQualifier}EventLog] ([LogCreateDate]) INCLUDE ([LogConfigID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_EventLog]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_EventLog]
AS
SELECT
 el.*,
 ee.AssemblyVersion,
 ee.PortalId,
 ee.UserId,
 ee.TabId,
 ee.RawUrl,
 ee.Referrer,
 ee.UserAgent,
 e.Message,
 e.StackTrace,
 e.InnerMessage,
 e.InnerStackTrace,
 e.Source
FROM {databaseOwner}{objectQualifier}EventLog el
 LEFT JOIN {databaseOwner}{objectQualifier}ExceptionEvents ee ON el.LogEventID = ee.LogEventID
 LEFT JOIN {databaseOwner}{objectQualifier}Exceptions e ON el.ExceptionHash = e.ExceptionHash
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_SetUserPreference]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_SetUserPreference]
	@PortalId INT ,	
	@UserId INT,
	@MessagesEmailFrequency INT,
	@NotificationsEmailFrequency INT
AS 
BEGIN	
	UPDATE {databaseOwner}{objectQualifier}CoreMessaging_UserPreferences
	SET MessagesEmailFrequency = @MessagesEmailFrequency
		,NotificationsEmailFrequency = @NotificationsEmailFrequency
	WHERE PortalId = @PortalId
	AND UserId = @UserId

	IF @@ROWCOUNT = 0 BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}CoreMessaging_UserPreferences (PortalId, UserId, MessagesEmailFrequency, NotificationsEmailFrequency)
		VALUES (@PortalId, @UserId, @MessagesEmailFrequency, @NotificationsEmailFrequency)
	END	
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPropertyDefinitionsByCategory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPropertyDefinitionsByCategory]
	@PortalID	int,
	@Category	nvarchar(50)

AS
SELECT	*
	FROM	{databaseOwner}{objectQualifier}ProfilePropertyDefinition
	WHERE  (PortalId = @PortalID OR (PortalId IS NULL AND @PortalID IS NULL))
		AND PropertyCategory = @Category
	ORDER BY ViewOrder
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFileVersion] 
	@FileId int,
	@Version int
AS
BEGIN
	SELECT 
	   [FileId]
      ,[Version]
      ,[FileName]
      ,[Extension]
      ,[Size]
      ,[Width]
      ,[Height]
      ,[ContentType]
      ,[CreatedByUserID]
      ,[CreatedOnDate]
      ,[LastModifiedByUserID]
      ,[LastModifiedOnDate]
      ,[SHA1Hash]
	FROM {databaseOwner}{objectQualifier}FileVersions fv
	WHERE FileId = @FileId
	  AND Version = @Version
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PageUpperBound]'
GO
-- new helper function for paging, replacing inefficient stored procedure
CREATE FUNCTION {databaseOwner}[{objectQualifier}PageUpperBound]
(
    @PageIndex Int, -- Page number starting with 0 or Null for all
    @PageSize  Int  -- number of items per page or Null for all
) 
	RETURNS    Int
AS
BEGIN
    DECLARE @bound Int = Cast(0x7fffffff AS Int)
    IF IsNull(@PageSize, -1) > 0 AND IsNull(@PageIndex, -1) >= 0 AND IsNull(@PageIndex, 0) <= (Cast(0x7fffffff AS Int) / IsNull(@PageSize, 1) -1)
        SET @Bound = @PageSize * (@PageIndex + 1)
    RETURN @Bound
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PageLowerBound]'
GO
-- new helperfunction for paging, replacing inefficient stored procedure
CREATE FUNCTION {databaseOwner}[{objectQualifier}PageLowerBound]
(
    @PageIndex Int, -- Page number starting with 0 or Null for all
    @PageSize  Int  -- number of items per page or Null for all
) 
	RETURNS    Int
AS
BEGIN
    DECLARE @bound Int = 1
    IF IsNull(@PageSize, -1) > 0 AND IsNull(@PageIndex, -1) >= 0 AND IsNull(@PageIndex, 0) <= (Cast(0x7fffffff AS Int) / IsNull(@PageSize, 1) -1)
        SET @bound  = @PageSize * @PageIndex + 1
    RETURN @bound
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventLog]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventLog]
    @PortalID   Int,            -- Might be Null for all sites
    @LogTypeKey nVarChar(35),   -- Key of log type or Null for all
    @PageSize   Int,            -- Number of items per page
    @PageIndex  Int             -- Page number starting with 0
AS
BEGIN
     WITH [eLog] AS (
         SELECT ROW_NUMBER() OVER (ORDER BY E.LogCreateDate Desc) AS RowNumber, e.*
          FROM {databaseOwner}{objectQualifier}vw_EventLog e
          WHERE (e.LogPortalID = @PortalID     OR IsNull(@PortalID,   -1) = -1)
            AND (e.LogTypeKey LIKE @LogTypeKey OR IsNull(@LogTypeKey, '') = '')
     )
     SELECT * FROM [eLog]
      WHERE RowNumber >= {databaseOwner}{objectQualifier}PageLowerBound(@PageIndex, @PageSize)
        AND RowNumber <= {databaseOwner}{objectQualifier}PageUpperBound(@PageIndex, @PageSize)
      ORDER BY RowNumber

    SELECT COUNT(1) AS TotalRecords
     FROM {databaseOwner}{objectQualifier}vw_EventLog e
     WHERE (e.LogPortalID = @PortalID     OR IsNull(@PortalID,   -1) = -1)
       AND (e.LogTypeKey Like @LogTypeKey OR IsNull(@LogTypeKey, '') = '')

END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}LocalizeTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}LocalizeTab] 
	@TabId					int,
	@CultureCode			nvarchar(10),
	@LastModifiedByUserID	int
AS
	BEGIN
		UPDATE {databaseOwner}{objectQualifier}Tabs
			SET 
				CultureCode				= @CultureCode,
				LastModifiedByUserID	= @LastModifiedByUserID,
				LastModifiedOnDate		= getdate()					
			WHERE TabID = @TabId
			
		UPDATE {databaseOwner}{objectQualifier}TabModules
			SET 
				CultureCode				= @CultureCode,
				LastModifiedByUserID	= @LastModifiedByUserID,
				LastModifiedOnDate		= getdate()					
			WHERE TabID = @TabId
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentItemsByTabId]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentItemsByTabId] 
	@TabId int
AS
	SELECT * FROM {databaseOwner}{objectQualifier}ContentItems WHERE TabID = @TabId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}EventLogTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}EventLogTypes]
(
[LogTypeKey] [nvarchar] (35) NOT NULL,
[LogTypeFriendlyName] [nvarchar] (50) NOT NULL,
[LogTypeDescription] [nvarchar] (128) NOT NULL,
[LogTypeOwner] [nvarchar] (100) NOT NULL,
[LogTypeCSSClass] [nvarchar] (40) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}EventLogTypes] on {databaseOwner}[{objectQualifier}EventLogTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}EventLogTypes] ADD CONSTRAINT [PK_{objectQualifier}EventLogTypes] PRIMARY KEY CLUSTERED  ([LogTypeKey])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateEventLogType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateEventLogType]
	@LogTypeKey nvarchar(35),
	@LogTypeFriendlyName nvarchar(50),
	@LogTypeDescription nvarchar(128),
	@LogTypeOwner nvarchar(100),
	@LogTypeCSSClass nvarchar(40)
AS
UPDATE {databaseOwner}{objectQualifier}EventLogTypes
	SET LogTypeFriendlyName = @LogTypeFriendlyName,
	LogTypeDescription = @LogTypeDescription,
	LogTypeOwner = @LogTypeOwner,
	LogTypeCSSClass = @LogTypeCSSClass
WHERE	LogTypeKey = @LogTypeKey
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventLogByLogGUID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventLogByLogGUID]
	@LogGUID varchar(36)
AS
SELECT *
FROM {databaseOwner}{objectQualifier}vw_EventLog
WHERE (LogGUID = @LogGUID)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Split]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}Journal_Split](@text varchar(8000), @delimiter char(1))
RETURNS @words TABLE (objectid smallint primary key, id int)
AS
BEGIN
	DECLARE @pos smallint,
		@i smallint,
		@j smallint,
		@s varchar(255)

	SET @pos = 1

	WHILE @pos <= LEN(@text)
	BEGIN
		SET @i = CHARINDEX(' ', @text, @pos)
		SET @j = CHARINDEX(@delimiter, @text, @pos)

		IF @i > 0 OR @j > 0
		BEGIN
			IF @i = 0 OR (@j > 0 AND @j < @i)
				SET @i = @j

			IF @i > @pos
			BEGIN
				-- @i now holds the earliest delimiter in the string
				SET @s = SUBSTRING(@text, @pos, @i - @pos)
	
				INSERT INTO @words
				VALUES (@pos, @s)
			END

			SET @pos = @i + 1
			WHILE @pos < LEN(@text) AND SUBSTRING(@text, @pos, 1) IN (' ', ',')
				SET @pos = @pos + 1
		END
		ELSE
		BEGIN
			INSERT INTO @words
			VALUES (@pos, SUBSTRING(@text, @pos, LEN(@text) - @pos + 1))

			SET @pos = LEN(@text) + 1
		END
	END
	
	RETURN
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comment_ListByJournalIds]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comment_ListByJournalIds]
@JounalIds nvarchar(max) = ''
AS
SELECT jc.*, u.* FROM {databaseOwner}[{objectQualifier}Journal_Comments] as jc 
	INNER JOIN {databaseOwner}[{objectQualifier}Users] as u ON jc.UserId = u.UserId
	INNER JOIN {databaseOwner}[{objectQualifier}Journal_Split](@JounalIds,';') as j ON j.id = jc.JournalId
ORDER BY jc.CommentId ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateServer]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateServer]
    @ServerID           INT,
    @URL                NVARCHAR(255),
    @UniqueId           NVARCHAR(200),
    @Enabled            BIT,
    @Group              NVARCHAR(200)
AS
    UPDATE {databaseOwner}{objectQualifier}WebServers
        SET 
            URL = @URL,
            UniqueId = @UniqueId,
            Enabled = @Enabled,
            ServerGroup = @Group
        WHERE  ServerID = @ServerID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}EventLogConfig]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}EventLogConfig]
(
[ID] [int] NOT NULL IDENTITY(1, 1),
[LogTypeKey] [nvarchar] (35) NULL,
[LogTypePortalID] [int] NULL,
[LoggingIsActive] [bit] NOT NULL,
[KeepMostRecent] [int] NOT NULL,
[EmailNotificationIsActive] [bit] NOT NULL,
[NotificationThreshold] [int] NULL,
[NotificationThresholdTime] [int] NULL,
[NotificationThresholdTimeType] [int] NULL,
[MailFromAddress] [nvarchar] (50) NOT NULL,
[MailToAddress] [nvarchar] (50) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}EventLogConfig] on {databaseOwner}[{objectQualifier}EventLogConfig]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}EventLogConfig] ADD CONSTRAINT [PK_{objectQualifier}EventLogConfig] PRIMARY KEY CLUSTERED  ([ID])
GO
PRINT N'Creating index [IX_{objectQualifier}LogTypeKey_{objectQualifier}LogTypePortalID] on {databaseOwner}[{objectQualifier}EventLogConfig]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}LogTypeKey_{objectQualifier}LogTypePortalID] ON {databaseOwner}[{objectQualifier}EventLogConfig] ([LogTypeKey], [LogTypePortalID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PurgeEventLog]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}PurgeEventLog]

AS
	;WITH logcounts AS
	(  
	  SELECT 
		LogEventID, 
		LogConfigID, 
		ROW_NUMBER() OVER(PARTITION BY LogConfigID ORDER BY LogCreateDate DESC) AS logEventSequence
	  FROM {databaseOwner}{objectQualifier}EventLog
	)
	DELETE {databaseOwner}{objectQualifier}EventLog 
	FROM {databaseOwner}{objectQualifier}EventLog el 
		JOIN logcounts lc ON el.LogEventID = lc.LogEventID
		INNER JOIN {databaseOwner}{objectQualifier}EventLogConfig elc ON elc.ID = lc.LogConfigID
	WHERE elc.KeepMostRecent <> -1
		AND lc.logEventSequence > elc.KeepMostRecent
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ResetFilePublishedVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}ResetFilePublishedVersion] 
@FileId int
AS
BEGIN
	UPDATE {databaseOwner}{objectQualifier}Files
		SET PublishedVersion = 1
		WHERE FileId = @FileId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePermission]
	@PermissionID			int, 
	@PermissionCode			varchar(50),
	@ModuleDefID			int, 
	@PermissionKey			varchar(50), 
	@PermissionName			varchar(50),
	@LastModifiedByUserID	int
AS

UPDATE {databaseOwner}{objectQualifier}Permission SET
	[ModuleDefID] = @ModuleDefID,
	[PermissionCode] = @PermissionCode,
	[PermissionKey] = @PermissionKey,
	[PermissionName] = @PermissionName,
	[LastModifiedByUserID] = @LastModifiedByUserID,
	[LastModifiedOnDate] = getdate()
WHERE
	[PermissionID] = @PermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventLogPendingNotif]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventLogPendingNotif]
	@LogConfigID int
AS
SELECT *
FROM {databaseOwner}{objectQualifier}vw_EventLog
WHERE LogNotificationPending = 1
AND LogConfigID = @LogConfigID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comment_Get]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comment_Get]
@CommentId int
AS
SELECT jc.*, u.* FROM {databaseOwner}[{objectQualifier}Journal_Comments] as jc 
	INNER JOIN {databaseOwner}[{objectQualifier}Users] as u ON jc.UserId = u.UserId
WHERE jc.CommentId = @CommentId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ModulePermission]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ModulePermission]
(
[ModulePermissionID] [int] NOT NULL IDENTITY(1, 1),
[ModuleID] [int] NOT NULL,
[PermissionID] [int] NOT NULL,
[AllowAccess] [bit] NOT NULL,
[RoleID] [int] NULL,
[UserID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[PortalID] [int] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ModulePermission] on {databaseOwner}[{objectQualifier}ModulePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModulePermission] ADD CONSTRAINT [PK_{objectQualifier}ModulePermission] PRIMARY KEY CLUSTERED  ([ModulePermissionID])
GO
PRINT N'Creating index [IX_{objectQualifier}ModulePermission_Modules] on {databaseOwner}[{objectQualifier}ModulePermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}ModulePermission_Modules] ON {databaseOwner}[{objectQualifier}ModulePermission] ([ModuleID], [PermissionID], [PortalID], [RoleID], [UserID]) INCLUDE ([AllowAccess])
GO
PRINT N'Creating index [IX_{objectQualifier}ModulePermission_Roles] on {databaseOwner}[{objectQualifier}ModulePermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}ModulePermission_Roles] ON {databaseOwner}[{objectQualifier}ModulePermission] ([RoleID], [ModuleID], [PermissionID], [PortalID]) INCLUDE ([AllowAccess]) WHERE ([RoleID] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}ModulePermission_Users] on {databaseOwner}[{objectQualifier}ModulePermission]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}ModulePermission_Users] ON {databaseOwner}[{objectQualifier}ModulePermission] ([UserID], [ModuleID], [PermissionID], [PortalID]) INCLUDE ([AllowAccess]) WHERE ([UserID] IS NOT NULL)
GO
PRINT N'Creating index [IX_{objectQualifier}ModulePermission_Permission] on {databaseOwner}[{objectQualifier}ModulePermission]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ModulePermission_Permission] ON {databaseOwner}[{objectQualifier}ModulePermission] ([PermissionID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModulePermissionsByModuleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteModulePermissionsByModuleID]
	@ModuleID int,
	@PortalID int
AS
	DELETE FROM {databaseOwner}{objectQualifier}ModulePermission
		WHERE ModuleID = @ModuleID
			AND PortalID = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventLogPendingNotifConfig]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventLogPendingNotifConfig]
AS

SELECT 	COUNT(*) as PendingNotifs,
	elc.ID,
	elc.LogTypeKey, 
	elc.LogTypePortalID, 
	elc.LoggingIsActive,
	elc.KeepMostRecent,
	elc.EmailNotificationIsActive,
	elc.NotificationThreshold,
	elc.NotificationThresholdTime,
	elc.NotificationThresholdTimeType,
	elc.MailToAddress, 
	elc.MailFromAddress
FROM {databaseOwner}{objectQualifier}EventLogConfig elc
INNER JOIN {databaseOwner}{objectQualifier}EventLog
ON {databaseOwner}{objectQualifier}EventLog.LogConfigID = elc.ID
WHERE {databaseOwner}{objectQualifier}EventLog.LogNotificationPending = 1
GROUP BY elc.ID,
	elc.LogTypeKey, 
	elc.LogTypePortalID, 
	elc.LoggingIsActive,
	elc.KeepMostRecent,
	elc.EmailNotificationIsActive,
	elc.NotificationThreshold,
	elc.NotificationThresholdTime,
	elc.NotificationThresholdTimeType,
	elc.MailToAddress, 
	elc.MailFromAddress
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserRelationships]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UserRelationships]
(
[UserRelationshipID] [int] NOT NULL IDENTITY(1, 1),
[UserID] [int] NOT NULL,
[RelatedUserID] [int] NOT NULL,
[RelationshipID] [int] NOT NULL,
[Status] [int] NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}UserRelationships_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}UserRelationships_LastModifiedOnDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UserRelationships] on {databaseOwner}[{objectQualifier}UserRelationships]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRelationships] ADD CONSTRAINT [PK_{objectQualifier}UserRelationships] PRIMARY KEY CLUSTERED  ([UserRelationshipID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserRelationships_UserID] on {databaseOwner}[{objectQualifier}UserRelationships]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserRelationships_UserID] ON {databaseOwner}[{objectQualifier}UserRelationships] ([UserID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserRelationships_UserID_RelatedUserID_RelationshipID] on {databaseOwner}[{objectQualifier}UserRelationships]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}UserRelationships_UserID_RelatedUserID_RelationshipID] ON {databaseOwner}[{objectQualifier}UserRelationships] ([UserID], [RelatedUserID], [RelationshipID])
GO
PRINT N'Creating index [IX_{objectQualifier}UserRelationships_RelatedUserID] on {databaseOwner}[{objectQualifier}UserRelationships]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UserRelationships_RelatedUserID] ON {databaseOwner}[{objectQualifier}UserRelationships] ([RelatedUserID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_User_Permissions]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}Journal_User_Permissions]
(
    @PortalId int,
    @UserId int,
    @RegisteredRoleId int
)
RETURNS 
@tmp TABLE (seckey nvarchar(200))

AS
BEGIN
IF @UserId > 0
        BEGIN
            IF @RegisteredRoleId = 1
                SELECT @RegisteredRoleId = RegisteredRoleId FROM {databaseOwner}[{objectQualifier}Portals] WHERE PortalID = @PortalId
            INSERT INTO @tmp (seckey) VALUES ('U' + Cast(@UserId as nvarchar(200)))
            INSERT INTO @tmp (seckey) VALUES ('P' + Cast(@UserId as nvarchar(200)))
            INSERT INTO @tmp (seckey) VALUES ('F' + Cast(@UserId as nvarchar(200)))
            IF EXISTS(SELECT RoleId FROM {databaseOwner}[{objectQualifier}UserRoles] WHERE UserID = @UserId AND RoleId = @RegisteredRoleId
                        AND    (EffectiveDate <= getdate() or EffectiveDate is null)
                        AND    (ExpiryDate >= getdate() or ExpiryDate is null))
                    INSERT INTO @tmp (seckey) VALUES ('C')
            
        END
        
    INSERT INTO @tmp (seckey) VALUES ('E')
    
    INSERT INTO @tmp (seckey)
    SELECT 'R' + CAST(ur.RoleId as nvarchar(200)) 
        FROM {databaseOwner}[{objectQualifier}UserRoles] as ur
            INNER JOIN {databaseOwner}[{objectQualifier}Users] as u on ur.UserId = u.UserId
            INNER JOIN {databaseOwner}[{objectQualifier}Roles] as r on ur.RoleId = r.RoleId
        WHERE  u.UserId = @UserId
            AND    r.PortalId = @PortalId
            AND    (EffectiveDate <= getdate() or EffectiveDate is null)
            AND    (ExpiryDate >= getdate() or ExpiryDate is null)
    INSERT INTO @tmp (seckey)
        SELECT (SELECT CASE WHEN @UserID = ur.UserId 
                        THEN 'F' + CAST(RelatedUserID as nvarchar(200))
                        ELSE 'F' + CAST(ur.UserId as nvarchar(200)) END) 
        FROM {databaseOwner}[{objectQualifier}UserRelationships] ur
        INNER JOIN {databaseOwner}[{objectQualifier}Relationships] r ON ur.RelationshipID = r.RelationshipID AND r.RelationshipTypeID = 1
        WHERE (ur.UserId = @UserId OR RelatedUserID = @UserId) AND Status = 2
    RETURN 
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventLogType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventLogType]
AS
SELECT *
FROM {databaseOwner}{objectQualifier}EventLogTypes
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}LanguagePacks]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}LanguagePacks]
(
[LanguagePackID] [int] NOT NULL IDENTITY(1, 1),
[PackageID] [int] NOT NULL,
[DependentPackageID] [int] NOT NULL,
[LanguageID] [int] NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}LanguagePacks] on {databaseOwner}[{objectQualifier}LanguagePacks]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}LanguagePacks] ADD CONSTRAINT [PK_{objectQualifier}LanguagePacks] PRIMARY KEY CLUSTERED  ([LanguagePackID])
GO
PRINT N'Creating index [IX_{objectQualifier}LanguagePacks] on {databaseOwner}[{objectQualifier}LanguagePacks]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}LanguagePacks] ON {databaseOwner}[{objectQualifier}LanguagePacks] ([LanguageID], [PackageID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetLanguagePackByPackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetLanguagePackByPackage]

	@PackageID int

AS
	SELECT * FROM {databaseOwner}{objectQualifier}LanguagePacks 
        WHERE  PackageID = @PackageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabSetting]
	@TabID      	INT,
	@SettingName	NVARCHAR(50)

AS

	DELETE	FROM {databaseOwner}{objectQualifier}TabSettings 
	WHERE	TabID = @TabID
	AND		SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ModuleSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ModuleSettings]
(
[ModuleID] [int] NOT NULL,
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (max) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ModuleSettings] on {databaseOwner}[{objectQualifier}ModuleSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModuleSettings] ADD CONSTRAINT [PK_{objectQualifier}ModuleSettings] PRIMARY KEY CLUSTERED  ([ModuleID], [SettingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModuleSettingsByTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModuleSettingsByTab]
    @TabId Int
AS
	BEGIN
		SELECT
			MS.ModuleID,
			MS.SettingName,
			CASE WHEN Lower(MS.SettingValue) LIKE 'fileid=%'
				 THEN {databaseOwner}{objectQualifier}FilePath(MS.SettingValue)
				 ELSE MS.SettingValue END           
				 AS SettingValue
		FROM   {databaseOwner}[{objectQualifier}ModuleSettings] MS
			INNER JOIN {databaseOwner}[{objectQualifier}TabModules] TM ON MS.ModuleID = TM.ModuleID
		WHERE  TM.TabID = @TabId
		ORDER BY MS.ModuleID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Version]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Version]
(
[VersionId] [int] NOT NULL IDENTITY(1, 1),
[Major] [int] NOT NULL,
[Minor] [int] NOT NULL,
[Build] [int] NOT NULL,
[Name] [nvarchar] (50) NULL,
[CreatedDate] [datetime] NOT NULL,
[Increment] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Version] on {databaseOwner}[{objectQualifier}Version]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Version] ADD CONSTRAINT [PK_{objectQualifier}Version] PRIMARY KEY CLUSTERED  ([VersionId])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Version]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Version] ADD CONSTRAINT [IX_{objectQualifier}Version] UNIQUE NONCLUSTERED  ([Major], [Minor], [Build], [Increment])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDatabaseVersion]'
GO
create procedure {databaseOwner}[{objectQualifier}GetDatabaseVersion]

as

select Major,
       Minor,
       Build
from   {databaseOwner}{objectQualifier}Version 
where  VersionId = ( select max(VersionId) from {databaseOwner}{objectQualifier}Version )
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRelationshipsByPortalID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRelationshipsByPortalID] @PortalID INT
AS 
    SELECT  RelationshipID,
			RelationshipTypeID,            
            Name,            
            Description,
			UserID,
			PortalID,
			DefaultResponse,
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}Relationships    
	WHERE PortalID = @PortalID AND UserID IS NULL
	ORDER BY RelationshipID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabModuleSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabModuleSettings]
(
[TabModuleID] [int] NOT NULL,
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (max) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabModuleSettings] on {databaseOwner}[{objectQualifier}TabModuleSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabModuleSettings] ADD CONSTRAINT [PK_{objectQualifier}TabModuleSettings] PRIMARY KEY CLUSTERED  ([TabModuleID], [SettingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModuleSettingsByTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModuleSettingsByTab]
    @TabId Int
AS
	BEGIN
		SELECT
			TMS.TabModuleID,
			TMS.SettingName,
			CASE WHEN Lower(TMS.SettingValue) LIKE 'fileid=%'
				 THEN {databaseOwner}{objectQualifier}FilePath(TMS.SettingValue)
				 ELSE TMS.SettingValue END           
				 AS SettingValue
		FROM   {databaseOwner}[{objectQualifier}TabModuleSettings] TMS
			INNER JOIN {databaseOwner}[{objectQualifier}TabModules] TM ON TMS.TabModuleID = TM.TabModuleID
		WHERE  TM.TabID = @TabId
		ORDER BY TMS.TabModuleID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UsersOnline]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UsersOnline]
(
[UserID] [int] NOT NULL,
[PortalID] [int] NOT NULL,
[TabID] [int] NOT NULL,
[CreationDate] [datetime] NOT NULL DEFAULT (getdate()),
[LastActiveDate] [datetime] NOT NULL DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UsersOnline] on {databaseOwner}[{objectQualifier}UsersOnline]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UsersOnline] ADD CONSTRAINT [PK_{objectQualifier}UsersOnline] PRIMARY KEY CLUSTERED  ([UserID], [PortalID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetOnlineUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetOnlineUser]
	@UserID int
AS

	SELECT
		U.UserID,
		U.UserName
	FROM {databaseOwner}{objectQualifier}Users U
	WHERE U.UserID = @UserID
		AND EXISTS (
			select 1 from {databaseOwner}{objectQualifier}UsersOnline UO where UO.UserID = U.UserID
		)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteDesktopModulePermissionsByPortalDesktopModuleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteDesktopModulePermissionsByPortalDesktopModuleID]
	@PortalDesktopModuleID int
AS
    DELETE FROM {databaseOwner}{objectQualifier}DesktopModulePermission
    WHERE PortalDesktopModuleID = @PortalDesktopModuleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabsByTabModuleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabsByTabModuleID]
	@TabModuleID Int -- NOT Null
AS
	BEGIN
		SELECT * FROM {databaseOwner}[{objectQualifier}vw_Tabs] T
		WHERE IsDeleted = 0
		  AND TabID IN (SELECT TabID FROM {databaseOwner}[{objectQualifier}TabModules]
						WHERE TabModuleID = @TabModuleID AND IsDeleted = 0)
		ORDER BY PortalId, Level, ParentID, TabOrder -- PortalId added for query optimization
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}EventQueue]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}EventQueue]
(
[EventMessageID] [int] NOT NULL IDENTITY(1, 1),
[EventName] [nvarchar] (100) NOT NULL,
[Priority] [int] NOT NULL,
[ProcessorType] [nvarchar] (250) NOT NULL,
[ProcessorCommand] [nvarchar] (250) NOT NULL,
[Body] [nvarchar] (250) NOT NULL,
[Sender] [nvarchar] (250) NOT NULL,
[Subscriber] [nvarchar] (100) NOT NULL,
[AuthorizedRoles] [nvarchar] (250) NOT NULL,
[ExceptionMessage] [nvarchar] (250) NOT NULL,
[SentDate] [datetime] NOT NULL,
[ExpirationDate] [datetime] NOT NULL,
[Attributes] [ntext] NOT NULL,
[IsComplete] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}EventQueue_IsComplete] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}EventQueue] on {databaseOwner}[{objectQualifier}EventQueue]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}EventQueue] ADD CONSTRAINT [PK_{objectQualifier}EventQueue] PRIMARY KEY CLUSTERED  ([EventMessageID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventMessages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventMessages]
	
	@EventName nvarchar(100)

AS
	SELECT * 
	FROM {databaseOwner}{objectQualifier}EventQueue
	WHERE EventName = @EventName
		AND IsComplete = 0
	ORDER BY SentDate
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateListEntry]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}UpdateListEntry]
	
	@EntryID int, 
	@Value nvarchar(100), 
	@Text nvarchar(150), 
	@Description nvarchar(500),
	@LastModifiedByUserID	int

AS
	UPDATE {databaseOwner}{objectQualifier}Lists
		SET	
			[Value] = @Value,
			[Text] = @Text,	
			[Description] = @Description,
			[LastModifiedByUserID] = @LastModifiedByUserID,	
			[LastModifiedOnDate] = getdate()
		WHERE 	[EntryID] = @EntryID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateEventLogPendingNotif]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateEventLogPendingNotif]
	@LogConfigID int
AS
UPDATE {databaseOwner}{objectQualifier}EventLog
SET LogNotificationPending = 0
WHERE LogNotificationPending = 1
AND LogConfigID = @LogConfigID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSearchCommonWord]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSearchCommonWord]
	@CommonWordID int
AS

DELETE FROM {databaseOwner}{objectQualifier}SearchCommonWords
WHERE
	[CommonWordID] = @CommonWordID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Taxonomy_Terms]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Taxonomy_Terms]
(
[TermID] [int] NOT NULL IDENTITY(1, 1),
[VocabularyID] [int] NOT NULL,
[ParentTermID] [int] NULL,
[Name] [nvarchar] (250) NOT NULL,
[Description] [nvarchar] (2500) NULL,
[Weight] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Taxonomy_Terms_Weight] DEFAULT ((0)),
[TermLeft] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Taxonomy_Terms_TermLeft] DEFAULT ((0)),
[TermRight] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Taxonomy_Terms_TermRight] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Taxonomy_Terms] on {databaseOwner}[{objectQualifier}Taxonomy_Terms]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_Terms] ADD CONSTRAINT [PK_{objectQualifier}Taxonomy_Terms] PRIMARY KEY CLUSTERED  ([TermID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteHeirarchicalTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteHeirarchicalTerm]	
    @TermId			int    
AS
BEGIN
    DECLARE @Left int, @Right int, @VocabularyID int, @Width int

	SELECT
		@Left = tt.TermLeft
		, @Right = tt.TermRight
		, @VocabularyID = tt.VocabularyID
		, @Width = @Right - @Left + 1
	FROM
		{databaseOwner}{objectQualifier}Taxonomy_Terms tt
	WHERE
		tt.TermID = @TermID

	BEGIN TRANSACTION

	-- Delete term(s)
	DELETE FROM {databaseOwner}{objectQualifier}Taxonomy_Terms
	WHERE TermLeft > = @Left AND TermLeft > 0
	  AND TermRight <= @Right AND TermRight > 0
	  AND VocabularyID = @VocabularyID

	IF @@ERROR = 0
	BEGIN
		-- Update Left values for all items that are after deleted term
		UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms
	    SET TermLeft = TermLeft - @Width
		WHERE TermLeft >= @Left + @Width
			AND VocabularyID = @VocabularyID

        IF @@ERROR = 0
        BEGIN
            -- Update Right values for all items that are after deleted term
            UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms
            SET TermRight = TermRight - @Width
            WHERE TermRight >= @Right
                AND VocabularyID = @VocabularyID

            IF @@ERROR = 0
            BEGIN
                COMMIT TRANSACTION
                RETURN
            END
        END
    END
    
	ROLLBACK TRANSACTION
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_TabModules]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_TabModules]
AS
    SELECT
        M.PortalID AS [OwnerPortalID],
        T.PortalID,
        TM.TabID,
        TM.TabModuleID,
        M.ModuleID,
        M.ModuleDefID,
        TM.ModuleOrder,
        TM.PaneName,
        TM.ModuleTitle,
        TM.CacheTime,
        TM.CacheMethod,
        TM.Alignment,
        TM.Color,
        TM.Border,
         Case when tm.IconFile LIKE 'fileid=%' 
			then (SELECT IsNull(Folder, '') + [FileName] FROM {databaseOwner}[{objectQualifier}vw_Files]
			 WHERE fileid = CAST(SUBSTRING(tm.IconFile, 8, 10) AS Int))
			 else Coalesce(tm.IconFile,'')
			 end as IconFile
		,M.AllTabs,
        TM.Visibility,
        TM.IsDeleted,
        TM.Header,
        TM.Footer,
        M.StartDate,
        M.EndDate,
        TM.ContainerSrc,
        TM.DisplayTitle,
        TM.DisplayPrint,
        TM.DisplaySyndicate,
        TM.IsWebSlice,
        TM.WebSliceTitle,
        TM.WebSliceExpiryDate,
        TM.WebSliceTTL,
        M.InheritViewPermissions,
        M.IsShareable,
        M.IsShareableViewOnly,
        MD.DesktopModuleID,
        MD.DefaultCacheTime,
        MC.ModuleControlID,
        DM.BusinessControllerClass,
        DM.IsAdmin,
        DM.SupportedFeatures,
        CI.ContentItemID,
        CI.Content,
        CI.ContentTypeID,
        CI.ContentKey,
        CI.Indexed,
        CI.StateID,
        TM.CreatedByUserID,
        TM.CreatedOnDate,
        TM.LastModifiedByUserID,
        TM.LastModifiedOnDate,
        M.LastContentModifiedOnDate,
        TM.UniqueId,
        TM.VersionGuid,
        TM.DefaultLanguageGuid,
        TM.LocalizedVersionGuid,
        TM.CultureCode
    FROM {databaseOwner}[{objectQualifier}ModuleDefinitions]     AS MD
     INNER JOIN {databaseOwner}[{objectQualifier}Modules]        AS M  ON MD.ModuleDefID = M.ModuleDefID
     INNER JOIN {databaseOwner}[{objectQualifier}ModuleControls] AS MC ON MD.ModuleDefID = MC.ModuleDefID
     INNER JOIN {databaseOwner}[{objectQualifier}DesktopModules] AS DM ON MD.DesktopModuleID = DM.DesktopModuleID
     LEFT  JOIN {databaseOwner}[{objectQualifier}ContentItems]   AS CI ON M.ContentItemID = CI.ContentItemID
     LEFT  JOIN {databaseOwner}[{objectQualifier}TabModules]     AS TM ON M.ModuleID = TM.ModuleID
     LEFT  JOIN {databaseOwner}[{objectQualifier}Tabs]           AS T  ON TM.TabID = T.TabID
    WHERE (MC.ControlKey IS NULL)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModule]
    @TabModuleID	int
AS
    SELECT *
	FROM {databaseOwner}{objectQualifier}vw_TabModules        
    WHERE  TabModuleID = @TabModuleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles]
(
[Id] [int] NOT NULL IDENTITY(1, 1),
[PortalId] [int] NOT NULL,
[Name] [nvarchar] (50) NOT NULL,
[Width] [int] NOT NULL,
[Height] [int] NOT NULL,
[UserAgent] [nvarchar] (260) NOT NULL,
[SortOrder] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Mobile_PreviewProfiles_SortOrder] DEFAULT ((0)),
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}Mobile_PreviewProfiles_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}Mobile_PreviewProfiles_LastModifiedOnDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Mobile_PreviewProfiles] on {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles] ADD CONSTRAINT [PK_{objectQualifier}Mobile_PreviewProfiles] PRIMARY KEY CLUSTERED  ([Id])
GO
PRINT N'Creating index [IX_{objectQualifier}Mobile_PreviewProfiles_SortOrder] on {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Mobile_PreviewProfiles_SortOrder] ON {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles] ([SortOrder])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_DeletePreviewProfile]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_DeletePreviewProfile] @Id INT
AS 
		
    DELETE  FROM {databaseOwner}{objectQualifier}Mobile_PreviewProfiles
    WHERE   Id = @Id
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSchedule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSchedule]
	@ScheduleID int
	,@TypeFullName varchar(200)
	,@TimeLapse int
	,@TimeLapseMeasurement varchar(2)
	,@RetryTimeLapse int
	,@RetryTimeLapseMeasurement varchar(2)
	,@RetainHistoryNum int
	,@AttachToEvent varchar(50)
	,@CatchUpEnabled bit
	,@Enabled bit
	,@ObjectDependencies varchar(300)
	,@Servers varchar(150)
	,@LastModifiedByUserID	int
	,@FriendlyName varchar(200)
	,@ScheduleStartDate datetime
AS
UPDATE {databaseOwner}{objectQualifier}Schedule
	SET 
	TypeFullName = @TypeFullName
	,FriendlyName = @FriendlyName
	,TimeLapse = @TimeLapse
	,TimeLapseMeasurement = @TimeLapseMeasurement
	,RetryTimeLapse = @RetryTimeLapse
	,RetryTimeLapseMeasurement = @RetryTimeLapseMeasurement
	,RetainHistoryNum = @RetainHistoryNum
	,AttachToEvent = @AttachToEvent
	,CatchUpEnabled = @CatchUpEnabled
	,Enabled = @Enabled
	,ObjectDependencies = @ObjectDependencies
	,Servers = @Servers,
	[LastModifiedByUserID] = @LastModifiedByUserID,	
	[LastModifiedOnDate] = getdate(),
	ScheduleStartDate = @ScheduleStartDate
	WHERE ScheduleID = @ScheduleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetLanguages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetLanguages]
AS
	SELECT *
		FROM   {databaseOwner}{objectQualifier}Languages
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModuleSettings]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteModuleSettings]
@ModuleId      int
as

DELETE FROM {databaseOwner}{objectQualifier}ModuleSettings 
WHERE ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePropertyDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePropertyDefinition]

	@PropertyDefinitionId int

AS

UPDATE {databaseOwner}{objectQualifier}ProfilePropertyDefinition 
	SET Deleted = 1
	WHERE  PropertyDefinitionId = @PropertyDefinitionId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateDatabaseVersion]'
GO
create procedure {databaseOwner}[{objectQualifier}UpdateDatabaseVersion]

@Major  int,
@Minor  int,
@Build  int

as

insert into {databaseOwner}{objectQualifier}Version (
  Major,
  Minor,
  Build,
  CreatedDate
)
values (
  @Major,
  @Minor,
  @Build,
  getdate()
)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteRelationship]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteRelationship] @RelationshipID INT	
AS 
	BEGIN
		DELETE FROM {databaseOwner}{objectQualifier}Relationships  
			WHERE RelationshipID = @RelationshipID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SetEventMessageComplete]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SetEventMessageComplete]
	
	@EventMessageID int

AS
	UPDATE {databaseOwner}{objectQualifier}EventQueue
		SET IsComplete = 1
	WHERE EventMessageID = @EventMessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Types]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Journal_Types]
(
[JournalTypeId] [int] NOT NULL,
[JournalType] [nvarchar] (25) NULL,
[icon] [nvarchar] (25) NULL,
[PortalId] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}JournalTypes_PortalId] DEFAULT ((-1)),
[IsEnabled] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}JournalTypes_IsEnabled] DEFAULT ((1)),
[AppliesToProfile] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}JournalTypes_AppliesToProfile] DEFAULT ((1)),
[AppliesToGroup] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}JournalTypes_AppliesToGroup] DEFAULT ((1)),
[AppliesToStream] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}JournalTypes_AppliesToStream] DEFAULT ((1)),
[Options] [nvarchar] (max) NULL,
[SupportsNotify] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}JournalTypes_SupportsNotify] DEFAULT ((0)),
[EnableComments] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Journal_Types_EnableComments] DEFAULT ((1))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}JournalTypes] on {databaseOwner}[{objectQualifier}Journal_Types]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Types] ADD CONSTRAINT [PK_{objectQualifier}JournalTypes] PRIMARY KEY CLUSTERED  ([JournalTypeId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Types_List]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Types_List]
@PortalId int
AS
SELECT * 
FROM {databaseOwner}[{objectQualifier}Journal_Types]
WHERE (PortalId = -1 OR PortalId = @PortalId)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModuleSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModuleSettings]
    @ModuleId Int -- Null: settings from all modules
AS
	BEGIN
		SELECT
			MS.SettingName,
			CASE WHEN Lower(MS.SettingValue) LIKE 'fileid=%'
				 THEN {databaseOwner}{objectQualifier}FilePath(MS.SettingValue)
				 ELSE MS.SettingValue END           AS SettingValue
		FROM   {databaseOwner}[{objectQualifier}ModuleSettings] MS
		WHERE  ModuleID = @ModuleId or IsNull(@ModuleId, -1) = -1
		OPTION (OPTIMIZE FOR (@ModuleId UNKNOWN))
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}MetaData]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}MetaData]
(
[MetaDataID] [int] NOT NULL IDENTITY(1, 1),
[MetaDataName] [nvarchar] (100) NOT NULL,
[MetaDataDescription] [nvarchar] (2500) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}MetaData] on {databaseOwner}[{objectQualifier}MetaData]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}MetaData] ADD CONSTRAINT [PK_{objectQualifier}MetaData] PRIMARY KEY CLUSTERED  ([MetaDataID])
GO
PRINT N'Creating index [IX_{objectQualifier}MetaData_MetaDataName] on {databaseOwner}[{objectQualifier}MetaData]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}MetaData_MetaDataName] ON {databaseOwner}[{objectQualifier}MetaData] ([MetaDataName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentWorkflowStates]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStates]
(
[StateID] [int] NOT NULL IDENTITY(1, 1),
[WorkflowID] [int] NOT NULL,
[StateName] [nvarchar] (40) NOT NULL,
[Order] [int] NOT NULL,
[IsActive] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflowStates_IsActive] DEFAULT ((1)),
[SendEmail] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflowStates_SendEmail] DEFAULT ((0)),
[SendMessage] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflowStates_SendMessage] DEFAULT ((0)),
[IsDisposalState] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflowStates_IsDisposalState] DEFAULT ((0)),
[OnCompleteMessageSubject] [nvarchar] (256) NOT NULL CONSTRAINT [DF_ContentWorkflowStates_OnCompleteMessageSubject] DEFAULT (N''),
[OnCompleteMessageBody] [nvarchar] (1024) NOT NULL CONSTRAINT [DF_ContentWorkflowStates_OnCompleteMessageBody] DEFAULT (N''),
[OnDiscardMessageSubject] [nvarchar] (256) NOT NULL CONSTRAINT [DF_ContentWorkflowStates_OnDiscardMessageSubject] DEFAULT (N''),
[OnDiscardMessageBody] [nvarchar] (1024) NOT NULL CONSTRAINT [DF_ContentWorkflowStates_OnDiscardMessageBody] DEFAULT (N''),
[IsSystem] [bit] NOT NULL DEFAULT ((0)),
[SendNotification] [bit] NOT NULL DEFAULT ((1)),
[SendNotificationToAdministrators] [bit] NOT NULL DEFAULT ((1))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentWorkflowStates] on {databaseOwner}[{objectQualifier}ContentWorkflowStates]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStates] ADD CONSTRAINT [PK_{objectQualifier}ContentWorkflowStates] PRIMARY KEY CLUSTERED  ([StateID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}ContentWorkflowStates]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStates] ADD CONSTRAINT [IX_{objectQualifier}ContentWorkflowStates] UNIQUE NONCLUSTERED  ([WorkflowID], [StateName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentWorkflows]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentWorkflows]
(
[WorkflowID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[WorkflowName] [nvarchar] (40) NOT NULL,
[Description] [nvarchar] (256) NULL,
[IsDeleted] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflows_IsDeleted] DEFAULT ((0)),
[StartAfterCreating] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflows_StartAfterCreating] DEFAULT ((1)),
[StartAfterEditing] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflows_StartAfterEditing] DEFAULT ((1)),
[DispositionEnabled] [bit] NOT NULL CONSTRAINT [DF_ContentWorkflows_DispositionEnabled] DEFAULT ((0)),
[IsSystem] [bit] NOT NULL DEFAULT ((0)),
[WorkflowKey] [nvarchar] (40) NOT NULL DEFAULT (N'')
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentWorkflows] on {databaseOwner}[{objectQualifier}ContentWorkflows]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflows] ADD CONSTRAINT [PK_{objectQualifier}ContentWorkflows] PRIMARY KEY CLUSTERED  ([WorkflowID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}ContentWorkflows]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflows] ADD CONSTRAINT [IX_{objectQualifier}ContentWorkflows] UNIQUE NONCLUSTERED  ([PortalID], [WorkflowName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentItems_MetaData]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentItems_MetaData]
(
[ContentItemMetaDataID] [int] NOT NULL IDENTITY(1, 1),
[ContentItemID] [int] NOT NULL,
[MetaDataID] [int] NOT NULL,
[MetaDataValue] [nvarchar] (max) NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Content_MetaData] on {databaseOwner}[{objectQualifier}ContentItems_MetaData]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems_MetaData] ADD CONSTRAINT [PK_{objectQualifier}Content_MetaData] PRIMARY KEY CLUSTERED  ([ContentItemMetaDataID])
GO
PRINT N'Creating index [IX_{objectQualifier}ContentItems_MetaData_ContentItemId] on {databaseOwner}[{objectQualifier}ContentItems_MetaData]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ContentItems_MetaData_ContentItemId] ON {databaseOwner}[{objectQualifier}ContentItems_MetaData] ([ContentItemID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_ContentWorkflowUsage]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_ContentWorkflowUsage]
AS
    SELECT COALESCE(cm.MetaDataValue, ci.Content) as 'ContentName', ct.ContentType, ws.WorkflowID 
	FROM {databaseOwner}[{objectQualifier}ContentItems] ci
		INNER JOIN {databaseOwner}[{objectQualifier}ContentTypes] ct
			ON ci.ContentTypeID = ct.ContentTypeID
		INNER JOIN {databaseOwner}[{objectQualifier}ContentWorkflowStates] ws 
			ON ci.StateID = ws.StateID
		LEFT JOIN {databaseOwner}[{objectQualifier}ContentItems_MetaData] cm
			ON ci.ContentItemID = cm.ContentItemID 
				AND cm.MetaDataID = (SELECT MetaDataID FROM {databaseOwner}[{objectQualifier}MetaData] WHERE MetaDataName = 'Title')
	WHERE ct.ContentType != 'Tab' -- Tabs will be managed specifically
		AND ct.ContentType != 'File' -- Exclude Files
	UNION ALL
	SELECT t.TabPath, ct.ContentType, ws.WorkflowID 
	FROM {databaseOwner}[{objectQualifier}ContentItems] ci
		INNER JOIN {databaseOwner}[{objectQualifier}ContentTypes] ct
			ON ci.ContentTypeID = ct.ContentTypeID
		INNER JOIN {databaseOwner}[{objectQualifier}Tabs] t
			ON ci.TabID = t.TabID
		INNER JOIN {databaseOwner}[{objectQualifier}ContentWorkflowStates] ws 
			ON ci.StateID = ws.StateID
	WHERE ct.ContentType = 'Tab'
		AND LOWER(t.TabPath) not like '//admin/%'
		AND LOWER(t.TabPath) != '//admin'
		AND t.IsSystem = 0
		AND LOWER(t.TabPath) not like '//host/%'
		AND LOWER(t.TabPath) != '//host'
		AND ci.StateID IS NOT NULL
	UNION ALL
	SELECT t.TabPath, ct.ContentType, 
		(SELECT CAST(ps.SettingValue AS INT) value 
			FROM {databaseOwner}[{objectQualifier}PortalSettings] ps
			WHERE ps.SettingName = 'DefaultTabWorkflowKey' 
			AND ps.PortalID = t.PortalID) as WorkflowID 
	FROM {databaseOwner}[{objectQualifier}ContentItems] ci
		INNER JOIN {databaseOwner}[{objectQualifier}ContentTypes] ct
			ON ci.ContentTypeID = ct.ContentTypeID
		INNER JOIN {databaseOwner}[{objectQualifier}Tabs] t
			ON ci.TabID = t.TabID
	WHERE ct.ContentType = 'Tab'
		AND LOWER(t.TabPath) NOT LIKE '//admin/%'
		AND LOWER(t.TabPath) != '//admin'
		AND t.IsSystem = 0
		AND LOWER(t.TabPath) NOT LIKE '//host/%'
		AND LOWER(t.TabPath) != '//host'
		AND ci.StateID IS NULL
	UNION ALL
	SELECT '/' + f.FolderPath, 'Folder', f.WorkflowID 
	FROM {databaseOwner}[{objectQualifier}Folders] f
	WHERE f.WorkflowID IS NOT NULL
	UNION ALL
	SELECT '/' + f.FolderPath, 'Folder', 
		(SELECT wf.WorkflowID 
			FROM {databaseOwner}[{objectQualifier}ContentWorkflows] wf
			WHERE wf.WorkflowKey = 'DirectPublish' 
			AND wf.PortalID = f.PortalID) AS WorkflowID 
	FROM {databaseOwner}[{objectQualifier}Folders] f
	WHERE f.WorkflowID IS NULL
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowUsage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowUsage]
	@WorkflowId INT,
	@PageIndex INT,
	@PageSize INT
AS
	DECLARE @StartIndex INT = ((@PageIndex - 1) * @PageSize) + 1
	DECLARE @EndIndex INT = (@PageIndex * @PageSize)
	
	;WITH ContenResourcesSet AS
    (
		SELECT wu.*, ROW_NUMBER() OVER (Order BY wu.ContentType, wu.ContentName) AS [Index]
		FROM {databaseOwner}[{objectQualifier}vw_ContentWorkflowUsage] wu 		
		WHERE wu.WorkflowID = @WorkflowId
    )
   SELECT * FROM ContenResourcesSet WHERE [Index] BETWEEN @StartIndex AND @EndIndex
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Types_Save]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Types_Save]
@JournalTypeId int,
@JournalType nvarchar(25),
@icon nvarchar(25),
@PortalId int,
@IsEnabled bit,
@AppliesToProfile bit,
@AppliesToGroup bit,
@AppliesToStream bit,
@options nvarchar(max),
@SupportsNotify bit
AS
IF EXISTS(SELECT JournalTypeId from {databaseOwner}[{objectQualifier}Journal_Types] WHERE JournalTypeId=@JournalTypeId AND PortalId = @PortalId)
	BEGIN
		UPDATE {databaseOwner}[{objectQualifier}Journal_Types]
			SET
				JournalType=@JournalType,
				icon=@icon,
				IsEnabled = @IsEnabled,
				AppliesToProfile = @AppliesToProfile,
				AppliesToGroup = @AppliesToGroup,
				AppliesToStream = @AppliesToStream,
				Options = @options,
				SupportsNotify = @SupportsNotify
			WHERE
				PortalId = @PortalId AND JournalTypeId = @JournalTypeId
	END
ELSE
	BEGIN
		SET @JournalTypeId = (SELECT MAX(JournalTypeId)+1 FROM {databaseOwner}[{objectQualifier}Journal_Types])
		INSERT INTO {databaseOwner}[{objectQualifier}Journal_Types]
			(JournalTypeId, JournalType, icon, PortalId, IsEnabled, AppliesToProfile, AppliesToGroup, AppliesToStream, Options, SupportsNotify)
			VALUES
			(@JournalTypeId, @JournalType, @icon, @PortalId, @IsEnabled, @AppliesToProfile, @AppliesToGroup, @AppliesToStream, @options, @SupportsNotify)
	END
SELECT @JournalTypeId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteAuthentication]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteAuthentication]
	@AuthenticationID int
AS
	DECLARE @AuthType nvarchar(100)
	SET @AuthType = (SELECT AuthenticationType FROM {databaseOwner}{objectQualifier}Authentication WHERE AuthenticationID = @AuthenticationID)
	
	-- Delete UserAuthentication rows
	IF (@AuthType Is Not Null)
		BEGIN
			DELETE FROM {databaseOwner}{objectQualifier}UserAuthentication
				WHERE AuthenticationType = @AuthType
		END

	-- Delete Record
	DELETE 
		FROM   {databaseOwner}{objectQualifier}Authentication
		WHERE AuthenticationID = @AuthenticationID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModuleSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModuleSetting]
    @ModuleId      Int,          -- not null!
    @SettingName   nVarChar(50)  -- not null or empty!
AS
	BEGIN
		SELECT
			MS.SettingName,
			CASE WHEN Lower(MS.SettingValue) LIKE 'fileid=%'
				 THEN {databaseOwner}{objectQualifier}FilePath(MS.SettingValue)
				 ELSE MS.SettingValue  END AS SettingValue
		FROM {databaseOwner}[{objectQualifier}ModuleSettings] MS
		WHERE  ModuleID = @ModuleId AND SettingName = @SettingName
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowUsageCount]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowUsageCount]
	@WorkflowId INT
AS
	SELECT COUNT(*)
	FROM {databaseOwner}[{objectQualifier}vw_ContentWorkflowUsage] wu 	
	WHERE wu.WorkflowID = @WorkflowId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPermissions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPermissions]
AS
	SELECT * FROM {databaseOwner}{objectQualifier}Permission
	ORDER BY ViewOrder
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModuleSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModuleSettings]
    @TabModuleId Int -- Null: all tabmodules
AS
	BEGIN
		SELECT
			TMS.SettingName,
			CASE WHEN Lower(TMS.SettingValue) LIKE 'fileid=%'
				 THEN {databaseOwner}{objectQualifier}FilePath(TMS.SettingValue)
				 ELSE TMS.SettingValue END           AS SettingValue
		FROM   {databaseOwner}[{objectQualifier}TabModuleSettings] TMS
		WHERE  TabModuleID = @TabModuleId OR IsNull(@TabModuleId, -1) = -1
		OPTION (OPTIMIZE FOR (@TabModuleId UNKNOWN))
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]
(
[NotificationTypeID] [int] NOT NULL IDENTITY(1, 1),
[Name] [nvarchar] (100) NOT NULL,
[Description] [nvarchar] (2000) NULL,
[TTL] [int] NULL,
[DesktopModuleID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL,
[IsTask] [bit] NOT NULL DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_NotificationTypes] on {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_NotificationTypes] PRIMARY KEY CLUSTERED  ([NotificationTypeID])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_NotificationTypes] on {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_NotificationTypes] ON {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes] ([Name])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]
(
[NotificationTypeActionID] [int] NOT NULL IDENTITY(1, 1),
[NotificationTypeID] [int] NOT NULL,
[NameResourceKey] [nvarchar] (100) NOT NULL,
[DescriptionResourceKey] [nvarchar] (100) NULL,
[ConfirmResourceKey] [nvarchar] (100) NULL,
[Order] [int] NOT NULL,
[APICall] [nvarchar] (500) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}CoreMessaging_NotificationTypeActions] on {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions] ADD CONSTRAINT [PK_{objectQualifier}CoreMessaging_NotificationTypeActions] PRIMARY KEY CLUSTERED  ([NotificationTypeActionID])
GO
PRINT N'Creating index [IX_{objectQualifier}CoreMessaging_NotificationTypeActions] on {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}CoreMessaging_NotificationTypeActions] ON {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions] ([NotificationTypeID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteNotificationType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteNotificationType]
	@NotificationTypeID int
AS
BEGIN
	-- First delete related data
	DELETE
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages]
	WHERE [NotificationTypeID] = @NotificationTypeID
	
	DELETE
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]
	WHERE [NotificationTypeID] = @NotificationTypeID

	-- Finally delete the Notification type
	DELETE
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]
	WHERE [NotificationTypeID] = @NotificationTypeID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RoleSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}RoleSettings]
(
[RoleSettingID] [int] NOT NULL IDENTITY(1, 1),
[RoleID] [int] NOT NULL,
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (2000) NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}RoleSettings_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}RoleSettings_LastModifiedOnDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}RoleSettings] on {databaseOwner}[{objectQualifier}RoleSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}RoleSettings] ADD CONSTRAINT [PK_{objectQualifier}RoleSettings] PRIMARY KEY CLUSTERED  ([RoleSettingID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRoleSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRoleSettings]
	@RoleId     int

AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}RoleSettings
	WHERE  RoleID = @RoleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalAliases]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalAliases]
AS
	SELECT * FROM {databaseOwner}{objectQualifier}PortalAlias
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModuleSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModuleSetting]
    @TabModuleId   Int,              -- not null!
    @SettingName   nVarChar(50)      -- not null or empty!
AS
	BEGIN
		SELECT
			TMS.SettingName,
			CASE WHEN TMS.SettingValue LIKE 'fileid%'
				 THEN {databaseOwner}{objectQualifier}FilePath(TMS.SettingValue)
				 ELSE TMS.SettingValue  END AS SettingValue
		FROM {databaseOwner}[{objectQualifier}TabModuleSettings] TMS
		WHERE  TabModuleID = @TabModuleId AND SettingName = @SettingName
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteContentType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteContentType] 
	@ContentTypeId	int
AS
	DELETE FROM {databaseOwner}{objectQualifier}ContentTypes
	WHERE ContentTypeId = @ContentTypeId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPortalInfo]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPortalInfo]
	@PortalName         nvarchar(128),
	@Currency           char(3),
	@ExpiryDate         datetime,
	@HostFee            money,
	@HostSpace          int,
	@PageQuota          int,
	@UserQuota          int,
	@SiteLogHistory     int,
	@HomeDirectory		varchar(100),
	@CultureCode		nvarchar(50),
	@CreatedByUserID	int
AS

DECLARE @PortalID int

insert into {databaseOwner}{objectQualifier}Portals (
  ExpiryDate,
  UserRegistration,
  BannerAdvertising,
  Currency,
  HostFee,
  HostSpace,
  PageQuota,
  UserQuota,
  SiteLogHistory,
  DefaultLanguage,
  HomeDirectory,
  CreatedByUserID,
  CreatedOnDate,
  LastModifiedByUserID,
  LastModifiedOnDate
)
values (
  @ExpiryDate,
  0,
  0,
  @Currency,
  @HostFee,
  @HostSpace,
  @PageQuota,
  @UserQuota,
  @SiteLogHistory,
  @CultureCode,
  @HomeDirectory,
  @CreatedByUserID,
  getdate(),
  @CreatedByUserID,
  getdate()
)

SET @PortalID = SCOPE_IDENTITY()

IF @HomeDirectory = ''
BEGIN
	UPDATE {databaseOwner}{objectQualifier}Portals SET HomeDirectory = 'Portals/' + convert(varchar(10), @PortalID) WHERE PortalID = @PortalID
END

insert into {databaseOwner}{objectQualifier}PortalLocalization (PortalID,CultureCode,PortalName,Description,KeyWords)
			values (@PortalID,@CultureCode,@PortalName,@PortalName,@PortalName)
           
  
SELECT @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_TypeFilters]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Journal_TypeFilters]
(
[JournalTypeFilterId] [int] NOT NULL IDENTITY(1, 1),
[PortalId] [int] NOT NULL,
[ModuleId] [int] NOT NULL,
[JournalTypeId] [int] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Journal_TypeFilters] on {databaseOwner}[{objectQualifier}Journal_TypeFilters]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_TypeFilters] ADD CONSTRAINT [PK_{objectQualifier}Journal_TypeFilters] PRIMARY KEY CLUSTERED  ([JournalTypeFilterId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Security]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Journal_Security]
(
[JournalSecurityId] [int] NOT NULL IDENTITY(1, 1),
[JournalId] [int] NOT NULL,
[SecurityKey] [nvarchar] (50) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Journal_Security] on {databaseOwner}[{objectQualifier}Journal_Security]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Security] ADD CONSTRAINT [PK_{objectQualifier}Journal_Security] PRIMARY KEY CLUSTERED  ([JournalSecurityId])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Journal_Security]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Security] ADD CONSTRAINT [IX_{objectQualifier}Journal_Security] UNIQUE NONCLUSTERED  ([JournalId] DESC, [SecurityKey])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Journal]
(
[JournalId] [int] NOT NULL IDENTITY(1, 1),
[JournalTypeId] [int] NOT NULL,
[UserId] [int] NULL,
[DateCreated] [datetime] NULL,
[DateUpdated] [datetime] NULL,
[PortalId] [int] NULL,
[ProfileId] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Journal_ProfileId] DEFAULT ((-1)),
[GroupId] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Journal_GroupId] DEFAULT ((-1)),
[Title] [nvarchar] (255) NULL,
[Summary] [nvarchar] (2000) NULL,
[ItemData] [nvarchar] (2000) NULL,
[ImageURL] [nvarchar] (255) NULL,
[ObjectKey] [nvarchar] (255) NULL,
[AccessKey] [uniqueidentifier] NULL,
[ContentItemId] [int] NULL,
[IsDeleted] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Journal_IsDeleted] DEFAULT ((0)),
[CommentsDisabled] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Journal_CommentsDisabled] DEFAULT ((0)),
[CommentsHidden] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}Journal_CommentsHidden] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Journal] on {databaseOwner}[{objectQualifier}Journal]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal] ADD CONSTRAINT [PK_{objectQualifier}Journal] PRIMARY KEY CLUSTERED  ([JournalId])
GO
PRINT N'Creating index [IX_{objectQualifier}Journal_ContentItemId] on {databaseOwner}[{objectQualifier}Journal]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Journal_ContentItemId] ON {databaseOwner}[{objectQualifier}Journal] ([ContentItemId]) INCLUDE ([GroupId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Types_Delete]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Types_Delete]
@JournalTypeId int,
@PortalId int
AS
IF @JournalTypeId > 200
	BEGIN
		DELETE FROM {databaseOwner}[{objectQualifier}Journal_Security]
		WHERE JournalId IN (SELECT JournalId FROM {databaseOwner}[{objectQualifier}Journal] WHERE JournalTypeId=@JournalTypeId AND PortalId=@PortalId)
		DELETE FROM {databaseOwner}[{objectQualifier}Journal]
		WHERE 
			JournalTypeId = @JournalTypeId 
			AND 
			PortalId = @PortalId
		DELETE FROM {databaseOwner}[{objectQualifier}Journal_TypeFilters]
		WHERE
			JournalTypeId = @JournalTypeId
			AND 
			PortalId = @PortalId
		DELETE FROM {databaseOwner}[{objectQualifier}Journal_Types]
		WHERE 
			JournalTypeId = @JournalTypeId
			AND
			PortalId = @PortalId
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteMetaData]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteMetaData] 
	@ContentItemId		int,
	@Name				nvarchar(100),
	@Value				nvarchar(MAX)
	
AS
	DELETE FROM {databaseOwner}{objectQualifier}ContentItems_MetaData
	FROM {databaseOwner}{objectQualifier}ContentItems_MetaData AS cm
		INNER JOIN {databaseOwner}{objectQualifier}MetaData AS m ON cm.MetaDataID = m.MetaDataID
	WHERE cm.ContentItemId = @ContentItemId AND m.MetaDataName = @Name AND cm.MetaDataValue = @Value
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteEventLogType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteEventLogType]
	@LogTypeKey nvarchar(35)
AS
DELETE FROM {databaseOwner}{objectQualifier}EventLogTypes
WHERE	LogTypeKey = @LogTypeKey
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Delete]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Delete]
	@JournalId int,
	@SoftDelete int = 0
	AS

	-- Hard Delete
	IF @SoftDelete <> 1 
	BEGIN
		DELETE FROM {databaseOwner}[{objectQualifier}Journal_Security] WHERE JournalId = @JournalId
		DELETE FROM {databaseOwner}[{objectQualifier}Journal_Comments] WHERE JournalId = @JournalId
		DELETE FROM {databaseOwner}[{objectQualifier}Journal] WHERE JournalId = @JournalId
	END

	-- Soft Delete
	IF @SoftDelete = 1 
	BEGIN
		UPDATE {databaseOwner}[{objectQualifier}Journal] SET IsDeleted = 1 WHERE JournalId = @JournalId
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Types_GetById]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Types_GetById]
@JournalTypeId int
AS
SELECT * from {databaseOwner}[{objectQualifier}Journal_Types] WHERE JournalTypeId = @JournalTypeId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Urls]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Urls]
(
[UrlID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[Url] [nvarchar] (255) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Urls] on {databaseOwner}[{objectQualifier}Urls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Urls] ADD CONSTRAINT [PK_{objectQualifier}Urls] PRIMARY KEY CLUSTERED  ([UrlID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}Urls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Urls] ADD CONSTRAINT [IX_{objectQualifier}Urls] UNIQUE NONCLUSTERED  ([Url], [PortalID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteUrl]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteUrl]

@PortalID     int,
@Url          nvarchar(255)

as

delete
from   {databaseOwner}{objectQualifier}Urls
where  PortalID = @PortalID
and    Url = @Url
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabModuleSetting]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteTabModuleSetting]
@TabModuleId      int,
@SettingName   nvarchar(50)
as

DELETE FROM {objectQualifier}TabModuleSettings 
WHERE TabModuleId = @TabModuleId
AND SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabSetting]

    @TabId         Int,         -- not null!
    @SettingName   nVarChar(50) -- not null or empty!

AS
	BEGIN
		SELECT
			TS.SettingName,
			CASE WHEN TS.SettingValue LIKE 'fileid%'
				 THEN {databaseOwner}{objectQualifier}FilePath(TS.SettingValue)
				 ELSE TS.SettingValue  END AS SettingValue
		FROM {databaseOwner}[{objectQualifier}TabSettings] TS
		WHERE  TabID = @TabId AND SettingName = @SettingName
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteVocabulary]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteVocabulary] 
	@VocabularyID			int
AS
	DELETE FROM {databaseOwner}{objectQualifier}Taxonomy_Vocabularies
	WHERE VocabularyID = @VocabularyID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_DeleteByGroupId]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_DeleteByGroupId]
	@PortalId int,
	@GroupId int,
	@SoftDelete int = 0
	AS

	-- Hard Delete
	IF @SoftDelete <> 1 
	BEGIN
		DELETE {databaseOwner}[{objectQualifier}Journal_Security] 
		FROM {databaseOwner}[{objectQualifier}Journal_Security] as js  INNER JOIN {databaseOwner}[{objectQualifier}Journal] as j 
		   ON js.JournalId = j.JournalId
		WHERE j.PortalId = @PortalId AND j.GroupId = @GroupId AND @GroupId > 0 AND j.GroupId IS NOT NULL

		DELETE {databaseOwner}[{objectQualifier}Journal_Comments] 
		FROM {databaseOwner}[{objectQualifier}Journal_Comments] as jc  INNER JOIN {databaseOwner}[{objectQualifier}Journal] as j 
		   ON jc.JournalId = j.JournalId
		WHERE j.PortalId = @PortalId AND j.GroupId = @GroupId AND @GroupId > 0 AND j.GroupId IS NOT NULL

		DELETE FROM {databaseOwner}[{objectQualifier}Journal] WHERE PortalId = @PortalId AND GroupId = @GroupId AND @GroupId > 0 AND GroupId IS NOT NULL
	END

	-- Soft Delete
	IF @SoftDelete = 1 
	BEGIN
		UPDATE {databaseOwner}[{objectQualifier}Journal] SET IsDeleted = 1 WHERE PortalId = @PortalId AND GroupId = @GroupId AND @GroupId > 0 AND GroupId IS NOT NULL
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateRoleSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateRoleSetting]
	@RoleID				int,
	@SettingName		nvarchar(50),
	@SettingValue		nvarchar(2000),
	@UserID				int

AS
	IF (SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}RoleSettings WHERE RoleID = @RoleID AND SettingName = @SettingName) > 0
		--Update
		UPDATE  {databaseOwner}{objectQualifier}RoleSettings
			SET SettingValue = @SettingValue,
				[LastModifiedByUserID]=@UserID,
				[LastModifiedOnDate]=getdate()
		WHERE RoleID = @RoleID
			AND SettingName = @SettingName
			
	ELSE
		--Add
		INSERT INTO {databaseOwner}{objectQualifier}RoleSettings 
		( 
			RoleID, 
			SettingName, 
			SettingValue, 
			CreatedByUserID, 
			CreatedOnDate, 
			LastModifiedByUserID, 
			LastModifiedOnDate
		) 
		VALUES 
		( 
			@RoleID, 
			@SettingName,
			@SettingValue ,
			@UserID ,
			getdate() ,
			@UserID,
			getdate()
		)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SortFieldSQL]'
GO
-- added, provides more flexibility, e.g. may be called again for multiple sort columns
CREATE FUNCTION {databaseOwner}[{objectQualifier}SortFieldSQL]
(
    @SortBy        nVarChar(100), -- should be a field name
    @SortAscending Bit,			  -- ascending or descending?
    @Default       nVarChar(100)  -- name of field to be used if @sortby is empty
)
	RETURNS 	   nVarChar(110)
AS
	BEGIN
		DECLARE @sortSql nVarChar(110) =  ''
		IF IsNull(@SortBy, '') = ''
			SET @SortBy = IsNull(@Default, '')
		IF @SortBy <>  ''
			SET @sortSql = N'[' + @SortBy + CASE WHEN IsNull(@SortAscending, 1) = 0 THEN N'] DESC' ELSE N'] ASC' END
		RETURN @sortSql
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FormattedString]'
GO
-- added for easier string handling
CREATE FUNCTION {databaseOwner}[{objectQualifier}FormattedString]
(
    @InputStr nVarChar(2000), -- might be null or empty, in this case an empty string is returned (format ignored)!
    @Format   nVarChar(2000)  -- not null or empty, contains token @@@
)
	RETURNS   nVarChar(4000)  -- replaced string, e.g. FormattedString('World', 'Hello @0!') returns 'Hello World!' 
AS
BEGIN
	DECLARE @RetVal AS nVarChar(4000) = ''
	IF NOT IsNull(@InputStr,'') = ''
		SET @retVal = REPLACE(@Format, N'@0', @InputStr)
	RETURN @RetVal
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSortSQL]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetSortSQL]
(   -- deprecated, please call SortFieldSQL and FormattedString instead
    @SortBy        nVarChar(100),
    @SortAscending Bit,
    @Default       nVarChar(100)
)
	RETURNS 	   nVarChar(120)
AS
	BEGIN
		RETURN {databaseOwner}[{objectQualifier}FormattedString]({databaseOwner}[{objectQualifier}SortFieldSQL](@SortBy, @SortAscending, @Default), N'ORDER BY @0')
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetProfileFieldSQL]'
GO
-- results order added
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetProfileFieldSQL]
(
    @PortalID 	 Int,
    @TemplateSql nVarChar(max)
)
	RETURNS 	 nVarChar(max)
AS
	BEGIN
		DECLARE @sql nVarChar(max);

		SELECT @sql = COALESCE(@sql + ',','') + '[' + PropertyName + ']' + @TemplateSql
		 FROM {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]
		 WHERE IsNull(PortalID, -1) = IsNull(@PortalID, -1)
		   AND Deleted = 0
		ORDER BY ViewOrder
		RETURN (@sql)
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersBasicSearch]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUsersBasicSearch]
(
	@PortalID int,					-- portal
	@PageSize int,					-- page size
	@PageIndex int,					-- 0 based page index
	@SortBy nvarchar(100),			-- sort field
	@SortAscending bit,				-- sort flag indicating whether sort is asc or desc
	@PropertyName nvarchar(256),    -- property to filter by (username, diaplayname, email)
	@PropertyValue nvarchar(256)	-- value of property
)
AS
	-- Set up Top XX
	DECLARE @topSql nvarchar(20)
	SET @topSql = CONVERT(nvarchar(20), @PageSize)

	--Set up Count
	DECLARE @minRowNumberSql nvarchar(20)
	SET @minRowNumberSql =  CONVERT(nvarchar(20), ((@PageIndex * @PageSize) + 1))

	-- Set up Sort
	DECLARE @sortSql nvarchar(1000)
	SET @sortSql = {databaseOwner}{objectQualifier}GetSortSql(@SortBy, @SortAscending, 'UserID')

	-- Setup Pivot Field List
	DECLARE @pivotSql nvarchar(max)
	SELECT @pivotSql = {databaseOwner}{objectQualifier}GetProfileFieldSql(@PortalID, '')

	-- Setup FieldName Field List for temporary table
	DECLARE @fieldNames nvarchar(max)
	SELECT @fieldNames = {databaseOwner}{objectQualifier}GetProfileFieldSql(@PortalID, ' nvarchar(max)')

	DECLARE @sql nvarchar(max)
	SELECT @sql=
				'
					DECLARE @pivotedUsers TABLE
					(
						RowNumber int,
						UserID int,
						PortalID int,
						Username nvarchar(100),
						Email nvarchar(256),
						DisplayName nvarchar(128),
						IsSuperUser bit,
						IsDeleted bit,
						AffiliateID int,
						UpdatePassword bit,
						Authorised bit,
						' + @fieldNames + '
					);

					WITH TempUsers
					AS
					(
						SELECT TOP ' + @topSql + ' * FROM (
							SELECT
								ROW_NUMBER() OVER(' + @sortSql + ') AS RowNumber,
								U.UserID,
								U.PortalID,
								U.Username,
								U.Email,
								U.DisplayName,
								U.IsSuperUser,
								U.IsDeleted,
								U.AffiliateID,
								U.UpdatePassword,
								U.Authorised
								FROM {databaseOwner}{objectQualifier}vw_Users AS U
							WHERE (U.PortalID = ' + CONVERT(nvarchar(20), @PortalID) + ' OR U.PortalID Is NULL )
								AND ((U.' + @PropertyName + ' LIKE N''' + @PropertyValue + '%'')
									OR (U.' + @PropertyName + ' LIKE N''% ' + @PropertyValue + '%''))
								AND U.IsDeleted = 0
						) AS U
						WHERE RowNumber >= ' + @minRowNumberSql + '
					),
					TempUsersWithProfile
					AS
					(
						SELECT
							U.UserID,
							U.PortalID,
							U.Username,
							U.Email,
							U.DisplayName,
							U.IsSuperUser,
							U.IsDeleted,
							U.AffiliateID,
							U.UpdatePassword,
							U.Authorised,
							P.PropertyName,
							P.PropertyValue
						FROM TempUsers U
							INNER JOIN {databaseOwner}{objectQualifier}vw_Profile P ON P.UserID = U.UserID
					)
				    SELECT  * FROM (
					    SELECT  * FROM TempUsersWithProfile
					    PIVOT
					    (
						    MAX(PropertyValue) for PropertyName in (' + @pivotSql + ')
					    ) as pivotTable
                    ) T
					' + @sortSql
	EXEC(@sql)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Types_Get]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Types_Get]
@JournalType nvarchar(25)
AS
SELECT * from {databaseOwner}[{objectQualifier}Journal_Types] WHERE JournalType = @JournalType
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetLastSentMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetLastSentMessage]
	@UserID int,
	@PortalID INT
AS
BEGIN
	SELECT TOP 1 *	
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages]
	WHERE SenderUserID = @UserID	
	AND PortalID=@PortalID
	AND NotificationTypeID IS NULL
	ORDER BY MessageID DESC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileByUniqueID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFileByUniqueID]
    @UniqueID   uniqueidentifier
AS
	SELECT	* 
	FROM	{databaseOwner}{objectQualifier}Files
	WHERE	UniqueID = @UniqueID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CalculatePagingInformation]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CalculatePagingInformation]
-- this procedure is deprecated, please use more efficient functions pageLowerBound AND pageUpperBound instead!
-- 2147483647 = Cast(0x7fffffff AS Int)
	@pageIndex 		Int, 	    -- negative to return all rows!
	@pageSize 		Int, 		-- negative OR 0 returns all rows
	@rowsToReturn  	Int output, -- row number of record AFTER last row (0 based) 
	@pageLowerBound Int output, -- row number of first record (0 based)
	@pageUpperBound Int output  -- row number of record AFTER last row (1 based)
AS
BEGIN 
	IF IsNull(@pageSize, 2147483647) < 2147483647 AND IsNull(@PageIndex, -1) >= 0 BEGIN
		SET @pageLowerBound = {databaseOwner}{objectQualifier}pageLowerBound(@pageIndex, @pageSize) - 1
		SET @rowsToReturn   = {databaseOwner}{objectQualifier}pageUpperBound(@pageIndex, @pageSize) 
		SET @pageUpperBound = @rowsToReturn + 1 
	END ELSE BEGIN
		SET @pageLowerBound = 0
		SET @rowsToReturn   = 2147483647 
		SET @pageUpperBound = 2147483647 
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersByEmail]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUsersByEmail]
	@PortalID  int,
	@EmailToMatch   nvarchar(256),
	@PageIndex      int,
	@PageSize       INT,
	@IncludeDeleted bit,
	@SuperUsersOnly bit		
AS
BEGIN
		-- Set the page bounds
		DECLARE 
			@PageLowerBound INT, 
			@PageUpperBound INT, 
			@RowsToReturn int, 
			@TotalRecords int

		exec {databaseOwner}{objectQualifier}CalculatePagingInformation @PageIndex, @PageSize, @RowsToReturn output, @PageLowerBound output, @PageUpperBound output

		declare @tblPageIndex table (
			IndexId int IDENTITY (0, 1) NOT NULL primary key,
			UserId int
		 )

		if @PortalId is null and @EmailToMatch IS NULL
			begin
				with [UsersByEmail] as (
					SELECT U.*, ROW_NUMBER() OVER (ORDER BY Email ASC) AS ROWID
						FROM    {databaseOwner}{objectQualifier}vw_Users U
						WHERE U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
							AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				)
				select *, ROWID - 1 AS IndexID, UserID 
					from [UsersByEmail]
					where ROWID > @PageLowerBound AND ROWID < @PageUpperBound
			end
		else if @PortalId is null and @EmailToMatch IS NOT NULL 
			begin
				with [UsersByEmail] as (
					SELECT U.*, ROW_NUMBER() OVER (ORDER BY Email ASC) AS ROWID
						FROM    {databaseOwner}{objectQualifier}vw_Users U
						WHERE LOWER(U.Email) LIKE LOWER(@EmailToMatch)
							AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
					)
					select *, ROWID - 1 AS IndexID, UserID 
						from [UsersByEmail]
						where ROWID > @PageLowerBound AND ROWID < @PageUpperBound
			end
		else if @EmailToMatch IS NULL 
			begin
				with [UsersByEmail] as (
					SELECT U.*, ROW_NUMBER() OVER (ORDER BY Email ASC) AS ROWID
						FROM    {databaseOwner}{objectQualifier}vw_Users U
						WHERE U.PortalId = @PortalID
							AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				)
				select *, ROWID - 1 AS IndexID, UserID 
					from [UsersByEmail]
					where ROWID > @PageLowerBound AND ROWID < @PageUpperBound
		  end
		else
			begin
				with [UsersByEmail] as (
					SELECT U.*, ROW_NUMBER() OVER (ORDER BY Email ASC) AS ROWID
						FROM    {databaseOwner}{objectQualifier}vw_Users U
						WHERE U.PortalId = @PortalID
							AND LOWER(U.Email) LIKE LOWER(@EmailToMatch)
							AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				)
				select *, ROWID - 1 AS IndexID, UserID 
					from [UsersByEmail]
					where ROWID > @PageLowerBound AND ROWID < @PageUpperBound
			end
	 
		if @PortalId is null and @EmailToMatch IS NULL
			begin
				SELECT count(*) as TotalRecords
					FROM    {databaseOwner}{objectQualifier}vw_Users U
					WHERE U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
						AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
			end 
		else if @PortalId is null and @EmailToMatch IS NOT NULL 
			begin
				SELECT count(*) as TotalRecords
					FROM    {databaseOwner}{objectQualifier}vw_Users U
					WHERE LOWER(U.Email) LIKE LOWER(@EmailToMatch)
						AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
						AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
			end 
		else if @EmailToMatch IS NULL 
			begin
				SELECT count(*) as TotalRecords
					FROM    {databaseOwner}{objectQualifier}vw_Users U
					WHERE U.PortalId = @PortalID
						AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
						AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
			end 
		else 
			begin
				SELECT count(*) as TotalRecords
					FROM    {databaseOwner}{objectQualifier}vw_Users U
					WHERE U.PortalId = @PortalID
						AND LOWER(U.Email) LIKE LOWER(@EmailToMatch)
						AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
						AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
		end
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_DeleteByKey]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_DeleteByKey]
	@PortalId int,
	@ObjectKey nvarchar(255),
	@SoftDelete int = 0
	AS
	DECLARE @JournalId int
	SET @JournalId = (SELECT JournalId FROM {databaseOwner}[{objectQualifier}Journal] WHERE PortalId = @PortalId AND ObjectKey = @ObjectKey AND @ObjectKey <> '' AND ObjectKey IS NOT NULL)

	-- Hard Delete
	IF @JournalId > 0 AND @SoftDelete <> 1 
	BEGIN
		DELETE FROM {databaseOwner}[{objectQualifier}Journal_Security] WHERE JournalId = @JournalId
		DELETE FROM {databaseOwner}[{objectQualifier}Journal_Comments] WHERE JournalId = @JournalId
		DELETE FROM {databaseOwner}[{objectQualifier}Journal] WHERE JournalId = @JournalId
	END

	-- Soft Delete
	IF @JournalId > 0 AND @SoftDelete = 1 
	BEGIN
		UPDATE {databaseOwner}[{objectQualifier}Journal] SET IsDeleted = 1 WHERE JournalId = @JournalId
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}IsUserInRole]'
GO
create procedure {databaseOwner}[{objectQualifier}IsUserInRole]
    
@UserID        int,
@RoleId        int,
@PortalID      int

as

select {databaseOwner}{objectQualifier}UserRoles.UserId,
       {databaseOwner}{objectQualifier}UserRoles.RoleId
from {databaseOwner}{objectQualifier}UserRoles
inner join {databaseOwner}{objectQualifier}Roles on {databaseOwner}{objectQualifier}UserRoles.RoleId = {databaseOwner}{objectQualifier}Roles.RoleId
where  {databaseOwner}{objectQualifier}UserRoles.UserId = @UserID
and    {databaseOwner}{objectQualifier}UserRoles.RoleId = @RoleId
and    {databaseOwner}{objectQualifier}Roles.PortalId = @PortalID
and    ({databaseOwner}{objectQualifier}UserRoles.ExpiryDate >= getdate() or {databaseOwner}{objectQualifier}UserRoles.ExpiryDate is null)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAvailableUsersForIndex]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAvailableUsersForIndex]
    @PortalId INT ,
    @StartDate DATETIME ,
    @startUserId INT = 0,
    @numberOfUsers INT = 500
AS
    BEGIN
		DECLARE @PivotSql NVARCHAR(MAX)

		SELECT @PivotSql = COALESCE(@PivotSql + ',','') + '[' + PropertyName + ']'
		 FROM {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] pd
		 INNER JOIN {databaseOwner}[{objectQualifier}Lists] l ON ListName = 'DataType' AND SystemList = 1 AND Value IN ( 'Text', 'RichText' ) AND l.EntryID = pd.DataType
		 WHERE ISNULL(pd.PortalID, -1) = ISNULL(@PortalId, -1)
		   AND Deleted = 0
		ORDER BY ViewOrder

		DECLARE @Sql NVARCHAR(MAX)

		SELECT @Sql = '
        WITH    ValidDataType
                  AS ( SELECT   EntryID
                       FROM     {databaseOwner}[{objectQualifier}Lists]
                       WHERE    ListName = ''DataType''
                                AND SystemList = 1
                                AND Value IN ( ''Text'', ''RichText'' )
                     ),
                  ValidUsers AS
                  (
                                      SELECT UserId FROM ( SELECT   UserId, ROW_NUMBER() OVER(ORDER BY UserId ASC) AS rownumber
                         FROM ( SELECT DISTINCT
                                            ( u.UserID )
                                  FROM      {databaseOwner}[{objectQualifier}Users] u
                                            INNER JOIN {databaseOwner}[{objectQualifier}UserPortals] up ON up.UserId = u.UserID
                                            INNER JOIN {databaseOwner}[{objectQualifier}vw_Profile] p ON p.UserID = u.UserID
                                            INNER JOIN {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] pd ON pd.PropertyDefinitionID = p.PropertyDefinitionID AND pd.Visible = 1 AND pd.PortalID = @PortalId
                                            INNER JOIN ValidDataType dt ON dt.EntryID = pd.DataType
                                  WHERE     (up.PortalId = @PortalId OR up.PortalId IS NULL)
                                            AND (u.LastModifiedOnDate > @StartDate OR (p.LastUpdatedDate IS NOT NULL AND (p.LastUpdatedDate > @StartDate OR pd.LastModifiedOnDate > @StartDate)))
                                            AND ((p.PropertyValue IS NOT NULL AND p.PropertyValue <> '''') OR u.LastModifiedOnDate > @StartDate OR p.LastUpdatedDate IS NULL OR p.LastUpdatedDate > @StartDate)
                                ) AS T WHERE UserID > @startUserId) AS T
                                WHERE rownumber <= @numberOfUsers
                     )

		SELECT * FROM (
        SELECT u.UserID ,
               u.DisplayName,
               u.LastModifiedOnDate,
			   u.Username,
			   u.IsSuperUser,
			   u.Email,
			   u.CreatedOnDate,
			   p.PropertyName,
			   REPLACE(p.PropertyValue, ''$$$'', ''[$][$][$]'') + ''$$$'' +
			   CAST(CASE WHEN (p.Visibility IS NULL) THEN 0 ELSE p.Visibility END AS VARCHAR(10)) + ''$$$'' +
			   p.ExtendedVisibility + ''$$$'' +
			   CONVERT(VARCHAR(20), CASE WHEN u.LastModifiedOnDate > p.LastUpdatedDate OR p.LastUpdatedDate IS NULL THEN u.LastModifiedOnDate ELSE p.LastUpdatedDate END, 20) AS [PropertyValue]
		FROM
			{databaseOwner}[{objectQualifier}Users] u
			INNER JOIN ValidUsers vu on vu.UserId = u.UserID
			INNER JOIN {databaseOwner}[{objectQualifier}vw_Profile] p ON p.UserID = u.UserID
			INNER JOIN {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] pd ON pd.PropertyDefinitionID = p.PropertyDefinitionID AND pd.Visible = 1 AND pd.PortalID = @PortalID
			INNER JOIN ValidDataType dt ON dt.EntryID = pd.DataType) AS T
		PIVOT (MAX(PropertyValue) for PropertyName in (' + @PivotSql + ')) AS T
		ORDER BY UserId
		'
		EXECUTE sp_executesql @Sql,
                              N'@PortalId INT ,
                                @StartDate DATETIME ,
                                @startUserId INT,
                                @numberOfUsers INT',
                              @PortalId, @StartDate, @startUserId, @numberOfUsers
    END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_UpdateContentItemId]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_UpdateContentItemId]
@JournalId int,
@ContentItemId int
AS
UPDATE {databaseOwner}[{objectQualifier}Journal]
	SET ContentItemId = @ContentItemId
WHERE JournalId = @JournalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUrls]'
GO
create procedure {databaseOwner}[{objectQualifier}GetUrls]

@PortalID     int

as

select *
from   {databaseOwner}{objectQualifier}Urls
where  PortalID = @PortalID
order by Url
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchProfilePropertyValues]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SearchProfilePropertyValues]
 @PortalId INT,
 @PropertyName NVARCHAR(50),
 @SearchString NVARCHAR(100)
AS
SELECT DISTINCT
 up.PropertyValue
FROM
 {databaseOwner}{objectQualifier}UserProfile up
 INNER JOIN {databaseOwner}{objectQualifier}ProfilePropertyDefinition ppd ON ppd.PropertyDefinitionID = up.PropertyDefinitionID
WHERE
 ppd.PortalID = @PortalId
 AND ppd.PropertyName = @PropertyName
 AND up.PropertyValue LIKE '%' + @SearchString + '%'
 AND up.PropertyValue IS NOT NULL
ORDER BY
 up.PropertyValue
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveRelationship]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveRelationship]
    @RelationshipID INT,
    @RelationshipTypeID INT,    
    @Name NVARCHAR(50),
    @Description NVARCHAR(500),
	@UserID INT,
	@PortalID INT,
	@DefaultResponse INT,
	@CreateUpdateUserID INT
    
AS 
    IF ( @RelationshipID = -1 ) 
        BEGIN
            INSERT  {databaseOwner}{objectQualifier}Relationships
                    ( RelationshipTypeID,
                      Name ,            
                      Description,					
					  UserID,
					  PortalID,		
					  DefaultResponse,			
                      CreatedByUserID ,
                      CreatedOnDate ,
                      LastModifiedByUserID ,
                      LastModifiedOnDate
			        
                    )
            VALUES  ( @RelationshipTypeID , -- @RelationshipTypeID INT
                      @Name , -- Name - nvarchar(50)
                      @Description , -- @Description NVARCHAR(500)
					  @UserID , -- @UserID int
					  @PortalID , -- @PortalID int
					  @DefaultResponse, -- @DefaultResponse int
                      @CreateUpdateUserID , -- CreatedBy - int
                      GETDATE() , -- CreatedOn - datetime
                      @CreateUpdateUserID , -- LastModifiedBy - int
                      GETDATE() -- LastModifiedOn - datetime
			        
                    )
                    
            SELECT  @RelationshipID = SCOPE_IDENTITY()
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}Relationships
            SET     Name = @Name ,                    
                    Description = @Description,
					RelationshipTypeID = @RelationshipTypeID,
					UserID = @UserID,
					PortalID = @PortalID,
					DefaultResponse = @DefaultResponse,
                    LastModifiedByUserID = @CreateUpdateUserID,
                    LastModifiedOnDate = GETDATE()
            WHERE   RelationshipID = @RelationshipID
        END
        
    SELECT  @RelationshipID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RoleGroups]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}RoleGroups]
(
[RoleGroupID] [int] NOT NULL IDENTITY(0, 1),
[PortalID] [int] NOT NULL,
[RoleGroupName] [nvarchar] (50) NOT NULL,
[Description] [nvarchar] (1000) NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}RoleGroups] on {databaseOwner}[{objectQualifier}RoleGroups]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}RoleGroups] ADD CONSTRAINT [PK_{objectQualifier}RoleGroups] PRIMARY KEY CLUSTERED  ([RoleGroupID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}RoleGroups]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}RoleGroups] ADD CONSTRAINT [IX_{objectQualifier}RoleGroupName] UNIQUE NONCLUSTERED  ([PortalID], [RoleGroupName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRoleGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRoleGroup]
	@PortalID		int,
	@RoleGroupId    int
AS
	SELECT *
		FROM {databaseOwner}{objectQualifier}RoleGroups
		WHERE  (RoleGroupId = @RoleGroupId OR RoleGroupId IS NULL AND @RoleGroupId IS NULL)
			AND    PortalId = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}JavaScriptLibraries]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}JavaScriptLibraries]
(
[JavaScriptLibraryID] [int] NOT NULL IDENTITY(1, 1),
[PackageID] [int] NOT NULL,
[LibraryName] [nvarchar] (200) NOT NULL,
[Version] [nvarchar] (50) NOT NULL,
[FileName] [nvarchar] (100) NOT NULL,
[ObjectName] [nvarchar] (100) NOT NULL,
[PreferredScriptLocation] [int] NOT NULL,
[CDNPath] [nvarchar] (250) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}JavaScriptLIbraries] on {databaseOwner}[{objectQualifier}JavaScriptLibraries]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}JavaScriptLibraries] ADD CONSTRAINT [PK_{objectQualifier}JavaScriptLIbraries] PRIMARY KEY CLUSTERED  ([JavaScriptLibraryID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveJavaScriptLibrary]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveJavaScriptLibrary]
	@JavaScriptLibraryID INT,
	@PackageID INT,
	@LibraryName NVARCHAR(200),
	@Version NVARCHAR(50),
	@FileName NVARCHAR(100),
	@ObjectName NVARCHAR(100),
	@PreferredScriptLocation int,
	@CDNPath NVARCHAR(250)
AS

	IF EXISTS (SELECT JavaScriptLibraryID FROM {objectQualifier}JavaScriptLibraries WHERE JavaScriptLibraryID = @JavaScriptLibraryID)
		BEGIN
			UPDATE {databaseOwner}[{objectQualifier}JavaScriptLibraries]
			   SET [PackageID] = @PackageID,
					[LibraryName] = @LibraryName,
					[Version] = @Version,
					[FileName] = @FileName,
					[ObjectName] = @ObjectName,
					[PreferredScriptLocation] = @PreferredScriptLocation,
					[CDNPath] = @CDNPath
			 WHERE JavaScriptLibraryID = @JavaScriptLibraryID
	 	END
	ELSE
		BEGIN
			INSERT INTO {databaseOwner}[{objectQualifier}JavaScriptLibraries] (
				[PackageID],
				[LibraryName],
				[Version],
				[FileName],
				[ObjectName],
				[PreferredScriptLocation],
				[CDNPath]
			)
			VALUES (
				@PackageID,
				@LibraryName,
				@Version,
				@FileName,
				@ObjectName,
				@PreferredScriptLocation,
				@CDNPath
			)
			SET @JavaScriptLibraryID = (SELECT @@IDENTITY)
		END

	SELECT @JavaScriptLibraryID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Data]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Journal_Data]
(
[JournalDataId] [int] NOT NULL IDENTITY(1, 1),
[JournalId] [int] NOT NULL,
[JournalXML] [xml] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Journal_Data] on {databaseOwner}[{objectQualifier}Journal_Data]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Data] ADD CONSTRAINT [PK_{objectQualifier}Journal_Data] PRIMARY KEY CLUSTERED  ([JournalDataId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Like]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Like]
@JournalId int,
@UserId int,
@UserName nvarchar(50)
AS 
IF NOT EXISTS (SELECT JournalId from {databaseOwner}[{objectQualifier}Journal_Data] WHERE JournalId = @JournalId)
	BEGIN
		DECLARE @x xml
		SET @x = '<items><item /></items>';
		INSERT INTO {databaseOwner}[{objectQualifier}Journal_Data] 
			(JournalId, JournalXML)
			VALUES
			(@JournalId, @x)
	END
IF EXISTS(SELECT j.JournalId 
			FROM {databaseOwner}{objectQualifier}Journal as j INNER JOIN
				{databaseOwner}{objectQualifier}Journal_Data as jx ON j.JournalId = jx.JournalId 
			WHERE j.JournalId = @JournalId 
				AND 
				jx.journalxml.exist('/items/likes/u[@uid=sql:variable("@userid")]') = 1)
BEGIN
UPDATE {databaseOwner}{objectQualifier}Journal_Data
SET JournalXML.modify('delete (/items/likes/u[@uid=sql:variable("@UserId")])')
WHERE JournalId = @JournalId 
	AND journalxml.exist('/items/likes/u[@uid=sql:variable("@UserId")]') = 1
END
ELSE
	BEGIN
		BEGIN
			IF NOT EXISTS(SELECT JournalId FROM {databaseOwner}{objectQualifier}Journal_Data
							WHERE JournalId = @JournalId 
									AND
								journalxml.exist('/items/likes') = 1)
				BEGIN
					UPDATE {databaseOwner}{objectQualifier}Journal_Data
					SET JournalXML.modify('insert <likes /> as last into (/items)[1]') 
					WHERE JournalId = @JournalId AND journalxml.exist('/items') = 1
				END
		END
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}Journal_Data
			SET JournalXML.modify('insert <u uid="{xs:string(sql:variable("@UserId"))}" un="{xs:string(sql:variable("@UserName"))}" /> as last into (/items/likes)[1]')
			Where JournalId = @JournalId AND journalxml.exist('/items/likes') = 1
		END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountNewThreads]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountNewThreads]
	@UserID int,
	@PortalID INT
AS
BEGIN
	SELECT COUNT(*) AS TotalNewThreads
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR
	JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] M ON MR.MessageID = M.MessageID
	WHERE MR.UserID = @UserID
	AND MR.[Read] = 0
	AND M.PortalID=@PortalID
	AND M.NotificationTypeID IS NULL
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentWorkflowSources]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentWorkflowSources]
(
[SourceID] [int] NOT NULL IDENTITY(1, 1),
[WorkflowID] [int] NOT NULL,
[SourceName] [nvarchar] (20) NOT NULL,
[SourceType] [nvarchar] (250) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentWorkflowSources] on {databaseOwner}[{objectQualifier}ContentWorkflowSources]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowSources] ADD CONSTRAINT [PK_{objectQualifier}ContentWorkflowSources] PRIMARY KEY CLUSTERED  ([SourceID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}ContentWorkflowSources]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowSources] ADD CONSTRAINT [IX_{objectQualifier}ContentWorkflowSources] UNIQUE NONCLUSTERED  ([WorkflowID], [SourceName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowSource]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowSource]
	@WorkflowID INT,
    @SourceName NVARCHAR(20)
AS
    SELECT 
		[SourceID],
		[WorkflowID],
		[SourceName],
		[SourceType]
	FROM {databaseOwner}{objectQualifier}ContentWorkflowSources
    WHERE WorkflowID = @WorkflowID AND SourceName = @SourceName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UrlLog]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UrlLog]
(
[UrlLogID] [int] NOT NULL IDENTITY(1, 1),
[UrlTrackingID] [int] NOT NULL,
[ClickDate] [datetime] NOT NULL,
[UserID] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UrlLog] on {databaseOwner}[{objectQualifier}UrlLog]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UrlLog] ADD CONSTRAINT [PK_{objectQualifier}UrlLog] PRIMARY KEY CLUSTERED  ([UrlLogID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddUrlLog]'
GO
create procedure {databaseOwner}[{objectQualifier}AddUrlLog]

@UrlTrackingID int,
@UserID        int

as

insert into {databaseOwner}{objectQualifier}UrlLog (
  UrlTrackingID,
  ClickDate,
  UserID
)
values (
  @UrlTrackingID,
  getdate(),
  @UserID
)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission]
(
[WorkflowStatePermissionID] [int] NOT NULL IDENTITY(1, 1),
[StateID] [int] NOT NULL,
[PermissionID] [int] NOT NULL,
[AllowAccess] [bit] NOT NULL,
[RoleID] [int] NULL,
[UserID] [int] NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentWorkflowStatePermission] on {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission] ADD CONSTRAINT [PK_{objectQualifier}ContentWorkflowStatePermission] PRIMARY KEY CLUSTERED  ([WorkflowStatePermissionID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission] ADD CONSTRAINT [IX_{objectQualifier}ContentWorkflowStatePermission] UNIQUE NONCLUSTERED  ([StateID], [PermissionID], [RoleID], [UserID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_ContentWorkflowStatePermissions]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_ContentWorkflowStatePermissions]
AS
    SELECT     
	    WSP.WorkflowStatePermissionID, 
	    WSP.StateID, 
	    P.PermissionID, 
	    WSP.RoleID,
	    CASE WSP.RoleID
		    when -1 then 'All Users'
		    when -2 then 'Superuser'
		    when -3 then 'Unauthenticated Users'
		    else 	R.RoleName
	    END AS 'RoleName',
	    WSP.AllowAccess, 
	    WSP.UserID,
	    U.Username,
	    U.DisplayName, 
	    P.PermissionCode, 
	    P.ModuleDefID, 
	    P.PermissionKey, 
	    P.PermissionName, 
        WSP.CreatedByUserID, 
        WSP.CreatedOnDate, 
        WSP.LastModifiedByUserID, 
        WSP.LastModifiedOnDate    
    FROM {databaseOwner}{objectQualifier}ContentWorkflowStatePermission AS WSP 
	    LEFT OUTER JOIN {databaseOwner}{objectQualifier}Permission AS P ON WSP.PermissionID = P.PermissionID 
	    LEFT OUTER JOIN {databaseOwner}{objectQualifier}Roles AS R ON WSP.RoleID = R.RoleID
	    LEFT OUTER JOIN {databaseOwner}{objectQualifier}Users AS U ON WSP.UserID = U.UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PackageDependencies]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PackageDependencies]
(
[PackageDependencyID] [int] NOT NULL IDENTITY(1, 1),
[PackageID] [int] NOT NULL,
[PackageName] [nvarchar] (128) NOT NULL,
[Version] [nvarchar] (50) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PackageDependencies] on {databaseOwner}[{objectQualifier}PackageDependencies]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PackageDependencies] ADD CONSTRAINT [PK_{objectQualifier}PackageDependencies] PRIMARY KEY CLUSTERED  ([PackageDependencyID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SavePackageDependency]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SavePackageDependency]
	@PackageDependencyID INT,
	@PackageID INT,
	@PackageName NVARCHAR(128),
	@Version NVARCHAR(50)
AS
	IF EXISTS (SELECT PackageDependencyID FROM {objectQualifier}PackageDependencies WHERE PackageID = @PackageID AND PackageName = @PackageName AND Version = @Version)
		BEGIN
			UPDATE {databaseOwner}[{objectQualifier}PackageDependencies]
			   SET [PackageID] = @PackageID,
					[PackageName] = @PackageName,
					[Version] = @Version
			 WHERE PackageDependencyID = @PackageDependencyID
		END
	ELSE
		BEGIN
			INSERT INTO {databaseOwner}[{objectQualifier}PackageDependencies] (
				[PackageID],
				[PackageName],
				[Version]
			)
			VALUES (
				@PackageID,
				@PackageName,
				@Version
			)
			SET @PackageDependencyID = (SELECT @@IDENTITY)
		END

	SELECT @PackageDependencyID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_LikeList]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_LikeList]
@PortalId int,
@JournalId int
AS
DECLARE @xdoc xml
set @xdoc = (SELECT journalxml.query('//likes') 
				from {databaseOwner}[{objectQualifier}Journal_Data] as jd
				INNER JOIN {databaseOwner}[{objectQualifier}Journal] as j ON j.JournalId = jd.JournalId
				 WHERE j.JournalId = @JournalId AND j.PortalId = @PortalId)
Select u.UserId, u.DisplayName,u.FirstName,u.LastName,u.Email,u.Username 
	FROM @xdoc.nodes('/likes//u') as e(x) 
CROSS APPLY {databaseOwner}[{objectQualifier}Users] as u
WHERE u.UserID = x.value('@uid[1]','int')
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddContentWorkflowSource]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddContentWorkflowSource]
	@WorkflowID INT,
    @SourceName NVARCHAR(20),
    @SourceType NVARCHAR(250)
AS
    INSERT INTO  {databaseOwner}{objectQualifier}ContentWorkflowSources(
		[WorkflowID],
		[SourceName],
		[SourceType])
    VALUES(
        @WorkflowID,
        @SourceName,
        @SourceType
    )

    SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSharedModulesByPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSharedModulesByPortal]
	@Portald int
AS
	SELECT * FROM {databaseOwner}{objectQualifier}vw_TabModules tb		
	WHERE tb.PortalID != tb.OwnerPortalID	
	AND tb.OwnerPortalID = @Portald
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersByUserName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUsersByUserName]
    @PortalID		int,
    @UserNameToMatch	nvarchar(256),
    @PageIndex		int,
    @PageSize		INT,
    @IncludeDeleted     bit,
    @SuperUsersOnly     bit		
AS
	BEGIN
		-- Set the page bounds
		DECLARE @PageLowerBound INT
		DECLARE @PageUpperBound INT
		SET @PageLowerBound = @PageSize * @PageIndex
		SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

		-- Create a temp table TO store the select results
		CREATE TABLE #PageIndexForUsers
		(
			IndexId int IDENTITY (0, 1) NOT NULL,
			UserId int
		)

		-- Insert into our temp table
		INSERT INTO #PageIndexForUsers (UserId)
			SELECT UserId FROM	{databaseOwner}{objectQualifier}vw_Users 
			WHERE  Username LIKE @UserNameToMatch
				AND (IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
				     OR IsDeleted Is NULL)
			        AND IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				AND ( PortalId = @PortalID OR (@PortalID is null ))
			ORDER BY UserName

		SELECT  *
		FROM	{databaseOwner}{objectQualifier}vw_Users u, 
				#PageIndexForUsers p
		WHERE  u.UserId = p.UserId
				AND (IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
				     OR IsDeleted Is NULL)
			        AND IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				AND ( PortalId = @PortalID OR (@PortalID is null ))
				AND p.IndexId >= @PageLowerBound AND p.IndexId <= @PageUpperBound
		ORDER BY u.UserName

		SELECT  TotalRecords = COUNT(*)
		FROM    #PageIndexForUsers
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddContentWorkflow]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddContentWorkflow]
@PortalID int,
@WorkflowName nvarchar(40),
@Description nvarchar(256),
@IsDeleted bit,
@StartAfterCreating bit,
@StartAfterEditing bit,
@DispositionEnabled bit
AS

INSERT INTO {databaseOwner}{objectQualifier}ContentWorkflows (
  [PortalID],
  [WorkflowName],
  [Description],
  [IsDeleted],
  [StartAfterCreating],
  [StartAfterEditing],
  [DispositionEnabled]
)
VALUES (
  @PortalID,
  @WorkflowName,
  @Description,
  @IsDeleted,
  @StartAfterCreating,
  @StartAfterEditing,
  @DispositionEnabled
)

SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RemoveUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}RemoveUser]
	@UserID		int,
	@PortalID   int
AS
	IF @PortalID IS NULL
		BEGIN
			-- Delete SuperUser
			DELETE FROM {databaseOwner}{objectQualifier}Users
				WHERE  UserId = @UserID
		END
	ELSE
		BEGIN
			-- Remove User from Portal
			DELETE FROM {databaseOwner}{objectQualifier}UserPortals
				WHERE  UserId = @UserID
                 AND PortalId = @PortalID
			IF NOT EXISTS (SELECT 1 FROM {databaseOwner}{objectQualifier}UserPortals WHERE  UserId = @UserID)
				-- Delete User (but not if SuperUser)
				BEGIN
					DELETE FROM {databaseOwner}{objectQualifier}Users
						WHERE  UserId = @UserID
							AND IsSuperUser = 0
					DELETE FROM {databaseOwner}{objectQualifier}UserRoles
						WHERE  UserID = @UserID
				END
			ELSE
				BEGIN
					DELETE ur FROM {databaseOwner}{objectQualifier}UserRoles ur
						INNER JOIN {databaseOwner}{objectQualifier}Roles r ON r.RoleID = ur.RoleID
						WHERE  UserID = @UserID AND r.PortalID = @PortalID
				END
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFileHashCode]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFileHashCode]
	@FileId				  Int, 		-- Not Null
	@HashCode VARCHAR(40)  -- Not NULL
AS
BEGIN
    UPDATE {databaseOwner}[{objectQualifier}Files]
    SET    SHA1Hash = @HashCode
    WHERE  FileId = @FileId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddRole]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddRole] 
	@PortalID         int,
	@RoleGroupId      int,
	@RoleName         nvarchar(50),
	@Description      nvarchar(1000),
	@ServiceFee       money,
	@BillingPeriod    int,
	@BillingFrequency char(1),
	@TrialFee         money,
	@TrialPeriod      int,
	@TrialFrequency   char(1),
	@IsPublic         bit,
	@AutoAssignment   bit,
	@RSVPCode         nvarchar(50),
	@IconFile         nvarchar(100),
	@CreatedByUserID  int,
	@Status			  int,
	@SecurityMode   int,
	@IsSystemRole bit
AS
	INSERT INTO {databaseOwner}{objectQualifier}Roles (
	  PortalId,
	  RoleGroupId,
	  RoleName,
	  Description,
	  ServiceFee,
	  BillingPeriod,
	  BillingFrequency,
	  TrialFee,
	  TrialPeriod,
	  TrialFrequency,
	  IsPublic,
	  AutoAssignment,
	  RSVPCode,
	  IconFile,
	  CreatedByUserID,
	  CreatedOnDate,
	  LastModifiedByUserID,
	  LastModifiedOnDate,
	  Status,
	  SecurityMode,
	  IsSystemRole
	)
	VALUES (
	  @PortalID,
	  @RoleGroupId,
	  @RoleName,
	  @Description,
	  @ServiceFee,
	  @BillingPeriod,
	  @BillingFrequency,
	  @TrialFee,
	  @TrialPeriod,
	  @TrialFrequency,
	  @IsPublic,
	  @AutoAssignment,
	  @RSVPCode,
	  @IconFile,
	  @CreatedByUserID,
	  getdate(),
	  @CreatedByUserID,
	  getdate(),
	  @Status,
	  @SecurityMode,
	  @IsSystemRole
	)
	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSharedModulesWithPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSharedModulesWithPortal]
	@Portald int
AS
	SELECT * FROM {databaseOwner}{objectQualifier}vw_TabModules tb		
	WHERE tb.PortalID != tb.OwnerPortalID	
	AND tb.PortalID = @Portald
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}InsertPortalLocalization]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}InsertPortalLocalization]
@PortalID           int,
@CultureCode nvarchar(10),
	@PortalName         nvarchar(128),
	@LogoFile           nvarchar(50),
	@FooterText         nvarchar(100),
	@Description        nvarchar(500),
	@KeyWords           nvarchar(500),
	@BackgroundFile     nvarchar(50),
	@HomeTabId          int,
	@LoginTabId         int,
	@UserTabId          int,
	@AdminTabid			int,
	@SplashTabId          int,
@CreatedByUserID  int
AS
INSERT INTO {databaseOwner}[{objectQualifier}PortalLocalization]
           ([PortalID]
           ,[CultureCode]
           ,[PortalName]
           ,[LogoFile]
           ,[FooterText]
           ,[Description]
           ,[KeyWords]
           ,[BackgroundFile]
           ,[HomeTabId]
           ,[LoginTabId]
           ,[UserTabId]
           ,[AdminTabId]
           ,[SplashTabId]
           ,[CreatedByUserID]
           ,[CreatedOnDate]
           ,[LastModifiedByUserID]
           ,[LastModifiedOnDate])
     VALUES
     (
     @PortalID,
     @CultureCode,
     @PortalName,
	@LogoFile, 
	@FooterText,
	@Description,
	@KeyWords,
	@BackgroundFile,
	@HomeTabId ,
	@LoginTabId ,
	@UserTabId,
	@AdminTabid,
	@SplashTabId  ,
-1,
		getdate(),
		-1,
		getdate()
		)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateContentWorkflow]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateContentWorkflow]
@WorkflowID int,
@WorkflowName nvarchar(40),
@Description nvarchar(256),
@IsDeleted bit,
@StartAfterCreating bit,
@StartAfterEditing bit,
@DispositionEnabled bit
AS

UPDATE {databaseOwner}{objectQualifier}ContentWorkflows
SET    WorkflowName = @WorkflowName,
       Description = @Description,
       IsDeleted = @IsDeleted,
	   StartAfterCreating = @StartAfterCreating,
	   StartAfterEditing = @StartAfterEditing,
	   DispositionEnabled = @DispositionEnabled
WHERE  WorkflowID = @WorkflowID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_Redirections]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Mobile_Redirections]
(
[Id] [int] NOT NULL IDENTITY(1, 1),
[PortalId] [int] NOT NULL,
[Name] [nvarchar] (50) NOT NULL,
[Type] [int] NOT NULL,
[SortOrder] [int] NOT NULL CONSTRAINT [DF_{objectQualifier}Mobile_Redirections_SortOrder] DEFAULT ((0)),
[SourceTabId] [int] NOT NULL,
[IncludeChildTabs] [bit] NOT NULL,
[TargetType] [int] NOT NULL,
[TargetValue] [nvarchar] (260) NOT NULL,
[Enabled] [bit] NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}Mobile_Redirections_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}Mobile_Redirections_LastModifiedOnDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Mobile_Redirections] on {databaseOwner}[{objectQualifier}Mobile_Redirections]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Mobile_Redirections] ADD CONSTRAINT [PK_{objectQualifier}Mobile_Redirections] PRIMARY KEY CLUSTERED  ([Id])
GO
PRINT N'Creating index [IX_{objectQualifier}Mobile_Redirections_SortOrder] on {databaseOwner}[{objectQualifier}Mobile_Redirections]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}Mobile_Redirections_SortOrder] ON {databaseOwner}[{objectQualifier}Mobile_Redirections] ([SortOrder])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_RedirectionRules]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Mobile_RedirectionRules]
(
[Id] [int] NOT NULL IDENTITY(1, 1),
[RedirectionId] [int] NOT NULL,
[Capability] [nvarchar] (50) NOT NULL,
[Expression] [nvarchar] (50) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Mobile_RedirectionRules] on {databaseOwner}[{objectQualifier}Mobile_RedirectionRules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Mobile_RedirectionRules] ADD CONSTRAINT [PK_{objectQualifier}Mobile_RedirectionRules] PRIMARY KEY CLUSTERED  ([Id])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_DeleteRedirection]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_DeleteRedirection] @Id INT
AS 
    DELETE  FROM {databaseOwner}{objectQualifier}Mobile_RedirectionRules
    WHERE   RedirectionId = @id
		
    DELETE  FROM {databaseOwner}{objectQualifier}Mobile_Redirections
    WHERE   Id = @Id
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRolesBasicSearch]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRolesBasicSearch]
    @PortalID           Int,                    -- might be null for all portals
    @PageIndex          Int,                    -- page number starting at 0
    @PageSize           Int,                    -- number of items per page
    @FilterBy           nVarChar(100)           -- pattern for role name, do not use preceding or trailing wildcards
AS
BEGIN
    IF IsNull(@FilterBy, '') <> '' BEGIN
        IF Substring(@FilterBy, 1, 1) = '%'
            SET @FilterBy = Substring(@FilterBy, 2, Len(@FilterBy) - 1)
        IF Substring(@FilterBy, Len(@FilterBy), 1) = '%'
            SET @FilterBy = Substring(@FilterBy, 1, Len(@FilterBy) - 1)
     END;

	IF IsNull(@PageIndex,-1) >= 0 AND IsNull(@PageSize, 0) > 0 AND IsNull(@PageSize, 0) < Cast(0x7fffffff AS Int)
		WITH OrderedRoles AS (
			SELECT RoleID, PortalID, RoleName, [Description], ServiceFee, BillingFrequency, TrialPeriod, TrialFrequency, BillingPeriod, TrialFee,
				   IsPublic, AutoAssignment, RoleGroupID, RSVPCode, {databaseOwner}{objectQualifier}FilePath(IconFile) AS IconFile, Status, SecurityMode,
				   CreatedByUserID,CreatedOnDate,LastModifiedByUserID,LastModifiedOnDate,
				   ROW_NUMBER() OVER (ORDER BY RoleName ASC, PortalID DESC) AS RowNum
			 FROM {databaseOwner}[{objectQualifier}Roles]
			 WHERE (RoleName LIKE '%' + @FilterBy + '%' OR IsNull(@FilterBy,'') = '')
			   AND (PortalID = @PortalID OR IsNull(@PortalID, -1)  = -1)
			   AND (RoleId  >= 0) -- DNN-4288: ignore virtual roles
			)
		SELECT * FROM OrderedRoles WHERE RowNum >= {databaseOwner}{objectQualifier}PageLowerBound(@PageIndex, @Pagesize)
									 AND RowNum <= {databaseOwner}{objectQualifier}PageUpperBound(@PageIndex, @Pagesize) ORDER BY RowNum
		 OPTION (OPTIMIZE FOR (@PortalId UNKNOWN));
	ELSE -- no paging
        SELECT RoleID, PortalID, RoleName, [Description], ServiceFee, BillingFrequency, TrialPeriod, TrialFrequency, BillingPeriod, TrialFee,
               IsPublic, AutoAssignment, RoleGroupID, RSVPCode, {databaseOwner}{objectQualifier}FilePath(IconFile) AS IconFile, Status, SecurityMode,
               CreatedByUserID,CreatedOnDate,LastModifiedByUserID,LastModifiedOnDate,
               ROW_NUMBER() OVER (ORDER BY RoleName ASC, PortalID DESC) AS RowNum
         FROM {databaseOwner}[{objectQualifier}Roles]
         WHERE (RoleName LIKE '%' + @FilterBy + '%' OR IsNull(@FilterBy,'') = '')
           AND (PortalID = @PortalID OR IsNull(@PortalID, -1)  = -1)
           AND (RoleId  >= 0) -- DNN-4288: ignore virtual roles
		 OPTION (OPTIMIZE FOR (@PortalId UNKNOWN))
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_TypeFilters_Save]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_TypeFilters_Save]
@PortalId int,
@ModuleId int,
@JournalTypeId int
AS
INSERT INTO {databaseOwner}[{objectQualifier}Journal_TypeFilters] 
	(PortalId, ModuleId, JournalTypeId)
	VALUES
	(@PortalId, @ModuleId, @JournalTypeId)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAuthenticationServices]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAuthenticationServices]
AS
	SELECT *
		FROM   {databaseOwner}{objectQualifier}Authentication
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflow]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflow]
@WorkflowID int
AS

SELECT 
  [WorkflowID],
  [PortalID],
  [WorkflowName],
  [Description],
  [IsDeleted],
  [StartAfterCreating],
  [StartAfterEditing],
  [DispositionEnabled]
FROM {databaseOwner}{objectQualifier}ContentWorkflows
WHERE WorkflowID = @WorkflowID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAuthenticationServiceByPackageID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAuthenticationServiceByPackageID]

	@PackageID int

AS
	SELECT *
		FROM  {databaseOwner}{objectQualifier}Authentication
		WHERE PackageID = @PackageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileContent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFileContent]
	@FileId int
AS
BEGIN
	SELECT Content
	FROM {databaseOwner}[{objectQualifier}Files]
	WHERE FileId = @FileId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortals]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortals]
	@CultureCode	nVarChar(50) -- pass Null | '' to return portal default language
AS
BEGIN
	SELECT * 
	FROM  {databaseOwner}[{objectQualifier}vw_Portals]
	WHERE CultureCode = 
		CASE 
			WHEN IsNull(@CultureCode, N'') = N'' THEN DefaultLanguage
			ELSE @CultureCode 
		END 
	ORDER BY PortalName;
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_TypeFilters_Delete]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_TypeFilters_Delete]
@PortalId int,
@ModuleId int
AS
DELETE FROM {databaseOwner}[{objectQualifier}Journal_TypeFilters] WHERE PortalId = @PortalId AND ModuleId=@ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModuleDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteModuleDefinition]
	@ModuleDefId int
AS

-- delete custom permissions
DELETE FROM {databaseOwner}{objectQualifier}Permission
WHERE moduledefid = @ModuleDefId
	
DELETE FROM {databaseOwner}{objectQualifier}ModuleDefinitions
WHERE  ModuleDefId = @ModuleDefId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Assemblies]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Assemblies]
(
[AssemblyID] [int] NOT NULL IDENTITY(1, 1),
[PackageID] [int] NULL,
[AssemblyName] [nvarchar] (250) NOT NULL,
[Version] [nvarchar] (20) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PackageAssemblies] on {databaseOwner}[{objectQualifier}Assemblies]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Assemblies] ADD CONSTRAINT [PK_{objectQualifier}PackageAssemblies] PRIMARY KEY CLUSTERED  ([AssemblyID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UnRegisterAssembly]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UnRegisterAssembly]
	@PackageID     INT,
	@AssemblyName   NVARCHAR(250)
AS
	DECLARE @ReturnCode BIT
	SET @ReturnCode = 1 -- 1 = Can Delete Assembly, 0 = Cannot Delete Assembly

	-- First remove the Assembly Reference for this Package
	DELETE FROM {databaseOwner}{objectQualifier}Assemblies
		WHERE PackageID = @PackageID
			AND AssemblyName = @AssemblyName

	IF EXISTS(SELECT TOP 1 PackageID FROM {databaseOwner}{objectQualifier}Assemblies WHERE AssemblyName = @AssemblyName)
		-- Set ReturnCode = 0, so assembly is not deleted
		SET @ReturnCode = 0

	SELECT @ReturnCode
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetScheduleByTypeFullName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetScheduleByTypeFullName]
	@TypeFullName	varchar(200),
	@Server			varchar(150)
AS
    SELECT S.*
	FROM {databaseOwner}[{objectQualifier}Schedule] S
	WHERE S.TypeFullName = @TypeFullName 
		AND (@Server IS NULL OR ISNULL(s.Servers, '') = '' OR ',' + s.Servers + ',' LIKE '%,' + @Server + ',%')
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflows]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflows]
	@PortalID int
AS

SELECT
	[WorkflowID],
	[PortalID],
	[WorkflowName],
	[Description],
	[IsDeleted],
	[StartAfterCreating],
	[StartAfterEditing],
	[DispositionEnabled]
FROM {databaseOwner}{objectQualifier}ContentWorkflows
WHERE (PortalID = @PortalID OR PortalID IS null)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteList]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteList]
	@ListName  nVarChar( 50), -- Not Null
	@ParentKey nVarChar(150)  -- Not Null
AS
BEGIN
	DELETE L
	 FROM  {databaseOwner}[{objectQualifier}Lists] L
	 WHERE ListName = @ListName 
	   AND {databaseOwner}[{objectQualifier}GetListParentKey](L.ParentID, L.ListName, N'ParentKey',  0) = @ParentKey;
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_TypeFilters_List]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_TypeFilters_List]
@PortalId int,
@ModuleId int
AS
SELECT jt.JournalTypeId, jt.JournalType from {databaseOwner}[{objectQualifier}Journal_Types] as jt INNER JOIN
	{databaseOwner}[{objectQualifier}Journal_TypeFilters] as jf ON jf.JournalTypeId = jt.JournalTypeId
WHERE jt.PortalId = @PortalId AND jf.ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSchedule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddSchedule]
	@TypeFullName varchar(200)
	,@TimeLapse int
	,@TimeLapseMeasurement varchar(2)
	,@RetryTimeLapse int
	,@RetryTimeLapseMeasurement varchar(2)
	,@RetainHistoryNum int
	,@AttachToEvent varchar(50)
	,@CatchUpEnabled bit
	,@Enabled bit
	,@ObjectDependencies varchar(300)
	,@Servers varchar(150)
	,@CreatedByUserID	int
	,@FriendlyName varchar(200)
	,@ScheduleStartDate datetime
AS
	INSERT INTO  {databaseOwner}{objectQualifier}Schedule(
		 TypeFullName
		,TimeLapse
		,TimeLapseMeasurement
		,RetryTimeLapse
		,RetryTimeLapseMeasurement
		,RetainHistoryNum
		,AttachToEvent
		,CatchUpEnabled
		,Enabled
		,ObjectDependencies
		,Servers
		,FriendlyName
		,[CreatedByUserID]
		,[CreatedOnDate]
		,[LastModifiedByUserID]
		,[LastModifiedOnDate]
		,ScheduleStartDate
		)
	VALUES
		(@TypeFullName
		,@TimeLapse
		,@TimeLapseMeasurement
		,@RetryTimeLapse
		,@RetryTimeLapseMeasurement
		,@RetainHistoryNum
		,@AttachToEvent
		,@CatchUpEnabled
		,@Enabled
		,@ObjectDependencies
		,@Servers
		,@FriendlyName
		,@CreatedByUserID
		,getdate()
		,@CreatedByUserID
		,getdate()
		,@ScheduleStartDate
		)
		select SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabVersion]
    @TabID			int,
    @VersionGuid	uniqueidentifier
AS
    UPDATE {databaseOwner}{objectQualifier}Tabs
        SET    VersionGuid = @VersionGuid
    WHERE  TabID = @TabID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddContentWorkflowState]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddContentWorkflowState]
	@WorkflowID	int,
	@StateName nvarchar(40),
	@Order int,
	@IsActive bit,
	@SendEmail bit,
	@SendMessage bit,
	@IsDisposalState bit,
	@OnCompleteMessageSubject nvarchar(256),
	@OnCompleteMessageBody nvarchar(1024),
	@OnDiscardMessageSubject nvarchar(256),
	@OnDiscardMessageBody nvarchar(1024)
AS

INSERT INTO {databaseOwner}{objectQualifier}ContentWorkflowStates (
	[WorkflowID],
	[StateName],
	[Order],
	[IsActive],
	[SendEmail],
	[SendMessage],
	[IsDisposalState],
	[OnCompleteMessageSubject],
	[OnCompleteMessageBody],
	[OnDiscardMessageSubject],
	[OnDiscardMessageBody]
)
VALUES (
	@WorkflowID,
	@StateName,
	@Order,
	@IsActive,
	@SendEmail,
	@SendMessage,
	@IsDisposalState,
	@OnCompleteMessageSubject,
	@OnCompleteMessageBody,
	@OnDiscardMessageSubject,
	@OnDiscardMessageBody
)

SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UrlTracking]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UrlTracking]
(
[UrlTrackingID] [int] NOT NULL IDENTITY(1, 1),
[PortalID] [int] NULL,
[Url] [nvarchar] (255) NOT NULL,
[UrlType] [char] (1) NOT NULL,
[Clicks] [int] NOT NULL,
[LastClick] [datetime] NULL,
[CreatedDate] [datetime] NOT NULL,
[LogActivity] [bit] NOT NULL,
[TrackClicks] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}UrlTracking_TrackClicks] DEFAULT ((1)),
[ModuleId] [int] NULL,
[NewWindow] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}UrlTracking_NewWindow] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UrlTracking] on {databaseOwner}[{objectQualifier}UrlTracking]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UrlTracking] ADD CONSTRAINT [PK_{objectQualifier}UrlTracking] PRIMARY KEY CLUSTERED  ([UrlTrackingID])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}UrlTracking]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UrlTracking] ADD CONSTRAINT [IX_{objectQualifier}UrlTracking] UNIQUE NONCLUSTERED  ([PortalID], [Url], [ModuleId])
GO
PRINT N'Creating index [IX_{objectQualifier}UrlTracking_Url_ModuleId] on {databaseOwner}[{objectQualifier}UrlTracking]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UrlTracking_Url_ModuleId] ON {databaseOwner}[{objectQualifier}UrlTracking] ([Url], [ModuleId]) INCLUDE ([NewWindow], [TrackClicks])
GO
PRINT N'Creating index [IX_{objectQualifier}UrlTracking_ModuleId] on {databaseOwner}[{objectQualifier}UrlTracking]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}UrlTracking_ModuleId] ON {databaseOwner}[{objectQualifier}UrlTracking] ([ModuleId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddUrlTracking]'
GO
create procedure {databaseOwner}[{objectQualifier}AddUrlTracking]

@PortalID     int,
@Url          nvarchar(255),
@UrlType      char(1),
@LogActivity  bit,
@TrackClicks  bit,
@ModuleId     int,
@NewWindow    bit

as

insert into {databaseOwner}{objectQualifier}UrlTracking (
  PortalID,
  Url,
  UrlType,
  Clicks,
  LastClick,
  CreatedDate,
  LogActivity,
  TrackClicks,
  ModuleId,
  NewWindow
)
values (
  @PortalID,
  @Url,
  @UrlType,
  0,
  null,
  getdate(),
  @LogActivity,
  @TrackClicks,
  @ModuleId,
  @NewWindow
)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PurgeScheduleHistory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}PurgeScheduleHistory]
AS
BEGIN
DELETE FROM {databaseOwner}[{objectQualifier}schedulehistory] WHERE schedulehistoryid IN (
	SELECT TOP 50000 ScheduleHistoryID FROM {databaseOwner}[{objectQualifier}ScheduleHistory] sh 
		INNER JOIN {databaseOwner}[{objectQualifier}Schedule] s ON s.ScheduleID = sh.ScheduleID AND s.Enabled = 1
	WHERE (
  SELECT COUNT(*) 
  FROM {databaseOwner}[{objectQualifier}ScheduleHistory] sh
  WHERE sh.ScheduleID = {databaseOwner}[{objectQualifier}ScheduleHistory].ScheduleID
  AND sh.StartDate >= {databaseOwner}[{objectQualifier}ScheduleHistory].StartDate
) > s.RetainHistoryNum
		AND s.RetainHistoryNum <> -1
		AND s.ScheduleID = sh.ScheduleID
	ORDER BY ScheduleHistoryID
)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRelationship]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRelationship] @UserRelationshipID INT
AS 
    SELECT  UserRelationshipID,
			UserID,
			RelatedUserID,
			RelationshipID,            
			Status,            
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}UserRelationships    
	WHERE UserRelationshipID = @UserRelationshipID
	ORDER BY UserRelationshipID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetVocabularies]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetVocabularies] 
AS
	SELECT *
		FROM {databaseOwner}{objectQualifier}Taxonomy_Vocabularies
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateContentWorkflowState]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateContentWorkflowState]
	@StateID int,
	@StateName nvarchar(40),
	@Order int,
	@IsActive bit,
	@SendEmail bit,
	@SendMessage bit,
	@IsDisposalState bit,
	@OnCompleteMessageSubject nvarchar(256),
	@OnCompleteMessageBody nvarchar(1024),
	@OnDiscardMessageSubject nvarchar(256),
	@OnDiscardMessageBody nvarchar(1024)
AS

UPDATE {databaseOwner}{objectQualifier}ContentWorkflowStates
SET [StateName] = @StateName,
	[Order] = @Order,
	[IsActive] = @IsActive,
	[SendEmail] = @SendEmail,
	[SendMessage] = @SendMessage,
	[IsDisposalState] = @IsDisposalState,
	[OnCompleteMessageSubject] = @OnCompleteMessageSubject,
	[OnCompleteMessageBody] = @OnCompleteMessageBody,
	[OnDiscardMessageSubject] = @OnDiscardMessageSubject,
	[OnDiscardMessageBody] = @OnDiscardMessageBody
WHERE  [StateID] = @StateID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteUserNotifications]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteUserNotifications]
	@UserId INT,
	@PortalId INT
AS
BEGIN
	DELETE FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages
	WHERE PortalId = @PortalId
	  AND NotificationTypeID IS NOT NULL
	  AND MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients WHERE UserID = @UserId)

	SELECT @@ROWCOUNT
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddHeirarchicalTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddHeirarchicalTerm] 
	@VocabularyID		int,
	@ParentTermID		int,
	@Name				nvarchar(250),
	@Description		nvarchar(2500),
	@Weight				int,
	@CreatedByUserID	int
AS

	DECLARE @Left int
	
	-- Get Left value of Sibling that we are inserting before
	SET @Left = (SELECT TOP 1 TermLeft FROM {databaseOwner}{objectQualifier}Taxonomy_Terms 
						WHERE VocabularyID = @VocabularyID 
							AND ParentTermID = @ParentTermID
							AND Name > @Name
						ORDER BY Name)
						
	-- Term is to be inserted at end of sibling list so get the Right value of the parent, which will become our new left value						
	IF @Left IS NULL
		SET @Left = (SELECT TermRight FROM {databaseOwner}{objectQualifier}Taxonomy_Terms 
							WHERE VocabularyID = @VocabularyID 
								AND TermID = @ParentTermID)
								
	-- Left is still null means this is the first term in this vocabulary - set the Left to 1
	IF @Left IS NULL
		SET @Left = 1
								
	BEGIN TRANSACTION
		-- Update Left values for all items that are after new term
		UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
			SET TermLeft = TermLeft + 2 
			WHERE TermLeft >= @Left
				AND VocabularyID = @VocabularyID

		IF @@ERROR = 0
			BEGIN
			-- Update Right values for all items that are after new term
				UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
					SET TermRight = TermRight + 2 
					WHERE TermRight >= @Left
						AND VocabularyID = @VocabularyID

				IF @@ERROR = 0
					BEGIN
							-- Insert new term
							INSERT INTO {databaseOwner}{objectQualifier}Taxonomy_Terms (
								VocabularyID,
								ParentTermID,
								[Name],
								Description,
								Weight,
								TermLeft,
								TermRight,
								CreatedByUserID,
								CreatedOnDate,
								LastModifiedByUserID,
								LastModifiedOnDate
							)

							VALUES (
								@VocabularyID,
								@ParentTermID,
								@Name,
								@Description,
								@Weight,
								@Left,
								@Left + 1,
								@CreatedByUserID,
								getdate(),
								@CreatedByUserID,
								getdate()
							)

							SELECT SCOPE_IDENTITY()

							IF @@ERROR = 0
								BEGIN
									COMMIT TRANSACTION
								END
							ELSE
								BEGIN
									-- Rollback the transaction
									ROLLBACK TRANSACTION		
								END
						END
				ELSE
					BEGIN
						-- Rollback the transaction
						ROLLBACK TRANSACTION
					END
			END
		ELSE
			BEGIN
				-- Rollback the transaction
				ROLLBACK TRANSACTION		
			END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteContentWorkflowState]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteContentWorkflowState]
	@StateID int
AS
    DELETE FROM {databaseOwner}{objectQualifier}ContentWorkflowStates
    WHERE StateID = @StateID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_UpdateMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_UpdateMessage] 
   @MessageID bigint,
   @ToUserID int,
   @ToRoleID int,
   @Status int,
   @Subject nvarchar(max),
   @Body nvarchar(max),
   @Date datetime,
   @ReplyTo bigint,
   @AllowReply bit,
   @SkipPortal bit
AS
	UPDATE {databaseOwner}{objectQualifier}Messaging_Messages
	SET ToUserID=@ToUserID, 
		ToRoleID=@ToRoleID, 
		Status=@Status, 
		Subject=@Subject, 
		Body=@Body, 
		Date= @Date,
		ReplyTo= @ReplyTo,
		AllowReply = @AllowReply,
		SkipPortal = @SkipPortal
	WHERE MessageID=@MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateLanguagePack]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateLanguagePack]
	@LanguagePackID			int,
	@PackageID			    int,
	@LanguageID			    int,
	@DependentPackageID		int,
	@LastModifiedByUserID	int

AS
	UPDATE {databaseOwner}{objectQualifier}LanguagePacks
		SET
			PackageID = @PackageID,
			LanguageID = @LanguageID,
			DependentPackageID = @DependentPackageID,
			[LastModifiedByUserID] = @LastModifiedByUserID,	
			[LastModifiedOnDate] = GETDATE()
	WHERE LanguagePackID = @LanguagePackID

	SELECT @LanguagePackID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Profile]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Profile]
(
[ProfileId] [int] NOT NULL IDENTITY(1, 1),
[UserId] [int] NOT NULL,
[PortalId] [int] NOT NULL,
[ProfileData] [ntext] NOT NULL,
[CreatedDate] [datetime] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Profile] on {databaseOwner}[{objectQualifier}Profile]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Profile] ADD CONSTRAINT [PK_{objectQualifier}Profile] PRIMARY KEY CLUSTERED  ([ProfileId])
GO
PRINT N'Creating index [IX_{objectQualifier}Profile] on {databaseOwner}[{objectQualifier}Profile]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_{objectQualifier}Profile] ON {databaseOwner}[{objectQualifier}Profile] ([UserId], [PortalId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddProfile]'
GO
create procedure {databaseOwner}[{objectQualifier}AddProfile]

@UserID        int, 
@PortalID      int

as

insert into {databaseOwner}{objectQualifier}Profile (
  UserId,
  PortalId,
  ProfileData,
  CreatedDate
)
values (
  @UserID,
  @PortalID,
  '',
  getdate()
)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowState]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowState]
	@StateID int
AS
    SELECT
		[StateID],
		[WorkflowID],
		[StateName],
		[Order],
		[IsActive],
		[SendEmail],
		[SendMessage],
		[IsDisposalState],
		[OnCompleteMessageSubject],
		[OnCompleteMessageBody],
		[OnDiscardMessageSubject],
		[OnDiscardMessageBody]
	FROM {databaseOwner}{objectQualifier}ContentWorkflowStates
    WHERE StateID = @StateID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_DeleteRedirectionRule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_DeleteRedirectionRule] @Id INT
AS 
    DELETE  FROM {databaseOwner}{objectQualifier}Mobile_RedirectionRules
    WHERE   Id = @id
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateOnlineUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateOnlineUser]
@UserID 	INT,
@PortalID 	INT,
@TabID 		INT,
@LastActiveDate DATETIME 
AS
BEGIN
	IF EXISTS (SELECT UserID FROM {databaseOwner}{objectQualifier}Users WHERE UserID = @UserID)
	BEGIN
		IF EXISTS (SELECT UserID FROM {databaseOwner}{objectQualifier}UsersOnline WHERE UserID = @UserID and PortalID = @PortalID)
			UPDATE 
				{databaseOwner}{objectQualifier}UsersOnline
			SET 
				TabID = @TabID,
				LastActiveDate = @LastActiveDate
			WHERE
				UserID = @UserID
				and 
				PortalID = @PortalID
		ELSE
			INSERT INTO
				{databaseOwner}{objectQualifier}UsersOnline
				(UserID, PortalID, TabID, CreationDate, LastActiveDate) 
			VALUES
				(@UserID, @PortalID, @TabID, GetDate(), @LastActiveDate)
	END

END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalSetting]
	@PortalID       Int,			-- Key, Not Null (unless for delete)
	@SettingName    nVarChar(  50), -- Key, not Null or Empty
	@SettingValue   nVarChar(2000), -- Not Null
	@UserID			Int,			-- Not Null (editing user)
	@CultureCode    nVarChar(  10)  -- Key, Null|'' for neutral language 
AS
BEGIN
	-- empty value: remove setting
	IF IsNull(@SettingValue, N'') = N'' AND IsNull(@SettingName, N'') != N''
		DELETE FROM {databaseOwner}[{objectQualifier}PortalSettings]
		 WHERE IsNull(PortalID, -1) = IsNull(@PortalID, -1)
		   AND (CultureCode = @CultureCode OR IsNull(@CultureCode, N'') = N'')
		   AND SettingName = @SettingName;
	ELSE IF IsNull(@SettingName, N'') != N'' AND IsNull(@PortalID, -1) != -1 BEGIN -- key must be valid
		MERGE INTO {databaseOwner}[{objectQualifier}PortalSettings] S
		 USING (SELECT @PortalID PID, @CultureCode CC, @SettingName SN, @SettingValue SV) Q
		    ON (S.PortalID = Q.PID AND IsNull(S.CultureCode, N'') = IsNull(Q.CC, N'') AND S.SettingName = Q.SN)
		 WHEN MATCHED AND IsNull(S.SettingValue, N'') != IsNull(Q.SV, N'') THEN -- update only, if value has been modified:
			UPDATE SET [SettingValue] = Q.SV, [LastModifiedByUserID] = @UserID, [LastModifiedOnDate] = GetDate()
		 WHEN NOT MATCHED THEN 
		    INSERT ( PortalID,  SettingName,  SettingValue, CreatedByUserID    , CreatedOnDate, LastModifiedByUserID, LastModifiedOnDate, CultureCode)
			VALUES (@PortalID, @SettingName, @SettingValue, IsNull(@UserID, -1),     GetDate(),  IsNull(@UserID, -1),          GetDate(), NULLIF(@CultureCode, N''));
		-- Saving a neutral setting overwrites all localized settings with same name (for current portal):
		IF IsNull(@CultureCode, N'') = N''
			DELETE FROM {databaseOwner}[{objectQualifier}PortalSettings] 
			 WHERE PortalID = @PortalID AND SettingName = @SettingName AND CultureCode IS Not Null;		       
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountTotalConversations]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountTotalConversations]
	@UserID int,
	@PortalID int
AS
BEGIN
	SELECT COUNT(DISTINCT M.ConversationID) AS TotalConversations
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] M
	JOIN {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR ON M.MessageID = MR.MessageID
	WHERE NotificationTypeID IS NULL AND PortalID = @PortalID AND Archived = 0 AND UserID = @UserID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_Profile]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_Profile]
AS
	SELECT     
		UP.UserID, 
		PD.PortalID, 
		PD.PropertyName, 
		CASE WHEN PropertyText IS NULL THEN PropertyValue ELSE PropertyText END AS PropertyValue, 
		UP.Visibility,
		UP.ExtendedVisibility,
		UP.LastUpdatedDate,
		PD.PropertyDefinitionID
	FROM {databaseOwner}[{objectQualifier}UserProfile] AS UP 
		INNER JOIN {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] AS PD ON PD.PropertyDefinitionID = UP.PropertyDefinitionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateRole]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateRole]
	@RoleId					int,
	@RoleGroupId			int,
	@RoleName				nvarchar(50),
	@Description			nvarchar(1000),
	@ServiceFee				money,
	@BillingPeriod			int,
	@BillingFrequency		char(1),
	@TrialFee				money,
	@TrialPeriod			int,
	@TrialFrequency			char(1),
	@IsPublic				bit,
	@AutoAssignment			bit,
	@RSVPCode				nvarchar(50),
	@IconFile				nvarchar(100),
	@LastModifiedByUserID	int,
	@Status					int,
	@SecurityMode			int,
	@IsSystemRole			bit
AS
	UPDATE {databaseOwner}{objectQualifier}Roles
	SET    RoleGroupId			= @RoleGroupId,
		   RoleName				= @RoleName,
		   Description			= @Description,
		   ServiceFee			= @ServiceFee,
		   BillingPeriod		= @BillingPeriod,
		   BillingFrequency		= @BillingFrequency,
		   TrialFee				= @TrialFee,
		   TrialPeriod			= @TrialPeriod,
		   TrialFrequency		= @TrialFrequency,
		   IsPublic				= @IsPublic,
		   AutoAssignment		= @AutoAssignment,
		   RSVPCode				= @RSVPCode,
		   IconFile				= @IconFile,
		   LastModifiedByUserID = @LastModifiedByUserID,
		   LastModifiedOnDate		= getdate(),
		   Status				= @Status,
		   SecurityMode			= @SecurityMode,
		   IsSystemRole			= @IsSystemRole
	WHERE  RoleId = @RoleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentTypes]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentTypes] 
AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}ContentTypes
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowStates]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowStates]
	@WorkflowID int
AS
    SELECT 
		[StateID],
		[WorkflowID],
		[StateName],
		[Order],
		[IsActive],
		[SendEmail],
		[SendMessage],
		[IsDisposalState],
		[OnCompleteMessageSubject],
		[OnCompleteMessageBody],
		[OnDiscardMessageSubject],
		[OnDiscardMessageBody]
	FROM {databaseOwner}{objectQualifier}ContentWorkflowStates
    WHERE WorkflowID = @WorkflowID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteContentItem]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteContentItem] 
	@ContentItemId			int
AS
	DELETE FROM {databaseOwner}{objectQualifier}ContentItems
	WHERE ContentItemId = @ContentItemId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteUserRole]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteUserRole]

@UserID int,
@RoleId int

as

delete
from {databaseOwner}{objectQualifier}UserRoles
where  UserId = @UserID
and    RoleId = @RoleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalSettings]
    @PortalId    Int,            -- not Null!
    @CultureCode nVarChar(20)    -- Null|'' for neutral language
AS
BEGIN
	DECLARE @DefaultLanguage nVarChar(20) = '';

	IF EXISTS (SELECT * FROM {databaseOwner}[{objectQualifier}PortalLocalization] L
					JOIN {databaseOwner}[{objectQualifier}Portals] P ON L.PortalID = P.PortalID AND L.CultureCode = P.DefaultLanguage
					WHERE P.PortalID = @PortalID)
		SELECT @DefaultLanguage = DefaultLanguage 
		FROM {databaseOwner}[{objectQualifier}Portals] 
		WHERE PortalID = @PortalID

	SELECT
		PS.SettingName,
		CASE WHEN Lower(PS.SettingValue) LIKE 'fileid=%'
			THEN {databaseOwner}[{objectQualifier}FilePath](PS.SettingValue)
			ELSE PS.SettingValue END   AS SettingValue,
		PS.CreatedByUserID,
		PS.CreatedOnDate,
		PS.LastModifiedByUserID,
		PS.LastModifiedOnDate,
		PS.CultureCode
		FROM {databaseOwner}[{objectQualifier}PortalSettings] PS
		WHERE PortalSettingID = (SELECT Top(1) PortalSettingID FROM {databaseOwner}[{objectQualifier}PortalSettings] S 
		                         WHERE PS.PortalID = S.PortalID AND PS.SettingName = S.SettingName 
								 ORDER BY CASE CultureCode WHEN @CultureCode THEN 2 WHEN Null THEN 1 ELSE 0 END DESC)
		  AND PortalID = @PortalID
	 ORDER BY SettingName
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetServers]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetServers] 
AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}WebServers
	ORDER BY ServerName, IISAppName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetScheduleByEvent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetScheduleByEvent]
	@EventName	varchar(50),
	@Server		varchar(150)
AS
    SELECT S.*
	FROM {databaseOwner}[{objectQualifier}Schedule] S
	WHERE S.AttachToEvent = @EventName
		AND (@Server IS NULL OR ISNULL(s.Servers, '') = '' OR ',' + s.Servers + ',' LIKE '%,' + @Server + ',%')
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowStatePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowStatePermission]
	@WorkflowStatePermissionID	int
AS
    SELECT *
    FROM {databaseOwner}{objectQualifier}vw_ContentWorkflowStatePermissions
    WHERE WorkflowStatePermissionID = @WorkflowStatePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePortalInfo]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePortalInfo]
	@PortalID int

AS
	/* Delete all the Portal Modules */
	DELETE
	FROM {databaseOwner}{objectQualifier}Modules
	WHERE PortalId = @PortalID

	/* Delete all the Portal Skins */
	DELETE
	FROM {databaseOwner}{objectQualifier}Packages
	WHERE  PortalId = @PortalID

	/* Delete Portal */
	DELETE
	FROM {databaseOwner}{objectQualifier}Portals
	WHERE  PortalId = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_MasterPortals]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_MasterPortals]
AS
	SELECT  P.PortalID,
			P.PortalGroupID,
			IsNull(G.MasterPortalID, P.PortalID) AS MasterPortalID
	FROM      {databaseOwner}[{objectQualifier}Portals] AS P
	LEFT JOIN {databaseOwner}[{objectQualifier}PortalGroups] AS G ON P.PortalGroupID = G.PortalGroupID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_FolderPermissions]'
GO
-- use new FK
CREATE VIEW {databaseOwner}[{objectQualifier}vw_FolderPermissions]
AS
SELECT  FP.FolderPermissionID,
        F.FolderID,
        F.FolderPath,
        F.PortalID,
        P.PermissionID,
        FP.RoleID,
        R.RoleName,
        FP.AllowAccess,
        FP.UserID,
        U.Username,
        U.DisplayName,
        P.PermissionCode,
        P.ModuleDefID,
        P.PermissionKey,
        P.PermissionName,
        FP.CreatedByUserID,
        FP.CreatedOnDate,
        FP.LastModifiedByUserID,
        FP.LastModifiedOnDate
FROM         {databaseOwner}[{objectQualifier}FolderPermission] AS FP
 INNER JOIN  {databaseOwner}[{objectQualifier}Folders]          AS F ON FP.FolderID     = F.FolderID
 INNER JOIN  {databaseOwner}[{objectQualifier}Permission]       AS P ON FP.PermissionID = P.PermissionID
 LEFT  JOIN  {databaseOwner}[{objectQualifier}Roles]            AS R ON FP.RoleID       = R.RoleID
 LEFT  JOIN  {databaseOwner}[{objectQualifier}Users]            AS U ON FP.UserID       = U.UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderPermissionsByFolderPath]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderPermissionsByFolderPath]
	
	@PortalID int,
	@FolderPath nvarchar(300), 
	@PermissionID int

AS
SELECT *
FROM {databaseOwner}{objectQualifier}vw_FolderPermissions

WHERE	((FolderPath = @FolderPath 
				AND ((PortalID = @PortalID) OR (PortalID IS NULL AND @PortalID IS NULL)))
			OR (FolderPath IS NULL AND PermissionCode = 'SYSTEM_FOLDER'))
	AND	(PermissionID = @PermissionID OR @PermissionID = -1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowStatePermissions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowStatePermissions]
AS
    SELECT *
    FROM {databaseOwner}{objectQualifier}vw_ContentWorkflowStatePermissions
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetList]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}GetList]
	@ListName nvarchar(50),
	@ParentKey nvarchar(150),
	@PortalID int
AS
SELECT DISTINCT
		ListName,
		[Level],
		DefinitionID,
		PortalID,
		SystemList,
		EntryCount,
		ParentID,
		ParentKey,
		Parent,
		ParentList,
		MaxSortOrder
	FROM {databaseOwner}{objectQualifier}vw_Lists
	WHERE ListName = @ListName
		AND ParentKey = @ParentKey
		AND PortalID = @PortalID
	ORDER BY [Level], ListName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_SaveMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_SaveMessage]
    @MessageID INT,
	@PortalID INT,
	@To nvarchar(2000),
	@From nvarchar(200),
    @Subject nvarchar(400),
    @Body nvarchar(max),
    @ConversationID int,
    @ReplyAllAllowed bit,
    @SenderUserID int,
	@CreateUpdateUserID INT
    
AS 
    IF ( @MessageID = -1 ) 
        BEGIN
            INSERT {databaseOwner}{objectQualifier}CoreMessaging_Messages(                    
  					[PortalID],
					[To],
					[From],					
					[Subject],
					[Body],
					[ConversationID],
					[ReplyAllAllowed],
					[SenderUserID],
                    [CreatedByUserID],
                    [CreatedOnDate],
                    [LastModifiedByUserID],
                    [LastModifiedOnDate]			        
                    )
            VALUES  (       
     			    @PortalID,
					@To,
					@From,
				    @Subject,			
					@Body,
					NULL,
					@ReplyAllAllowed,
					@SenderUserID,
                    @CreateUpdateUserID , -- CreatedBy - int
                    GETUTCDATE(), -- CreatedOn - datetime
                    @CreateUpdateUserID , -- LastModifiedBy - int
                    GETDATE() -- LastModifiedOn - datetime			        
                    )
                    
            SELECT  @MessageID = SCOPE_IDENTITY()
			UPDATE  {databaseOwner}{objectQualifier}CoreMessaging_Messages SET [ConversationID] = @MessageID WHERE [MessageID] = @MessageID 
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}CoreMessaging_Messages
            SET     [To] = @To,
					[From] = @From,
					[Subject] = @Subject,			
					[Body] = @Body,
					[ConversationID] = @ConversationID,
					[ReplyAllAllowed] = @ReplyAllAllowed,
					[SenderUserID] = SenderUserID,
                    LastModifiedByUserID = @CreateUpdateUserID,
                    LastModifiedOnDate = GETDATE()
            WHERE   MessageID = @MessageID
        END
        
    SELECT  @MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateServerActivity]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateServerActivity]
    @ServerName			NVARCHAR(50),
    @IISAppName			NVARCHAR(200),
    @CreatedDate		DATETIME,
    @LastActivityDate	DATETIME,
    @PingFailureCount   INT,
    @Enabled            BIT
AS

	DECLARE @ServerID int
	SET @ServerID = (SELECT ServerID FROM {databaseOwner}{objectQualifier}WebServers WHERE ServerName = @ServerName AND IISAppName = @IISAppName)

	IF @ServerID IS NULL
		BEGIN
			-- Insert
			INSERT INTO {databaseOwner}{objectQualifier}WebServers (
				ServerName,
				IISAppName,
				CreatedDate,
				LastActivityDate,
                PingFailureCount,
				[Enabled]
			)
			VALUES (
				@ServerName,
				@IISAppName,
				@CreatedDate,
				@LastActivityDate,
                @PingFailureCount,
				@Enabled
			)

            SELECT @ServerID = SCOPE_IDENTITY()
		END
	ELSE
		BEGIN
			-- Update
			UPDATE {databaseOwner}{objectQualifier}WebServers 
				SET 
					LastActivityDate = @LastActivityDate, PingFailureCount = @PingFailureCount, [Enabled] = @Enabled
				WHERE  ServerName = @ServerName AND IISAppName = @IISAppName
		END

    SELECT @ServerID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddUser]

	@PortalID		int,
	@Username		nvarchar(100),
	@FirstName		nvarchar(50),
	@LastName		nvarchar(50),
	@AffiliateId    int,
	@IsSuperUser    bit,
	@Email          nvarchar(256),
	@DisplayName    nvarchar(100),
	@UpdatePassword	bit,
	@Authorised		bit,
	@CreatedByUserID int
AS

DECLARE @UserID int

SELECT @UserID = UserID
	FROM {databaseOwner}{objectQualifier}Users
	WHERE  Username = @Username

IF @UserID is null
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}Users (
			Username,
			FirstName, 
			LastName, 
			AffiliateId,
			IsSuperUser,
			Email,
			DisplayName,
			UpdatePassword,
			CreatedByUserID,
			CreatedOnDate,
			LastModifiedByUserID,
			LastModifiedOnDate
		  )
		VALUES (
			@Username,
			@FirstName, 
			@LastName, 
			@AffiliateId,
			@IsSuperUser,
			@Email,
			@DisplayName,
			@UpdatePassword,
			@CreatedByUserID,
			getdate(),
			@CreatedByUserID,
			getdate()
		)

		SELECT @UserID = SCOPE_IDENTITY()
	END

	IF not exists ( SELECT 1 FROM {databaseOwner}{objectQualifier}UserPortals WHERE UserID = @UserID AND PortalID = @PortalID ) AND @PortalID > -1
		BEGIN
			INSERT INTO {databaseOwner}{objectQualifier}UserPortals (
				UserID,
				PortalID,
				Authorised,
				CreatedDate
			)
			VALUES (
				@UserID,
				@PortalID,
				@Authorised,
				getdate()
			)
		END

SELECT @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowStatePermissionsByStateID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowStatePermissionsByStateID]
	@StateID int
AS
    SELECT *
    FROM {databaseOwner}{objectQualifier}vw_ContentWorkflowStatePermissions
	WHERE StateID = @StateID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteUserFromConversation]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteUserFromConversation]
	@ConversationID INT,
    @UserID INT
AS
    --Remove the User from recipients list
	DELETE FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
		WHERE [UserID] = @UserID
		AND MessageID IN (SELECT MessageID FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WHERE ConversationID = @ConversationID)
    
    --Remove Messages which has no recipient
    DELETE FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages]
        FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] m
        LEFT JOIN {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] mr on MR.MessageID = m.MessageID
        WHERE ConversationID = @ConversationID AND mr.MessageID IS NULL
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSystemMessage]'
GO
create procedure {databaseOwner}[{objectQualifier}UpdateSystemMessage]

@PortalID     int,
@MessageName  nvarchar(50),
@MessageValue ntext

as

update {databaseOwner}{objectQualifier}SystemMessages
set    MessageValue = @MessageValue
where  ((PortalID = @PortalID) or (PortalID is null and @PortalID is null))
and    MessageName = @MessageName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteContentWorkflowStatePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteContentWorkflowStatePermission]
	@WorkflowStatePermissionID int
AS
    DELETE FROM {databaseOwner}{objectQualifier}ContentWorkflowStatePermission
    WHERE WorkflowStatePermissionID = @WorkflowStatePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateHeirarchicalTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateHeirarchicalTerm] 
	@TermID					int, 
	@VocabularyID			int,
	@ParentTermID			int,
	@Name					nvarchar(250),
	@Description			nvarchar(2500),
	@Weight					int,
	@LastModifiedByUserID	int
AS

	DECLARE @Left				int
	DECLARE @Right				int
	DECLARE @Width				int
	
	SET @Left = (SELECT TermLeft FROM {databaseOwner}{objectQualifier}Taxonomy_Terms WHERE TermID = @TermID)
	SET @Right = (SELECT TermRight FROM {databaseOwner}{objectQualifier}Taxonomy_Terms WHERE TermID = @TermID)
	SET @Width = @Right - @Left + 1
	
	BEGIN TRANSACTION
		BEGIN
			-- Temporarily remove term from heirarchy - but retain information about term and children 
			-- (these should now be -n, ...,-2,-1 etc)
			UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
				SET TermLeft = TermLeft - @Right - 1,
					TermRight = TermRight - @Right - 1
				WHERE TermLeft >= @Left
					AND TermRight <= @Right
					AND VocabularyID = @VocabularyID
			
			IF @@ERROR = 0
				BEGIN
					-- Update Left values for all items that are after the original term
					UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
						SET TermLeft = TermLeft - @Width 
						WHERE TermLeft >= @Left + @Width
							AND VocabularyID = @VocabularyID

					IF @@ERROR = 0
						BEGIN
						-- Update Right values for all items that are after the original term
							UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
								SET TermRight = TermRight - @Width 
								WHERE TermRight >= @Right
									AND VocabularyID = @VocabularyID

							IF @@ERROR = 0
								BEGIN
									-- Get Left value of Sibling that we are inserting before
									SET @Left = (SELECT TOP 1 TermLeft FROM {databaseOwner}{objectQualifier}Taxonomy_Terms 
														WHERE VocabularyID = @VocabularyID 
															AND ParentTermID = @ParentTermID
															AND Name > @Name
														ORDER BY Name)
														
									-- Term is to be inserted at end of sibling list so get the Right value of the parent, which will become our new left value						
									IF @Left IS NULL
										SET @Left = (SELECT TermRight FROM {databaseOwner}{objectQualifier}Taxonomy_Terms 
															WHERE VocabularyID = @VocabularyID 
																AND TermID = @ParentTermID)

									-- Left is still null means this is the first term in this vocabulary - set the Left to 1
									IF @Left IS NULL
										SET @Left = 1
							
									SET @Right = @Left + @Width - 1
																	
									-- Update Left values for all items that are after the updated term
									UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
										SET TermLeft = TermLeft + @Width 
										WHERE TermLeft >= @Left
											AND VocabularyID = @VocabularyID

									IF @@ERROR = 0
										BEGIN
										-- Update Right values for all items that are after the term
											UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
												SET TermRight = TermRight + @Width 
												WHERE TermRight >= @Left
													AND VocabularyID = @VocabularyID

											IF @@ERROR = 0
												BEGIN
													-- Update Left/Right values for all items temporarily removed from heirarchy
													UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms 
														SET TermLeft = TermLeft + @Left + @Width,
															TermRight = TermRight + @Left + @Width
														WHERE TermLeft < 0
															AND TermRight < 0
															AND VocabularyID = @VocabularyID

													IF @@ERROR = 0
														BEGIN
															-- Update Term
															UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms
																SET 
																	VocabularyID = @VocabularyID,
																	ParentTermID = @ParentTermID,
																	[Name] = @Name,
																	Description = @Description,
																	Weight = @Weight,
																	LastModifiedByUserID = @LastModifiedByUserID,
																	LastModifiedOnDate = getdate()
															WHERE TermID = @TermID

															IF @@ERROR = 0
																BEGIN
																	COMMIT TRANSACTION
																END
															ELSE
																BEGIN
																	-- Rollback the transaction
																	ROLLBACK TRANSACTION		
																END
															END
													ELSE
														BEGIN
															-- Rollback the transaction
															ROLLBACK TRANSACTION
														END
													END
											ELSE
												BEGIN
													-- Rollback the transaction
													ROLLBACK TRANSACTION
												END
											END
									ELSE
										BEGIN
											-- Rollback the transaction
											ROLLBACK TRANSACTION
										END
									END
								ELSE
									BEGIN
										-- Rollback the transaction
										ROLLBACK TRANSACTION		
									END
							END
					ELSE
						BEGIN
							-- Rollback the transaction
							ROLLBACK TRANSACTION
						END
				END
			ELSE
				BEGIN
					-- Rollback the transaction
					ROLLBACK TRANSACTION		
				END
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_UserRoles]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_UserRoles]
AS
	SELECT     
		UR.UserRoleID, 
		R.RoleID, 
		U.UserID, 
		R.PortalID, 
		R.RoleName, 
		U.Username, 
		R.Description, 
		U.DisplayName, 
		U.Email,
		UR.Status, 
		UR.IsOwner,
		R.SecurityMode,
		R.ServiceFee, 
		R.BillingFrequency, 
		R.TrialPeriod, 
        R.TrialFrequency, 
		R.BillingPeriod, 
		R.TrialFee, 
		R.IsPublic, 
		R.AutoAssignment, 
		R.RoleGroupID, 
		R.RSVPCode, 
		R.IconFile, 
		UR.EffectiveDate, 
		UR.ExpiryDate, 
        UR.IsTrialUsed, 
		UR.CreatedByUserID, 
		UR.CreatedOnDate, 
		UR.LastModifiedByUserID, 
		UR.LastModifiedOnDate,
		R.IsSystemRole 
	FROM {databaseOwner}{objectQualifier}UserRoles AS UR 
		INNER JOIN {databaseOwner}{objectQualifier}Users AS U ON UR.UserID = U.UserID 
		INNER JOIN {databaseOwner}{objectQualifier}Roles AS R ON UR.RoleID = R.RoleID
	WHERE R.Status = 1
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRolesByUsername]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRolesByUsername]
	@PortalID int, 
	@Username nvarchar(100), 
	@Rolename nvarchar(50)
AS
	IF @UserName Is Null
		BEGIN
			SELECT	*
				FROM {databaseOwner}{objectQualifier}vw_UserRoles
				WHERE PortalId = @PortalID AND (Rolename = @Rolename or @RoleName is NULL)
		END
	ELSE
		BEGIN
			IF @RoleName Is NULL
				BEGIN
					SELECT	*
						FROM {databaseOwner}{objectQualifier}vw_UserRoles
						WHERE PortalId = @PortalID AND (Username = @Username or @Username is NULL)
				END
			ELSE
				BEGIN
					SELECT	*
						FROM {databaseOwner}{objectQualifier}vw_UserRoles
						WHERE PortalId = @PortalID
							AND (Rolename = @Rolename or @RoleName is NULL)
							AND (Username = @Username or @Username is NULL)
				END
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSkinControlByPackageID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSkinControlByPackageID]
	@PackageID	int
AS
    SELECT *
    FROM   {databaseOwner}{objectQualifier}SkinControls
	WHERE PackageID = @PackageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetSentBox]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetSentBox]
	@UserID INT,
	@PortalID INT,
	@AfterMessageId INT,
	@NumberOfRecords INT,
	@SortField NVARCHAR(25) = 'CreatedOnDate',
	@SortAscending BIT = 0
AS
BEGIN
	;WITH RollUpMessageIDs AS
	(
		SELECT MAX(m.MessageID) AS TopMessageID
		FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] mr
		INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] m ON mr.MessageID = m.MessageID AND mr.UserID = m.SenderUserID --make sure sender haven't delete the message.
		WHERE SenderUserID = @UserID AND NotificationTypeID IS NULL AND PortalID = @PortalID
		GROUP BY ConversationID
	), SentBox AS
	(
		SELECT DISTINCT m.[MessageID], [ConversationID], [Subject], CONVERT(NVARCHAR(50), [Body]) AS Body,
				[To], [From], [ReplyAllAllowed], [SenderUserID],
				m.[CreatedByUserID], m.[CreatedOnDate],
				m.[LastModifiedByUserID], m.[LastModifiedOnDate],
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments WHERE MessageID = m.MessageID) AS AttachmentCount,
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages WHERE ConversationID = m.ConversationID) AND UserID = @UserID AND [READ] = 0) AS NewThreadCount,
				(SELECT COUNT(*) FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages WHERE ConversationID = m.ConversationID) AND UserID = @UserID) AS ThreadCount,
				ROW_NUMBER() OVER(ORDER BY
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 1 THEN m.[CreatedOnDate] END ASC,
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 0 THEN m.[CreatedOnDate] END DESC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 1 THEN [From] END ASC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 0 THEN [From] END DESC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 1 THEN [Subject] END ASC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 0 THEN [Subject] END DESC
					) AS RowNumber
		FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages AS m
		WHERE m.MessageID IN (SELECT TopMessageID FROM RollUpMessageIDs)
	)
	SELECT * FROM SentBox
	WHERE (@AfterMessageID > 0 AND RowNumber BETWEEN (SELECT RowNumber + 1 FROM SentBox WHERE [MessageID] = @AfterMessageID) AND (SELECT RowNumber + @NumberOfRecords FROM SentBox WHERE [MessageID] = @AfterMessageID)) OR
	(@AfterMessageID = -1 AND RowNumber BETWEEN 1 AND @NumberOfRecords)
	ORDER BY RowNumber ASC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersByPropertyName]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetUsersByPropertyName]
(
	@PropertyName nvarchar(100),
	@PropertyValue nvarchar(max),
	@PortalID int
)
RETURNS TABLE
AS
	RETURN
		SELECT *
			FROM {databaseOwner}[{objectQualifier}vw_Profile]
			WHERE PropertyName = @PropertyName 
				AND PropertyValue LIKE @PropertyValue
				AND PortalID = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddContentWorkflowStatePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddContentWorkflowStatePermission]
	@StateID int,
	@PermissionID int,
	@RoleID int,
	@AllowAccess bit,
	@UserID int,
	@CreatedByUserID int
AS

	INSERT INTO {databaseOwner}{objectQualifier}ContentWorkflowStatePermission (
		[StateID],
		[PermissionID],
		[RoleID],
		[AllowAccess],
		[UserID],
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	) VALUES (
		@StateID,
		@PermissionID,
		@RoleID,
		@AllowAccess,
		@UserID,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_GetPreviewProfiles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_GetPreviewProfiles] @PortalId INT
AS 
    SELECT  Id, PortalId, Name, Width, Height, UserAgent, SortOrder, CreatedByUserID, CreatedOnDate, LastModifiedByUserID, LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}Mobile_PreviewProfiles
    WHERE   PortalId = @PortalId
	ORDER BY SortOrder ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateDatabaseVersionIncrement]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateDatabaseVersionIncrement] 

	@Major  int,
	@Minor  int,
	@Build  int,
	@Increment int,
	@Name	nvarchar(50)

AS

	UPDATE {databaseOwner}{objectQualifier}Version
	SET Increment=@Increment where Major=@Major AND Minor=@Minor AND Build=@Build AND Name=@Name
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRelationshipsByMultipleIDs]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRelationshipsByMultipleIDs] 
	@UserID INT,
	@RelatedUserID INT,
	@RelationshipID INT,
	@Direction INT
AS 
	IF ( @Direction = 1 ) --OneWay
	  BEGIN
		SELECT  UserRelationshipID,
				UserID,
				RelatedUserID,
				RelationshipID,            
				Status,            
				CreatedByUserID ,
				CreatedOnDate ,
				LastModifiedByUserID ,
				LastModifiedOnDate
		FROM    {databaseOwner}{objectQualifier}UserRelationships    
		WHERE UserID = @UserID
		AND   RelatedUserID = @RelatedUserID
		AND   RelationshipID = @RelationshipID
		ORDER BY UserRelationshipID ASC    
	  END
	  ELSE IF ( @Direction = 2 ) --TwoWay
	  BEGIN
		SELECT  UserRelationshipID,
				UserID,
				RelatedUserID,
				RelationshipID,            
				Status,            
				CreatedByUserID ,
				CreatedOnDate ,
				LastModifiedByUserID ,
				LastModifiedOnDate
		FROM    {databaseOwner}{objectQualifier}UserRelationships    		
		WHERE (  (UserID = @UserID AND RelatedUserID = @RelatedUserID) 
			  OR (RelatedUserID = @UserID AND UserID = @RelatedUserID) --swap userids and check
			  )
		AND   RelationshipID = @RelationshipID
		ORDER BY UserRelationshipID ASC    
	  END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetArchiveBox]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetArchiveBox]
	@UserID INT,
	@PortalID INT,
	@AfterMessageID INT,
	@NumberOfRecords INT,
	@SortField NVARCHAR(25) = 'CreatedOnDate',
	@SortAscending BIT = 0
AS
BEGIN
	;WITH RollUpMessageIDs AS
	(
		SELECT MAX(m.MessageID) AS TopMessageID
		FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] mr
		INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] m ON mr.MessageID = m.MessageID
		WHERE NotificationTypeID IS NULL AND PortalID = @PortalID AND MR.UserID = @UserID AND MR.Archived = 1
		GROUP BY ConversationID
	), ArchiveBox AS
	(
		SELECT DISTINCT m.[MessageID], [ConversationID], [Subject], convert(nvarchar(50), [Body]) AS Body,
				[To], [From], [ReplyAllAllowed], [SenderUserID],
				m.[CreatedByUserID], m.[CreatedOnDate],
				m.[LastModifiedByUserID], m.[LastModifiedOnDate],
				(SELECT COUNT(*) FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments] WHERE MessageID = m.MessageID) AS AttachmentCount,
				(SELECT COUNT(*) FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WHERE ConversationID = m.ConversationID) AND UserID = @UserID AND [READ] = 0) AS NewThreadCount,
				(SELECT COUNT(*) FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WHERE ConversationID = m.ConversationID) AND UserID = @UserID) AS ThreadCount,
				ROW_NUMBER() OVER(ORDER BY
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 1 THEN m.[CreatedOnDate] END ASC,
					 CASE WHEN @SortField = 'CreatedOnDate' AND @SortAscending = 0 THEN m.[CreatedOnDate] END DESC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 1 THEN [From] END ASC,
					 CASE WHEN @SortField = 'From' AND @SortAscending = 0 THEN [From] END DESC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 1 THEN [Subject] END ASC,
					 CASE WHEN @SortField = 'Subject' AND @SortAscending = 0 THEN [Subject] END DESC
					) AS RowNumber
		FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] AS m
		WHERE m.MessageID IN (SELECT TopMessageID FROM RollUpMessageIDs)
	)
	SELECT * FROM ArchiveBox
	WHERE (@AfterMessageID > 0 AND RowNumber BETWEEN (SELECT RowNumber + 1 FROM ArchiveBox WHERE [MessageID] = @AfterMessageID) AND (SELECT RowNumber + @NumberOfRecords FROM ArchiveBox WHERE [MessageID] = @AfterMessageID)) OR
	(@AfterMessageID = -1 AND RowNumber BETWEEN 1 AND @NumberOfRecords)
	ORDER BY RowNumber ASC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateVocabulary]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateVocabulary] 
	@VocabularyID			int,
	@VocabularyTypeID		int,
	@Name					nvarchar(250),
	@Description			nvarchar(2500),
	@Weight					int,
	@ScopeID				int,
	@ScopeTypeID			int,
	@LastModifiedByUserID	int
AS
	UPDATE {databaseOwner}{objectQualifier}Taxonomy_Vocabularies
		SET 
			VocabularyTypeID = @VocabularyTypeID,
			[Name] = @Name,
			Description = @Description,
			Weight = @Weight,
			ScopeID = @ScopeID,
			ScopeTypeID = @ScopeTypeID,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
	WHERE VocabularyId = @VocabularyId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateContentWorkflowStatePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateContentWorkflowStatePermission]
	@WorkflowStatePermissionID int, 
	@StateID int, 
	@PermissionID int, 
	@RoleID int ,
	@AllowAccess bit,
    @UserID int,
	@LastModifiedByUserID	int
AS
    UPDATE {databaseOwner}{objectQualifier}ContentWorkflowStatePermission 
    SET     
	    [StateID] = @StateID,
	    [PermissionID] = @PermissionID,
	    [RoleID] = @RoleID,
	    [AllowAccess] = @AllowAccess,
        [UserID] = @UserID,
        [LastModifiedByUserID] = @LastModifiedByUserID,
	    [LastModifiedOnDate] = getdate()
    WHERE
		[WorkflowStatePermissionID] = @WorkflowStatePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUnAuthorizedUsers]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUnAuthorizedUsers]
	@PortalID       int,
	@IncludeDeleted bit,
	@SuperUsersOnly bit		
AS
	SELECT  *
	FROM	{databaseOwner}{objectQualifier}vw_Users
	WHERE  PortalId = @PortalID
		AND Authorised = 0
		AND IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
		--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
		AND IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
	ORDER BY UserName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentItemsByVocabularyId]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentItemsByVocabularyId] 
	@VocabularyID int
AS
BEGIN
	SELECT c.*
	FROM {databaseOwner}{objectQualifier}ContentItems As c
		INNER JOIN {databaseOwner}{objectQualifier}ContentItems_Tags ct ON ct.ContentItemID = c.ContentItemID
		INNER JOIN {databaseOwner}{objectQualifier}Taxonomy_Terms t ON t.TermID = ct.TermID
	WHERE t.VocabularyID = @VocabularyID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetLastAppliedIteration]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetLastAppliedIteration] 

	@Major  int,
	@Minor  int,
	@Build  int	

AS

	SELECT ISNULL(MAX(Increment),0) from {databaseOwner}{objectQualifier}Version WHERE Major=@Major AND Minor=@Minor AND Build=@Build
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountArchivedConversations]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountArchivedConversations]
	@UserID INT,
	@PortalID INT
AS
BEGIN
	SELECT COUNT(DISTINCT M.ConversationID) AS TotalRecords
	    FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] M
	    JOIN {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR ON M.MessageID = MR.MessageID
	    WHERE Archived = 1
	        AND NotificationTypeID IS NULL AND PortalID = @PortalID AND UserID = @UserID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentWorkflowLogs]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentWorkflowLogs]
(
[WorkflowLogID] [int] NOT NULL IDENTITY(1, 1),
[Action] [nvarchar] (40) NOT NULL,
[Comment] [nvarchar] (max) NOT NULL,
[Date] [datetime] NOT NULL,
[User] [int] NOT NULL,
[WorkflowID] [int] NOT NULL,
[ContentItemID] [int] NOT NULL,
[Type] [int] NOT NULL DEFAULT ((-1))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentWorkflowLogs] on {databaseOwner}[{objectQualifier}ContentWorkflowLogs]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowLogs] ADD CONSTRAINT [PK_{objectQualifier}ContentWorkflowLogs] PRIMARY KEY CLUSTERED  ([WorkflowLogID])
GO
PRINT N'Creating index [IX_{objectQualifier}ContentWorkflowLogs_ContentItemId] on {databaseOwner}[{objectQualifier}ContentWorkflowLogs]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}ContentWorkflowLogs_ContentItemId] ON {databaseOwner}[{objectQualifier}ContentWorkflowLogs] ([ContentItemID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddContentWorkflowLog]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddContentWorkflowLog]
	@Action nvarchar(40),
	@Comment nvarchar(256),
	@User int,
	@WorkflowID int,
	@ContentItemID int
AS
    INSERT INTO {databaseOwner}[{objectQualifier}ContentWorkflowLogs] (
		[Action],
		[Comment],
		[Date],
		[User],
		[WorkflowID],
		[ContentItemID]
	) VALUES (
		@Action,
		@Comment,
		getdate(),
		@User,
		@WorkflowID,
		@ContentItemID
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_SplitText]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}Journal_SplitText](@text varchar(8000), @delimiter char(1))
RETURNS @words TABLE (objectid smallint primary key, string varchar(1000), optionalid int)
AS
BEGIN
	DECLARE @pos smallint,
		@i smallint,
		@j smallint,
		@s varchar(255),
        @o int

	SET @pos = 1

	WHILE @pos <= LEN(@text)
	BEGIN
		SET @i = CHARINDEX(' ', @text, @pos)
		SET @j = CHARINDEX(@delimiter, @text, @pos)

		IF @i > 0 OR @j > 0
		BEGIN
			IF @i = 0 OR (@j > 0 AND @j < @i)
				SET @i = @j

			IF @i > @pos
			BEGIN
				-- @i now holds the earliest delimiter in the string
				SET @s = SUBSTRING(@text, @pos, @i - @pos)
				SET @o = 0
	            IF CHARINDEX('|',@s,0) > 0
					BEGIN
						SET @o = SUBSTRING(@s,0,CHARINDEX('|',@s,0))
						SET @s = SUBSTRING(@s,CHARINDEX('|',@s,0)+1,LEN(@s))

					END

				IF NOT EXISTS (SELECT 1 FROM @words WHERE [string]=@s)
				BEGIN
					INSERT INTO @words
					VALUES (@pos, @s, @o)
				END
			END

			SET @pos = @i + 1
			WHILE @pos < LEN(@text) AND SUBSTRING(@text, @pos, 1) IN (' ', ',')
				SET @pos = @pos + 1
		END
		ELSE
		BEGIN
			SET @s = SUBSTRING(@text, @pos, LEN(@text) - @pos + 1)
			IF CHARINDEX('|',@s,0) > 0
			BEGIN
				SET @o = SUBSTRING(@s,0,CHARINDEX('|',@s,0))
				SET @s = SUBSTRING(@s,CHARINDEX('|',@s,0)+1,LEN(@s))

			END

			IF NOT EXISTS (SELECT 1 FROM @words WHERE [string]=@s)
			BEGIN
				INSERT INTO @words
				VALUES (@pos, @s ,@o)
			END

			SET @pos = LEN(@text) + 1
		END
	END

	RETURN
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Save]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Save]
@PortalId int,
@JournalId int,
@JournalTypeId int,
@UserId int,
@ProfileId int,
@GroupId int,
@Title nvarchar(255),
@Summary nvarchar(2000),
@ItemData nvarchar(2000),
@JournalXML xml,
@ObjectKey nvarchar(255),
@AccessKey uniqueidentifier,
@SecuritySet nvarchar(2000),
@CommentsDisabled bit,
@CommentsHidden bit
AS
INSERT INTO {databaseOwner}[{objectQualifier}Journal]
	(JournalTypeId, UserId, DateCreated, DateUpdated, PortalId, ProfileId, GroupId,Title,Summary, ObjectKey, AccessKey, ItemData, CommentsHidden, CommentsDisabled)
	VALUES
	(@JournalTypeId, @UserId, GETUTCDATE(), GETUTCDATE(), @PortalId, @ProfileId, @GroupId, @Title, @Summary, @ObjectKey, @AccessKey, @ItemData, @CommentsHidden, @CommentsDisabled)
SET @JournalId = SCOPE_IDENTITY()
BEGIN
INSERT INTO {databaseOwner}[{objectQualifier}Journal_Security]
	(JournalId, SecurityKey) 
	SELECT @JournalId, string from {databaseOwner}[{objectQualifier}Journal_SplitText](@SecuritySet,',')
END
IF @JournalXML IS NOT NULL
BEGIN
INSERT INTO {databaseOwner}[{objectQualifier}Journal_Data]
	(JournalId, JournalXML)
	VALUES
	(@JournalId, @JournalXML)
END
SELECT @JournalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountMessagesByConversation]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountMessagesByConversation]
	@ConversationID int
AS
BEGIN
	SELECT COUNT(*) AS TotalRecords
	FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages
	WHERE (ConversationID = @ConversationID)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountSentConversations]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountSentConversations]
	@UserID INT,
	@PortalID INT
AS
BEGIN
	SELECT COUNT(DISTINCT ConversationID) AS TotalRecords
	    FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] m
        INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] mr ON mr.MessageID = m.MessageID AND mr.UserID = m.SenderUserID --make sure sender haven't delete the message.
	    WHERE SenderUserID = @UserID
	        AND NotificationTypeID IS NULL AND PortalID = @PortalID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowLogs]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowLogs]
	@ContentItemID int,
	@WorkflowID int
AS
    SELECT *
	FROM {databaseOwner}[{objectQualifier}ContentWorkflowLogs]
	WHERE ContentItemID = @ContentItemID AND WorkflowID = @WorkflowID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Update]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Update]
@PortalId int,
@JournalId int,
@JournalTypeId int,
@UserId int,
@ProfileId int,
@GroupId int,
@Title nvarchar(255),
@Summary nvarchar(2000),
@ItemData nvarchar(2000),
@JournalXML xml,
@ObjectKey nvarchar(255),
@AccessKey uniqueidentifier,
@SecuritySet nvarchar(2000),
@CommentsDisabled bit,
@CommentsHidden bit
AS
UPDATE {databaseOwner}[{objectQualifier}Journal]
	SET 
		JournalTypeId = @JournalTypeId,
		UserId = @UserId,
		DateUpdated = GETUTCDATE(),
		PortalId = @PortalId,
		ProfileId = @ProfileId,
		GroupId = @GroupId,
		Title = @Title,
		Summary = @Summary,
		ObjectKey = @ObjectKey,
		AccessKey = @AccessKey,
		ItemData = @ItemData,
		CommentsHidden = @CommentsHidden,
		CommentsDisabled = @CommentsDisabled
	WHERE JournalId = @JournalId
IF @SecuritySet IS NOT NULL AND @SecuritySet <> ''
BEGIN
DELETE FROM {databaseOwner}[{objectQualifier}Journal_Security] WHERE JournalId = @JournalId
INSERT INTO {databaseOwner}[{objectQualifier}Journal_Security]
	(JournalId, SecurityKey) 
	SELECT @JournalId, string from {databaseOwner}[{objectQualifier}Journal_SplitText](@SecuritySet,',')
END
SELECT @JournalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ScheduleItemSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ScheduleItemSettings]
(
[ScheduleID] [int] NOT NULL,
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (max) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ScheduleItemSettings] on {databaseOwner}[{objectQualifier}ScheduleItemSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ScheduleItemSettings] ADD CONSTRAINT [PK_{objectQualifier}ScheduleItemSettings] PRIMARY KEY CLUSTERED  ([ScheduleID], [SettingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddScheduleItemSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddScheduleItemSetting]
	@ScheduleID int,
	@Name nvarchar(50),
	@Value nvarchar(256)
AS
BEGIN
	UPDATE {databaseOwner}[{objectQualifier}ScheduleItemSettings]
	SET SettingValue = @Value
	WHERE ScheduleID = @ScheduleID
	AND SettingName = @Name

	IF @@ROWCOUNT = 0 BEGIN
		INSERT INTO {databaseOwner}[{objectQualifier}ScheduleItemSettings] (ScheduleID, SettingName, Settingvalue)
		VALUES (@ScheduleID, @Name, @Value)
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSchedule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSchedule]
 @Server varchar(150)
AS
BEGIN
SELECT
  S.*
  , (SELECT max(S1.NextStart)
   FROM {databaseOwner}{objectQualifier}ScheduleHistory S1
   WHERE S1.ScheduleID = S.ScheduleID) as NextStart
 FROM {databaseOwner}{objectQualifier}Schedule S
 WHERE
	(
		@Server IS NULL OR 
		S.Servers LIKE '%,' + @Server + ',%' OR
		S.Servers LIKE @Server + ',%' OR
		S.Servers LIKE '%,' + @Server OR
		S.Servers = @Server OR
		S.Servers IS NULL)
	ORDER BY FriendlyName ASC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RestoreUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}RestoreUser]
	@UserID		int,
	@PortalID   int
AS
	IF @PortalID IS NULL
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}Users
				SET	IsDeleted = 0
				WHERE  UserId = @UserID
		END
	ELSE
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}UserPortals
				SET IsDeleted = 0
				WHERE  UserId = @UserID
					AND PortalId = @PortalID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentItems]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentItems] 
	@ContentTypeId	int,
	@TabId			int,
	@ModuleId		int
AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}ContentItems
	WHERE (ContentTypeId = @ContentTypeId OR @ContentTypeId IS NULL)
		AND (TabId = @TabId OR @TabId IS NULL)
		AND (ModuleId = @ModuleId OR @ModuleId IS NULL)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteContentWorkflowLogs]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteContentWorkflowLogs]
	@ContentItemID int,
	@WorkflowID int
AS
    DELETE FROM {databaseOwner}[{objectQualifier}ContentWorkflowLogs]
	WHERE ContentItemID = @ContentItemID AND WorkflowID = @WorkflowID

	SELECT @@ROWCOUNT
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_AddNotificationTypeAction]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_AddNotificationTypeAction]
	@NotificationTypeID int,
	@NameResourceKey nvarchar(100),
	@DescriptionResourceKey nvarchar(100),
	@ConfirmResourceKey nvarchar(100),
	@APICall nvarchar(500),
	@CreatedByUserID int
AS
BEGIN
	DECLARE @Order int 
	
	SELECT @Order = MAX([Order])
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]
	WHERE [NotificationTypeID] = @NotificationTypeID
	
	IF @Order IS NULL
		SET @Order = 1
	ELSE
		SET @Order = @Order + 2
		
	INSERT INTO {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions] (
		[NotificationTypeID],
		[NameResourceKey],
		[DescriptionResourceKey],
		[ConfirmResourceKey],
		[Order],
		[APICall],
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	) VALUES (
		@NotificationTypeID,
		@NameResourceKey,
		@DescriptionResourceKey,
		@ConfirmResourceKey,
		@Order,
		@APICall,
		@CreatedByUserID,
		GETDATE(),
		@CreatedByUserID,
		GETDATE()
	)
	
	SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comments_ToggleDisable]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comments_ToggleDisable]
@PortalId int,
@JournalId int,
@Disabled bit
AS
UPDATE {databaseOwner}[{objectQualifier}Journal]
	SET CommentsDisabled = @Disabled
	WHERE PortalId = @PortalId AND JournalId = @JournalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabSettings]
	@TabID      	INT

AS

	DELETE	FROM {databaseOwner}{objectQualifier}TabSettings 
	WHERE	TabID = @TabID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabPaths]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabPaths] 
	@PortalID		INT,
	@CultureCode	NVARCHAR(10)
AS
	SELECT
		TabID, 
		PortalID, 
		TabPath
	FROM {databaseOwner}{objectQualifier}vw_Tabs
	WHERE (PortalID = @PortalID AND (CultureCode = @CultureCode OR CultureCode Is NULL OR ISNULL(@CultureCode, '') = ''))
		OR @PortalID Is NULL
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteUserRelationship]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteUserRelationship] @UserRelationshipID INT	
AS 
	BEGIN
		DELETE FROM {databaseOwner}{objectQualifier}UserRelationships  
			WHERE UserRelationshipID = @UserRelationshipID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_GetByKey]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_GetByKey]
	@PortalId INT,
	@ObjectKey NVARCHAR(255),
	@IncludeAllItems INT = 0,
	@IsDeleted INT = 0
	AS
	SELECT     j.JournalId, j.JournalTypeId, j.Title, j.Summary, j.UserId, j.DateCreated, j.DateUpdated, j.PortalId,
				j.ProfileId, j.GroupId, j.ObjectKey, j.AccessKey,
				"JournalOwner" = '<entity><id>' + CAST(p.UserId as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name></entity>',
				"JournalAuthor" = CASE WHEN ISNULL(a.UserId,-1) >0 THEN '<entity><id>' + CAST(a.UserId as nvarchar(150)) + '</id><name><![CDATA[' + a.DisplayName + ']]></name></entity>' ELSE '' END,
				"JournalOwnerId" = ISNULL(j.ProfileId,j.UserId),
				 jt.Icon, jt.JournalType,
				"Profile" = CASE WHEN j.ProfileId > 0 THEN '<entity><id>' + CAST(p.UserID as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name><vanity></vanity></entity>' ELSE '' END,
				"SimilarCount" = (SELECT COUNT(JournalId) FROM {databaseOwner}{objectQualifier}Journal WHERE ContentItemId = j.ContentItemId AND JournalTypeId = j.JournalTypeId),
				jd.JournalXML, ContentItemId, j.ItemData, j.IsDeleted, j.CommentsDisabled, j.CommentsHidden
	FROM       	{databaseOwner}[{objectQualifier}Journal] AS j INNER JOIN
				{databaseOwner}[{objectQualifier}Journal_Types] as jt ON jt.JournalTypeId = j.JournalTypeId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Journal_Data] as jd on jd.JournalId = j.JournalId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS p ON j.ProfileId = p.UserID LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS a ON j.UserId = a.UserID
	WHERE		((@IncludeAllItems = 0) AND (j.ObjectKey = @ObjectKey AND j.ObjectKey IS NOT NULL AND @ObjectKey <> '' AND j.IsDeleted = @IsDeleted)) 
				OR 
				((@IncludeAllItems = 1) AND (j.ObjectKey = @ObjectKey AND j.ObjectKey IS NOT NULL AND @ObjectKey <> ''))
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserDisplayName]'
GO
-- new helper function, returning Displayname for a userid
CREATE FUNCTION {databaseOwner}[{objectQualifier}UserDisplayName]
(
	@userId Int
)
RETURNS 
	nVarChar(255)
AS
	BEGIN
		DECLARE @DisplayName AS nVarChar(255)

		SELECT  @DisplayName = DisplayName FROM {databaseOwner}[{objectQualifier}Users] WHERE UserID = @UserId
		RETURN  @DisplayName
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUrlLog]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUrlLog]
	@URLTrackingID Int,
	@StartDate DateTime,
	@EndDate DateTime
AS
	BEGIN
		SELECT 
			L.*,
			{databaseOwner}[{objectQualifier}UserDisplayname](L.UserId) AS 'FullName'
		FROM {databaseOwner}{objectQualifier}UrlLog L
			INNER JOIN {databaseOwner} {objectQualifier}UrlTracking T ON L.UrlTrackingId = T.UrlTrackingId
		WHERE L.UrlTrackingID = @UrlTrackingID
			AND ((ClickDate >= @StartDate) OR @StartDate Is Null)
			AND ((ClickDate <= @EndDate ) OR @EndDate Is Null)
		ORDER BY ClickDate
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModuleControl]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteModuleControl]

@ModuleControlId int

as

delete
from   {databaseOwner}{objectQualifier}ModuleControls
where  ModuleControlId = @ModuleControlId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}MoveTabModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}MoveTabModule]
	@FromTabId				int,
	@ModuleId				int,
	@ToTabId				int,
	@PaneName				nvarchar(50),
	@LastModifiedByUserID	int

AS
	UPDATE {databaseOwner}{objectQualifier}TabModules
		SET 
			TabId = @ToTabId,   
			ModuleOrder = -1,
			PaneName = @PaneName,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
		WHERE  TabId = @FromTabId
		AND    ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comments_ToggleHidden]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comments_ToggleHidden]
@PortalId int,
@JournalId int,
@Hidden bit
AS
UPDATE {databaseOwner}[{objectQualifier}Journal]
	SET CommentsHidden = @Hidden
	WHERE PortalId = @PortalId AND JournalId = @JournalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetLists]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}GetLists]
	
	@PortalID int

AS
	SELECT DISTINCT 
		ListName,
		[Level],
		DefinitionID,
		PortalID,
		SystemList,
		EntryCount,
		ParentID,
		ParentKey,
		Parent,
		ParentList,
		MaxSortOrder
	FROM {databaseOwner}{objectQualifier}vw_Lists
	WHERE PortalID = @PortalID
	ORDER BY [Level], ListName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddDesktopModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddDesktopModule]
	@PackageID		int,
	@ModuleName		nvarchar(128),
	@FolderName		nvarchar(128),
	@FriendlyName		nvarchar(128),
	@Description		nvarchar(2000),
	@Version		nvarchar(8),
	@IsPremium		bit,
	@IsAdmin		bit,
	@BusinessController	nvarchar(200),
	@SupportedFeatures	int,
	@Shareable		int,
	@CompatibleVersions	nvarchar(500),
	@Dependencies		nvarchar(400),
	@Permissions		nvarchar(400),
	@ContentItemId		int,
	@CreatedByUserID	int,
	@AdminPage		nvarchar(128),
	@HostPage		nvarchar(128)

AS
	INSERT INTO {databaseOwner}{objectQualifier}DesktopModules (
		PackageID,
		ModuleName,
		FolderName,
		FriendlyName,
		Description,
		Version,
		IsPremium,
		IsAdmin,
		BusinessControllerClass,
		SupportedFeatures,
		Shareable,
		CompatibleVersions,
		Dependencies,
		Permissions,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate,
		ContentItemId,
		AdminPage,
		HostPage
	)
	VALUES (
		@PackageID,
		@ModuleName,
		@FolderName,
		@FriendlyName,
		@Description,
		@Version,
		@IsPremium,
		@IsAdmin,
		@BusinessController,
		@SupportedFeatures,
		@Shareable,
		@CompatibleVersions,
		@Dependencies,
		@Permissions,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate(),
		@ContentItemId,
		@AdminPage,
		@HostPage
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSimpleTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddSimpleTerm] 
	@VocabularyID		int,
	@Name				nvarchar(250),
	@Description		nvarchar(2500),
	@Weight				int,
	@CreatedByUserID	int
AS
	INSERT INTO {databaseOwner}{objectQualifier}Taxonomy_Terms (
		VocabularyID,
		[Name],
		Description,
		Weight,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	)

	VALUES (
		@VocabularyID,
		@Name,
		@Description,
		@Weight,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_ListForGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_ListForGroup]
	@PortalId int,
	@ModuleId int,
	@CurrentUserId int,
	@GroupId int,
	@RowIndex int,
	@MaxRows int,
	@IncludeAllItems int = 0,
	@IsDeleted int = 0
	AS
	DECLARE @EndRow int
	SET @EndRow = @RowIndex + @MaxRows;
		DECLARE @j TABLE(id int IDENTITY, journalid int, datecreated datetime)
	IF EXISTS(SELECT * from {databaseOwner}[{objectQualifier}Journal_TypeFilters] WHERE ModuleId = @ModuleId)
	INSERT INTO @j 
		SELECT j.journalid, jt.datecreated from (
			SELECT DISTINCT js.JournalId from {databaseOwner}[{objectQualifier}Journal] as j
					INNER JOIN {databaseOwner}[{objectQualifier}Journal_Security] as js ON js.JournalId = j.JournalId
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_User_Permissions](@PortalId,@CurrentUserId ,1) as t 
					ON t.seckey = js.SecurityKey AND (js.SecurityKey = 'R' + CAST(@GroupId as nvarchar(100)) OR js.SecurityKey = 'E')
					WHERE j.PortalId = @PortalId
			) as j INNER JOIN {databaseOwner}[{objectQualifier}Journal] jt ON jt.JournalId = j.JournalId AND jt.PortalId = @PortalId AND jt.GroupId = @GroupId
			INNER JOIN {databaseOwner}[{objectQualifier}Journal_TypeFilters] as jf ON jf.JournalTypeId = jt.JournalTypeId AND jf.ModuleId = @ModuleId
			ORDER BY jt.DateCreated DESC, jt.JournalId DESC;
	ELSE
	INSERT INTO @j 
		SELECT j.journalid, jt.datecreated from (
			SELECT DISTINCT js.JournalId from {databaseOwner}[{objectQualifier}Journal] as j
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_Security] as js ON js.JournalId = j.JournalId
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_User_Permissions](@PortalId,@CurrentUserId ,1) as t 
					ON t.seckey = js.SecurityKey AND (js.SecurityKey = 'R' + CAST(@GroupId as nvarchar(100)) OR js.SecurityKey = 'E')
					WHERE j.PortalId = @PortalId
			) as j INNER JOIN {databaseOwner}[{objectQualifier}Journal] jt ON jt.JournalId = j.JournalId AND jt.PortalId = @PortalId AND jt.GroupId = @GroupId
			ORDER BY jt.DateCreated DESC, jt.JournalId DESC;
	WITH journalItems  AS
	(
		SELECT	j.JournalId,
				ROW_NUMBER() OVER (ORDER BY j.JournalId DESC) AS RowNumber
		FROM	{databaseOwner}[{objectQualifier}Journal] as j INNER JOIN @j as jtmp ON jtmp.JournalId = j.JournalId
		WHERE j.PortalId = @PortalId
	)
	SELECT	j.JournalId, j.JournalTypeId, j.Title, j.Summary, j.UserId, j.DateCreated, j.DateUpdated, j.PortalId,
				j.ProfileId, j.GroupId, j.ObjectKey, j.AccessKey,
				"JournalOwner" = '<entity><id>' + CAST(r.RoleId as nvarchar(150)) + '</id><name><![CDATA[' + r.RoleName + ']]></name></entity>',
				"JournalAuthor" = CASE WHEN ISNULL(a.UserId,-1) >0 THEN '<entity><id>' + CAST(a.UserId as nvarchar(150)) + '</id><name><![CDATA[' + a.DisplayName + ']]></name></entity>' ELSE '' END,
				"JournalOwnerId" = ISNULL(j.ProfileId,j.UserId),
				 jt.Icon, jt.JournalType,
				"Profile" = CASE WHEN j.ProfileId > 0 THEN '<entity><id>' + CAST(p.UserID as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name><vanity></vanity></entity>' ELSE '' END,
				"SimilarCount" = (SELECT COUNT(JournalId) FROM {databaseOwner}{objectQualifier}Journal WHERE ContentItemId = j.ContentItemId AND JournalTypeId = j.JournalTypeId),
				jd.JournalXML, j.ContentItemId, j.ItemData, RowNumber, j.IsDeleted, j.CommentsDisabled, j.CommentsHidden
	FROM	journalItems as ji INNER JOIN 
		{databaseOwner}[{objectQualifier}Journal] as j ON j.JournalId = ji.JournalId INNER JOIN
		{databaseOwner}[{objectQualifier}Journal_Types] as jt ON jt.JournalTypeId = j.JournalTypeId INNER JOIN
		{databaseOwner}[{objectQualifier}Roles] as r ON j.GroupId = r.RoleId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Journal_Data] as jd on jd.JournalId = j.JournalId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS p ON j.ProfileId = p.UserID LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS a ON j.UserId = a.UserID
	WHERE		((@IncludeAllItems = 0) AND (RowNumber BETWEEN @RowIndex AND @EndRow AND j.IsDeleted = @IsDeleted)) 
				OR 
				((@IncludeAllItems = 1) AND (RowNumber BETWEEN @RowIndex AND @EndRow))
	ORDER BY RowNumber ASC;
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_GetRedirectionRules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_GetRedirectionRules] @RedirectionId INT
AS 
    SELECT  Id ,
            RedirectionId ,
            Capability ,
            Expression
    FROM    {objectQualifier}Mobile_RedirectionRules
    WHERE RedirectionId = @RedirectionId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateDesktopModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateDesktopModule]
	@DesktopModuleId		int,    
	@PackageID			int,
	@ModuleName			nvarchar(128),
	@FolderName			nvarchar(128),
	@FriendlyName			nvarchar(128),
	@Description			nvarchar(2000),
	@Version			nvarchar(8),
	@IsPremium			bit,
	@IsAdmin			bit,
	@BusinessController		nvarchar(200),
	@SupportedFeatures		int,
	@Shareable			int,
	@CompatibleVersions		nvarchar(500),
	@Dependencies			nvarchar(400),
	@Permissions			nvarchar(400),
	@ContentItemId			int,
	@LastModifiedByUserID		int,
	@AdminPage		nvarchar(128),
	@HostPage		nvarchar(128)

AS
		UPDATE {databaseOwner}{objectQualifier}DesktopModules
		SET    	
			PackageID = @PackageID,
			ModuleName = @ModuleName,
			FolderName = @FolderName,
			FriendlyName = @FriendlyName,
			Description = @Description,
			Version = @Version,
			IsPremium = @IsPremium,
			IsAdmin = @IsAdmin,
			BusinessControllerClass = @BusinessController,
			SupportedFeatures = @SupportedFeatures,
			Shareable = @Shareable,
			CompatibleVersions = @CompatibleVersions,
			Dependencies = @Dependencies,
			Permissions = @Permissions,
			ContentItemId = @ContentItemId,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate(),
			AdminPage=@AdminPage,
			HostPage=@HostPage
	WHERE  DesktopModuleId = @DesktopModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ClearFileContent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}ClearFileContent]

	@FileId      int

AS

UPDATE {databaseOwner}{objectQualifier}Files
	SET    Content = NULL
	WHERE  FileId = @FileId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePackage]
	@PackageID		int
AS
	DELETE 
		FROM   {databaseOwner}{objectQualifier}Packages
		WHERE  [PackageID] = @PackageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_ListForProfile]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_ListForProfile]
	@PortalId int,
	@ModuleId int,
	@CurrentUserId int,
	@ProfileId int,
	@RowIndex int,
	@MaxRows int,
	@IncludeAllItems int = 0,
	@IsDeleted int = 0
	AS
	DECLARE @EndRow int
	SET @EndRow = @RowIndex + @MaxRows;
	DECLARE @j TABLE(id int IDENTITY, journalid int, datecreated datetime)
	IF EXISTS(SELECT * from {databaseOwner}[{objectQualifier}Journal_TypeFilters] WHERE ModuleId = @ModuleId)
	INSERT INTO @j 
		SELECT j.journalid, jt.datecreated from (
			SELECT DISTINCT js.JournalId from {databaseOwner}[{objectQualifier}Journal] as j
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_Security] as js ON js.JournalId = j.JournalId
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_User_Permissions](@PortalId,@CurrentUserId ,1) as t ON t.seckey = js.SecurityKey
				WHERE j.ProfileId = @ProfileId AND j.PortalId = @PortalId
			) as j INNER JOIN {databaseOwner}[{objectQualifier}Journal] jt ON jt.JournalId = j.JournalId AND jt.PortalId = @PortalId
			INNER JOIN {databaseOwner}[{objectQualifier}Journal_TypeFilters] as jf ON jf.JournalTypeId = jt.JournalTypeId AND jf.ModuleId = @ModuleId
			ORDER BY jt.DateCreated DESC, jt.JournalId DESC;
	ELSE
	INSERT INTO @j 
		SELECT j.journalid, jt.datecreated from (
			SELECT DISTINCT js.JournalId from {databaseOwner}[{objectQualifier}Journal] as j
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_Security] as js ON js.JournalId = j.JournalId
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_User_Permissions](@PortalId,@CurrentUserId ,1) as t ON t.seckey = js.SecurityKey
				WHERE j.ProfileId = @ProfileId AND j.PortalId = @PortalId
			) as j INNER JOIN {databaseOwner}[{objectQualifier}Journal] jt ON jt.JournalId = j.JournalId AND jt.PortalId = @PortalId
			ORDER BY jt.DateCreated DESC, jt.JournalId DESC;
	WITH journalItems  AS
	(
		SELECT	j.JournalId,
				ROW_NUMBER() OVER (ORDER BY j.JournalId DESC) AS RowNumber
		FROM	{databaseOwner}[{objectQualifier}Journal] as j INNER JOIN @j as jtmp ON jtmp.JournalId = j.JournalId
		WHERE j.PortalId = @PortalId AND j.ProfileId = @ProfileId
	)
	SELECT	j.JournalId, j.JournalTypeId, j.Title, j.Summary, j.UserId, j.DateCreated, j.DateUpdated, j.PortalId,
				j.ProfileId, j.GroupId, j.ObjectKey, j.AccessKey,
				"JournalOwner" = '<entity><id>' + CAST(p.UserId as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name></entity>',
				"JournalAuthor" = CASE WHEN ISNULL(a.UserId,-1) >0 THEN '<entity><id>' + CAST(a.UserId as nvarchar(150)) + '</id><name><![CDATA[' + a.DisplayName + ']]></name></entity>' ELSE '' END,
				"JournalOwnerId" = ISNULL(j.ProfileId,j.UserId),
				 jt.Icon, jt.JournalType,
				"Profile" = CASE WHEN j.ProfileId > 0 THEN '<entity><id>' + CAST(p.UserID as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name><vanity></vanity></entity>' ELSE '' END,
				"SimilarCount" = (SELECT COUNT(JournalId) FROM {databaseOwner}{objectQualifier}Journal WHERE ContentItemId = j.ContentItemId AND JournalTypeId = j.JournalTypeId),
				jd.JournalXML, j.ContentItemId, j.ItemData, RowNumber, j.IsDeleted, j.CommentsDisabled, j.CommentsHidden
	FROM	journalItems as ji INNER JOIN 
		{databaseOwner}[{objectQualifier}Journal] as j ON j.JournalId = ji.JournalId INNER JOIN
	{databaseOwner}[{objectQualifier}Journal_Types] as jt ON jt.JournalTypeId = j.JournalTypeId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Journal_Data] as jd on jd.JournalId = j.JournalId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS p ON j.ProfileId = p.UserID LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS a ON j.UserId = a.UserID
	WHERE	((@IncludeAllItems = 0) AND (RowNumber BETWEEN @RowIndex AND @EndRow AND j.IsDeleted = @IsDeleted)) 
			OR 
			((@IncludeAllItems = 1) AND (RowNumber BETWEEN @RowIndex AND @EndRow))	
	ORDER BY RowNumber ASC;
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddEventLogType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddEventLogType]
	@LogTypeKey nvarchar(35),
	@LogTypeFriendlyName nvarchar(50),
	@LogTypeDescription nvarchar(128),
	@LogTypeOwner nvarchar(100),
	@LogTypeCSSClass nvarchar(40)
AS
	INSERT INTO {databaseOwner}{objectQualifier}EventLogTypes
	(LogTypeKey,
	LogTypeFriendlyName,
	LogTypeDescription,
	LogTypeOwner,
	LogTypeCSSClass)
VALUES
	(@LogTypeKey,
	@LogTypeFriendlyName,
	@LogTypeDescription,
	@LogTypeOwner,
	@LogTypeCSSClass)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SearchTypes]
(
[SearchTypeId] [int] NOT NULL IDENTITY(1, 1),
[SearchTypeName] [nvarchar] (100) NOT NULL,
[SearchResultClass] [nvarchar] (256) NOT NULL,
[IsPrivate] [bit] NULL CONSTRAINT [DF_{objectQualifier}SearchTypes_IsPrivate] DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SearchTypes] on {databaseOwner}[{objectQualifier}SearchTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SearchTypes] ADD CONSTRAINT [PK_{objectQualifier}SearchTypes] PRIMARY KEY CLUSTERED  ([SearchTypeId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchTypes_GetAll]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SearchTypes_GetAll]
AS
    SELECT *
	FROM {databaseOwner}[{objectQualifier}SearchTypes]
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSearchModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSearchModules]

@PortalID int

AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}vw_Modules M
		INNER JOIN {databaseOwner}{objectQualifier}Tabs T ON T.TabId = M.TabId
	WHERE  M.IsDeleted = 0  
		AND T.IsDeleted = 0  
		AND M.IsAdmin = 0
		AND (M.SupportedFeatures & 2 = 2)
		AND (T.EndDate > GETDATE() or T.EndDate IS NULL) 
		AND (T.StartDate <= GETDATE() or T.StartDate IS NULL) 
		AND (M.StartDate <= GETDATE() or M.StartDate IS NULL) 
		AND (M.EndDate > GETDATE() or M.EndDate IS NULL) 
		AND (NOT (M.BusinessControllerClass IS NULL))
		AND (T.PortalID = @PortalID OR (T.PortalID IS NULL AND @PortalID Is NULL))
	ORDER BY ModuleOrder
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserByDisplayName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserByDisplayName]

	@PortalID int,
	@DisplayName nvarchar(128)

AS
	SELECT * FROM {databaseOwner}{objectQualifier}vw_Users
	WHERE  DisplayName = @DisplayName
		AND  ((@PortalId IS NULL) OR (PortalId = @PortalID) OR IsSuperUser = 1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountArchivedMessagesByConversation]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountArchivedMessagesByConversation]
	@ConversationID int
AS
BEGIN
	SELECT COUNT(*) AS TotalArchivedThreads
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
	WHERE MessageID IN (SELECT MessageID FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WHERE ConversationID = @ConversationID)
	AND [Archived] = 1
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_ListForSummary]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_ListForSummary]
	@PortalId int,
	@ModuleId int,
	@CurrentUserId int,
	@RowIndex int,
	@MaxRows int,
	@IncludeAllItems int = 0,
	@IsDeleted int = 0	
	AS
	IF @RowIndex = 0
	BEGIN
		SET @RowIndex = 1
	END
	DECLARE @EndRow int
	SET @EndRow = @RowIndex + @MaxRows - 1;
	DECLARE @j TABLE(id int IDENTITY, journalid int, datecreated datetime)
	IF EXISTS(SELECT * from {databaseOwner}[{objectQualifier}Journal_TypeFilters] WHERE ModuleId = @ModuleId)
	INSERT INTO @j 
		SELECT j.journalid, jt.datecreated from (
			SELECT DISTINCT js.JournalId from {databaseOwner}[{objectQualifier}Journal] as j
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_Security] as js ON js.JournalId = j.JournalId
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_User_Permissions](@PortalId,@CurrentUserId ,1) as t ON t.seckey = js.SecurityKey
				WHERE j.PortalId = @PortalId
			) as j INNER JOIN {databaseOwner}[{objectQualifier}Journal] jt ON jt.JournalId = j.JournalId AND jt.PortalId = @PortalId
			INNER JOIN {databaseOwner}[{objectQualifier}Journal_TypeFilters] as jf ON jf.JournalTypeId = jt.JournalTypeId AND jf.ModuleId = @ModuleId
			ORDER BY jt.DateCreated DESC, jt.JournalId DESC;
	ELSE
	INSERT INTO @j 
		SELECT j.journalid, jt.datecreated from (
			SELECT DISTINCT js.JournalId from {databaseOwner}[{objectQualifier}Journal] as j
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_Security] as js ON js.JournalId = j.JournalId
				INNER JOIN {databaseOwner}[{objectQualifier}Journal_User_Permissions](@PortalId,@CurrentUserId ,1) as t ON t.seckey = js.SecurityKey
				WHERE j.PortalId = @PortalId
			) as j INNER JOIN {databaseOwner}[{objectQualifier}Journal] jt ON jt.JournalId = j.JournalId AND jt.PortalId = @PortalId
			ORDER BY jt.DateCreated DESC, jt.JournalId DESC;
	WITH journalItems  AS
	(
		SELECT	j.JournalId,
				ROW_NUMBER() OVER (ORDER BY j.JournalId DESC) AS RowNumber
		FROM	{databaseOwner}[{objectQualifier}Journal] as j INNER JOIN @j as jtmp ON jtmp.JournalId = j.JournalId
		WHERE j.PortalId = @PortalId
	)
	SELECT	j.JournalId, j.JournalTypeId, j.Title, j.Summary, j.UserId, j.DateCreated, j.DateUpdated, j.PortalId,
				j.ProfileId, j.GroupId, j.ObjectKey, j.AccessKey,
				"JournalOwner" = '<entity><id>' + CAST(p.UserId as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name></entity>',
				"JournalAuthor" = CASE WHEN ISNULL(a.UserId,-1) >0 THEN '<entity><id>' + CAST(a.UserId as nvarchar(150)) + '</id><name><![CDATA[' + a.DisplayName + ']]></name></entity>' ELSE '' END,
				"JournalOwnerId" = ISNULL(j.ProfileId,j.UserId),
				 jt.Icon, jt.JournalType,
				"Profile" = CASE WHEN j.ProfileId > 0 THEN '<entity><id>' + CAST(p.UserID as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name><vanity></vanity></entity>' ELSE '' END,
				"SimilarCount" = (SELECT COUNT(JournalId) FROM {databaseOwner}{objectQualifier}Journal WHERE ContentItemId = j.ContentItemId AND JournalTypeId = j.JournalTypeId),
				jd.JournalXML, j.ContentItemId, j.ItemData, RowNumber, j.IsDeleted, j.CommentsDisabled, j.CommentsHidden
	FROM	journalItems as ji INNER JOIN 
		{databaseOwner}[{objectQualifier}Journal] as j ON j.JournalId = ji.JournalId INNER JOIN
	{databaseOwner}[{objectQualifier}Journal_Types] as jt ON jt.JournalTypeId = j.JournalTypeId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Journal_Data] as jd on jd.JournalId = j.JournalId LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS p ON j.ProfileId = p.UserID LEFT OUTER JOIN
				{databaseOwner}[{objectQualifier}Users] AS a ON j.UserId = a.UserID
	WHERE	((@IncludeAllItems = 0) AND (RowNumber BETWEEN @RowIndex AND @EndRow AND j.IsDeleted = @IsDeleted)) 
			OR 
			((@IncludeAllItems = 1) AND (RowNumber BETWEEN @RowIndex AND @EndRow ))
	ORDER BY RowNumber ASC;
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateProfile]'
GO
create procedure {databaseOwner}[{objectQualifier}UpdateProfile]

@UserID        int, 
@PortalID      int,
@ProfileData   ntext

as

update {databaseOwner}{objectQualifier}Profile
set    ProfileData = @ProfileData,
       CreatedDate = getdate()
where  UserId = @UserID
and    PortalId = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddException]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddException]
	@ExceptionHash varchar(100),
	@Message nvarchar(500),
	@StackTrace nvarchar(max),
	@InnerMessage nvarchar(500),
	@InnerStackTrace nvarchar(max),
	@Source nvarchar(500)
AS

BEGIN TRY
	IF NOT EXISTS (SELECT * FROM {databaseOwner}[{objectQualifier}Exceptions] WHERE ExceptionHash=@ExceptionHash)
	INSERT INTO {databaseOwner}[{objectQualifier}Exceptions]
		(ExceptionHash,
		[Message],
		StackTrace,
		InnerMessage,
		InnerStackTrace,
		Source)
	VALUES
		(@ExceptionHash,
		@Message,
		@StackTrace,
		@InnerMessage,
		@InnerStackTrace,
		@Source)
END TRY
BEGIN CATCH

END CATCH
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveUserRelationship]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveUserRelationship]
    @UserRelationshipID INT,
	@UserID INT,
	@RelatedUserID INT,
	@RelationshipID INT,
	@Status INT,
	@CreateUpdateUserID INT
    
AS 
    IF ( @UserRelationshipID = -1 ) 
        BEGIN
            INSERT  {databaseOwner}{objectQualifier}UserRelationships
                    ( UserID,
					  RelatedUserID,					
					  RelationshipID,
					  Status,
                      CreatedByUserID ,
                      CreatedOnDate ,
                      LastModifiedByUserID ,
                      LastModifiedOnDate
			        
                    )
            VALUES  ( @UserID , -- @UserID int
					  @RelatedUserID , -- @RelatedUserlID int
					  @RelationshipID, -- @RelationshipID int
					  @Status , -- @Status int
                      @CreateUpdateUserID , -- CreatedBy - int
                      GETDATE() , -- CreatedOn - datetime
                      @CreateUpdateUserID , -- LastModifiedBy - int
                      GETDATE() -- LastModifiedOn - datetime
			        
                    )
                    
            SELECT  @UserRelationshipID = SCOPE_IDENTITY()
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}UserRelationships
            SET     UserID = @UserID,
					RelatedUserID = @RelatedUserID,
					RelationshipID = @RelationshipID,
					Status = @Status,
                    LastModifiedByUserID = @CreateUpdateUserID,
                    LastModifiedOnDate = GETDATE()
            WHERE   UserRelationshipID = @UserRelationshipID
        END
        
    SELECT  @UserRelationshipID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModuleByDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModuleByDefinition]
      @PortalId int,
      @DefinitionName nvarchar(128)
AS
	SELECT M.*   
	FROM {databaseOwner}{objectQualifier}vw_Modules M
		INNER JOIN {databaseOwner}{objectQualifier}ModuleDefinitions as MD ON M.ModuleDefID = MD.ModuleDefID
		INNER JOIN {databaseOwner}{objectQualifier}Tabs as T ON M.TabID = T.TabID
	WHERE ((M.PortalId = @PortalId) or (M.PortalId is null and @PortalID is null))
		AND MD.DefinitionName = @DefinitionName
		AND M.IsDeleted = 0
		AND T.IsDeleted = 0
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateContentType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateContentType] 
	@ContentTypeId		int,
	@ContentType		nvarchar(250)
AS
	UPDATE {databaseOwner}{objectQualifier}ContentTypes 
		SET 
			ContentType = @ContentType
	WHERE ContentTypeId = @ContentTypeId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalDesktopModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalDesktopModules]
	@PortalId int,
	@DesktopModuleId int

AS
	SELECT {objectQualifier}PortalDesktopModules.*,
		   PortalName,
		   FriendlyName
	FROM   {objectQualifier}PortalDesktopModules
		INNER JOIN {objectQualifier}vw_Portals ON {objectQualifier}PortalDesktopModules.PortalId = {objectQualifier}vw_Portals.PortalId
		INNER JOIN {objectQualifier}DesktopModules ON {objectQualifier}PortalDesktopModules.DesktopModuleId = {objectQualifier}DesktopModules.DesktopModuleId
	WHERE  (({objectQualifier}PortalDesktopModules.PortalId = @PortalId) OR @PortalId is null)
		AND    (({objectQualifier}PortalDesktopModules.DesktopModuleId = @DesktopModuleId) OR @DesktopModuleId is null)
	ORDER BY {objectQualifier}PortalDesktopModules.PortalId, {objectQualifier}PortalDesktopModules.DesktopModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessagesBySender]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessagesBySender]
    @SenderUserID INT,
	@PortalID INT
AS
BEGIN
	SELECT [MessageID], [To], [From], [Subject], [Body], [ConversationID], [ReplyAllAllowed], [SenderUserID], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate] 
	FROM   {databaseOwner}[{objectQualifier}CoreMessaging_Messages] 
	WHERE  [SenderUserID] = @SenderUserID AND [PortalID] = @PortalID
	AND [NotificationTypeID] IS NULL
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabSettings]
    @PortalId Int
AS
	BEGIN
		SELECT
			TS.TabID,
			TS.SettingName,
			CASE WHEN Lower(TS.SettingValue) LIKE 'fileid=%'
				 THEN {databaseOwner}{objectQualifier}FilePath(TS.SettingValue)
				 ELSE TS.SettingValue END           
				 AS SettingValue
		FROM   {databaseOwner}[{objectQualifier}TabSettings] TS
			INNER JOIN {databaseOwner}[{objectQualifier}Tabs] T ON t.TabID = TS.TabID
		WHERE  (PortalId = @PortalId OR (PortalID IS NULL AND @PortalId IS NULL))
		ORDER BY TS.TabID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserAuthentication]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserAuthentication]
  @UserID          int

AS
  select * from {databaseOwner}{objectQualifier}UserAuthentication
     where UserId = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSkinPackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSkinPackage]
	@SkinPackageID  int,
	@PackageID      int,
	@PortalID       int,
	@SkinName       nvarchar(50),
	@SkinType       nvarchar(20),
	@LastModifiedByUserID	int
AS
	UPDATE {databaseOwner}{objectQualifier}SkinPackages
		SET
			PackageID = @PackageID,
			PortalID = @PortalID,
			SkinName = @SkinName,
			SkinType = @SkinType,
 			[LastModifiedByUserID] = @LastModifiedByUserID,	
			[LastModifiedOnDate] = getdate()
	WHERE SkinPackageID = @SkinPackageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteNotificationTypeAction]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteNotificationTypeAction]
	@NotificationTypeActionID int
AS
BEGIN
	DELETE 
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]
	WHERE [NotificationTypeActionID] = @NotificationTypeActionID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllUsers]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAllUsers]
	@PortalID        int,
	@PageIndex       int,
	@PageSize        INT,
	@IncludeDeleted  bit,
	@SuperUsersOnly  bit	
AS
	BEGIN
		-- Set the page bounds
		DECLARE 
			@PageLowerBound INT, 
			@PageUpperBound INT, 
			@RowsToReturn int

		EXEC {databaseOwner}{objectQualifier}CalculatePagingInformation @PageIndex, @PageSize, @RowsToReturn output, @PageLowerBound output, @PageUpperBound output

		IF @PortalID IS NULL
			BEGIN
				WITH [tmpUsers] AS (
					SELECT U.*, row_number() over (ORDER BY U.UserName) AS rowid
						FROM {databaseOwner}{objectQualifier}vw_Users u
						WHERE U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
							  AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				)
				SELECT * FROM [tmpUsers]
					WHERE rowid > @PageLowerBound AND rowid < @PageUpperBound
					ORDER BY rowid
			END 
		ELSE 
			BEGIN
				WITH [tmpUsers] AS (
					SELECT U.*, row_number() over (order by U.UserName) AS rowid
						FROM {databaseOwner}{objectQualifier}vw_Users u
						WHERE U.PortalID = @PortalID AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
						  AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				)
				SELECT * FROM [tmpUsers]
					WHERE rowid > @PageLowerBound AND rowid < @PageUpperBound
					ORDER by rowid
			END

		SET ROWCOUNT 0
 
		IF @PortalId IS NULL
			BEGIN
				SELECT COUNT(*) as TotalRecords
					FROM   {databaseOwner}{objectQualifier}vw_Users as U
					WHERE U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
				          AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
			END 
		ELSE 
			BEGIN
				SELECT COUNT(*) as TotalRecords
					FROM   {databaseOwner}{objectQualifier}vw_Users U
						WHERE U.PortalId = @PortalId
							AND U.IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							AND U.IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
			END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFolderMapping]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFolderMapping]
	@FolderMappingID int
AS
BEGIN
	DELETE
	FROM {databaseOwner}[{objectQualifier}FolderMappings]
	WHERE FolderMappingID = @FolderMappingID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetToasts]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetToasts] 
 	@UserId INT
	,@PortalId INT
AS
BEGIN
	SELECT DISTINCT m.*
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] mr
		INNER JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] m 
			ON (mr.MessageID = m.MessageID)
	WHERE mr.UserID = @UserID
		AND m.PortalID = @PortalID
		--Added to allow a single index to cover both this and the other two messaging procs:
		--{databaseOwner}[CoreMessaging_CountNotifications]
		--CoreMessaging_CountNewThreads
		AND mr.[Read] in (0,1)
		AND mr.SendToast = 1
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDesktopModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDesktopModulePermission]
	@DesktopModulePermissionID	int
AS
    SELECT *
    FROM {databaseOwner}{objectQualifier}vw_DesktopModulePermissions
    WHERE DesktopModulePermissionID = @DesktopModulePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateUserLastIpAddress]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateUserLastIpAddress] 
	@UserID         int,
	@LastIPAddress	nvarchar(50)
AS
	UPDATE {databaseOwner}[{objectQualifier}Users] 
	SET	LastIPAddress = @LastIPAddress
	WHERE  UserId = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}HostSettings]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}HostSettings]
(
[SettingName] [nvarchar] (50) NOT NULL,
[SettingValue] [nvarchar] (256) NOT NULL,
[SettingIsSecure] [bit] NOT NULL CONSTRAINT [DF_{objectQualifier}HostSettings_Secure] DEFAULT ((0)),
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}HostSettings] on {databaseOwner}[{objectQualifier}HostSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}HostSettings] ADD CONSTRAINT [PK_{objectQualifier}HostSettings] PRIMARY KEY CLUSTERED  ([SettingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddHostSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddHostSetting]

	@SettingName		nvarchar(50),
	@SettingValue		nvarchar(256),
	@SettingIsSecure	bit,
	@CreatedByUserID	int
AS
	insert into {objectQualifier}HostSettings (
	  SettingName,
	  SettingValue,
	  SettingIsSecure,
	  [CreatedByUserID],
	  [CreatedOnDate],
	  [LastModifiedByUserID],
	  [LastModifiedOnDate]
	) 
	values (
	  @SettingName,
	  @SettingValue,
	  @SettingIsSecure,
	  @CreatedByUserID,
	  getdate(),
	  @CreatedByUserID,
	  getdate()
	)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddRoleGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddRoleGroup] 
	@PortalID         int,
	@RoleGroupName    nvarchar(50),
	@Description      nvarchar(1000),
	@CreatedByUserID  int
AS

	INSERT INTO {databaseOwner}{objectQualifier}RoleGroups (
	  PortalId,
	  RoleGroupName,
	  Description,
	  CreatedByUserID,
	  CreatedOnDate,
	  LastModifiedByUserID,
	  LastModifiedOnDate
	)
	VALUES (
	  @PortalID,
	  @RoleGroupName,
	  @Description,
	  @CreatedByUserID,
	  getdate(),
	  @CreatedByUserID,
	  getdate()
	)

SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddContentItem]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddContentItem] 
	@Content			nvarchar(max),
	@ContentTypeID		int,
	@TabID				int,
	@ModuleID			int, 
	@ContentKey			nvarchar(250),
	@Indexed			bit,
	@CreatedByUserID	int,
	@StateID			int = NULL
AS
	INSERT INTO {databaseOwner}[{objectQualifier}ContentItems] (
		Content,
		ContentTypeID,
		TabID,
		ModuleID,
		ContentKey,
		Indexed,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate,
		StateID
	)

	VALUES (
		@Content,
		@ContentTypeID,
		@TabID,
		@ModuleID,
		@ContentKey,
		@Indexed,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate(),
		@StateID
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_GetRedirections]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_GetRedirections] @PortalId INT
AS 
    SELECT  Id ,
            PortalId ,
            Name ,
            [Type] ,
            SortOrder ,
            SourceTabId ,
			IncludeChildTabs ,
            TargetType ,
            TargetValue ,
			Enabled ,
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}Mobile_Redirections
    WHERE   PortalId = @PortalId
	ORDER BY SortOrder ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTermToContent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTermToContent] 
	@TermID			int,
	@ContentItemID	int
AS
	INSERT INTO {databaseOwner}{objectQualifier}ContentItems_Tags (
		TermID,
		ContentItemID
	)

	VALUES (
		@TermID,
		@ContentItemID
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotifications]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotifications]
	@UserID              Int,
	@PortalID            Int,
	@AfterNotificationID Int,
	@NumberOfRecords     Int
AS
BEGIN
	--Get the top message for each conversation
	SELECT TOP(@NumberOfRecords)
			M.[MessageID],
			M.[NotificationTypeId],
			M.[To],
			M.[From],
			M.[Subject],
			M.[Body],
			M.[SenderUserID],
			M.[ExpirationDate],
            M.[IncludeDismissAction],
			M.[CreatedByUserID],
			M.[CreatedOnDate],
			M.[LastModifiedByUserID],
			M.[LastModifiedOnDate],
            M.[Context],
			ROW_NUMBER() OVER(ORDER BY M.MessageId DESC) AS RowNumber
		FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages]       AS M
		JOIN {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR 
				ON (M.[MessageID] = MR.[MessageID])
		WHERE ([NotificationTypeId] IS NOT NULL)
		  AND (MR.[UserID]  = @UserID)
		  AND (M.[PortalID] = @PortalID)
		  AND (ISNull(M.[ExpirationDate], GETUTCDATE()) >= GETUTCDATE())
		  AND (M.[MessageID] > isNull(@AfterNotificationID, -1))
		ORDER BY RowNumber ASC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountSentMessages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountSentMessages]
	@UserID int,
	@PortalID int
AS
BEGIN
	SELECT COUNT(MessageID) AS TotalRecords
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages]
	WHERE SenderUserID = @UserID
	AND NotificationTypeID IS NULL AND PortalID = @PortalID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchDeletedItems_Add]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SearchDeletedItems_Add]
	@document nvarchar(max)
AS
BEGIN
	INSERT INTO {databaseOwner}{objectQualifier}SearchDeletedItems
		   (  document )
	VALUES ( @document )
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTerm] 
	@TermId			int
AS
	SELECT TT.*,
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = TT.TermID
			) AS TotalTermUsage ,
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = TT.TermID
			  AND	    CI.CreatedOnDate > DATEADD(day, -30, GETDATE())
		) AS MonthTermUsage ,
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = TT.TermID
			  AND	    CI.CreatedOnDate > DATEADD(day, -7, GETDATE())
		) AS WeekTermUsage ,
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = TT.TermID
			  AND	    CI.CreatedOnDate > DATEADD(day, -1, GETDATE())
		) AS DayTermUsage
	FROM {databaseOwner}{objectQualifier}Taxonomy_Terms TT
	WHERE TT.TermId = @TermId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateContentItem]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateContentItem] 
	@ContentItemID			int,
	@Content				nvarchar(max),
	@ContentTypeID			int,
	@TabID					int,
	@ModuleID				int, 
	@ContentKey				nvarchar(250),
	@Indexed				bit,
	@LastModifiedByUserID	int,
	@StateID				int = NULL
AS
	UPDATE {databaseOwner}[{objectQualifier}ContentItems] 
		SET 
			Content = @Content,
			ContentTypeID = @ContentTypeID,
			TabID = @TabID,
			ModuleID = @ModuleID,
			ContentKey = @ContentKey,
			Indexed = @Indexed,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate(),
			StateID = @StateID
	WHERE ContentItemId = @ContentItemId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddEventLog]'
GO
CREATE PROCEDURE  {databaseOwner}[{objectQualifier}AddEventLog]
	@LogGUID varchar(36),
	@LogTypeKey nvarchar(35),
	@LogUserID int,
	@LogUserName nvarchar(50),
	@LogPortalID int,
	@LogPortalName nvarchar(100),
	@LogCreateDate datetime,
	@LogServerName nvarchar(50),
	@LogProperties ntext,
	@LogConfigID int,
	@ExceptionHash varchar(100) = NULL,
	@NotificationActive bit = 0
AS
BEGIN
	DECLARE @LogEventID bigint

	INSERT INTO  {databaseOwner}[{objectQualifier}EventLog]
		(LogGUID,
		LogTypeKey,
		LogUserID,
		LogUserName,
		LogPortalID,
		LogPortalName,
		LogCreateDate,
		LogServerName,
		LogProperties,
		LogConfigID,
		ExceptionHash)
	VALUES
		(@LogGUID,
		@LogTypeKey,
		@LogUserID,
		@LogUserName,
		@LogPortalID,
		@LogPortalName,
		@LogCreateDate,
		@LogServerName,
		@LogProperties,
		@LogConfigID,
		@ExceptionHash)

	SELECT @LogEventID = SCOPE_IDENTITY()

	IF @NotificationActive=1
	BEGIN

		DECLARE @NotificationThreshold bit
		DECLARE @ThresholdQueue int
		DECLARE @NotificationThresholdTime int
		DECLARE @NotificationThresholdTimeType int
		DECLARE @MinDateTime smalldatetime
		DECLARE @CurrentDateTime smalldatetime

		SET @CurrentDateTime = getDate()

		SELECT TOP 1 @NotificationThreshold = NotificationThreshold,
			@NotificationThresholdTime = NotificationThresholdTime,
			@NotificationThresholdTimeType = NotificationThresholdTimeType,
			@MinDateTime = 
				CASE
					 --seconds
					WHEN NotificationThresholdTimeType=1 THEN DateAdd(second, NotificationThresholdTime * -1, @CurrentDateTime)
					--minutes
					WHEN NotificationThresholdTimeType=2  THEN DateAdd(minute, NotificationThresholdTime * -1, @CurrentDateTime)
					--hours
					WHEN NotificationThresholdTimeType=3  THEN DateAdd(Hour, NotificationThresholdTime * -1, @CurrentDateTime)
					--days
					WHEN NotificationThresholdTimeType=4  THEN DateAdd(Day, NotificationThresholdTime * -1, @CurrentDateTime)
				END
		FROM  {databaseOwner}[{objectQualifier}EventLogConfig]
		WHERE ID = @LogConfigID

		SELECT @ThresholdQueue = COUNT(*)
		FROM  {databaseOwner}[{objectQualifier}EventLog] el
			INNER JOIN  {databaseOwner}[{objectQualifier}EventLogConfig] elc
				ON  el.LogConfigID =  elc.ID
		WHERE LogCreateDate > @MinDateTime

		IF @ThresholdQueue >= @NotificationThreshold
		BEGIN
			UPDATE  {databaseOwner}[{objectQualifier}EventLog]
			SET LogNotificationPending = 1 
			WHERE LogConfigID = @LogConfigID
				AND LogNotificationPending IS NULL		
				AND LogCreateDate > @MinDateTime
		END

	END
 
	SELECT @LogEventID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchDeletedItems_DeleteProcessed]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SearchDeletedItems_DeleteProcessed]
    @CutoffTime	DATETIME
AS
BEGIN
	DELETE FROM {databaseOwner}{objectQualifier}SearchDeletedItems
	WHERE [DateCreated] < @CutoffTime
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderByFolderID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderByFolderID]
	@FolderID int
AS
BEGIN
	SELECT *
	FROM {databaseOwner}[{objectQualifier}Folders]
	WHERE FolderID = @FolderID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CountLegacyFiles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CountLegacyFiles]
AS
BEGIN

SELECT COUNT(*) FROM {databaseOwner}[{objectQualifier}Files] WHERE ContentItemID IS NULL
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalsByName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalsByName]

    @NameToMatch	nvarchar(256),
    @PageIndex			int,
    @PageSize			int
AS
	BEGIN
		-- Set the page bounds
		DECLARE @PageLowerBound INT
		DECLARE @PageUpperBound INT
		SET @PageLowerBound = @PageSize * @PageIndex
		SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

		-- Create a temp table TO store the select results
		CREATE TABLE #PageIndexForPortals
		(
			IndexId int IDENTITY (0, 1) NOT NULL,
			PortalId int
		)

		-- Insert into our temp table
		INSERT INTO #PageIndexForPortals (PortalId)
			SELECT PortalId FROM	{databaseOwner}{objectQualifier}vw_PortalsDefaultLanguage
			WHERE  PortalName LIKE @NameToMatch
			ORDER BY PortalName

		SELECT  *
		FROM	{databaseOwner}{objectQualifier}vw_PortalsDefaultLanguage p, 
				#PageIndexForPortals i
		WHERE  p.PortalId = i.PortalId
				AND i.IndexId >= @PageLowerBound AND i.IndexId <= @PageUpperBound
		ORDER BY p.PortalName

		SELECT  TotalRecords = COUNT(*)
		FROM    #PageIndexForPortals
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabModule]
    @TabModuleId            int,
    @TabId					int,
    @ModuleId				int,
	@ModuleTitle			nvarchar(256),
	@Header					ntext,
	@Footer					ntext,
    @ModuleOrder			int,
    @PaneName				nvarchar(50),
    @CacheTime				int,
    @CacheMethod			varchar(50),
    @Alignment				nvarchar(10),
    @Color					nvarchar(20),
    @Border					nvarchar(1),
    @IconFile				nvarchar(100),
    @Visibility				int,
    @ContainerSrc			nvarchar(200),
    @DisplayTitle			bit,
    @DisplayPrint			bit,
    @DisplaySyndicate		bit,
    @IsWebSlice				bit,
    @WebSliceTitle			nvarchar(256),
    @WebSliceExpiryDate		datetime,
    @WebSliceTTL			int,
    @VersionGuid			uniqueidentifier,
    @DefaultLanguageGuid	uniqueidentifier,
    @LocalizedVersionGuid	uniqueidentifier,
    @CultureCode			nvarchar(10),
    @LastModifiedByUserID	int

AS
    UPDATE {databaseOwner}{objectQualifier}TabModules
        SET    
            TabId = @TabId,
            ModuleId = @ModuleId,
			ModuleTitle = @ModuleTitle,
			Header = @Header,
			Footer = @Footer, 
            ModuleOrder = @ModuleOrder,
            PaneName = @PaneName,
            CacheTime = @CacheTime,
            CacheMethod = @CacheMethod,
            Alignment = @Alignment,
            Color = @Color,
            Border = @Border,
            IconFile = @IconFile,
            Visibility = @Visibility,
            ContainerSrc = @ContainerSrc,
            DisplayTitle = @DisplayTitle,
            DisplayPrint = @DisplayPrint,
            DisplaySyndicate = @DisplaySyndicate,
            IsWebSlice = @IsWebSlice,
            WebSliceTitle = @WebSliceTitle,
            WebSliceExpiryDate = @WebSliceExpiryDate,
            WebSliceTTL = @WebSliceTTL,
            VersionGuid = @VersionGuid,
            DefaultLanguageGuid = @DefaultLanguageGuid,
            LocalizedVersionGuid = @LocalizedVersionGuid,
            CultureCode= @CultureCode,
            LastModifiedByUserID = @LastModifiedByUserID,
            LastModifiedOnDate = getdate()
        WHERE  TabModuleId = @TabModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetProfile]'
GO
create procedure {databaseOwner}[{objectQualifier}GetProfile]

@UserID    int, 
@PortalID  int

as

select *
from   {databaseOwner}{objectQualifier}Profile
where  UserId = @UserID 
and    PortalId = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSystemMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSystemMessage]
 @PortalID     int,
 @MessageName  nvarchar(50)
AS
BEGIN
 if @PortalID is null
 begin
  select MessageValue
  from   {databaseOwner}{objectQualifier}SystemMessages
  where  PortalID is null and MessageName = @MessageName
 end else begin
  select MessageValue
  from   {databaseOwner}{objectQualifier}SystemMessages
  where  PortalID = @PortalID and MessageName = @MessageName
 end
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessage]
	@MessageID int
AS
	DELETE FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages
	WHERE  [MessageID] = @MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePackage]
	@PackageID			int,
	@PortalID			int,
	@FriendlyName	    nvarchar(250),
	@Description	    nvarchar(2000),
	@PackageType	    nvarchar(50),
	@Version		    nvarchar(50),
	@License		    ntext,
	@Manifest		    ntext,
	@Owner				nvarchar(100),
	@Organization		nvarchar(100),
	@Url				nvarchar(250),
	@Email				nvarchar(100),
	@ReleaseNotes	    ntext,
	@IsSystemPackage    bit,
	@LastModifiedByUserID	int,
	@FolderName			nvarchar(128),
	@IconFile			nvarchar(100)
AS
	UPDATE {databaseOwner}{objectQualifier}Packages
		SET	
			PortalID = @PortalID,
			FriendlyName = @FriendlyName,
			[Description] = @Description,
			PackageType = @PackageType,
			Version = @Version,
			License = @License,
			Manifest = @Manifest,
			[Owner] = @Owner,
			Organization = @Organization,
			Url = @Url,
			Email = @Email,
			ReleaseNotes = @ReleaseNotes,
			IsSystemPackage = @IsSystemPackage,
			[LastModifiedByUserID] = @LastModifiedByUserID,	[LastModifiedOnDate] = getdate(),
			FolderName = @FolderName,
			IconFile = @IconFile
		WHERE  PackageID = @PackageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSystemMessage]'
GO
create procedure {databaseOwner}[{objectQualifier}AddSystemMessage]

@PortalID     int,
@MessageName  nvarchar(50),
@MessageValue ntext

as

insert into {databaseOwner}{objectQualifier}SystemMessages (
  PortalID,
  MessageName,
  MessageValue
)
values (
  @PortalID,
  @MessageName,
  @MessageValue
)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SplitStrings_CTE]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}SplitStrings_CTE]
(
   @List       NVARCHAR(MAX),
   @Delimiter  NVARCHAR(255)
)
RETURNS @Items TABLE (Item NVARCHAR(4000))
WITH SCHEMABINDING
AS
BEGIN
   DECLARE @StringLength INT = LEN(@List) + 1, @DelimiterLength INT = LEN(@Delimiter);
 
   WITH a AS
   (
       SELECT
           [start] = 1,
           [end]   = COALESCE(NULLIF(CHARINDEX(@Delimiter, 
                       @List, 1), 0), @StringLength),
           [value] = SUBSTRING(@List, 1, 
                     COALESCE(NULLIF(CHARINDEX(@Delimiter, 
                       @List, 1), 0), @StringLength) - 1)
       UNION ALL
       SELECT
           [start] = CONVERT(INT, [end]) + @DelimiterLength,
           [end]   = COALESCE(NULLIF(CHARINDEX(@Delimiter, 
                       @List, [end] + @DelimiterLength), 0), @StringLength),
           [value] = SUBSTRING(@List, [end] + @DelimiterLength, 
                     COALESCE(NULLIF(CHARINDEX(@Delimiter, 
                       @List, [end] + @DelimiterLength), 0), @StringLength)-[end]-@DelimiterLength)
       FROM a
       WHERE [end] < @StringLength
   )
   INSERT @Items SELECT [value]
   FROM a
   WHERE LEN([value]) > 0
   OPTION (MAXRECURSION 0);
 
   RETURN;
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDefaultLanguageByModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDefaultLanguageByModule]
(
	@ModuleList NVARCHAR(4000)
)
AS
BEGIN
	SET NOCOUNT ON

SELECT DISTINCT m.ModuleID, p.DefaultLanguage
FROM            {databaseOwner}[{objectQualifier}Modules]  m
INNER JOIN      {databaseOwner}[{objectQualifier}Portals] p ON p.PortalID = m.PortalID
Inner Join		{databaseOwner}[{objectQualifier}SplitStrings_CTE](@ModuleList,',') ML ON M.ModuleID = ML.item
ORDER BY        m.ModuleID	
		
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteSubscriptionsByObjectKey]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteSubscriptionsByObjectKey]
	@PortalId int,
	@ObjectKey NVARCHAR(255)
AS
BEGIN
	DELETE
	FROM {databaseOwner}{objectQualifier}CoreMessaging_Subscriptions
	WHERE PortalId = @PortalId
		AND ObjectKey = @ObjectKey
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetLanguagesByPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetLanguagesByPortal]
    @PortalId			int
AS
    SELECT 
        L.*,
        PL.PortalId,
        PL.IsPublished
    FROM   {databaseOwner}{objectQualifier}Languages L
        INNER JOIN {databaseOwner}{objectQualifier}PortalLanguages PL On L.LanguageID = PL.LanguageID
    WHERE PL.PortalID = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ImportDocumentLibraryCategories]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}ImportDocumentLibraryCategories]
	@VocabularyID 				int
AS
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'{databaseOwner}[{objectQualifier}dlfp_Category]') AND type in (N'U'))
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}Taxonomy_Terms([Name],[VocabularyID])
		SELECT DISTINCT CategoryName,VID=@VocabularyID
		FROM         {databaseOwner}{objectQualifier}dlfp_Category where CategoryName NOT IN (SELECT [name] from {databaseOwner}{objectQualifier}Taxonomy_Terms)
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeAction]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeAction]
	@NotificationTypeActionID int
AS
BEGIN
	SELECT [NotificationTypeActionID], [NotificationTypeID], [NameResourceKey], [DescriptionResourceKey], [ConfirmResourceKey], [Order], [APICall], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]
	WHERE [NotificationTypeActionID] = @NotificationTypeActionID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderMapping]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderMapping]
	@FolderMappingID int
AS
BEGIN
	SELECT *
	FROM {databaseOwner}[{objectQualifier}FolderMappings]
	WHERE FolderMappingID = @FolderMappingID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserRelationshipPreferences]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}UserRelationshipPreferences]
(
[PreferenceID] [int] NOT NULL IDENTITY(1, 1),
[UserID] [int] NOT NULL,
[RelationshipID] [int] NOT NULL,
[DefaultResponse] [int] NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}UserRelationshipPreferences_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}UserRelationshipPreferences_LastModifiedOnDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}UserRelationshipPreferences] on {databaseOwner}[{objectQualifier}UserRelationshipPreferences]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRelationshipPreferences] ADD CONSTRAINT [PK_{objectQualifier}UserRelationshipPreferences] PRIMARY KEY CLUSTERED  ([PreferenceID], [RelationshipID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRelationshipPreferenceByID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRelationshipPreferenceByID] 
	@PreferenceID INT	
AS 
    SELECT  PreferenceID,
			UserID,
			RelationshipID,            
			DefaultResponse,            
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}UserRelationshipPreferences    
	WHERE @PreferenceID = @PreferenceID	  
	ORDER BY PreferenceID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ImportDocumentLibraryCategoryAssoc]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}ImportDocumentLibraryCategoryAssoc]
AS
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'{databaseOwner}[{objectQualifier}dlfp_Category]') AND type in (N'U'))
	BEGIN
	SELECT     dlc.CategoryName, {databaseOwner}{objectQualifier}Files.FileId
	FROM         {databaseOwner}{objectQualifier}dlfp_Category AS dlc INNER JOIN
                      {databaseOwner}{objectQualifier}dlfp_DocumentCategoryAssoc AS dlca ON dlc.CategoryID = dlca.CategoryID INNER JOIN
                      {databaseOwner}{objectQualifier}dlfp_Document AS dld ON dlca.DocumentID = dld.ID INNER JOIN
                      {databaseOwner}{objectQualifier}Files ON dld.ID = {databaseOwner}{objectQualifier}Files.FileId
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSimpleTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSimpleTerm] 
	@TermID					int,
	@VocabularyID			int,
	@Name					nvarchar(250),
	@Description			nvarchar(2500),
	@Weight					int,
	@LastModifiedByUserID	int
AS
	UPDATE {databaseOwner}{objectQualifier}Taxonomy_Terms
		SET 
			VocabularyID = @VocabularyID,
			[Name] = @Name,
			Description = @Description,
			Weight = @Weight,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
	WHERE TermID = @TermID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RemoveStringCharacters]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}RemoveStringCharacters]
(
		@string nvarchar(max), 
		@remove nvarchar(100)
)
RETURNS nvarchar(max)
AS
BEGIN
    WHILE @string LIKE '%[' + @remove + ']%'
    BEGIN
        SET @string = REPLACE(@string,SUBSTRING(@string,PATINDEX('%[' + @remove + ']%',@string),1),'')
    END

    RETURN @string
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}BuildTabLevelAndPath]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}BuildTabLevelAndPath](@TabId INT, @IncludeChild BIT = 0)
	AS
	BEGIN
		DECLARE @ParentId INT, @Level INT, @TabPath NVARCHAR(255), @TabName NVARCHAR(200)
		SELECT @ParentId = ParentId, @TabName = TabName FROM {databaseOwner}[{objectQualifier}Tabs] WHERE TabID = @TabId
		IF @ParentId > 0
		BEGIN
			SELECT 
				@Level = [Level] + 1,
				@TabPath = TabPath + '//' + {databaseOwner}[{objectQualifier}RemoveStringCharacters](@TabName, '&? ./''#:*')
			 FROM {databaseOwner}[{objectQualifier}Tabs] WHERE TabID = @ParentId
		END
		ELSE
		BEGIN
			SELECT @Level = 0, @TabPath = '//' + {databaseOwner}[{objectQualifier}RemoveStringCharacters](@TabName, '&? ./''#:*')
		END
		
		UPDATE {databaseOwner}[{objectQualifier}Tabs] SET [Level] = @Level, TabPath = @TabPath WHERE TabID = @TabId
		
		IF @IncludeChild = 1
		BEGIN
			DECLARE @ChildTabs TABLE(TabID INT)
			DECLARE @ChildID INT
			INSERT INTO @ChildTabs SELECT TabID FROM {databaseOwner}[{objectQualifier}Tabs] WHERE ParentId =  @TabId
			WHILE EXISTS (SELECT TOP 1 TabID FROM @ChildTabs)
				BEGIN
					SET @ChildID = (SELECT TOP 1 TabID FROM @ChildTabs)
					EXEC {databaseOwner}[{objectQualifier}BuildTabLevelAndPath] @ChildID, @IncludeChild
					DELETE FROM @ChildTabs WHERE TabID = @ChildID
				END
		END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_MarkMessageAsDispatched]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_MarkMessageAsDispatched]
	@MessageId int,
	@RecipientId int
AS
BEGIN
	Update {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients set EmailSent = 1, EmailSentDate =GETDATE()   where MessageID =@MessageId AND RecipientId=@RecipientId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalByPortalAliasID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalByPortalAliasID]

	@PortalAliasId  int

AS
SELECT P.*
FROM {databaseOwner}{objectQualifier}vw_Portals P
	INNER JOIN {databaseOwner}{objectQualifier}PortalAlias PA ON P.PortalID = PA.PortalID
WHERE PA.PortalAliasId = @PortalAliasId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}MoveTabAfter]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}MoveTabAfter] 
	@TabId					int,
	@AfterTabId				int,
	@LastModifiedByUserID	int
AS
	BEGIN
		DECLARE @OldParentId int
		DECLARE @NewParentId int
		DECLARE @PortalId int
		
		SET @OldParentId = (SELECT ParentId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)
		SET @NewParentId = (SELECT ParentId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @AfterTabId)
		SET @PortalId = (SELECT PortalId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)

		DECLARE @TabOrder int
		SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)
		
		IF (@OldParentId <> @NewParentId OR NOT (@OldParentId IS NULL AND @NewParentId IS NULL))
			-- Parent has changed
			BEGIN
				-- update TabOrder of Tabs with same original Parent
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder - 2
					WHERE (ParentId = @OldParentId OR (ParentId IS NULL AND @OldParentId IS NULL)) 
						AND TabOrder > @TabOrder
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))

				-- Get TabOrder of AfterTab
				SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @AfterTabId)
						
				-- update TabOrder of Tabs with same new Parent
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder + 2
					WHERE (ParentId = @NewParentId OR (ParentId IS NULL AND @NewParentId IS NULL)) 
						AND TabOrder > @TabOrder
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))

				-- Update Tab with new TabOrder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET 
						ParentId				= @NewParentId,
						TabOrder				= @TabOrder + 2,
						LastModifiedByUserID	= @LastModifiedByUserID,
						LastModifiedOnDate		= GETDATE()					
					WHERE TabID = @TabId
				EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId, 1
			END
		ELSE
			-- Parent has not changed
			BEGIN
				-- Remove Tab from TabOrder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = -1
					WHERE TabID = @TabId
					
				-- Reorder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder - 2
					WHERE (ParentId = @OldParentId OR (ParentId IS NULL AND @OldParentId IS NULL)) 
						AND TabOrder > @TabOrder
						AND TabId <> @TabId
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))
						
				-- Get TabOrder of AfterTab
				SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @AfterTabId)
										
				-- Reorder					
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder + 2
					WHERE (ParentId = @OldParentId OR (ParentId IS NULL AND @OldParentId IS NULL)) 
						AND TabOrder > @TabOrder
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))

				-- Update Tab with new TabOrder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET 
						TabOrder				= @TabOrder + 2,
						LastModifiedByUserID	= @LastModifiedByUserID,
						LastModifiedOnDate		= GETDATE()					
					WHERE TabID = @TabId
				EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId
			END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabPermission]
	@TabPermissionID int
AS

DELETE FROM {databaseOwner}{objectQualifier}TabPermission
WHERE
	[TabPermissionID] = @TabPermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_GetAllRedirections]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_GetAllRedirections]
AS 
    SELECT  Id ,
            PortalId ,
            Name ,
            [Type] ,
            SortOrder ,
            SourceTabId ,
			IncludeChildTabs ,
            TargetType ,
            TargetValue ,
			Enabled ,
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}Mobile_Redirections    
	ORDER BY PortalId ASC, SortOrder ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddListEntry]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddListEntry]

	@ListName nvarchar(50), 
	@Value nvarchar(100), 
	@Text nvarchar(150),
	@ParentID int,
	@Level int, 
	@EnableSortOrder bit,
	@DefinitionID int, 
	@Description nvarchar(500),
	@PortalID int,
	@SystemList bit,
	@CreatedByUserID	int

AS
	DECLARE @SortOrder int

	IF @EnableSortOrder = 1
		SET @SortOrder = IsNull((SELECT MAX ([SortOrder]) From {databaseOwner}[{objectQualifier}Lists] Where [ListName] = @ListName), 0) + 1
	ELSE
		SET @SortOrder = 0

	-- Check if this entry exists
	If EXISTS (SELECT [EntryID] From {databaseOwner}[{objectQualifier}Lists] WHERE [ListName] = @ListName And [Value] = @Value And [Text] = @Text And [ParentID] = @ParentID)
	BEGIN
		SELECT -1
		RETURN 
	END

	INSERT INTO {databaseOwner}[{objectQualifier}Lists] 
		(
  		[ListName],
		[Value],
		[Text],
		[Level],
		[SortOrder],
		[DefinitionID],
		[ParentID],
		[Description],
		[PortalID],
		[SystemList],
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
		)
	VALUES (
		@ListName,
		@Value,
		@Text,
		@Level,
		@SortOrder,
		@DefinitionID,
		@ParentID,
		@Description,
		@PortalID,
		@SystemList,
  		@CreatedByUserID,
	  	getdate(),
	  	@CreatedByUserID,
	  	getdate()	
		)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateUrlTrackingStats]'
GO
create procedure {databaseOwner}[{objectQualifier}UpdateUrlTrackingStats]

@PortalID     int,
@Url          nvarchar(255),
@ModuleId     int

as

update {databaseOwner}{objectQualifier}UrlTracking
set    Clicks = Clicks + 1,
       LastClick = getdate()
where  PortalID = @PortalID
and    Url = @Url
and    ((ModuleId = @ModuleId) or (ModuleId is null and @ModuleId is null))
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}MoveTabBefore]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}MoveTabBefore] 
	@TabId					int,
	@BeforeTabId			int,
	@LastModifiedByUserID	int
AS
	BEGIN
		DECLARE @OldParentId int
		DECLARE @NewParentId int
		DECLARE @PortalId int
		
		SET @OldParentId = (SELECT ParentId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)
		SET @NewParentId = (SELECT ParentId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @BeforeTabId)
		SET @PortalId = (SELECT PortalId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)
		
		DECLARE @TabOrder int
		SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)
		
		IF (@OldParentId <> @NewParentId OR NOT (@OldParentId IS NULL AND @NewParentId IS NULL))
			-- Parent has changed
			BEGIN
				-- update TabOrder of Tabs with same original Parent
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder - 2
					WHERE (ParentId = @OldParentId OR (ParentId IS NULL AND @OldParentId IS NULL)) 
						AND TabOrder > @TabOrder
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))

				-- Get TabOrder of AfterTab
				SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @BeforeTabId)
						
				-- update TabOrder of Tabs with same new Parent
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder + 2
					WHERE (ParentId = @NewParentId OR (ParentId IS NULL AND @NewParentId IS NULL)) 
						AND TabOrder >= @TabOrder
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))

				-- Update Tab with new TabOrder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET 
						ParentId				= @NewParentId,
						TabOrder				= @TabOrder,
						LastModifiedByUserID	= @LastModifiedByUserID,
						LastModifiedOnDate		= GETDATE()					
					WHERE TabID = @TabId
				EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId, 1
			END
		ELSE
			-- Parent has not changed
			BEGIN
				-- Remove Tab from TabOrder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = -1
					WHERE TabID = @TabId
					
				-- Reorder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder - 2
					WHERE (ParentId = @OldParentId OR (ParentId IS NULL AND @OldParentId IS NULL)) 
						AND TabOrder > @TabOrder
						AND TabId <> @TabId
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))
						
				-- Get TabOrder of BeforeTab
				SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @BeforeTabId)
										
				-- Reorder					
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET TabOrder = TabOrder + 2
					WHERE (ParentId = @OldParentId OR (ParentId IS NULL AND @OldParentId IS NULL)) 
						AND TabOrder >= @TabOrder
						AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))

				-- Update Tab with new TabOrder
				UPDATE {databaseOwner}{objectQualifier}Tabs
					SET 
						TabOrder				= @TabOrder,
						LastModifiedByUserID	= @LastModifiedByUserID,
						LastModifiedOnDate		= GETDATE()					
					WHERE TabID = @TabId
				EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId
			END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddLanguage]

	@CultureCode		    nvarchar(50),
	@CultureName            nvarchar(200),
	@FallbackCulture        nvarchar(50),
	@CreatedByUserID	int

AS
	INSERT INTO {databaseOwner}{objectQualifier}Languages (
		CultureCode,
		CultureName,
		FallbackCulture,
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	)
	VALUES (
		@CultureCode,
		@CultureName,
		@FallbackCulture,
		@CreatedByUserID,
	  	getdate(),
	  	@CreatedByUserID,
	  	getdate()
	)
	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}EnsureNeutralLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}EnsureNeutralLanguage]
    @PortalId INT ,
    @CultureCode NVARCHAR(10)
AS 
    BEGIN
        SET NOCOUNT ON;

        UPDATE  {databaseOwner}{objectQualifier}Tabs
        SET     CultureCode = NULL
        WHERE   PortalID = @PortalId
                AND CultureCode = @CultureCode
    END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_SaveMessageRecipient]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_SaveMessageRecipient]
    @RecipientID int,
    @MessageID int,
    @UserID int,
    @Read bit,
	@Archived bit,
	@CreateUpdateUserID INT
AS
BEGIN
    IF ( @RecipientID = -1 )
        BEGIN
            INSERT {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients(
					[MessageID],
					[UserID],
					[Read],
					[Archived],
                    [CreatedByUserID],
                    [CreatedOnDate],
                    [LastModifiedByUserID],
                    [LastModifiedOnDate]
                    )
            VALUES  (
					@MessageID,
					@UserID,
					@Read,
					@Archived,
                    @CreateUpdateUserID , -- CreatedBy - int
                    GETDATE(), -- CreatedOn - datetime
                    @CreateUpdateUserID , -- LastModifiedBy - int
                    GETDATE() -- LastModifiedOn - datetime
                    )

            SELECT  @RecipientID = SCOPE_IDENTITY()
        END
    ELSE
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
            SET     [MessageID] = @MessageID,
					[UserID] = @UserID,
					[Read] = @Read,
					[Archived] = @Archived,
                    LastModifiedByUserID = @CreateUpdateUserID,
                    LastModifiedOnDate = GETDATE()
            WHERE   RecipientID = @RecipientID
        END

    SELECT  @RecipientID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddLanguagePack]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddLanguagePack]

	@PackageID			    int,
	@LanguageID			    int,
	@DependentPackageID		int,
	@CreatedByUserID	int

AS
	INSERT INTO {databaseOwner}{objectQualifier}LanguagePacks (
		PackageID,
		LanguageID,
		DependentPackageID,
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]

	)
	VALUES (
		@PackageID,
		@LanguageID,
		@DependentPackageID,
		@CreatedByUserID,
	  	getdate(),
	  	@CreatedByUserID,
	  	getdate()
	)
	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}MoveTabToParent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}MoveTabToParent] 
	@TabId					int,
	@NewParentId			int,
	@LastModifiedByUserID	int
AS
	BEGIN
		DECLARE @PortalId int
		SET @PortalId = (SELECT PortalId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)

		DECLARE @OldParentId int
		SET @OldParentId = (SELECT ParentId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)
		
		DECLARE @TabOrder int
		SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId)
		
		-- Get New TabOrder
		DECLARE @NewTabOrder int
		SET @NewTabOrder = (SELECT MAX(TabOrder) FROM {databaseOwner}{objectQualifier}Tabs 
						 WHERE (PortalId = @PortalID OR (PortalId IS NULL AND @PortalID IS NULL)) AND
							   (ParentId = @NewParentId OR (ParentId IS NULL AND @NewParentId IS NULL))
						)
		IF @NewTabOrder IS NULL 
			SET @NewTabOrder = 1
		ELSE
			SET @NewTabOrder = @NewTabOrder + 2			
				
		BEGIN
			-- update TabOrder of Tabs with same original Parent
			UPDATE {databaseOwner}{objectQualifier}Tabs
				SET TabOrder = TabOrder - 2
				WHERE (ParentId = @OldParentId OR (ParentId IS NULL AND @OldParentId IS NULL)) 
					AND TabOrder > @TabOrder
					AND (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))

			-- Update Tab with new TabOrder
			UPDATE {databaseOwner}{objectQualifier}Tabs
				SET 
					ParentId				= @NewParentId,
					TabOrder				= @NewTabOrder,
					LastModifiedByUserID	= @LastModifiedByUserID,
					LastModifiedOnDate		= GETDATE()					
				WHERE TabID = @TabId
		END
		IF (@OldParentId <> @NewParentId) OR (@OldParentId IS NULL AND @NewParentId IS NOT NULL) OR (@OldParentId IS NOT NULL AND @NewParentId IS NULL)
			BEGIN
				EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId, 1
			END
		ELSE
			BEGIN
				EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId
			END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUrl]'
GO
create procedure {databaseOwner}[{objectQualifier}GetUrl]

@PortalID     int,
@Url          nvarchar(255)

as

select *
from   {databaseOwner}{objectQualifier}Urls
where  PortalID = @PortalID
and    Url = @Url
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserByUsername]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserByUsername]

	@PortalID int,
	@Username nvarchar(100)

AS
	SELECT * FROM {databaseOwner}{objectQualifier}vw_Users
	WHERE  Username = @Username
		AND  ((@PortalId IS NULL) OR (PortalId = @PortalID) OR IsSuperUser = 1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ConvertTabToNeutralLanguage]'
GO
Create PROCEDURE {databaseOwner}[{objectQualifier}ConvertTabToNeutralLanguage]
    @PortalId INT ,
    @TabId INT ,
    @CultureCode NVARCHAR(10)
AS 
    BEGIN
        SET NOCOUNT ON;

        UPDATE  {databaseOwner}{objectQualifier}Tabs
        SET     CultureCode = NULL
        WHERE   PortalID = @PortalId
                AND TabID = @TabID
                AND CultureCode = @CultureCode
    END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetScheduleHistory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetScheduleHistory] @ScheduleID INT
AS 
    SELECT  S.* ,
            SH.*
    FROM    {databaseOwner}{objectQualifier}Schedule S
            INNER JOIN {databaseOwner}{objectQualifier}ScheduleHistory SH ON S.ScheduleID = SH.ScheduleID
    WHERE   S.ScheduleID = @ScheduleID
            OR @ScheduleID = -1
    ORDER BY SH.StartDate DESC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetInstalledModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetInstalledModules]
AS
BEGIN
	SELECT		
		DM.DesktopModuleID, 
		DM.ModuleName,
		DM.FriendlyName,
		DM.Version,
		--Left Joined nulls will not add to the count
		COUNT(MDEF.DesktopModuleID) as Instances
	FROM {databaseOwner}[{objectQualifier}DesktopModules] AS DM
		--Paren's Will enforce inner join first before left outer joining
		LEFT JOIN ({databaseOwner}[{objectQualifier}ModuleDefinitions] MDEF 
				INNER JOIN {databaseOwner}[{objectQualifier}Modules] MODS ON MDEF.ModuleDefID = MODS.ModuleDefID)
	ON dm.DesktopModuleID = MDEF.DesktopModuleID 
	WHERE (IsAdmin = 0)
	GROUP BY DM.DesktopModuleID, DM.ModuleName, DM.FriendlyName, DM.Version
	ORDER BY DM.[FriendlyName] ASC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountArchivedMessages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountArchivedMessages]
	@UserID int,
	@PortalID int
AS
BEGIN
	SELECT COUNT(DISTINCT M.MessageID) AS TotalRecords
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] M
	JOIN {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR ON M.MessageID = MR.MessageID
	WHERE Archived = 1
	AND NotificationTypeID IS NULL AND PortalID = @PortalID AND UserID = @UserID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RemovePortalLocalization]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}RemovePortalLocalization]
    @PortalId INT ,
    @CultureCode NVARCHAR(10)
AS 
    BEGIN
        SET NOCOUNT ON;

        DELETE  FROM {databaseOwner}{objectQualifier}PortalLocalization
        WHERE   PortalID = @PortalId
                AND CultureCode = @CultureCode

    END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddFolderMappingsSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddFolderMappingsSetting]
	@FolderMappingID int,
	@SettingName nvarchar(50),
	@SettingValue nvarchar(2000),
	@CreatedByUserID int
AS
BEGIN
	INSERT INTO {databaseOwner}[{objectQualifier}FolderMappingsSettings] (
		FolderMappingID,
		SettingName,
		SettingValue,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	)
	VALUES (
		@FolderMappingID,
		@SettingName,
		@SettingValue,
		@CreatedByUserID,
		GETDATE(),
		@CreatedByUserID,
		GETDATE()
	)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDatabaseInstallVersion]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}GetDatabaseInstallVersion]
AS
SELECT  TOP 1 Major ,
        Minor ,
        Build
FROM    {databaseOwner}{objectQualifier}Version V
WHERE   VersionId IN ( SELECT   MAX(VersionId) AS VersionID
                       FROM     {databaseOwner}[{objectQualifier}Version]
                       GROUP BY CONVERT(NVARCHAR(8), CreatedDate, 112) )
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSystemMessages]'
GO
create procedure {databaseOwner}[{objectQualifier}GetSystemMessages]

as

select MessageName
from   {databaseOwner}{objectQualifier}SystemMessages
where  PortalID is null
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddEventLogConfig]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}AddEventLogConfig]
	@LogTypeKey nvarchar(35),
	@LogTypePortalID int,
	@LoggingIsActive bit,
	@KeepMostRecent int,
	@EmailNotificationIsActive bit,
	@NotificationThreshold int,
	@NotificationThresholdTime int,
	@NotificationThresholdTimeType int,
	@MailFromAddress nvarchar(50),
	@MailToAddress nvarchar(50)
AS

DECLARE @ID int
SET @ID = (SELECT EC.ID FROM {databaseOwner}{objectQualifier}EventLogConfig EC 
				WHERE (EC.LogTypeKey = @LogTypeKey OR (EC.LogTypeKey IS NULL AND @LogTypeKey IS NULL))  
					AND (EC.LogTypePortalID = @LogTypePortalID  OR (EC.LogTypePortalID IS NULL AND @LogTypePortalID IS NULL))
			)

IF @ID IS NULL
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}EventLogConfig
			(LogTypeKey,
			LogTypePortalID,
			LoggingIsActive,
			KeepMostRecent,
			EmailNotificationIsActive,
			NotificationThreshold,
			NotificationThresholdTime,
			NotificationThresholdTimeType,
			MailFromAddress,
			MailToAddress)
		VALUES
			(@LogTypeKey,
			@LogTypePortalID,
			@LoggingIsActive,
			@KeepMostRecent,
			@EmailNotificationIsActive,
			@NotificationThreshold,
			@NotificationThresholdTime,
			@NotificationThresholdTimeType,
			@MailFromAddress,
			@MailToAddress)
	END
ELSE
	BEGIN
		UPDATE {databaseOwner}{objectQualifier}EventLogConfig
		SET 	LogTypeKey = @LogTypeKey,
			LogTypePortalID = @LogTypePortalID,
			LoggingIsActive = @LoggingIsActive,
			KeepMostRecent = @KeepMostRecent,
			EmailNotificationIsActive = @EmailNotificationIsActive,
			NotificationThreshold = @NotificationThreshold,
			NotificationThresholdTime = @NotificationThresholdTime,
			NotificationThresholdTimeType = @NotificationThresholdTimeType,
			MailFromAddress = @MailFromAddress,
			MailToAddress = @MailToAddress
		WHERE	ID = @ID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveCoreAuditTypes]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveCoreAuditTypes]
	@LogTypeKey nvarchar(35),  
	@LogTypeFriendlyName nvarchar(50),  
	@LogTypeOwner nvarchar(100),  
	@LogTypeCSSClass nvarchar(40) ,
	@LoggingIsActive bit,  
	@KeepMostRecent int,  
	@EmailNotificationIsActive bit  

AS  
 IF NOT EXISTS (SELECT * FROM {databaseOwner}{objectQualifier}EventLogTypes WHERE LogTypeKey = @LogTypeKey)  
	BEGIN  
		-- Add new Event Type  
		EXEC {databaseOwner}{objectQualifier}AddEventLogType @LogTypeKey, @LogTypeFriendlyName, N'', @LogTypeOwner, @LogTypeCSSClass  

		-- Add new Event Type Config  
		EXEC {databaseOwner}{objectQualifier}AddEventLogConfig @LogTypeKey, NULL, @LoggingIsActive, @KeepMostRecent, @EmailNotificationIsActive, 1, 1, 1, N'', N''  
		  
		-- exit  
		Return
	END
  ELSE

		UPDATE {databaseOwner}{objectQualifier}EventLogTypes SET LogTypeFriendlyName = @LogTypeFriendlyName WHERE LogTypeKey = @LogTypeKey  

		UPDATE {databaseOwner}{objectQualifier}EventLogConfig
		SET LoggingIsActive=@LoggingIsActive,
		KeepMostRecent=@KeepMostRecent,
		EmailNotificationIsActive=@EmailNotificationIsActive
		WHERE LogTypeKey = @LogTypeKey
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteEventLog]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteEventLog]	
    @LogGUID varchar(36)
AS
BEGIN
    IF @LogGUID is null
    BEGIN
        DELETE FROM {databaseOwner}{objectQualifier}EventLog
    END ELSE BEGIN
        DELETE FROM {databaseOwner}{objectQualifier}EventLog WHERE LogGUID = @LogGUID
    END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersByRolename]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUsersByRolename]
	@PortalID	INT,
	@Rolename	NVARCHAR(50)
AS
	DECLARE @UserPortalId INT
	DECLARE @PortalGroupId INT
	SELECT @PortalGroupId = PortalGroupId FROM {databaseOwner}[{objectQualifier}Portals] WHERE PortalID = @PortalID
	IF EXISTS(SELECT PortalGroupID FROM {databaseOwner}[{objectQualifier}PortalGroups] WHERE PortalGroupID = @PortalGroupId)
	BEGIN
		SELECT @UserPortalId = MasterPortalID FROM {databaseOwner}[{objectQualifier}PortalGroups] WHERE PortalGroupID = @PortalGroupId
	END
	ELSE
	BEGIN
		SELECT @UserPortalId = @PortalID
	END
	SELECT     
		U.*, 
		UP.PortalId, 
		UP.Authorised, 
		UP.IsDeleted,
		UP.RefreshRoles,
		UP.VanityUrl
	FROM {databaseOwner}{objectQualifier}UserPortals AS UP 
			RIGHT OUTER JOIN {databaseOwner}{objectQualifier}UserRoles  UR 
			INNER JOIN {databaseOwner}{objectQualifier}Roles R ON UR.RoleID = R.RoleID 
			RIGHT OUTER JOIN {databaseOwner}{objectQualifier}Users AS U ON UR.UserID = U.UserID 
		ON UP.UserId = U.UserID	
	WHERE ( UP.PortalId = @UserPortalId OR @UserPortalId IS Null )
		AND (UP.IsDeleted = 0 OR UP.IsDeleted Is NULL)
		AND (R.RoleName = @Rolename)
		AND (R.PortalId = @PortalID OR @PortalID IS Null )
	ORDER BY U.FirstName + ' ' + U.LastName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTab]

@TabId    int

AS
SELECT *
FROM   {databaseOwner}{objectQualifier}vw_Tabs
WHERE  TabId = @TabId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRelationshipPreference]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRelationshipPreference] 
	@UserID INT,
	@RelationshipID INT
AS 
    SELECT  PreferenceID,
			UserID,
			RelationshipID,            
			DefaultResponse,            
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}UserRelationshipPreferences    
	WHERE UserID = @UserID
	  AND RelationshipID = @RelationshipID
	ORDER BY UserID ASC, RelationshipID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetServices]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetServices]
    @PortalId  Int, -- pass Null for roles of all sites
    @UserId    Int  -- not null!
AS
BEGIN
    SELECT
        R.*,
        UR.IsOwner,
        UR.UserRoleID,
        UR.UserID,
        UR.ExpiryDate,
        UR.IsTrialUsed,
        UR.EffectiveDate,
        U.DisplayName,
        U.Email
    FROM         {databaseOwner}[{objectQualifier}Users]      U
     INNER JOIN  {databaseOwner}[{objectQualifier}UserRoles] UR ON UR.UserID = U.UserID
     RIGHT JOIN  {databaseOwner}[{objectQualifier}Roles]      R ON UR.RoleID = R.RoleID  AND UR.UserID = @UserId
    WHERE (R.PortalId = @PortalId OR IsNull(@PortalId, -1) = -1)
      AND  R.IsPublic = 1
      AND  R.RoleId  >= 0
	  AND U.UserID = @UserId
    ORDER BY R.RoleName
	OPTION (OPTIMIZE FOR (@PortalId UNKNOWN))
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModuleSetting]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteModuleSetting]
@ModuleId      int,
@SettingName   nvarchar(50)
as

DELETE FROM {databaseOwner}{objectQualifier}ModuleSettings 
WHERE ModuleId = @ModuleId
AND SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteUserPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteUserPortal]
	@UserID		int,
	@PortalID   int
AS
	IF @PortalID IS NULL
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}Users
				SET
					IsDeleted = 1
				WHERE  UserId = @UserID
		END
	ELSE
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}UserPortals
				SET
					IsDeleted = 1
				WHERE  UserId = @UserID
					AND PortalId = @PortalID
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderByUniqueID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderByUniqueID]
    @UniqueID   uniqueidentifier
AS
	SELECT	* 
	FROM	{databaseOwner}{objectQualifier}Folders
	WHERE	UniqueID = @UniqueID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_ModulePermissions]'
GO
-- use new FK
CREATE VIEW {databaseOwner}[{objectQualifier}vw_ModulePermissions]
AS
SELECT  MP.ModulePermissionID,
        MP.ModuleID,
        MP.PortalID,
        P.PermissionID,
        MP.RoleID,
        R.RoleName,
        MP.AllowAccess,
        MP.UserID,
        U.Username,
        U.DisplayName,
        P.PermissionCode,
        P.ModuleDefID,
        P.PermissionKey,
        P.PermissionName,
        MP.CreatedByUserID,
        MP.CreatedOnDate,
        MP.LastModifiedByUserID,
        MP.LastModifiedOnDate
FROM        {databaseOwner}[{objectQualifier}ModulePermission] AS MP
 INNER JOIN {databaseOwner}[{objectQualifier}Permission]       AS P  ON MP.PermissionID = P.PermissionID
 LEFT  JOIN {databaseOwner}[{objectQualifier}Roles]            AS R  ON MP.RoleID       = R.RoleID
 LEFT  JOIN {databaseOwner}[{objectQualifier}Users]            AS U  ON MP.UserID       = U.UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePortalDesktopModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePortalDesktopModules]
    @PortalID        int,
    @DesktopModuleId int
AS
BEGIN
    IF @PortalID is not null AND @DesktopModuleId is not null
        DELETE FROM {databaseOwner}{objectQualifier}PortalDesktopModules WHERE PortalId = @PortalID AND DesktopModuleId = @DesktopModuleId
    ELSE 
        BEGIN
            IF @PortalID is not null
                DELETE FROM {databaseOwner}{objectQualifier}PortalDesktopModules WHERE PortalId = @PortalID
            ELSE
                BEGIN 
                    IF @DesktopModuleId is not null
                        DELETE FROM {databaseOwner}{objectQualifier}PortalDesktopModules WHERE DesktopModuleId = @DesktopModuleId
                END
        END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabOrder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabOrder] 
	@TabId					int,
	@TabOrder				int,
	@ParentId				int,
	@LastModifiedByUserID	int
AS
	DECLARE @OldParentId INT
	SELECT @OldParentId = ParentId FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @TabId
	UPDATE {objectQualifier}Tabs
		SET
			TabOrder				= @TabOrder,
			ParentId				= @ParentId,
			LastModifiedByUserID	= @LastModifiedByUserID,
			LastModifiedOnDate		= GETDATE()
	WHERE  TabId = @TabId
	IF @OldParentId <> @ParentId
		BEGIN
			EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId, 1
		END
	ELSE
		BEGIN
			EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSkinControl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSkinControl]
	@SkinControlID	int
AS
    SELECT *
    FROM   {databaseOwner}{objectQualifier}SkinControls
	WHERE SkinControlID = @SkinControlID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCache]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}OutputCache]
(
[CacheKey] [varchar] (36) NOT NULL,
[ItemId] [int] NOT NULL,
[Data] [nvarchar] (max) NOT NULL,
[Expiration] [datetime] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}OutputCache] on {databaseOwner}[{objectQualifier}OutputCache]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}OutputCache] ADD CONSTRAINT [PK_{objectQualifier}OutputCache] PRIMARY KEY CLUSTERED  ([CacheKey])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCacheGetItem]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}OutputCacheGetItem]
	@CacheKey VarChar (36)
AS
BEGIN
    SELECT *
     FROM  {databaseOwner}{objectQualifier}OutputCache
     WHERE CacheKey = @CacheKey
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabPermission]

	@TabPermissionID int

AS
SELECT *
FROM {databaseOwner}{objectQualifier}vw_TabPermissions
WHERE TabPermissionID = @TabPermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalLanguage]
    @PortalId				int,
    @LanguageId				int,
    @IsPublished			bit,
    @LastModifiedByUserID  	int

AS
    UPDATE {databaseOwner}{objectQualifier}PortalLanguages 
        SET		
            IsPublished				= @IsPublished,
            LastModifiedByUserID	= @LastModifiedByUserID,
            LastModifiedOnDate		= getdate()
    WHERE PortalId = @PortalId
        AND LanguageId = @LanguageId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CanDeleteSkin]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CanDeleteSkin]
	@SkinType char(1),
	@SkinFolderName nvarchar(200) 
AS
	BEGIN
		IF exists(SELECT * FROM {databaseOwner}{objectQualifier}Tabs WHERE (SkinSrc like '%![' + @SkinType + '!]' + @SkinFolderName + '%' ESCAPE '!') 
					OR (ContainerSrc like '%![' + @SkinType + '!]' + @SkinFolderName + '%' ESCAPE '!'))
			SELECT 0
		ELSE
			BEGIN
				IF exists(SELECT * FROM {databaseOwner}{objectQualifier}TabModules WHERE ContainerSrc like '%![' + @SkinType + '!]' + @SkinFolderName + '%' ESCAPE '!')
					SELECT 0
				ELSE
					SELECT 1
			END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCacheAddItem]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}OutputCacheAddItem]
	@ItemId     Int,
	@CacheKey   VarChar ( 36),
	@Data	    nVarChar(Max),
	@Expiration DateTime
AS
BEGIN
    INSERT INTO {databaseOwner}{objectQualifier}OutputCache
    (	ItemId, 
	CacheKey, 
	Data, 
	Expiration
    ) VALUES 
    (   @ItemId, 
	@CacheKey, 
	@Data, 
	@Expiration
    )
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_UpdateMessageReadStatus]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_UpdateMessageReadStatus]
	@ConversationID int,
	@UserID          int,
	@Read			 bit
AS
BEGIN
UPDATE {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] SET [Read]=@Read 
WHERE UserID = @UserID
AND MessageID IN (SELECT MessageID FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WHERE ConversationID=@ConversationID)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AnonymousUsers]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}AnonymousUsers]
(
[UserID] [char] (36) NOT NULL,
[PortalID] [int] NOT NULL,
[TabID] [int] NOT NULL,
[CreationDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}AnonymousUsers_CreationDate] DEFAULT (getdate()),
[LastActiveDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}AnonymousUsers_LastActiveDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}AnonymousUsers] on {databaseOwner}[{objectQualifier}AnonymousUsers]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}AnonymousUsers] ADD CONSTRAINT [PK_{objectQualifier}AnonymousUsers] PRIMARY KEY CLUSTERED  ([UserID], [PortalID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateAnonymousUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateAnonymousUser]
    @UserID  char(36),
    @PortalID  int,
    @TabID   int,
    @LastActiveDate datetime 
as
begin
 update {databaseOwner}{objectQualifier}AnonymousUsers set 
  TabID = @TabID,
  LastActiveDate = @LastActiveDate
 where
  UserID = @UserID
  and PortalID = @PortalID

 if @@ROWCOUNT = 0
 begin
  insert into {databaseOwner}{objectQualifier}AnonymousUsers
   (UserID, PortalID, TabID, CreationDate, LastActiveDate) 
  VALUES
   (@UserID, @PortalID, @TabID, GetDate(), @LastActiveDate)
 end
end
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SynonymsGroups]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SynonymsGroups]
(
[SynonymsGroupID] [int] NOT NULL IDENTITY(1, 1),
[SynonymsTags] [nvarchar] (max) NOT NULL,
[PortalID] [int] NOT NULL,
[CultureCode] [nvarchar] (50) NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL,
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SynonymsGroups] on {databaseOwner}[{objectQualifier}SynonymsGroups]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SynonymsGroups] ADD CONSTRAINT [PK_{objectQualifier}SynonymsGroups] PRIMARY KEY CLUSTERED  ([SynonymsGroupID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllSynonymsGroups]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAllSynonymsGroups]
	@PortalID int,
	@CultureCode nvarchar(50)
AS
BEGIN
	SELECT   
	  [SynonymsGroupID],  
	  [SynonymsTags],  
	  [PortalID],
	  [CreatedByUserID],  
	  [CreatedOnDate],  
	  [LastModifiedByUserID],  
	  [LastModifiedOnDate]
	FROM {databaseOwner}{objectQualifier}SynonymsGroups 
	WHERE [PortalID] = @PortalID
	AND [CultureCode] = @CultureCode
	ORDER BY LastModifiedOnDate DESC
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeActionByName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeActionByName]
	@NotificationTypeID int,
	@NameResourceKey nvarchar(100)
AS
BEGIN
	SELECT [NotificationTypeActionID], [NotificationTypeID], [NameResourceKey], [DescriptionResourceKey], [ConfirmResourceKey], [Order], [APICall], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]
	WHERE [NotificationTypeID] = @NotificationTypeID AND [NameResourceKey] LIKE @NameResourceKey
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSearchResultModules]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}GetSearchResultModules]

@PortalID int

AS

SELECT     
		TM.TabID, 
		T.TabName  AS SearchTabName
FROM	{databaseOwner}{objectQualifier}Modules M
INNER JOIN	{databaseOwner}{objectQualifier}ModuleDefinitions MD ON MD.ModuleDefID = M.ModuleDefID 
INNER JOIN	{databaseOwner}{objectQualifier}TabModules TM ON TM.ModuleID = M.ModuleID 
INNER JOIN	{databaseOwner}{objectQualifier}Tabs T ON T.TabID = TM.TabID
WHERE	MD.FriendlyName = N'Search Results'
	AND T.PortalID = @PortalID
	AND T.IsDeleted = 0
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ExtensionUrlProviders]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviders]
(
[ExtensionUrlProviderID] [int] NOT NULL IDENTITY(1, 1),
[ProviderName] [nvarchar] (150) NOT NULL,
[ProviderType] [nvarchar] (1000) NOT NULL,
[SettingsControlSrc] [nvarchar] (1000) NULL,
[IsActive] [bit] NOT NULL,
[RewriteAllUrls] [bit] NOT NULL,
[RedirectAllUrls] [bit] NOT NULL,
[ReplaceAllUrls] [bit] NOT NULL,
[DesktopModuleId] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ExtensionUrlProviders] on {databaseOwner}[{objectQualifier}ExtensionUrlProviders]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviders] ADD CONSTRAINT [PK_{objectQualifier}ExtensionUrlProviders] PRIMARY KEY CLUSTERED  ([ExtensionUrlProviderID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ExtensionUrlProviderConfiguration]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviderConfiguration]
(
[ExtensionUrlProviderID] [int] NOT NULL,
[PortalID] [int] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ExtensionUrlProviderConfiguration] on {databaseOwner}[{objectQualifier}ExtensionUrlProviderConfiguration]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviderConfiguration] ADD CONSTRAINT [PK_{objectQualifier}ExtensionUrlProviderConfiguration] PRIMARY KEY CLUSTERED  ([ExtensionUrlProviderID], [PortalID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_ExtensionUrlProviders]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_ExtensionUrlProviders]
AS
	SELECT     
		P.ExtensionUrlProviderID, 
		PC.PortalID, 
		P.ProviderName, 
		P.IsActive, 
		P.RewriteAllUrls, 
		P.RedirectAllUrls, 
		P.ReplaceAllUrls, 
		P.DesktopModuleId
	FROM    {databaseOwner}{objectQualifier}ExtensionUrlProviderConfiguration PC
		RIGHT OUTER JOIN {databaseOwner}{objectQualifier}ExtensionUrlProviders P ON PC.ExtensionUrlProviderID = P.ExtensionUrlProviderID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCacheGetItemCount]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}OutputCacheGetItemCount]
	@ItemId int
AS
BEGIN
    SELECT COUNT(*) N
     FROM  {databaseOwner}{objectQualifier}OutputCache
     WHERE ItemId = @ItemId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModulePermission]
	
	@ModulePermissionID int

AS
SELECT *
FROM {databaseOwner}{objectQualifier}vw_ModulePermissions
WHERE ModulePermissionID = @ModulePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetMetaData]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetMetaData] 
	@ContentItemId   int
AS
	SELECT md.MetaDataName, cmd.MetaDataValue
	FROM {databaseOwner}[{objectQualifier}ContentItems_MetaData] cmd
	JOIN {databaseOwner}[{objectQualifier}MetaData] md on (cmd.MetaDataID = md.MetaDataID)
	WHERE ContentItemId = @ContentItemId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSearchCommonWord]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSearchCommonWord]
	@CommonWordID int, 
	@CommonWord nvarchar(255), 
	@Locale nvarchar(10) 
AS

UPDATE {databaseOwner}{objectQualifier}SearchCommonWords SET
	[CommonWord] = @CommonWord,
	[Locale] = @Locale
WHERE
	[CommonWordID] = @CommonWordID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSynonymsGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddSynonymsGroup]
	@SynonymsTags 			nvarchar(MAX),
	@CreatedByUserID 		int,
	@PortalID				int,
	@CultureCode            nvarchar(50)
AS
BEGIN	
	INSERT INTO {databaseOwner}[{objectQualifier}SynonymsGroups](
		[SynonymsTags],  
		[CreatedByUserID],  
		[CreatedOnDate],  
		[LastModifiedByUserID],  
		[LastModifiedOnDate],
		[PortalID],
		[CultureCode]
	) VALUES (
		@SynonymsTags,
		@CreatedByUserID,
	    GETUTCDATE(),
		@CreatedByUserID,
		GETUTCDATE(),
		@PortalID,
		@CultureCode
	)	

	SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_SavePreviewProfile]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_SavePreviewProfile]
    @Id INT ,
    @PortalId INT ,
    @Name NVARCHAR(50) ,
    @Width INT ,
    @Height INT ,
	@UserAgent NVARCHAR(260) ,
	@SortOrder INT ,
    @UserId INT
AS 
    IF ( @Id = -1 ) 
        BEGIN
            INSERT  {databaseOwner}{objectQualifier}Mobile_PreviewProfiles
                    ( PortalId ,
                      Name ,
                      Width ,
                      Height ,
					  UserAgent ,
					  SortOrder ,
                      CreatedByUserID ,
                      CreatedOnDate ,
                      LastModifiedByUserID ,
                      LastModifiedOnDate
			        
                    )
            VALUES  ( @PortalId , -- PortalId - int
                      @Name , -- Name - nvarchar(50)
                      @Width , -- Width - int
                      @Height , -- Height - int
					  @UserAgent ,
					  @SortOrder ,
                      @UserId , -- CreatedBy - int
                      GETDATE() , -- CreatedOn - datetime
                      @UserId , -- LastModifiedBy - int
                      GETDATE() -- LastModifiedOn - datetime
			        
                    )
                    
            SELECT  @Id = SCOPE_IDENTITY()
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}Mobile_PreviewProfiles
            SET     Name = @Name ,
                    Width = @Width ,
                    Height = @Height ,
					UserAgent = @UserAgent ,
					SortOrder = @SortOrder ,
                    LastModifiedByUserID = @UserId ,
                    LastModifiedOnDate = GETDATE()
            WHERE   Id = @Id
        END
        
    SELECT  @Id
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllProfiles]'
GO
create procedure {databaseOwner}[{objectQualifier}GetAllProfiles]
AS
SELECT * FROM {databaseOwner}{objectQualifier}Profile
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCachePurgeCache]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}OutputCachePurgeCache]
AS
BEGIN
    DELETE
     FROM  {databaseOwner}{objectQualifier}OutputCache
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteUserRelationshipPreference]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteUserRelationshipPreference]
	@PreferenceID INT	
AS 
	BEGIN
		DELETE FROM {databaseOwner}{objectQualifier}UserRelationshipPreferences  
		WHERE PreferenceID = @PreferenceID

	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FindDatabaseVersion]'
GO
create procedure {databaseOwner}[{objectQualifier}FindDatabaseVersion]

@Major  int,
@Minor  int,
@Build  int

as

select 1
from   {databaseOwner}{objectQualifier}Version
where  Major = @Major
and    Minor = @Minor
and    Build = @Build
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSynonymsGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSynonymsGroup]
	@SynonymsGroupID		int,
	@SynonymsTags 			nvarchar(MAX),
	@LastModifiedByUserID 	int
AS
BEGIN	
	UPDATE {databaseOwner}{objectQualifier}SynonymsGroups
			SET				
				SynonymsTags = @SynonymsTags,
				LastModifiedByUserID = @LastModifiedByUserID,
				LastModifiedOnDate = GETUTCDATE()
			WHERE SynonymsGroupID = @SynonymsGroupID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCachePurgeExpiredItems]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}OutputCachePurgeExpiredItems]
	@CurrentUtcDateTime DateTime
AS
BEGIN
    DELETE
     FROM  {databaseOwner}{objectQualifier}OutputCache
     WHERE Expiration <= @CurrentUtcDateTime
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateHostSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateHostSetting]
	@SettingName			nvarchar(50),
	@SettingValue			nvarchar(256),
	@SettingIsSecure		bit,
	@LastModifiedByUserID	int
AS
	UPDATE {objectQualifier}HostSettings
		SET    
			SettingValue = @SettingValue, 
			SettingIsSecure = @SettingIsSecure,
			[LastModifiedByUserID] = @LastModifiedByUserID,	
			[LastModifiedOnDate] = getdate()
	WHERE  SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_GetInboxCount]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_GetInboxCount] 
	@PortalID int,
	@UserID int
AS

	SELECT COUNT (*)[Body]
	FROM {databaseOwner}{objectQualifier}Messaging_Messages
	WHERE (ToUserID= @UserID AND Status in (1,2) AND SkipPortal = '0') 
		OR (FromUserID = @UserID AND Status = 0)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSynonymsGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSynonymsGroup]
	@SynonymsGroupID int
AS
BEGIN	
	DELETE FROM {databaseOwner}{objectQualifier}SynonymsGroups WHERE SynonymsGroupID = @SynonymsGroupID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRole]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRole]

	@PortalID int, 
	@UserID int, 
	@RoleId int

AS
	SELECT	*
	    FROM	{databaseOwner}{objectQualifier}vw_UserRoles
	    WHERE   UserId = @UserID
		    AND  PortalId = @PortalID
		    AND  RoleId = @RoleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCacheRemoveItem]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}OutputCacheRemoveItem]
	@ItemId Int
AS
BEGIN
    DELETE
    FROM  {databaseOwner}{objectQualifier}OutputCache
    WHERE ItemId = @ItemId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_UpdateMessageArchivedStatus]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_UpdateMessageArchivedStatus]
	@ConversationID int,
	@UserID int,
	@Archived bit
AS
BEGIN
	UPDATE {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
	SET [Archived] = @Archived
	WHERE UserID = @UserID
	AND MessageID IN (SELECT MessageID FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WHERE ConversationID = @ConversationID)

	IF @Archived = 1 BEGIN
		-- If archiving, set also as read
		UPDATE {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
		SET [Read] = 1
		WHERE [UserID] = @UserID
		AND MessageID IN (SELECT MessageID FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WHERE ConversationID = @ConversationID)
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabVersions]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabVersions]
(
[TabVersionId] [int] NOT NULL IDENTITY(1, 1),
[TabId] [int] NOT NULL,
[Version] [int] NOT NULL,
[TimeStamp] [datetime] NOT NULL,
[IsPublished] [bit] NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL,
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabVersions] on {databaseOwner}[{objectQualifier}TabVersions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabVersions] ADD CONSTRAINT [PK_{objectQualifier}TabVersions] PRIMARY KEY CLUSTERED  ([TabVersionId])
GO
PRINT N'Creating index [IX_{objectQualifier}TabVersions_TabId] on {databaseOwner}[{objectQualifier}TabVersions]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}TabVersions_TabId] ON {databaseOwner}[{objectQualifier}TabVersions] ([TabId])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}TabVersions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabVersions] ADD CONSTRAINT [IX_{objectQualifier}TabVersions] UNIQUE NONCLUSTERED  ([TabId], [Version] DESC)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabVersions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabVersions]
	@TabId INT
AS
BEGIN
	SELECT   
		[TabVersionId],
		[TabId],
		[Version],
		[TimeStamp],
		[IsPublished],
	    [CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	FROM {databaseOwner}[{objectQualifier}TabVersions]
	WHERE [TabId] = @TabId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRoles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRoles]
	@PortalId  int,
	@UserId    int
AS
	SELECT *
		FROM {databaseOwner}{objectQualifier}vw_UserRoles
		WHERE UserID = @UserId AND PortalID = @PortalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModuleControls]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModuleControls]
AS
    SELECT *
    FROM   {databaseOwner}{objectQualifier}ModuleControls
	ORDER BY  ControlKey, ViewOrder
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeActions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeActions]
	@NotificationTypeID int
AS
BEGIN
	SELECT [NotificationTypeActionID], [NotificationTypeID], [NameResourceKey], [DescriptionResourceKey], [ConfirmResourceKey], [Order], [APICall], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]
	WHERE [NotificationTypeID] = @NotificationTypeID
	ORDER BY [Order]
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetExpiredPortals]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetExpiredPortals]

AS
SELECT * FROM {databaseOwner}{objectQualifier}vw_Portals
WHERE ExpiryDate < getDate()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveTabVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveTabVersion]
    @Id INT,
    @TabId INT,
    @TimeStamp DATETIME,
    @Version INT,
	@IsPublished BIT,
    @CreatedByUserID [INT] = -1,
	@LastModifiedByUserID [INT] = -1
AS
BEGIN
    IF ISNULL(@Id, 0) = 0
    BEGIN
        INSERT INTO {databaseOwner}[{objectQualifier}TabVersions](            
            [TabId],
            [TimeStamp],
            [Version],
			[IsPublished],
            [CreatedByUserID],
            [CreatedOnDate],
            [LastModifiedByUserID],
            [LastModifiedOnDate]
        ) VALUES (
            @TabId,
            @TimeStamp,
            @Version,      
			@IsPublished,      
            @CreatedByUserID,
            GETDATE(),
            @LastModifiedByUserID,
            GETDATE()
        )

        SELECT @Id = SCOPE_IDENTITY()
    END
    ELSE
    BEGIN
        UPDATE {databaseOwner}[{objectQualifier}TabVersions] SET            
            [TabId] = @TabId,
            [Version] = @Version,
            [TimeStamp] = @TimeStamp,
			[IsPublished] = @IsPublished,
            [LastModifiedByUserID] = @LastModifiedByUserID,
            [LastModifiedOnDate] = GETDATE()
        WHERE TabVersionId = @Id
    END
	SELECT @Id
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteRole]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteRole]
    @RoleId Int -- ID of role to delete. System Roles ignored (deletion of system roles not supported)
AS
BEGIN
    IF @RoleId >= 0 BEGIN
        DELETE FROM {databaseOwner}[{objectQualifier}DesktopModulePermission] WHERE RoleID = @RoleId
        DELETE FROM {databaseOwner}[{objectQualifier}FolderPermission]        WHERE RoleID = @RoleId
        DELETE FROM {databaseOwner}[{objectQualifier}ModulePermission]        WHERE RoleID = @RoleId
        DELETE FROM {databaseOwner}[{objectQualifier}TabPermission]           WHERE RoleID = @RoleId
        DELETE FROM {databaseOwner}[{objectQualifier}Roles]                   WHERE RoleID = @RoleId
    END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteEventLogConfig]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteEventLogConfig]
	@ID int
AS
DELETE FROM {databaseOwner}{objectQualifier}EventLogConfig
WHERE ID = @ID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateRoleGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateRoleGroup] 
	@RoleGroupId		int,
	@RoleGroupName		nvarchar(50),
	@Description		nvarchar(1000),
	@LastModifiedUserID int
AS

	UPDATE {databaseOwner}{objectQualifier}RoleGroups
	SET    RoleGroupName		= @RoleGroupName,
		   Description			= @Description,
		   LastModifiedByUserID = @LastModifiedUserID,
		   LastModifiedOnDate		= getdate()
	WHERE  RoleGroupId = @RoleGroupId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_SaveRedirection]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Mobile_SaveRedirection]
    @Id INT ,
    @PortalId INT ,
    @Name NVARCHAR(50) ,
    @Type INT ,
    @SortOrder INT ,
    @SourceTabId INT ,
	@IncludeChildTabs BIT ,
    @TargetType INT ,
    @TargetValue NVARCHAR(260) ,
	@Enabled BIT,
    @UserId INT
AS 
    IF ( @Id = -1 ) 
        BEGIN
            INSERT  {databaseOwner}{objectQualifier}Mobile_Redirections
                    ( PortalId ,
                      Name ,
                      Type ,
                      SortOrder ,
                      SourceTabId ,
					  IncludeChildTabs ,
                      TargetType ,
                      TargetValue ,
					  Enabled ,
                      CreatedByUserID ,
                      CreatedOnDate ,
                      LastModifiedByUserID ,
                      LastModifiedOnDate
			        
                    )
            VALUES  ( @PortalId , -- PortalId - int
                      @Name , -- Name - nvarchar(50)
                      @Type , -- Type - int
                      @SortOrder , -- SortOrder - int
                      @SourceTabId , -- SourceTabId - int
					  @IncludeChildTabs ,
                      @TargetType ,
                      @TargetValue ,
					  @Enabled ,
                      @UserId , -- CreatedBy - int
                      GETDATE() , -- CreatedOn - datetime
                      @UserId , -- LastModifiedBy - int
                      GETDATE() -- LastModifiedOn - datetime
			        
                    )
		SELECT  SCOPE_IDENTITY()
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}Mobile_Redirections
            SET     Name = @Name ,
                    [Type] = @Type ,
                    SortOrder = @SortOrder ,
                    SourceTabId = @SourceTabId ,
					IncludeChildTabs = @IncludeChildTabs ,
                    TargetType = @TargetType ,
                    TargetValue = @TargetValue ,
					Enabled = @Enabled ,
                    LastModifiedByUserID = @UserId ,
                    LastModifiedOnDate = GETDATE()
            WHERE   Id = @Id
			SELECT @Id
        END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipient]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipient]
    @RecipientID INT
AS
	SELECT [RecipientID], [MessageID], [UserID], [Read], [Archived], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM   {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
	WHERE  [RecipientID] = @RecipientID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTab]
    @ContentItemID          Int,
    @PortalID               Int,
    @TabOrder               Int,
    @UniqueId               UniqueIdentifier,
    @VersionGuid            UniqueIdentifier,
    @DefaultLanguageGuid    UniqueIdentifier,
    @LocalizedVersionGuid   UniqueIdentifier,
    @TabName                nVarChar(200),
    @IsVisible              Bit,
    @DisableLink            Bit,
    @ParentId               Int,
    @IconFile               nVarChar(255),
    @IconFileLarge          nVarChar(255),
    @Title                  nVarChar(200),
    @Description            nVarChar(500),
    @KeyWords               nVarChar(500),
    @Url                    nVarChar(255),
    @SkinSrc                nVarChar(200),
    @ContainerSrc           nVarChar(200),
    @StartDate              DateTime,
    @EndDate                DateTime,
    @RefreshInterval        Int,
    @PageHeadText           nVarChar(Max),
    @IsSecure               Bit,
    @PermanentRedirect      Bit,
    @SiteMapPriority        Float,
    @CreatedByUserID        Int,
    @CultureCode            nVarChar( 10),
    @IsSystem               bit
AS
BEGIN
    INSERT INTO {databaseOwner}{objectQualifier}Tabs (
        ContentItemID,
        PortalID,
        TabOrder,
        UniqueId,
        VersionGuid,
        DefaultLanguageGuid,
        LocalizedVersionGuid,
        TabName,
        IsVisible,
        DisableLink,
        ParentId,
        IconFile,
        IconFileLarge,
        Title,
        Description,
        KeyWords,
        IsDeleted,
        Url,
        SkinSrc,
        ContainerSrc,
        StartDate,
        EndDate,
        RefreshInterval,
        PageHeadText,
        IsSecure,
        PermanentRedirect,
        SiteMapPriority,
        CreatedByUserID,
        CreatedOnDate,
        LastModifiedByUserID,
        LastModifiedOnDate,
        CultureCode,
        IsSystem
    )
    VALUES (
        @ContentItemID,
        @PortalID,
        @TabOrder,
        @UniqueId,
        @VersionGuid,
        @DefaultLanguageGuid,
        @LocalizedVersionGuid,
        @TabName,
        @IsVisible,
        @DisableLink,
        @ParentId,
        @IconFile,
        @IconFileLarge,
        @Title,
        @Description,
        @KeyWords,
        0,
        @Url,
        @SkinSrc,
        @ContainerSrc,
        @StartDate,
        @EndDate,
        @RefreshInterval,
        @PageHeadText,
        @IsSecure,
        @PermanentRedirect,
        @SiteMapPriority,
        @CreatedByUserID,
        getdate(),
        @CreatedByUserID,
        getdate(),
        @CultureCode,
        @IsSystem
    )
    DECLARE @TabId Int = SCOPE_IDENTITY();
    EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId;
    SELECT @TabId;
    RETURN @TabId;
END /* Procedure */
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveUserRelationshipPreference]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveUserRelationshipPreference]
    @PreferenceID INT,
	@UserID INT,	
	@RelationshipID INT,
	@DefaultResponse INT,
	@CreateUpdateUserID INT
    
AS 
    IF ( @PreferenceID = -1 ) 
        BEGIN
            INSERT  {databaseOwner}{objectQualifier}UserRelationshipPreferences
                    ( UserID,					  
					  RelationshipID,
					  DefaultResponse,
                      CreatedByUserID ,
                      CreatedOnDate ,
                      LastModifiedByUserID ,
                      LastModifiedOnDate
			        
                    )
            VALUES  ( @UserID , -- @UserID int					  
					  @RelationshipID, -- @RelationshipID int
					  @DefaultResponse , -- @DefaultResponse int
                      @CreateUpdateUserID , -- CreatedBy - int
                      GETDATE() , -- CreatedOn - datetime
                      @CreateUpdateUserID , -- LastModifiedBy - int
                      GETDATE() -- LastModifiedOn - datetime
			        
                    )
                    
            SELECT  @PreferenceID = SCOPE_IDENTITY()
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}UserRelationshipPreferences
            SET     UserID = @UserID,					
					RelationshipID = @RelationshipID,
					DefaultResponse = @DefaultResponse,
                    LastModifiedByUserID = @CreateUpdateUserID,
                    LastModifiedOnDate = GETDATE()
            WHERE   PreferenceID = @PreferenceID
        END
        
    SELECT  @PreferenceID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabVersion]
    @Id INT
AS
BEGIN
    DELETE FROM {databaseOwner}[{objectQualifier}TabVersions] WHERE TabVersionId = @Id
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModule]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteModule]

@ModuleId   int

as

delete
from   {databaseOwner}{objectQualifier}Modules 
where  ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SearchStopWords]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SearchStopWords]
(
[StopWordsID] [int] NOT NULL IDENTITY(1, 1),
[StopWords] [nvarchar] (max) NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL,
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL,
[PortalID] [int] NOT NULL,
[CultureCode] [nvarchar] (50) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SearchStopWords] on {databaseOwner}[{objectQualifier}SearchStopWords]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SearchStopWords] ADD CONSTRAINT [PK_{objectQualifier}SearchStopWords] PRIMARY KEY CLUSTERED  ([StopWordsID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSearchStopWords]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSearchStopWords]
	@PortalID int,
	@CultureCode nvarchar(50)
AS
BEGIN
	SELECT   
	  [StopWordsID],  
	  [StopWords],  
	  [CreatedByUserID],  
	  [CreatedOnDate],  
	  [LastModifiedByUserID],  
	  [LastModifiedOnDate],
	  [PortalID],
	  [CultureCode]
	FROM {databaseOwner}{objectQualifier}SearchStopWords 
	WHERE [PortalID] = @PortalID AND [CultureCode] = @CultureCode
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderMappingByMappingName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderMappingByMappingName]
	@PortalID int,
	@MappingName nvarchar(50)
AS
BEGIN
	SELECT *
	FROM {databaseOwner}[{objectQualifier}FolderMappings]
	WHERE ISNULL(PortalID, -1) = ISNULL(@PortalID, -1) AND MappingName = @MappingName
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTab]
    @TabId                  Int,
    @ContentItemID          Int,
    @PortalId               Int,
    @VersionGuid            UniqueIdentifier,
    @DefaultLanguageGuid    UniqueIdentifier,
    @LocalizedVersionGuid   UniqueIdentifier,
    @TabName                nVarChar(200),
    @IsVisible              Bit,
    @DisableLink            Bit,
    @ParentId               Int,
    @IconFile               nVarChar(255),
    @IconFileLarge          nVarChar(255),
    @Title                  nVarChar(200),
    @Description            nVarChar(500),
    @KeyWords               nVarChar(500),
    @IsDeleted              Bit,
    @Url                    nVarChar(255),
    @SkinSrc                nVarChar(200),
    @ContainerSrc           nVarChar(200),
    @StartDate              DateTime,
    @EndDate                DateTime,
    @RefreshInterval        Int,
    @PageHeadText           nVarChar(max),
    @IsSecure               Bit,
    @PermanentRedirect      Bit,
    @SiteMapPriority        Float,
    @LastModifiedByUserID   Int,
    @CultureCode            nVarChar( 10),
    @IsSystem               Bit
AS
BEGIN
    DECLARE @OldParentId Int
    SET @OldParentId = (SELECT ParentId FROM {databaseOwner}[{objectQualifier}Tabs] WHERE TabID = @TabId)

    DECLARE @TabOrder Int
    SET @TabOrder = (SELECT TabOrder FROM {databaseOwner}[{objectQualifier}Tabs] WHERE TabID = @TabId)

    -- Get New TabOrder
    DECLARE @NewTabOrder Int
    SET @NewTabOrder = (SELECT MAX(TabOrder) FROM {databaseOwner}[{objectQualifier}Tabs] WHERE (ParentId = @ParentId OR (ParentId IS NULL AND @ParentId IS NULL)))
    IF @NewTabOrder IS NULL
        SET @NewTabOrder = 1
    ELSE
        SET @NewTabOrder = @NewTabOrder + 2

    UPDATE {databaseOwner}[{objectQualifier}Tabs]
        SET
            ContentItemID           = @ContentItemID,
            PortalId                = @PortalId,
            VersionGuid             = @VersionGuid,
            DefaultLanguageGuid     = @DefaultLanguageGuid,
            LocalizedVersionGuid    = @LocalizedVersionGuid,
            TabName                 = @TabName,
            IsVisible               = @IsVisible,
            DisableLink             = @DisableLink,
            ParentId                = @ParentId,
            IconFile                = @IconFile,
            IconFileLarge           = @IconFileLarge,
            Title                   = @Title,
            Description             = @Description,
            KeyWords                = @KeyWords,
            IsDeleted               = @IsDeleted,
            Url                     = @Url,
            SkinSrc                 = @SkinSrc,
            ContainerSrc            = @ContainerSrc,
            StartDate               = @StartDate,
            EndDate                 = @EndDate,
            RefreshInterval         = @RefreshInterval,
            PageHeadText            = @PageHeadText,
            IsSecure                = @IsSecure,
            PermanentRedirect       = @PermanentRedirect,
            SiteMapPriority         = @SiteMapPriority,
            LastModifiedByUserID    = @LastModifiedByUserID,
            LastModifiedOnDate      = getdate(),
            CultureCode             = @CultureCode,
            IsSystem                = @IsSystem
    WHERE  TabId = @TabId;

    IF (@OldParentId <> @ParentId) BEGIN
        -- update TabOrder of Tabs with same original Parent
        UPDATE {databaseOwner}[{objectQualifier}Tabs]
           SET TabOrder = TabOrder - 2
         WHERE (ParentId = @OldParentId)
           AND TabOrder > @TabOrder

        -- Update Tab with new TabOrder
        UPDATE {databaseOwner}[{objectQualifier}Tabs]
           SET TabOrder = @NewTabOrder
         WHERE TabID = @TabId
    END /* IF */

    EXEC {databaseOwner}{objectQualifier}BuildTabLevelAndPath @TabId, 1
END /* Procedure */
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteUsersOnline]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteUsersOnline]
	@TimeWindow int	
AS
BEGIN
    DECLARE @dt datetime
	SET @dt = DATEADD(MINUTE, -@TimeWindow, GETDATE())

	DELETE FROM {databaseOwner}{objectQualifier}AnonymousUsers WHERE LastActiveDate < @dt

	DELETE FROM {databaseOwner}{objectQualifier}UsersOnline WHERE LastActiveDate < @dt
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetSubscriptionsByUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetSubscriptionsByUser]
	@PortalId int,
	@UserId int,
	@SubscriptionTypeID int
AS
BEGIN
	SELECT *
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions]
	WHERE 
			(( @PortalId is null and PortalId is null) or (PortalId = @PortalId))
			AND UserId = @UserId
			AND (@SubscriptionTypeID IS NULL OR SubscriptionTypeID = @SubscriptionTypeID)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}InsertSearchStopWords]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}InsertSearchStopWords]
	@StopWords 			nvarchar(MAX),
	@CreatedByUserID 		int,
	@PortalID				int,
	@CultureCode		nvarchar(50)
AS
BEGIN	
	INSERT INTO {databaseOwner}[{objectQualifier}SearchStopWords](
		[StopWords],  
		[CreatedByUserID],  
		[CreatedOnDate],  
		[LastModifiedByUserID],  
		[LastModifiedOnDate],
		[PortalID],
		[CultureCode]
	) VALUES (
		@StopWords,
		@CreatedByUserID,
	    GETUTCDATE(),
		@CreatedByUserID,
		GETUTCDATE(),
		@PortalID,
		@CultureCode
	)	

	SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTabAfter]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTabAfter]
    @AfterTabID             Int,
    @ContentItemID          Int,
    @PortalID               Int,
    @UniqueID               UniqueIdentifier,
    @VersionGuid            UniqueIdentifier,
    @DefaultLanguageGuid    UniqueIdentifier,
    @LocalizedVersionGuid   UniqueIdentifier,
    @TabName                nVarChar(200),
    @IsVisible              Bit,
    @DisableLink            Bit,
    @ParentID               Int,
    @IconFile               nVarChar(255),
    @IconFileLarge          nVarChar(255),
    @Title                  nVarChar(200),
    @Description            nVarChar(500),
    @KeyWords               nVarChar(500),
    @Url                    nVarChar(255),
    @SkinSrc                nVarChar(200),
    @ContainerSrc           nVarChar(200),
    @StartDate              DateTime,
    @EndDate                DateTime,
    @RefreshInterval        Int,
    @PageHeadText           nVarChar(max),
    @IsSecure               Bit,
    @PermanentRedirect      Bit,
    @SiteMapPriority        Float,
    @CreatedByUserID        Int,
    @CultureCode            nVarChar( 10),
    @IsSystem               Bit
AS
BEGIN
    DECLARE @TabId    Int
    DECLARE @TabOrder Int = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @AfterTabID)

    -- Update TabOrders for all Tabs higher than @TabOrder
    UPDATE {databaseOwner}{objectQualifier}Tabs
       SET TabOrder = TabOrder + 2
     WHERE (ParentId = @ParentID OR (ParentId IS NULL AND @ParentID IS NULL))
       AND TabOrder > @TabOrder
       AND (PortalId = @PortalID OR (PortalId IS NULL AND @PortalID IS NULL))

    -- Create Tab
    SET @TabOrder = @TabOrder + 2
    EXECUTE @TabId = {databaseOwner}{objectQualifier}AddTab
                        @ContentItemID,
                        @PortalID,
                        @TabOrder,
                        @UniqueId,
                        @VersionGuid,
                        @DefaultLanguageGuid,
                        @LocalizedVersionGuid,
                        @TabName,
                        @IsVisible,
                        @DisableLink,
                        @ParentID,
                        @IconFile,
                        @IconFileLarge,
                        @Title,
                        @Description,
                        @KeyWords,
                        @Url,
                        @SkinSrc,
                        @ContainerSrc,
                        @StartDate,
                        @EndDate,
                        @RefreshInterval,
                        @PageHeadText,
                        @IsSecure,
                        @PermanentRedirect,
                        @SiteMapPriority,
                        @CreatedByUserID,
                        @CultureCode,
                        @IsSystem;

    -- Update Content Item
    UPDATE {databaseOwner}{objectQualifier}ContentItems
       SET TabID = @TabId
     WHERE ContentItemID = @ContentItemID;

    SELECT @TabId;
END /* Procedure */
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddScheduleHistory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddScheduleHistory]
@ScheduleID int,
@StartDate datetime,
@Server varchar(150)
AS
INSERT INTO {databaseOwner}{objectQualifier}ScheduleHistory
(ScheduleID,
StartDate,
Server)
VALUES
(@ScheduleID,
@StartDate,
@Server)

select SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetSubscriptionsByContent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetSubscriptionsByContent]
	@PortalId int,
	@SubscriptionTypeID int,
	@ObjectKey NVARCHAR(255)
AS
BEGIN
	SELECT *
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions]
	WHERE 
		(( @PortalId is null and PortalId is null) or (PortalId = @PortalId))
		AND SubscriptionTypeID = @SubscriptionTypeID
		AND ObjectKey = @ObjectKey
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSearchStopWords]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSearchStopWords]
	@StopWordsID		int,
	@StopWords 			nvarchar(MAX),
	@LastModifiedByUserID 	int
AS
BEGIN	
	UPDATE {databaseOwner}{objectQualifier}SearchStopWords
			SET				
				StopWords = @StopWords,
				LastModifiedByUserID = @LastModifiedByUserID,
				LastModifiedOnDate = GETUTCDATE()
			WHERE StopWordsID = @StopWordsID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateEventLogConfig]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateEventLogConfig]
	@ID int,
	@LogTypeKey nvarchar(35),
	@LogTypePortalID int,
	@LoggingIsActive bit,
	@KeepMostRecent int,
	@EmailNotificationIsActive bit,
	@NotificationThreshold int,
	@NotificationThresholdTime int,
	@NotificationThresholdTimeType int,
	@MailFromAddress nvarchar(50),
	@MailToAddress nvarchar(50)
AS
UPDATE {databaseOwner}{objectQualifier}EventLogConfig
SET 	LogTypeKey = @LogTypeKey,
	LogTypePortalID = @LogTypePortalID,
	LoggingIsActive = @LoggingIsActive,
	KeepMostRecent = @KeepMostRecent,
	EmailNotificationIsActive = @EmailNotificationIsActive,
	NotificationThreshold = @NotificationThreshold,
	NotificationThresholdTime = @NotificationThresholdTime,
	NotificationThresholdTimeType = @NotificationThresholdTimeType,
	MailFromAddress = @MailFromAddress,
	MailToAddress = @MailToAddress
WHERE	ID = @ID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTabBefore]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTabBefore]
    @BeforeTabID            Int,
    @ContentItemID          Int,
    @PortalID               Int,
    @UniqueID               UniqueIdentifier,
    @VersionGuid            UniqueIdentifier,
    @DefaultLanguageGuid    UniqueIdentifier,
    @LocalizedVersionGuid   UniqueIdentifier,
    @TabName                nVarChar(200),
    @IsVisible              Bit,
    @DisableLink            Bit,
    @ParentID               Int,
    @IconFile               nVarChar(255),
    @IconFileLarge          nVarChar(255),
    @Title                  nVarChar(200),
    @Description            nVarChar(500),
    @KeyWords               nVarChar(500),
    @Url                    nVarChar(255),
    @SkinSrc                nVarChar(200),
    @ContainerSrc           nVarChar(200),
    @StartDate              DateTime,
    @EndDate                DateTime,
    @RefreshInterval        Int,
    @PageHeadText           nVarChar(max),
    @IsSecure               Bit,
    @PermanentRedirect      Bit,
    @SiteMapPriority        Float,
    @CreatedByUserID        Int,
    @CultureCode            nVarChar( 10),
    @IsSystem               Bit
AS
BEGIN
    DECLARE @TabID    Int
    DECLARE @TabOrder Int = (SELECT TabOrder FROM {databaseOwner}{objectQualifier}Tabs WHERE TabID = @BeforeTabID);

    -- Update TabOrders for all Tabs higher than @TabOrder
    UPDATE {databaseOwner}{objectQualifier}Tabs
       SET TabOrder = TabOrder + 2
     WHERE (ParentId = @ParentId OR (ParentID IS NULL AND @ParentID IS NULL))
       AND TabOrder >= @TabOrder
       AND (PortalId = @PortalId OR (PortalID IS NULL AND @PortalID IS NULL))

    -- Create Tab
    EXECUTE @TabId = {databaseOwner}{objectQualifier}AddTab
                        @ContentItemID,
                        @PortalID,
                        @TabOrder,
                        @UniqueID,
                        @VersionGuid,
                        @DefaultLanguageGuid,
                        @LocalizedVersionGuid,
                        @TabName,
                        @IsVisible,
                        @DisableLink,
                        @ParentID,
                        @IconFile,
                        @IconFileLarge,
                        @Title,
                        @Description,
                        @KeyWords,
                        @Url,
                        @SkinSrc,
                        @ContainerSrc,
                        @StartDate,
                        @EndDate,
                        @RefreshInterval,
                        @PageHeadText,
                        @IsSecure,
                        @PermanentRedirect,
                        @SiteMapPriority,
                        @CreatedByUserID,
                        @CultureCode,
                        @IsSystem;

    -- Update Content Item
    UPDATE {databaseOwner}{objectQualifier}ContentItems
       SET TabID = @TabId
     WHERE ContentItemID = @ContentItemID;

    SELECT @TabId;
END /* Procedure */
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalAliasOnInstall]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalAliasOnInstall]
	@PortalAlias			nvarchar(200),
	@LastModifiedByUserID	int
AS
	UPDATE {databaseOwner}{objectQualifier}PortalAlias 
		SET HTTPAlias = @PortalAlias,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
	WHERE  HTTPAlias = '_default'
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_AddSubscription]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_AddSubscription]
	@UserId INT ,
	@PortalId INT ,
	@SubscriptionTypeId INT ,
	@ObjectKey NVARCHAR(255) ,
	@Description NVARCHAR(255),
	@ModuleId INT ,
	@TabId INT,
	@ObjectData NVARCHAR(MAX)
AS 
	BEGIN
        DECLARE @SubscriptionId INT = NULL   
        
        SELECT  TOP 1 @SubscriptionId = SubscriptionId
		FROM    {databaseOwner}{objectQualifier}CoreMessaging_Subscriptions
		WHERE   UserId = @UserId
				AND (( @PortalId is null and PortalId is null) or (PortalId = @PortalId))
				AND SubscriptionTypeId = @SubscriptionTypeID
				AND ObjectKey = @ObjectKey
				AND ((@ModuleId is null and ModuleId is null ) or (ModuleId = @ModuleId))	
				AND ((@TabId is null and TabId is null ) or (TabId = @TabId))
		      
        IF (@SubscriptionId IS NULL) 
			BEGIN
				INSERT  INTO {databaseOwner}{objectQualifier}CoreMessaging_Subscriptions
						( UserId ,
							PortalId ,
							SubscriptionTypeId ,
							ObjectKey ,
							Description,
							CreatedOnDate ,
							ModuleId ,
							TabId,
							ObjectData
						)
				VALUES  ( @UserId ,
							@PortalId ,
							@SubscriptionTypeId ,
							@ObjectKey ,
							@Description,
							GETUTCDATE() ,
							@ModuleId ,
							@TabId,
							@ObjectData
						)

				SELECT  SCOPE_IDENTITY() AS [SubscriptionId]
			END
		ELSE 
			BEGIN
				UPDATE  {databaseOwner}{objectQualifier}CoreMessaging_Subscriptions
				SET     UserId = @UserId ,
						PortalId = @PortalId ,
						SubscriptionTypeId = @SubscriptionTypeId ,
						ObjectKey = @ObjectKey ,
						Description = @Description ,
						ModuleId = @ModuleId ,
						TabId = @TabId,
						ObjectData = @ObjectData
				WHERE   SubscriptionId = @SubscriptionId

				SELECT  @SubscriptionId AS [SubscriptionId]
			END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetListEntries]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetListEntries]
	@ListName nvarchar(50),
	@ParentKey nvarchar(150),
	@PortalID int
AS
SELECT *
	FROM {databaseOwner}{objectQualifier}vw_Lists
	WHERE (ListName = @ListName OR @ListName='')
		AND (ParentKey = @ParentKey OR @ParentKey = '')
		AND (PortalID = @PortalID OR PortalID = -1 OR @PortalID IS NULL or SystemList=1)
	ORDER BY [Level], ListName, SortOrder, Text
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFileContent]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}UpdateFileContent]

@FileId      int,
@Content     image

as

update {databaseOwner}{objectQualifier}Files
set    Content = @Content
where  FileId = @FileId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSearchStopWords]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSearchStopWords]
	@StopWordsID int
AS
BEGIN	
	DELETE FROM {databaseOwner}{objectQualifier}SearchStopWords WHERE StopWordsID = @StopWordsID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTabToEnd]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTabToEnd]
    @ContentItemID          Int,
    @PortalID               Int,
    @UniqueID               UniqueIdentifier,
    @VersionGuid            UniqueIdentifier,
    @DefaultLanguageGuid    UniqueIdentifier,
    @LocalizedVersionGuid   UniqueIdentifier,
    @TabName                nVarChar(200),
    @IsVisible              Bit,
    @DisableLink            Bit,
    @ParentID               Int,
    @IconFile               nVarChar(255),
    @IconFileLarge          nVarChar(255),
    @Title                  nVarChar(200),
    @Description            nVarChar(500),
    @KeyWords               nVarChar(500),
    @Url                    nVarChar(255),
    @SkinSrc                nVarChar(200),
    @ContainerSrc           nVarChar(200),
    @StartDate              DateTime,
    @EndDate                DateTime,
    @RefreshInterval        Int,
    @PageHeadText           nVarChar(max),
    @IsSecure               Bit,
    @PermanentRedirect      Bit,
    @SiteMapPriority        Float,
    @CreatedByUserID        Int,
    @CultureCode            nVarChar( 10),
    @IsSystem               Bit
AS
BEGIN
    DECLARE @TabId Int
    DECLARE @TabOrder Int
    SET @TabOrder = (SELECT MAX(TabOrder) FROM {databaseOwner}{objectQualifier}Tabs
                     WHERE (PortalId = @PortalID OR (PortalID IS NULL AND @PortalID IS NULL))
                       AND (ParentId = @ParentID OR (ParentID IS NULL AND @ParentID IS NULL))
                    )
    IF @TabOrder IS NULL
        SET @TabOrder = 1
    ELSE
        SET @TabOrder = @TabOrder + 2

    -- Create Tab
    EXECUTE @TabId = {databaseOwner}{objectQualifier}AddTab
                        @ContentItemID,
                        @PortalID,
                        @TabOrder,
                        @UniqueId,
                        @VersionGuid,
                        @DefaultLanguageGuid,
                        @LocalizedVersionGuid,
                        @TabName,
                        @IsVisible,
                        @DisableLink,
                        @ParentId,
                        @IconFile,
                        @IconFileLarge,
                        @Title,
                        @Description,
                        @KeyWords,
                        @Url,
                        @SkinSrc,
                        @ContainerSrc,
                        @StartDate,
                        @EndDate,
                        @RefreshInterval,
                        @PageHeadText,
                        @IsSecure,
                        @PermanentRedirect,
                        @SiteMapPriority,
                        @CreatedByUserID,
                        @CultureCode,
                        @IsSystem;

    -- Update Content Item
    UPDATE {databaseOwner}{objectQualifier}ContentItems
       SET TabID = @TabId
     WHERE ContentItemID = @ContentItemID;

    SELECT @TabId;
END /* Procedure */
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddModuleDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddModuleDefinition]

	@DesktopModuleId int,    
	@FriendlyName    nvarchar(128),
	@DefinitionName nvarchar(128),
	@DefaultCacheTime int,
	@CreatedByUserID  int

as

insert into {databaseOwner}{objectQualifier}ModuleDefinitions (
	DesktopModuleId,
	FriendlyName,
	DefinitionName,
	DefaultCacheTime,
	CreatedByUserID,
	CreatedOnDate,
	LastModifiedByUserID,
	LastModifiedOnDate
)
values (
	@DesktopModuleId,
	@FriendlyName,
	@DefinitionName,
	@DefaultCacheTime,
	@CreatedByUserID,
	getdate(),
	@CreatedByUserID,
	getdate()
)

select SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_IsSubscribed]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_IsSubscribed]
	@PortalId INT ,
	@UserId INT ,
	@SubscriptionTypeId INT ,
	@ObjectKey NVARCHAR(255) ,
	@ModuleId INT ,
	@TabId INT
AS 
	BEGIN
		SELECT  TOP 1 *
		FROM    {databaseOwner}{objectQualifier}CoreMessaging_Subscriptions
		WHERE   UserId = @UserId
				AND (( @PortalId is null and PortalId is null) or (PortalId = @PortalId))
				AND SubscriptionTypeId = @SubscriptionTypeID
				AND ObjectKey = @ObjectKey
				AND ((@ModuleId is null and ModuleId is null ) or (ModuleId = @ModuleId))	
				AND ((@TabId is null and TabId is null ) or (TabId = @TabId))
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_GetMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_GetMessage] 
	@MessageID bigint
AS
	SELECT * FROM {objectQualifier}Messaging_Messages WHERE MessageID = @MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddExtensionUrlProvider]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddExtensionUrlProvider] 
	@ExtensionUrlProviderID	int, 
    @DesktopModuleId		int, 
    @ProviderName			nvarchar(150), 
    @ProviderType			nvarchar(1000), 
    @SettingsControlSrc		nvarchar(1000), 
    @IsActive				bit, 
    @RewriteAllUrls			bit, 
    @RedirectAllUrls		bit, 
    @ReplaceAllUrls			bit
AS

IF EXISTS (SELECT * FROM {databaseOwner}{objectQualifier}ExtensionUrlProviders WHERE ExtensionUrlProviderID = @ExtensionUrlProviderID)
	BEGIN
		UPDATE {databaseOwner}{objectQualifier}ExtensionUrlProviders
			SET
				DesktopModuleId = @DesktopModuleId,
				ProviderName = @ProviderName,
				ProviderType = @ProviderType,
				SettingsControlSrc = @SettingsControlSrc,
				IsActive = @IsActive,
				RewriteAllUrls = @RewriteAllUrls,
				RedirectAllUrls = @RedirectAllUrls,
				ReplaceAllUrls = @ReplaceAllUrls
			WHERE ExtensionUrlProviderID = @ExtensionUrlProviderID
	END
ELSE
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}ExtensionUrlProviders (
				DesktopModuleId,
				ProviderName,
				ProviderType,
				SettingsControlSrc,
				IsActive,
				RewriteAllUrls,
				RedirectAllUrls,
				ReplaceAllUrls
		)
		VALUES (
				@DesktopModuleId,
				@ProviderName,
				@ProviderType,
				@SettingsControlSrc,
				@IsActive,
				@RewriteAllUrls,
				@RedirectAllUrls,
				@ReplaceAllUrls
		)
		
		SET @ExtensionUrlProviderID = @@IDENTITY
		
	END
	
SELECT @ExtensionUrlProviderID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipientsByUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipientsByUser]
    @UserID INT
AS
	SELECT [RecipientID], [MessageID], [UserID], [Read], [Archived], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM   {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
	WHERE  [UserID] = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddScopeType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddScopeType] 
	@ScopeType			nvarchar(250)
AS
	INSERT INTO {databaseOwner}{objectQualifier}Taxonomy_ScopeTypes (
		ScopeType
	)

	VALUES (
		@ScopeType
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabVersionDetails]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabVersionDetails]
(
[TabVersionDetailId] [int] NOT NULL IDENTITY(1, 1),
[TabVersionId] [int] NOT NULL,
[ModuleId] [int] NOT NULL,
[ModuleVersion] [int] NOT NULL,
[PaneName] [nvarchar] (50) NOT NULL,
[ModuleOrder] [int] NOT NULL,
[Action] [int] NOT NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL,
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabVersionDetails] on {databaseOwner}[{objectQualifier}TabVersionDetails]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabVersionDetails] ADD CONSTRAINT [PK_{objectQualifier}TabVersionDetails] PRIMARY KEY CLUSTERED  ([TabVersionDetailId])
GO
PRINT N'Creating index [IX_{objectQualifier}TabVersionDetails_TabVersionId] on {databaseOwner}[{objectQualifier}TabVersionDetails]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}TabVersionDetails_TabVersionId] ON {databaseOwner}[{objectQualifier}TabVersionDetails] ([TabVersionId])
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}TabVersionDetails]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabVersionDetails] ADD CONSTRAINT [IX_{objectQualifier}TabVersionDetails_Unique(TabVersionId_ModuleId)] UNIQUE NONCLUSTERED  ([TabVersionId], [ModuleId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabVersionDetails]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabVersionDetails]
	@TabVersionId INT
AS
BEGIN
	SELECT   
		[TabVersionDetailId] ,
        [TabVersionId] ,
		[ModuleId] ,
		[ModuleVersion] ,
		[PaneName] ,
		[ModuleOrder] ,
		[Action],
	    [CreatedByUserID] ,
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	FROM {databaseOwner}[{objectQualifier}TabVersionDetails]
	WHERE [TabVersionId] = @TabVersionId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTabModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTabModule]
    @TabId                  int,
    @ModuleId               int,
	@ModuleTitle			nvarchar(256),
	@Header					ntext,
	@Footer					ntext,
    @ModuleOrder            int,
    @PaneName               nvarchar(50),
    @CacheTime              int,
    @CacheMethod			varchar(50),
    @Alignment              nvarchar(10),
    @Color                  nvarchar(20),
    @Border                 nvarchar(1),
    @IconFile               nvarchar(100),
    @Visibility             int,
    @ContainerSrc           nvarchar(200),
    @DisplayTitle           bit,
    @DisplayPrint           bit,
    @DisplaySyndicate       bit,
    @IsWebSlice				bit,
    @WebSliceTitle			nvarchar(256),
    @WebSliceExpiryDate     datetime,
    @WebSliceTTL			int,
    @UniqueId				uniqueidentifier,
    @VersionGuid			uniqueidentifier,
    @DefaultLanguageGuid	uniqueidentifier,
    @LocalizedVersionGuid	uniqueidentifier,
    @CultureCode			nvarchar(10),
    @CreatedByUserID  		int

AS
    INSERT INTO {databaseOwner}{objectQualifier}TabModules ( 
        TabId,
        ModuleId,
        ModuleTitle,
        Header,
        Footer,
		ModuleOrder,
        PaneName,
        CacheTime,
        CacheMethod,
        Alignment,
        Color,
        Border,
        IconFile,
        Visibility,
        ContainerSrc,
        DisplayTitle,
        DisplayPrint,
        DisplaySyndicate,
        IsWebSlice,
        WebSliceTitle,
        WebSliceExpiryDate,
        WebSliceTTL,
        UniqueId,
        VersionGuid,
        DefaultLanguageGuid,
        LocalizedVersionGuid,
        CultureCode,
        CreatedByUserID,
        CreatedOnDate,
        LastModifiedByUserID,
        LastModifiedOnDate
    )
    VALUES (
        @TabId,
        @ModuleId,
        @ModuleTitle,
        @Header,
        @Footer,
        @ModuleOrder,
        @PaneName,
        @CacheTime,
        @CacheMethod,
        @Alignment,
        @Color,
        @Border,
        @IconFile,
        @Visibility,
        @ContainerSrc,
        @DisplayTitle,
        @DisplayPrint,
        @DisplaySyndicate,
        @IsWebSlice,
        @WebSliceTitle,
        @WebSliceExpiryDate,
        @WebSliceTTL,
        @UniqueId,
        @VersionGuid,
        @DefaultLanguageGuid,
        @LocalizedVersionGuid,
        @CultureCode,
        @CreatedByUserID,
        getdate(),
        @CreatedByUserID,
        getdate()
    )
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteExtensionUrlProvider]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteExtensionUrlProvider] 
	@ExtensionUrlProviderID	int
AS

DELETE FROM {databaseOwner}{objectQualifier}ExtensionUrlProviders
	WHERE ExtensionUrlProviderID = @ExtensionUrlProviderID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteLanguagePack]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteLanguagePack]

	@LanguagePackID		int

AS
    DELETE
	    FROM	{databaseOwner}{objectQualifier}LanguagePacks
	    WHERE   LanguagePackID = @LanguagePackID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateUser]
	@UserID         int,
	@PortalID		int,
	@FirstName		nvarchar(50),
	@LastName		nvarchar(50),
	@IsSuperUser    bit,
	@Email          nvarchar(256),
	@DisplayName    nvarchar(100),
	@VanityUrl		nvarchar(100),
	@UpdatePassword	bit,
	@Authorised		bit,
	@RefreshRoles	bit,
	@LastIPAddress	nvarchar(50),
	@passwordResetToken uniqueidentifier,
	@passwordResetExpiration datetime,
	@IsDeleted		bit,
	@LastModifiedByUserID int
AS
	UPDATE {databaseOwner}{objectQualifier}Users
		SET
			FirstName = @FirstName,
			LastName = @LastName,
			IsSuperUser = @IsSuperUser,
			Email = @Email,
			DisplayName = @DisplayName,
			UpdatePassword = @UpdatePassword,
			PasswordResetToken=@passwordResetToken,
			PasswordResetExpiration=@passwordResetExpiration,
			LastIPAddress = @LastIPAddress,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
		WHERE  UserId = @UserID
	
	IF @PortalID IS NULL
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}Users
				SET
					IsDeleted = @IsDeleted
				WHERE  UserId = @UserID
		END
	ELSE
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}UserPortals
				SET
					Authorised = @Authorised,
					RefreshRoles = @RefreshRoles,
					VanityUrl = @VanityUrl,
					IsDeleted = @IsDeleted
				WHERE  UserId = @UserID
					AND PortalId = @PortalID
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserRelationships]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserRelationships]
	@UserID INT
AS 
	SELECT  UserRelationshipID,
			UserID,
			RelatedUserID,
			RelationshipID,            
			Status,            
			CreatedByUserID ,
			CreatedOnDate ,
			LastModifiedByUserID ,
			LastModifiedOnDate
	FROM    {databaseOwner}{objectQualifier}UserRelationships    		
	WHERE UserID = @UserID OR RelatedUserID = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveTabVersionDetail]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveTabVersionDetail]
    @Id INT,
    @TabVersionId INT,
    @ModuleId INT,
    @ModuleVersion INT,
	@PaneName NVARCHAR(50),
	@ModuleOrder INT,
	@Action INT,
    @CreatedByUserID [INT] = -1,
	@LastModifiedByUserID [INT] = -1
AS
BEGIN
    IF ISNULL(@Id, 0) = 0
    BEGIN
        INSERT INTO {databaseOwner}[{objectQualifier}TabVersionDetails](
            [TabVersionId],
            [ModuleId],
            [ModuleVersion],
			[PaneName],
            [ModuleOrder],
			[Action],
            [CreatedByUserID],
            [CreatedOnDate],
            [LastModifiedByUserID],
            [LastModifiedOnDate]
        ) VALUES (
            @TabVersionId,
			@ModuleId,            
            @ModuleVersion,            
			@PaneName,
			@ModuleOrder,
			@Action,
            @CreatedByUserID,
            GETDATE(),
            @LastModifiedByUserID,
            GETDATE()
        )

        SELECT @Id = SCOPE_IDENTITY()
    END
    ELSE
    BEGIN
        UPDATE {databaseOwner}[{objectQualifier}TabVersionDetails] SET            
            [TabVersionId] = @TabVersionId,
			[ModuleId] = @ModuleId,
            [ModuleVersion] = @ModuleVersion,            
            [PaneName] = @PaneName,
			[ModuleOrder] = @ModuleOrder,
			[Action] = @Action,
            [LastModifiedByUserID] = @LastModifiedByUserID,
            [LastModifiedOnDate] = GETDATE()
        WHERE TabVersionDetailId = @Id
    END
	SELECT @Id
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_Save_Message]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_Save_Message] 
   @PortalID int,
   @FromUserID int,
   @ToUserID int,
   @ToRoleID int,
   @Status int,
   @Subject nvarchar(max),
   @Body nvarchar(max),
   @Date datetime,
   @Conversation uniqueidentifier,
   @ReplyTo bigint,
   @AllowReply bit,
   @SkipPortal bit

AS
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}Messaging_Messages
       ([PortalID]
       ,[FromUserID]
	   ,[FromUserName]
       ,[ToUserID]
       ,[ToRoleID]
	   ,[ToUserName]
       ,[Status]
       ,[Subject]
       ,[Body]
       ,[Date]
       ,[Conversation]
       ,[ReplyTo]
       ,[AllowReply]
       ,[SkipPortal]
		,[EmailSent])
 SELECT
       @PortalID,
       @FromUserID,
	   (SELECT UserName FROM {objectQualifier}Users WHERE UserID = @FromUserID) as FromUserName,
       @ToUserID,
       @ToRoleID,
	   (SELECT UserName FROM {objectQualifier}Users WHERE UserID = @ToUserID) as ToUserName, 
       @Status,
       @Subject, 
       @Body,
       @Date, 
       @Conversation,
       @ReplyTo,
       @AllowReply, 
       @SkipPortal,
	   '0'
			
		SELECT SCOPE_IDENTITY()						
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_SendNotification]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_SendNotification]
	@NotificationTypeID int,
	@PortalID INT,
	@To nvarchar(2000),
	@From nvarchar(200),
    @Subject nvarchar(400),
    @Body nvarchar(max),
    @SenderUserID int,
	@CreateUpdateUserID int,
	@ExpirationDate datetime,
    @IncludeDismissAction bit,
    @Context nvarchar(200)
AS
BEGIN
	INSERT {databaseOwner}[{objectQualifier}CoreMessaging_Messages] (
		[NotificationTypeID],
		[PortalID],
		[To],
		[From],
		[Subject],
		[Body],
		[SenderUserID],
		[ExpirationDate],
        [IncludeDismissAction],
        [Context],
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	) VALUES (
		@NotificationTypeID,
		@PortalID,
		@To,
		@From,
		@Subject,
		@Body,
		@SenderUserID,
		@ExpirationDate,
        @IncludeDismissAction,
        @Context,
		@CreateUpdateUserID, -- CreatedBy
		GETUTCDATE(), -- CreatedOn
		@CreateUpdateUserID, -- LastModifiedBy
		GETDATE() -- LastModifiedOn
	)

	SELECT  SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ExtensionUrlProviderTab]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviderTab]
(
[ExtensionUrlProviderID] [int] NOT NULL,
[PortalID] [int] NOT NULL,
[TabID] [int] NOT NULL,
[IsActive] [bit] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ExtensionUrlProviderTab] on {databaseOwner}[{objectQualifier}ExtensionUrlProviderTab]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviderTab] ADD CONSTRAINT [PK_{objectQualifier}ExtensionUrlProviderTab] PRIMARY KEY CLUSTERED  ([ExtensionUrlProviderID], [PortalID], [TabID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ExtensionUrlProviderSetting]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviderSetting]
(
[ExtensionUrlProviderID] [int] NOT NULL,
[PortalID] [int] NOT NULL,
[SettingName] [nvarchar] (100) NOT NULL,
[SettingValue] [nvarchar] (2000) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ExtensionUrlProviderSetting] on {databaseOwner}[{objectQualifier}ExtensionUrlProviderSetting]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ExtensionUrlProviderSetting] ADD CONSTRAINT [PK_{objectQualifier}ExtensionUrlProviderSetting] PRIMARY KEY CLUSTERED  ([ExtensionUrlProviderID], [PortalID], [SettingName])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetExtensionUrlProviders]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetExtensionUrlProviders] 
	@PortalID	int 
AS
	SELECT 
		p.*, 
		pc.PortalID
	FROM  {databaseOwner}{objectQualifier}ExtensionUrlProviderConfiguration pc 
		RIGHT OUTER JOIN {databaseOwner}{objectQualifier}ExtensionUrlProviders p 
			ON pc.ExtensionUrlProviderID = p.ExtensionUrlProviderID
	WHERE pc.PortalID = @PortalID OR pc.PortalID IS Null

	SELECT ExtensionUrlProviderID, 
			PortalID, 
			SettingName, 
			SettingValue
	FROM {databaseOwner}{objectQualifier}ExtensionUrlProviderSetting
	WHERE PortalID = PortalID

	SELECT DISTINCT 
			P.ExtensionUrlProviderID,
			TM.TabID
		FROM {databaseOwner}{objectQualifier}DesktopModules DM
			INNER JOIN {databaseOwner}{objectQualifier}ModuleDefinitions MD ON DM.DesktopModuleID = MD.DesktopModuleID 
			INNER JOIN {databaseOwner}{objectQualifier}Modules M ON MD.ModuleDefID = M.ModuleDefID 
			INNER JOIN {databaseOwner}{objectQualifier}TabModules TM ON M.ModuleID = TM.ModuleID 
			INNER JOIN {databaseOwner}{objectQualifier}vw_ExtensionUrlProviders P ON DM.DesktopModuleID = P.DesktopModuleId
		WHERE     (P.PortalID = @PortalID) OR (P.PortalID IS NULL)
		  
		UNION
			SELECT  
				P.ExtensionUrlProviderID,
				PT.TabId
			FROM    {databaseOwner}{objectQualifier}ExtensionUrlProviderTab PT
				INNER JOIN {databaseOwner}{objectQualifier}ExtensionUrlProviders P ON P.ExtensionUrlProviderID = PT.ExtensionUrlProviderID
			WHERE   (PT.IsActive = 1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModule]

	@ModuleId int,
	@TabId    int
	
AS
SELECT	* 
FROM {databaseOwner}{objectQualifier}vw_Modules
WHERE   ModuleId = @ModuleId
AND     (TabId = @TabId or @TabId is null)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModuleSettingsByName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModuleSettingsByName]
	@PortalId INT,
	@SettingName NVARCHAR(50)
AS
BEGIN
	SELECT tms.TabModuleID, tms.SettingValue
	FROM {databaseOwner}[{objectQualifier}TabModuleSettings] tms
			INNER JOIN {databaseOwner}[{objectQualifier}TabModules] tm ON tms.TabModuleID = tm.TabModuleID
			INNER JOIN {databaseOwner}[{objectQualifier}Tabs] t ON tm.TabID = t.TabID AND (t.PortalID = @PortalID OR t.PortalID IS NULL)
	WHERE tms.SettingName = @SettingName
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddMetaData]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddMetaData] 
	@ContentItemID		int,
	@Name				nvarchar(100),
	@Value				nvarchar(MAX)
AS
	DECLARE @MetaDataID	int
	SET @MetaDataID = (SELECT MetaDataID FROM {objectQualifier}MetaData WHERE MetaDataName = @Name)
	
	IF @MetaDataID IS NULL
		BEGIN
			--Insert new item into MetaData table
			INSERT INTO {databaseOwner}{objectQualifier}MetaData ( MetaDataName ) VALUES ( @Name )

			SET @MetaDataID = (SELECT SCOPE_IDENTITY() )
		END
		
	INSERT INTO {databaseOwner}{objectQualifier}ContentItems_MetaData (
		ContentItemID,
		MetaDataID,
		MetaDataValue
	)
	VALUES (
		@ContentItemID,
		@MetaDataID,
		@Value
	)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabVersionDetail]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabVersionDetail]
    @Id INT
AS
BEGIN
    DELETE FROM {databaseOwner}[{objectQualifier}TabVersionDetails] WHERE TabVersionDetailId = @Id
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_GetNewMessageCount]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_GetNewMessageCount] 
	@PortalID int,
	@UserID int
AS
	SELECT count(*) FROM {objectQualifier}Messaging_Messages WHERE ToUserID = @UserID AND Status = 1
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Mobile_SaveRedirectionRule]'
GO
CREATE PROC {databaseOwner}[{objectQualifier}Mobile_SaveRedirectionRule]
    @Id INT ,
    @RedirectionId INT ,
    @Capbility NVARCHAR(50) ,
    @Expression NVARCHAR(50)
AS 
    IF @Id = -1 
        BEGIN
            INSERT  INTO {databaseOwner}{objectQualifier}Mobile_RedirectionRules
                    ( RedirectionId ,
                      Capability ,
                      Expression
		        )
            VALUES  ( @RedirectionId , -- RedirectionId - int
                      @Capbility , -- Capability - nvarchar(50)
                      @Expression  -- Expression - nvarchar(50)
		        )
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}Mobile_RedirectionRules
            SET     Capability = @Capbility ,
                    Expression = @Expression
            WHERE   Id = @Id
        END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateExtensionUrlProvider]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateExtensionUrlProvider] 
	@ExtensionUrlProviderID		int,
	@IsActive					bit
AS
	UPDATE {databaseOwner}{objectQualifier}ExtensionUrlProviders
		SET IsActive = @IsActive
		WHERE ExtensionUrlProviderID = @ExtensionUrlProviderID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteModulePermission]
	@ModulePermissionID int
AS

DELETE FROM {databaseOwner}{objectQualifier}ModulePermission
WHERE
	[ModulePermissionID] = @ModulePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModuleIdsBySettingNameAndValue]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModuleIdsBySettingNameAndValue]
	@PortalId INT,
	@SettingName NVARCHAR(50),
	@SettingValue NVARCHAR(max)
AS
BEGIN
	SELECT DISTINCT tms.TabModuleID
	FROM {databaseOwner}[{objectQualifier}TabModuleSettings] tms
			INNER JOIN {databaseOwner}[{objectQualifier}TabModules] tm ON tms.TabModuleID = tm.TabModuleID
			INNER JOIN {databaseOwner}[{objectQualifier}Tabs] t ON tm.TabID = t.TabID AND (t.PortalID = @PortalID OR t.PortalID IS NULL)
	WHERE tms.SettingName = @SettingName
	  AND tms.SettingValue = @SettingValue
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPackages]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPackages]
	@PortalID	int
AS
	SELECT *
		FROM   {databaseOwner}{objectQualifier}Packages
		WHERE (PortalID = @PortalID OR @PortalID IS NULL OR PortalID IS NULL)
		ORDER BY PackageType ASC, [FriendlyName] ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabVersionDetailsHistory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabVersionDetailsHistory]
	@TabID iNT,
    @Version INT
AS
BEGIN    
	SELECT tvd.[TabVersionDetailId]
		  ,tvd.[TabVersionId]
		  ,tvd.[ModuleId]
		  ,tvd.[ModuleVersion]
		  ,tvd.[PaneName]
		  ,tvd.[ModuleOrder]
		  ,tvd.[Action]
		  ,tvd.[CreatedByUserID]
		  ,tvd.[CreatedOnDate]
		  ,tvd.[LastModifiedByUserID]
		  ,tvd.[LastModifiedOnDate]
	FROM {databaseOwner}[{objectQualifier}TabVersionDetails] tvd
	INNER JOIN {databaseOwner}[{objectQualifier}TabVersions] tv ON tvd.TabVersionId = tv.TabVersionId
	WHERE tv.Version <= @Version
		AND tv.TabId = @TabID
	ORDER BY tvd.CreatedOnDate 
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateModuleDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateModuleDefinition]

	@ModuleDefId			int,    
	@FriendlyName			nvarchar(128),
	@DefinitionName			nvarchar(128),
	@DefaultCacheTime		int,
	@LastModifiedByUserID	int

as

update {databaseOwner}{objectQualifier}ModuleDefinitions 
	SET FriendlyName = @FriendlyName,
		DefinitionName = @DefinitionName,
		DefaultCacheTime = @DefaultCacheTime,
		LastModifiedByUserID = @LastModifiedByUserID,
		LastModifiedOnDate = getdate()
	WHERE ModuleDefId = @ModuleDefId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFileLastModificationTime]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFileLastModificationTime]
	@FileId				  Int, 		-- Not Null
	@LastModificationTime DateTime  -- Null: Now
AS
BEGIN
    UPDATE {databaseOwner}[{objectQualifier}Files]
    SET    LastModificationTime = IsNull(@LastModificationTime, GetDate())
    WHERE  FileId = @FileId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetLegacyFolderCount]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetLegacyFolderCount]
AS
	SELECT COUNT(*)
	FROM {databaseOwner}{objectQualifier}Folders
		WHERE ParentID IS NULL AND FolderPath <> ''
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFolderMappingsSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFolderMappingsSetting]
	@FolderMappingID int,
	@SettingName nvarchar(50),
	@SettingValue nvarchar(2000),
	@LastModifiedByUserID int
AS
BEGIN
	UPDATE {databaseOwner}[{objectQualifier}FolderMappingsSettings]
	SET
		SettingValue = @SettingValue,
		LastModifiedByUserID = @LastModifiedByUserID,
		LastModifiedOnDate = GETDATE()
	WHERE FolderMappingID = @FolderMappingID AND SettingName = @SettingName
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveExtensionUrlProviderSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveExtensionUrlProviderSetting] 
	@ExtensionUrlProviderID		int,
	@PortalId					int,
	@SettingName				nvarchar(100),
	@SettingValue				nvarchar(2000)
AS

	IF (SELECT COUNT(*) 
			FROM {databaseOwner}{objectQualifier}ExtensionUrlProviderSetting 
			WHERE ExtensionUrlProviderID = @ExtensionUrlProviderID
				AND PortalID = @PortalId
				AND SettingName = @SettingName) = 0
		BEGIN
			--ADD
			INSERT INTO {databaseOwner}{objectQualifier}ExtensionUrlProviderSetting
			        ( ExtensionUrlProviderID ,
			          PortalID ,
			          SettingName ,
			          SettingValue
			        )
			VALUES  ( @ExtensionUrlProviderID , -- ExtensionUrlProviderID - int
			          @PortalId , -- PortalID - int
			          @SettingName , -- SettingName - nvarchar(100)
			          @SettingValue  -- SettingValue - nvarchar(2000)
			        )
		END
	ELSE
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}ExtensionUrlProviderSetting	
				SET 
					SettingValue = @SettingValue
				WHERE ExtensionUrlProviderID = @ExtensionUrlProviderID
					AND PortalID = @PortalId
					AND SettingName = @SettingName
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTranslatedTabs]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTranslatedTabs]
    @PortalID INT ,
    @CultureCode NVARCHAR(10)
AS 
    BEGIN

        SET NOCOUNT ON;
		
        BEGIN TRY

            BEGIN TRANSACTION DeleteTranslatedTabs
		
			-- first store ContentItem records to be deleted
            DECLARE @TempDeleteCI TABLE ( ContentItemId INT )
        
            INSERT  INTO @TempDeleteCI
                    SELECT  ContentItemId
                    FROM    {databaseOwner}{objectQualifier}Tabs
                    WHERE   ( PortalID = @PortalID )
                            AND ( CultureCode = @CultureCode )

		-- delete all tabs in the portal that have been localized to the requested cultureCode
		-- This will also delete related tabmodule records
            DELETE  FROM {databaseOwner}{objectQualifier}Tabs
            WHERE   ( PortalID = @PortalID )
                    AND ( CultureCode = @CultureCode )

		
		-- append ContentItems to be deleted from stale modules
            INSERT  INTO @TempDeleteCI
                    SELECT  ContentItemID
                    FROM    {databaseOwner}{objectQualifier}ContentItems CI
                    WHERE   EXISTS ( SELECT *
                                     FROM   {databaseOwner}{objectQualifier}Modules M
                                     WHERE  ( CI.ModuleID = M.ModuleID )
                                            AND NOT EXISTS ( SELECT
                                                              *
                                                             FROM
                                                              {databaseOwner}{objectQualifier}TabModules TM
                                                             WHERE
                                                              M.ModuleID = TM.ModuleID ) )

		-- delete stale modules (these are modules that do not have a corresponding TabModules record,
		-- in other words: modules that are not placed on any page anymore)
            DELETE  FROM {databaseOwner}{objectQualifier}Modules
            WHERE   NOT EXISTS ( SELECT *
                                 FROM   {databaseOwner}{objectQualifier}TabModules
                                 WHERE  {databaseOwner}{objectQualifier}Modules.ModuleID = {databaseOwner}{objectQualifier}TabModules.ModuleID )

		-- finally delete all corresponding content items
            DELETE  FROM {databaseOwner}{objectQualifier}ContentItems
            WHERE   ContentItemID IN ( SELECT   ContentItemID
                                       FROM     @TempDeleteCI )
			AND ContentItemID NOT IN (SELECT ContentItemID FROM {databaseOwner}{objectQualifier}Modules)

            COMMIT TRANSACTION DeleteTranslatedTabs

        END TRY
  
        BEGIN CATCH
            IF @@TRANCOUNT > 0 
                ROLLBACK TRANSACTION DeleteTranslatedTabs


            DECLARE @ErrorMessage NVARCHAR(4000);
            DECLARE @ErrorSeverity INT;

            SELECT  @ErrorMessage = ERROR_MESSAGE() ,
                    @ErrorSeverity = ERROR_SEVERITY();

            RAISERROR (@ErrorMessage, @ErrorSeverity, 1 );			
			
        END CATCH	      

    END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRoleGroupByName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRoleGroupByName]
	@PortalID		int,
	@RoleGroupName	nvarchar(50)
AS
	SELECT *
		FROM {databaseOwner}{objectQualifier}RoleGroups
		WHERE  PortalId = @PortalID 
			AND RoleGroupName = @RoleGroupName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabTranslationStatus]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabTranslationStatus]
	@TabId					int,
    @LocalizedVersionGuid	uniqueidentifier,
	@LastModifiedByUserID	int
AS
	UPDATE {databaseOwner}{objectQualifier}Tabs
		SET
		LocalizedVersionGuid	= @LocalizedVersionGuid,
		LastModifiedByUserID	= @LastModifiedByUserID,
		LastModifiedOnDate		= getdate()
	WHERE  TabId = @TabId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalSpaceUsed]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalSpaceUsed]
	@PortalId INT     -- Null|-1: Host files
AS
	BEGIN
		SELECT SUM(CAST(Size as bigint)) AS SpaceUsed
		FROM {databaseOwner}{objectQualifier}Files
		WHERE (IsNull(PortalID, -1) = IsNull(@PortalId, -1))
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteDesktopModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteDesktopModulePermission]
	@DesktopModulePermissionID int
AS
    DELETE FROM {databaseOwner}{objectQualifier}DesktopModulePermission
    WHERE DesktopModulePermissionID = @DesktopModulePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateLegacyFolders]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateLegacyFolders]
AS
	UPDATE TOP (500) {databaseOwner}{objectQualifier}Folders
		SET ParentID = (COALESCE(	
				(SELECT TOP 1
					F2.FolderID 
					FROM {databaseOwner}{objectQualifier}Folders AS F2
					WHERE SUBSTRING (F1.FolderPath, 1, LEN(F1.FolderPath) - 
						(CASE 
							WHEN CHARINDEX ('/', REVERSE(SUBSTRING(F1.FolderPath, 0, LEN(F1.FolderPath)))) != 0 
							THEN CHARINDEX ('/', REVERSE(SUBSTRING(F1.FolderPath, 0, LEN(F1.FolderPath)))) 
							ELSE LEN(F1.FolderPath) END
						 )) = F2.FolderPath
						AND (F2.PortalID = F1.PortalID OR (F1.PortalID IS NULL AND F2.PortalID IS NULL))
						AND LEN(F1.FolderPath) > LEN(F2.FolderPath)
					ORDER BY LEN(F2.FolderPath) DESC
					), -1))
	FROM {databaseOwner}{objectQualifier}Folders AS F1
	WHERE F1.ParentID IS NULL AND FolderPath <> ''
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TabAliasSkins]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}TabAliasSkins]
(
[TabAliasSkinId] [int] NOT NULL IDENTITY(1, 1),
[TabId] [int] NOT NULL,
[PortalAliasId] [int] NOT NULL,
[SkinSrc] [nvarchar] (200) NOT NULL,
[CreatedByUserId] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserId] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}TabAliasSkin] on {databaseOwner}[{objectQualifier}TabAliasSkins]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabAliasSkins] ADD CONSTRAINT [PK_{objectQualifier}TabAliasSkin] PRIMARY KEY CLUSTERED  ([TabAliasSkinId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabAliasSkins]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabAliasSkins] 
(
	 @PortalID		int 
)
AS
	SELECT 
		t.TabId, 
		pa.PortalAliasId, 
		pa.HttpAlias, 
		t.SkinSrc, 
		t.CreatedByUserId, 
		t.CreatedOnDate, 
		t.LastModifiedByUserId, 
		t.LastModifiedOnDate
	FROM {databaseOwner}{objectQualifier}TabAliasSkins t
		INNER JOIN {databaseOwner}{objectQualifier}PortalAlias pa ON t.PortalAliasId = pa.PortalAliasId
	WHERE pa.PortalID = @PortalID OR @PortalID = -1
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipientsByMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipientsByMessage]
    @MessageID INT
AS
	SELECT [RecipientID], [MessageID], [UserID], [Read], [Archived], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM   {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
	WHERE  [MessageID] = @MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CreateMessageRecipientsForRole]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CreateMessageRecipientsForRole]
    @MessageID int,         -- message id
    @RoleIDs nvarchar(max), -- comma separated list of RoleIds
	@CreateUpdateUserID INT -- create / update user id
AS
BEGIN    

    INSERT {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients](
			[MessageID],
			[UserID],
			[Read],
			[Archived],
            [CreatedByUserID],
            [CreatedOnDate],
            [LastModifiedByUserID],
            [LastModifiedOnDate]
            )
			SELECT distinct 
			  @MessageID,
			  UserID,
			  0,
			  0,
              @CreateUpdateUserID , -- CreatedBy - int
              GETDATE(), -- CreatedOn - datetime
              @CreateUpdateUserID , -- LastModifiedBy - int
              GETDATE() -- LastModifiedOn - datetime
           FROM {databaseOwner}[{objectQualifier}vw_UserRoles] ur
			INNER JOIN {databaseOwner}[{objectQualifier}SplitStrings_CTE](@RoleIDs,',') m on ur.RoleID = m.Item
			WHERE ur.ExpiryDate >= getdate() OR ur.ExpiryDate IS NULL
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModuleDefinitions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModuleDefinitions]
AS
    SELECT *
    FROM   {databaseOwner}{objectQualifier}ModuleDefinitions
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AdministratorRoleId]'
GO
-- new function to return RoleID for Administrators of the Portal passed in as parameter
CREATE FUNCTION {databaseOwner}[{objectQualifier}AdministratorRoleId](
    @PortalId	 		 Int -- Needs to be >= 0, otherwise false is returned
) 
	RETURNS 			 int
AS
	BEGIN
		DECLARE @adminRoleId int = 0
		SELECT  @adminRoleId = AdministratorRoleId FROM {databaseOwner}[{objectQualifier}Portals] WHERE PortalID = @PortalId
		RETURN  @adminRoleId
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabCustomAliases]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabCustomAliases] 
(
	 @PortalID		int 
)
AS
	SELECT 
		t.TabId, 
		Coalesce(trp.CultureCode, '') as CultureCode, 
		pa.HttpAlias
	FROM {databaseOwner}{objectQualifier}Tabs t
		INNER JOIN {databaseOwner}{objectQualifier}TabUrls trp ON trp.TabId = t.ParentId	
		INNER JOIN {databaseOwner}{objectQualifier}PortalAlias pa ON trp.PortalAliasId = pa.PortalAliasId
		WHERE trp.PortalAliasUsage = 1 /* child tabs inherit */
		  AND (@portalId = t.PortalId OR @portalId = -1)
		  AND NOT EXISTS (SELECT tr2.TabId 
							FROM {databaseOwner}{objectQualifier}TabUrls tr2 
							WHERE tr2.TabId = t.TabId 
								AND tr2.CultureCode = trp.CultureCode
							)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModulePackagesInUse]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModulePackagesInUse]
	@PortalID INT,
	@ForHost BIT
AS
	-- Create a temp table to store the select results
	CREATE TABLE #TabsLatestPublished
	(
		IndexId int IDENTITY (0, 1) NOT NULL,
		TabId int,
		ModuleId int
	);

	WITH Temp AS ( 
        SELECT ROW_NUMBER() OVER (PARTITION BY TabId ORDER BY Version DESC) AS RowNumber, TabVersionId, TabId
        FROM {databaseOwner}{objectQualifier}TabVersions
		WHERE IsPublished = 1		
    )
	-- Insert into our temp table
	INSERT INTO #TabsLatestPublished (TabId, ModuleId)
	SELECT TLP.TabId, TVD.ModuleId 	
	FROM Temp TLP
	INNER JOIN {databaseOwner}{objectQualifier}TabVersionDetails TVD ON TLP.TabVersionId = TVD.TabVersionId 
	WHERE RowNumber = 1 AND TVD.Action <> 2

	IF (@ForHost = 1)
		-- Get in use for all host pages and portal pages
		SELECT AllPackages.* FROM {databaseOwner}{objectQualifier}Packages AS AllPackages
			INNER JOIN (
				SELECT DISTINCT P.PackageID
				FROM {databaseOwner}{objectQualifier}Packages P
					INNER JOIN {databaseOwner}{objectQualifier}DesktopModules DM 
						ON P.PackageID=DM.PackageID
					INNER JOIN {databaseOwner}{objectQualifier}vw_Modules M
						ON M.DesktopModuleID=DM.DesktopModuleID
					INNER JOIN {databaseOwner}{objectQualifier}tabs T 
						ON T.TabID=M.TabID
					LEFT JOIN #TabsLatestPublished TLP 
						ON TLP.TabId = M.TabId AND TLP.ModuleId = M.ModuleID
				WHERE T.IsDeleted=0
					AND (M.IsDeleted=0 OR (TLP.TabId IS NOT NULL AND TLP.ModuleId IS NOT NULL))) AS InUsePackages	
			ON AllPackages.PackageID = InUsePackages.PackageID
		ORDER BY AllPackages.FriendlyName
	ELSE
		-- Get in use for portal or host only
		SELECT AllPackages.* FROM {databaseOwner}{objectQualifier}Packages AS AllPackages
			INNER JOIN (
				SELECT DISTINCT P.PackageID
				FROM {databaseOwner}{objectQualifier}Packages P
					INNER JOIN {databaseOwner}{objectQualifier}DesktopModules DM 
						ON P.PackageID=DM.PackageID
					INNER JOIN {databaseOwner}{objectQualifier}vw_Modules M
						ON M.DesktopModuleID=DM.DesktopModuleID
					INNER JOIN {databaseOwner}{objectQualifier}tabs T 
						ON T.TabID=M.TabID
					LEFT JOIN #TabsLatestPublished TLP 
						ON TLP.TabId = M.TabId AND TLP.ModuleId = M.ModuleID
				WHERE ((@PortalID IS NULL AND T.PortalID IS NULL) OR T.PortalID = @PortalID)
					AND T.IsDeleted=0
					AND (M.IsDeleted=0 OR (TLP.TabId IS NOT NULL AND TLP.ModuleId IS NOT NULL))) AS InUsePackages	
			ON AllPackages.PackageID = InUsePackages.PackageID
		ORDER BY AllPackages.FriendlyName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PublishTab]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}PublishTab]
	@TabID INT
AS
BEGIN 
        UPDATE {databaseOwner}[{objectQualifier}Tabs] SET            
            [HasBeenPublished] = 1
        WHERE TabID = @TabID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}FitsExtendedPropertyPermission]'
GO
-- new function to determine, whether a user may view content of another users property,
-- if extended permissions (per social group or relationship) are specified
CREATE FUNCTION {databaseOwner}[{objectQualifier}FitsExtendedPropertyPermission](
    @viewingUserId 		 Int,
    @viewedUserID 		 Int,
    @extendedPermissions nVarChar(2000)
) 
	RETURNS 			 Bit
AS
	BEGIN
		DECLARE @rolesStr    nVarChar(2000) = ''
		DECLARE @reltnStr    nVarChar(2000) = ''
		DECLARE @gStartPos   Int
		DECLARE @rStartPos   Int
		DECLARE @recCount    Int = 0
		DECLARE @SQL         Int
		If (@viewedUserID > 0 and Len(IsNull(@extendedPermissions,'')) > 2) BEGIN
			SET @gStartPos = CHARINDEX('G:',@extendedPermissions) + 2
			SET @rStartPos = CHARINDEX('R:',@extendedPermissions) + 2
			if @gStartPos > @rStartPos BEGIN
				SET @rolesStr = SUBSTRING(@extendedPermissions, @gStartPos, Len(@extendedPermissions) - @gStartPos)
				if @rStartPos > 0 SET @reltnStr = SUBSTRING(@extendedPermissions, @rStartPos, @gStartPos - @rStartPos - 1)
			END
			If @gStartPos < @rStartPos BEGIN
				SET @reltnStr = SUBSTRING(@extendedPermissions, @rStartPos, Len(@extendedPermissions) - @rStartPos)
				if @gStartPos > 0 SET @rolesStr = SUBSTRING(@extendedPermissions, @gStartPos, @rStartPos - @gStartPos - 1)
			END
			If @rolesStr <> '' BEGIN
				SET @rolesStr = ',' + SUBSTRING(@rolesStr,1, Len(@rolesStr) - CASE WHEN RIGHT(@RolesStr,1) = ';' THEN 1 ELSE 0 END)
				SELECT @recCount = COUNT(1) FROM {databaseOwner}[{objectQualifier}UserRoles] WHERE UserID = @viewingUserId AND @rolesStr LIKE '%,' + Convert(nVarChar(10),RoleId) + ',%'
			END
			If @recCount = 0 AND @reltnStr <> '' BEGIN
				SET @reltnStr = ',' + SUBSTRING(@reltnStr,1, Len(@reltnStr) - CASE WHEN RIGHT(@reltnStr,1) = ';' THEN 1 ELSE 0 END)
				SELECT @recCount = COUNT(1) FROM {databaseOwner}[{objectQualifier}vw_RelatedUsers] WHERE UserID = @viewingUserId AND relatedUserID = @viewedUserId AND @reltnStr LIKE '%,' + Convert(nVarChar(10),RelationShipID) + ',%' AND Status = 2
			END
		END
		RETURN CASE WHEN IsNull(@RecCount, 0) > 0 THEN 1 ELSE 0 END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetElement]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetElement]
(
	@ord AS INT,
	@str AS VARCHAR(8000),
	@delim AS VARCHAR(1) 
)
RETURNS INT

AS

BEGIN
	-- If input is invalid, return null.
	IF  @str IS NULL
		OR LEN(@str) = 0
		OR @ord IS NULL
		OR @ord < 1
		-- @ord > [is the] expression that calculates the number of elements.
		OR @ord > LEN(@str) - LEN(REPLACE(@str, @delim, '')) + 1
		RETURN NULL
 
	DECLARE @pos AS INT, @curord AS INT
	SELECT @pos = 1, @curord = 1
	-- Find next element's start position and increment index.
	WHILE @curord < @ord
		SELECT
			@pos = CHARINDEX(@delim, @str, @pos) + 1,
			@curord = @curord + 1
	RETURN    CAST(SUBSTRING(@str, @pos, CHARINDEX(@delim, @str + @delim, @pos) - @pos) AS INT)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetProfileElement]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetProfileElement]
(
	@fieldName AS NVARCHAR(100),
	@fields AS NVARCHAR(4000),
	@values AS NVARCHAR(4000)
)

RETURNS NVARCHAR(4000)

AS

BEGIN

	-- If input is invalid, return null.
	IF  @fieldName IS NULL
		OR LEN(@fieldName) = 0
		OR @fields IS NULL
		OR LEN(@fields) = 0
		OR @values IS NULL
		OR LEN(@values) = 0
		RETURN NULL

	-- locate FieldName in Fields
	DECLARE @fieldNameToken AS NVARCHAR(20)
	DECLARE @fieldNameStart AS INTEGER, @valueStart AS INTEGER, @valueLength AS INTEGER

	-- Only handle string type fields (:S:)
	SET @fieldNameStart = CHARINDEX(@fieldName + ':S',@Fields,0)

	-- If field is not found, return null
	IF @fieldNameStart = 0 RETURN NULL
	SET @fieldNameStart = @fieldNameStart + LEN(@fieldName) + 3

	-- Get the field token which I've defined as the start of the field offset to the end of the length
	SET @fieldNameToken =
	SUBSTRING(@Fields,@fieldNameStart,LEN(@Fields)-@fieldNameStart)

	-- Get the values for the offset and length
	SET @valueStart = {databaseOwner}{objectQualifier}getelement(1,@fieldNameToken,':')
	SET @valueLength = {databaseOwner}{objectQualifier}getelement(2,@fieldNameToken,':')

	-- Check for sane values, 0 length means the profile item was stored, just no data
	IF @valueLength = 0 RETURN ''

	-- Return the string
	RETURN SUBSTRING(@values, @valueStart+1, @valueLength)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabUrl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabUrl] 
	@TabID				int,
	@SeqNum				int
AS
	DELETE FROM {databaseOwner}{objectQualifier}TabUrls
	WHERE TabId = @TabID AND SeqNum = @SeqNum
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabsByPackageID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabsByPackageID]
    @PortalId  Int, -- Null for Host menu items
    @PackageId Int, -- Not Null!
    @ForHost   Bit  -- 0: Get pages for a specific portal (or host pages only)
                    -- 1: Get all host pages and portal pages
AS
BEGIN
	-- Create a temp table to store the select results
	CREATE TABLE #TabsLatestPublished
	(
		IndexId int IDENTITY (0, 1) NOT NULL,
		TabId int,
		ModuleId int
	);

	WITH Temp AS ( 
        SELECT ROW_NUMBER() OVER (PARTITION BY TabId ORDER BY Version DESC) AS RowNumber, TabVersionId, TabId
        FROM {databaseOwner}{objectQualifier}TabVersions
		WHERE IsPublished = 1		
    )
	-- Insert into our temp table
	INSERT INTO #TabsLatestPublished (TabId, ModuleId)
	SELECT TLP.TabId, TVD.ModuleId 	
	FROM Temp TLP
	INNER JOIN {databaseOwner}{objectQualifier}TabVersionDetails TVD ON TLP.TabVersionId = TVD.TabVersionId 
	WHERE RowNumber = 1 AND TVD.Action <> 2
	
    SELECT * FROM {databaseOwner}[{objectQualifier}vw_Tabs]
    WHERE (IsNull(PortalId, -1) = IsNull(@PortalId, -1) Or @ForHost = 1)
		AND IsDeleted = 0
		AND TabId IN (SELECT M.TabId FROM {databaseOwner}[{objectQualifier}vw_Modules] M
                      INNER JOIN {databaseOwner}[{objectQualifier}DesktopModules] DM ON M.DesktopModuleID = DM.DesktopModuleID
					  LEFT JOIN #TabsLatestPublished TLP ON TLP.TabId = M.TabId AND TLP.ModuleId = M.ModuleID
                      WHERE DM.PackageID = @PackageId AND (M.IsDeleted = 0 OR (TLP.TabId IS NOT NULL AND TLP.ModuleId IS NOT NULL)))
    ORDER BY PortalID, TabName
	OPTION (OPTIMIZE FOR (@PortalId UNKNOWN, @PackageId UNKNOWN, @ForHost UNKNOWN));
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPropertyDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPropertyDefinition]
	@PortalId int,
	@ModuleDefId int,
	@DataType int,
	@DefaultValue nvarchar(max),
	@PropertyCategory nvarchar(50),
	@PropertyName nvarchar(50),
	@ReadOnly bit,
	@Required bit,
	@ValidationExpression nvarchar(2000),
	@ViewOrder int,
	@Visible bit,
    @Length int,
    @DefaultVisibility int,
	@CreatedByUserID int

AS
	DECLARE @PropertyDefinitionId int

	SELECT @PropertyDefinitionId = PropertyDefinitionId
		FROM   {databaseOwner}{objectQualifier}ProfilePropertyDefinition
		WHERE  (PortalId = @PortalId OR (PortalId IS NULL AND @PortalId IS NULL))
			AND PropertyName = @PropertyName
			
	IF @vieworder=-1
		BEGIN
			SELECT	@vieworder = MAX(ViewOrder) + 1 
			FROM	{databaseOwner}{objectQualifier}ProfilePropertyDefinition
		END

	IF @PropertyDefinitionId IS NULL
		BEGIN
			INSERT {databaseOwner}{objectQualifier}ProfilePropertyDefinition	(
					PortalId,
					ModuleDefId,
					Deleted,
					DataType,
					DefaultValue,
					PropertyCategory,
					PropertyName,
					ReadOnly,
					Required,
					ValidationExpression,
					ViewOrder,
					Visible,
					Length,
                    DefaultVisibility,
					[CreatedByUserID],
					[CreatedOnDate],
					[LastModifiedByUserID],
					[LastModifiedOnDate]

				)
				VALUES	(
					@PortalId,
					@ModuleDefId,
					0,
					@DataType,
					@DefaultValue,
					@PropertyCategory,
					@PropertyName,
					@ReadOnly,
					@Required,
					@ValidationExpression,
					@ViewOrder,
					@Visible,
					@Length,
                    @DefaultVisibility,
					@CreatedByUserID,
  					getdate(),
  					@CreatedByUserID,
  					getdate()
				)

			SELECT @PropertyDefinitionId = SCOPE_IDENTITY()
		END
	ELSE
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}ProfilePropertyDefinition 
				SET DataType = @DataType,
					ModuleDefId = @ModuleDefId,
					DefaultValue = @DefaultValue,
					PropertyCategory = @PropertyCategory,
					ReadOnly = @ReadOnly,
					Required = @Required,
					ValidationExpression = @ValidationExpression,
					ViewOrder = @ViewOrder,
					Deleted = 0,
					Visible = @Visible,
					Length = @Length,
                    DefaultVisibility = @DefaultVisibility,
					[LastModifiedByUserID] = @CreatedByUserID,	
					[LastModifiedOnDate] = getdate()
				WHERE PropertyDefinitionId = @PropertyDefinitionId
		END
		
	SELECT @PropertyDefinitionId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteModulePermissionsByUserID]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}DeleteModulePermissionsByUserID]
	@PortalID int,
	@UserID int
AS
	DELETE FROM {databaseOwner}{objectQualifier}ModulePermission
		FROM {databaseOwner}{objectQualifier}ModulePermission MP
			INNER JOIN {databaseOwner}{objectQualifier}Modules AS M ON MP.ModuleID = M.ModuleID
		WHERE M.PortalID = @PortalID
		AND MP.UserID = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CreateMessageReply]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CreateMessageReply]
    @ConversationID    INT,           -- parent message id
	@PortalID			INT,			--portalID of message
    @Body               nvarchar(max), -- message body
    @SenderUserID       INT,           -- create / update user id
    @From               nvarchar(200), -- message from
	@CreateUpdateUserID INT            -- create / update user id
AS
    DECLARE @ReplyAllAllowed BIT
    DECLARE @NewMessageID INT
    DECLARE @OriginalSenderUserID INT
    DECLARE @OriginalTo nvarchar(2000)
    DECLARE @OriginalSubject nvarchar(400)

	--Was Sender a Recipient in the Original Message.
	SELECT @ReplyAllAllowed = [ReplyAllAllowed],
	       @OriginalSenderUserID = [SenderUserID],
		   @OriginalTo = REPLACE(REPLACE([TO] + ',' + [FROM], ',' + @From, ''), @From + ',', ''),
		   @OriginalSubject = [Subject]
	FROM {databaseOwner}{objectQualifier}CoreMessaging_Messages m
	INNER JOIN {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients mr ON m.MessageID = mr.MessageID
	AND m.MessageID = @ConversationID
	AND mr.UserID = @SenderUserID

	--Reply can only be create if Sender was Recipient of Orginial message
	IF @ReplyAllAllowed IS NULL
	BEGIN
		SELECT -1
		RETURN
	END

	--Create new message
	INSERT {databaseOwner}{objectQualifier}CoreMessaging_Messages(
					[PortalID],
  					[To],
					[From],
					[Subject],
					[Body],
					[ConversationID],
					[ReplyAllAllowed],
					[SenderUserID],
                    [CreatedByUserID],
                    [CreatedOnDate],
                    [LastModifiedByUserID],
                    [LastModifiedOnDate]
                    )
            VALUES  (
					@PortalID,
     			    @OriginalTo,
					@From,
				    @OriginalSubject,
					@Body,
					@ConversationID,
					@ReplyAllAllowed,
					@SenderUserID,
                    @CreateUpdateUserID , -- CreatedBy - int
                    GETUTCDATE() , -- CreatedOn - datetime
                    @CreateUpdateUserID , -- LastModifiedBy - int
                    GETDATE() -- LastModifiedOn - datetime
                    )

	SELECT @NewMessageID = SCOPE_IDENTITY()

	IF (@ReplyAllAllowed = 0) --original message was sent to a Role, reply will be sent to the original sender only
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
		        ( [MessageID],
		          [UserID],
		          [Read],
		          [Archived],
		          CreatedByUserID,
		          CreatedOnDate,
		          LastModifiedByUserID,
		          LastModifiedOnDate
		        )
		VALUES  ( @NewMessageID, -- MessageID - int
		          @OriginalSenderUserID, -- UserID - int
		          0, -- Read - bit
		          0, -- Archived - bit
		          @CreateUpdateUserID , -- CreatedByUserID - int
		          GETDATE() , -- CreatedOnDate - datetime
		          @CreateUpdateUserID , -- LastModifiedByUserID - int
		          GETDATE()  -- LastModifiedOnDate - datetime
		        )
        
        IF @OriginalSenderUserID <> @SenderUserID
        BEGIN
            INSERT INTO {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
		            ( [MessageID],
		              [UserID],
		              [Read],
		              [Archived],
		              CreatedByUserID,
		              CreatedOnDate,
		              LastModifiedByUserID,
		              LastModifiedOnDate
		            )
		    VALUES  ( @NewMessageID, -- MessageID - int
		              @SenderUserID, -- UserID - int
		              1, -- Read - bit
		              0, -- Archived - bit
		              @CreateUpdateUserID , -- CreatedByUserID - int
		              GETDATE() , -- CreatedOnDate - datetime
		              @CreateUpdateUserID , -- LastModifiedByUserID - int
		              GETDATE()  -- LastModifiedOnDate - datetime
		            )
        END
	END
	ELSE --Reply should be sent to all the original Recipients
	BEGIN
		INSERT {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients(
			[MessageID],
			[UserID],
			[Read],
			[Archived],
            [CreatedByUserID],
            [CreatedOnDate],
            [LastModifiedByUserID],
            [LastModifiedOnDate]
            )
			SELECT
			  @NewMessageID,
			  UserID,
			  0,
			  0,
              @CreateUpdateUserID , -- CreatedBy - int
              GETDATE() , -- CreatedOn - datetime
              @CreateUpdateUserID , -- LastModifiedBy - int
              GETDATE() -- LastModifiedOn - datetime
           FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
           WHERE MessageID = @ConversationID
	END

	SELECT  @NewMessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabUrls]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabUrls] 
(
	 @PortalId		int 
)
AS
	SELECT 
		tu.TabId,	
		tu.SeqNum,	
		tu.Url,	
		tu.QueryString,
		tu.HttpStatus,	
		tu.CultureCode,
		tu.IsSystem,
		case when parentTu.PortalAliasUsage = 1 /* parent is set to 'child pages inherit' so get parent portal alias id */
			then 
				case when Coalesce(tu.PortalAliasId, 0) < 1 /* if this page has no specific alias id, then use parent*/
					then parentTu.PortalAliasId 
					else tu.PortalAliasId 
				END /* otherwise, use this page alias id */
			else tu.PortalALiasId 
		END as PortalAliasId,

		case when Coalesce(tu.PortalAliasUsage,0) = 0 and coalesce(tu.PortalALiasId,0) < 1 /* default value and no specific alias */
			then /* check for inheritance from parent */
				case when Coalesce(parentTu.PortalALiasUsage,0) = 1 and Coalesce(parentTu.PortalAliasId, 0) > 0 /* parent specifies an alias */
					then 3 /* inherited from parent */
					else 0 
				END /* default value */
			when Coalesce(tu.PortalAliasId,0) > 0 /*specific alias for this tab */
			then 
				case when coalesce(tu.PortalALiasUsage,0) < 1 
					then 1 /* if not set, default to 'child pages inherit'*/
					else tu.PortalAliasUsage 
				END
			else 
				0 /* default - fall through value */
		END as PortalAliasUsage 
	FROM {databaseOwner}{objectQualifier}TabUrls tu
		INNER JOIN {databaseOwner}{objectQualifier}Tabs t on t.TabId = tu.TabId
		LEFT JOIN {databaseOwner}{objectQualifier}TabUrls parentTu on t.ParentId = parentTu.TabId
			AND parentTu.CultureCode = tu.CultureCode
			and parentTu.PortalAliasUsage > 0	   
	WHERE (@portalId = PortalId OR @portalId = -1)
	ORDER BY PortalId, TabOrder, tu.SeqNum
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddUserRole]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddUserRole]
	@PortalID		int,
	@UserID			int,
	@RoleId			int,
	@Status			int,
	@IsOwner		bit,
	@EffectiveDate	datetime = null,
	@ExpiryDate		datetime = null,
	@CreatedByUserID  int
AS

DECLARE @UserRoleId int

SELECT @UserRoleId = null

SELECT @UserRoleId = UserRoleId
	FROM {databaseOwner}{objectQualifier}UserRoles
	WHERE  UserId = @UserID AND RoleId = @RoleId
 
IF @UserRoleId IS NOT NULL
	BEGIN
		UPDATE {databaseOwner}{objectQualifier}UserRoles
			SET 
				Status = @Status,
				IsOwner = @IsOwner,
				ExpiryDate = @ExpiryDate,
				EffectiveDate = @EffectiveDate,
				IsTrialUsed = 1,
				LastModifiedByUserID = @CreatedByUserID,
				LastModifiedOnDate = getdate()
			WHERE  UserRoleId = @UserRoleId
		SELECT @UserRoleId
	END
ELSE
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}UserRoles (
			UserId,
			RoleId,
			Status,
			IsOwner,
			EffectiveDate,
			ExpiryDate,
			IsTrialUsed,
			CreatedByUserID,
			CreatedOnDate,
			LastModifiedByUserID,
			LastModifiedOnDate
		  )
		VALUES (
			@UserID,
			@RoleId,
			@Status,
			@IsOwner,
			@EffectiveDate,
			@ExpiryDate,
			1,
			@CreatedByUserID,
			getdate(),
			@CreatedByUserID,
			getdate()
		  )

	SELECT SCOPE_IDENTITY()
    END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRoles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRoles]
AS
BEGIN
     SELECT R.*,
          (SELECT COUNT(*) FROM {databaseOwner}[{objectQualifier}UserRoles] U 
				WHERE U.RoleID = R.RoleID 
					AND U.Status = 1 
					AND (U.EffectiveDate < GETDATE() OR U.EffectiveDate IS NULL)
                    AND (U.ExpiryDate > GETDATE() OR U.ExpiryDate IS NULL)) AS UserCount
     FROM {databaseOwner}[{objectQualifier}Roles] AS R
     WHERE RoleID >= 0 -- ignore virtual roles. Note: might be removed, after controller has been adjusted
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSkin]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSkin]

	@SkinID   int,
	@SkinSrc  nvarchar(200)

AS
	UPDATE {databaseOwner}{objectQualifier}Skins
		SET
			SkinSrc = @SkinSrc
	WHERE SkinID = @SkinID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersByProfileProperty]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUsersByProfileProperty]
     @PortalID		int,
    @PropertyName   nvarchar(256),
    @PropertyValue  nvarchar(256),
    @PageIndex      int,
    @PageSize       INT,
    @IncludeDeleted bit,
    @SuperUsersOnly bit	
AS
	BEGIN
		-- Set the page bounds
		DECLARE @PageLowerBound INT
		DECLARE @PageUpperBound INT
		SET @PageLowerBound = @PageSize * @PageIndex
		SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

		-- Create a temp table TO store the select results
		CREATE TABLE #PageIndexForUsers
		(
			IndexId int IDENTITY (0, 1) NOT NULL,
			UserId int,
			DisplayName varchar(512)
		)

		-- Insert into our temp table
		INSERT INTO #PageIndexForUsers (UserId,DisplayName)
			SELECT DISTINCT U.UserId, U.DisplayName 
			FROM   {databaseOwner}{objectQualifier}ProfilePropertyDefinition P
				INNER JOIN {databaseOwner}{objectQualifier}UserProfile UP ON P.PropertyDefinitionID = UP.PropertyDefinitionID 
				INNER JOIN {databaseOwner}{objectQualifier}vw_Users U ON UP.UserID = U.UserID
				INNER JOIN {databaseOwner}{objectQualifier}Lists dt ON dt.EntryID = P.DataType
				LEFT JOIN {databaseOwner}{objectQualifier}Lists L ON L.ListName = @PropertyName AND L.Value = UP.PropertyValue AND L.Text LIKE @PropertyValue
			WHERE (PropertyName = @PropertyName) AND (PropertyValue LIKE @PropertyValue OR PropertyText LIKE @PropertyValue OR (dt.Value = 'List' AND L.EntryID IS NOT NULL ))
				AND (IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
				     OR IsDeleted Is NULL)
				AND IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				AND (P.Portalid = @PortalID OR (@PortalID is null ))
			ORDER BY U.DisplayName

		SELECT  *
		FROM	{databaseOwner}{objectQualifier}vw_Users u, 
				#PageIndexForUsers p
		WHERE  u.UserId = p.UserId
				AND (IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
				     OR IsDeleted Is NULL)
				AND IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				AND ( PortalId = @PortalID OR (@PortalID is null ))
				AND p.IndexId >= @PageLowerBound AND p.IndexId <= @PageUpperBound
			ORDER BY U.DisplayName

		SELECT  TotalRecords = COUNT(*)
		FROM    #PageIndexForUsers
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDesktopModulePermissions]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDesktopModulePermissions]
AS
    SELECT *
    FROM {databaseOwner}{objectQualifier}vw_DesktopModulePermissions
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalRoles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalRoles]
    @PortalId     Int -- Null: Host Roles
AS
BEGIN
    SELECT R.*,
          (SELECT COUNT(*) FROM {databaseOwner}[{objectQualifier}UserRoles] U 
				WHERE U.RoleID = R.RoleID 
					AND U.Status = 1 
					AND (U.EffectiveDate < GETDATE() OR U.EffectiveDate IS NULL)
                    AND (U.ExpiryDate > GETDATE() OR U.ExpiryDate IS NULL)) AS UserCount
     FROM {databaseOwner}[{objectQualifier}Roles] R
    WHERE (R.PortalId = @PortalId OR R.PortalId is null)
      AND (R.RoleId >= 0) -- DNN-4288: hide system role atm to prevent duplicates. Might be removed, after API has been adopt
    ORDER BY R.RoleName
	OPTION (OPTIMIZE FOR (@PortalId UNKNOWN))
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSkin]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddSkin]
	@SkinPackageID		int,
    @SkinSrc			nvarchar(200)		
AS
	BEGIN
		IF NOT EXISTS (
			SELECT 1 FROM {databaseOwner}{objectQualifier}Skins S
				WHERE S.SkinPackageID = @SkinPackageID AND S.SkinSrc = @SkinSrc
			)
			BEGIN
				INSERT INTO {databaseOwner}{objectQualifier}Skins (SkinPackageID, SkinSrc)
				VALUES (@SkinPackageID, @SkinSrc)
			END
	END
	
	SELECT SkinID FROM {databaseOwner}{objectQualifier}Skins S
		WHERE S.SkinPackageID = @SkinPackageID AND S.SkinSrc = @SkinSrc
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_GetNextMessageForDispatch]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_GetNextMessageForDispatch] 
	@SchedulerInstance uniqueidentifier
AS
	Declare  @target_messageID int

	SELECT @target_messageID =  MessageID FROM {objectQualifier}Messaging_Messages WHERE EmailSent = 0  AND  
	(EmailSchedulerInstance is NULL or EmailSchedulerInstance= '00000000-0000-0000-0000-000000000000') 
	AND status not in  (0,3) ORDER BY Date DESC

Update {objectQualifier}Messaging_Messages set EmailSchedulerInstance = @SchedulerInstance  where MessageID = @target_messageID
select * from {objectQualifier}Messaging_Messages where MessageID = @target_messageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersByDisplayName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUsersByDisplayName]
    @PortalID		int,
    @NameToMatch	nvarchar(256),
    @PageIndex		int,
    @PageSize		INT,
    @IncludeDeleted     bit,
    @SuperUsersOnly     bit		
AS
	BEGIN
		-- Set the page bounds
		DECLARE @PageLowerBound INT
		DECLARE @PageUpperBound INT
		SET @PageLowerBound = @PageSize * @PageIndex
		SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

		-- Create a temp table TO store the select results
		CREATE TABLE #PageIndexForUsers
		(
			IndexId int IDENTITY (0, 1) NOT NULL,
			UserId int
		)

		-- Insert into our temp table
		INSERT INTO #PageIndexForUsers (UserId)
			SELECT UserId FROM	{databaseOwner}{objectQualifier}vw_Users 
			WHERE  DisplayName LIKE @NameToMatch
				AND (IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
				     OR IsDeleted Is NULL)
			        AND IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				AND ( PortalId = @PortalID OR (@PortalID is null ))
			ORDER BY DisplayName

		SELECT  *
		FROM	{databaseOwner}{objectQualifier}vw_Users u, 
				#PageIndexForUsers p
		WHERE  u.UserId = p.UserId
				AND (IsDeleted <= CASE @IncludeDeleted WHEN 0 THEN 0 ELSE 1 END
							--less than equal done to cover IsDeleted in (1,0) for IncludeDeleted...else just IsDeleted = 0
				     OR IsDeleted Is NULL)
			        AND IsSuperUser >= CASE @SuperUsersOnly WHEN 1 THEN 1 ELSE 0 END
				AND ( PortalId = @PortalID OR (@PortalID is null ))
				AND p.IndexId >= @PageLowerBound AND p.IndexId <= @PageUpperBound
		ORDER BY u.DisplayName

		SELECT  TotalRecords = COUNT(*)
		FROM    #PageIndexForUsers
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipientsByMessageAndUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageRecipientsByMessageAndUser]
    @MessageID INT,
    @UserID INT
AS
	SELECT [RecipientID], [MessageID], [UserID], [Read], [Archived], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM   {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
	WHERE  [MessageID] = @MessageID
	AND   [UserID] = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ConvertListToTable]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}ConvertListToTable]
(  
	@Delimiter	nvarchar(5), 
    @List		nvarchar(max)
) 
RETURNS @TableOfValues TABLE 
(  
	RowNumber	smallint IDENTITY(1,1), 
    RowValue	nvarchar(50) 
) 
AS 
   BEGIN
      DECLARE @LenString int 
 
      WHILE len( @List ) > 0 
         BEGIN 
         
            SELECT @LenString = 
               (CASE charindex( @Delimiter, @List ) 
                   WHEN 0 THEN len( @List ) 
                   ELSE ( charindex( @Delimiter, @List ) -1 )
                END
               ) 
                                
            INSERT INTO @TableOfValues 
               SELECT substring( @List, 1, @LenString )
                
            SELECT @List = 
               (CASE ( len( @List ) - @LenString ) 
                   WHEN 0 THEN '' 
                   ELSE right( @List, len( @List ) - @LenString - 1 ) 
                END
               ) 
         END
      RETURN 
   END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUsersAdvancedSearch]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUsersAdvancedSearch] 
(
    @PortalID int,                          -- portal                
    @UserId int,                            -- for determining correct visibility permissions
    @FilterUserId int,                      -- for filtering relationships on    
    @FilterRoleId int,                      -- for filtering by roles
    @RelationshipTypeId int,                -- for filtering by relationships
    @IsAdmin bit,                           -- determines visibility
    @PageSize int,                          -- page size
    @PageIndex int,                         -- 0 based page index
    @SortBy nvarchar(100),                  -- sort field
    @SortAscending bit,                     -- sort flag indicating whether sort is asc or desc
    @PropertyNames nvarchar(max),           -- list of property names to filter
    @PropertyValues nvarchar(max)           -- list of property values to filter
)
AS
    -- Setup Top XX
    DECLARE @topSql nvarchar(20) SET @topSql = ''
    IF @PageSize > -1 BEGIN SET @topSql = ' TOP ' + CONVERT(nvarchar(20), @PageSize) END
                
    -- Setup Specific Page
    DECLARE @minRowNumberSql nvarchar(20) SET @minRowNumberSql =  CONVERT(nvarchar(20), ((@PageIndex * @PageSize) + 1))
    -- Setup Pivot Field List
    DECLARE @pivotSql nvarchar(max) SELECT @pivotSql = {databaseOwner}{objectQualifier}GetProfileFieldSql(@PortalID, '')

    -- Get User specific columns
    DECLARE @UserColumns TABLE(ColumnName NVARCHAR(100))
    INSERT INTO @UserColumns SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = '{objectQualifier}vw_Users' AND TABLE_SCHEMA = REPLACE('{databaseOwner}', '.', '')

    -- Lists Filters names and values into tables
    DECLARE @PropertyNamesTable TABLE (RowNumber INT, RowValue nvarchar(MAX))
    DECLARE @PropertyValuesTable TABLE (RowNumber INT, RowValue nvarchar(MAX))
    INSERT INTO @PropertyNamesTable SELECT * FROM {databaseOwner}{objectQualifier}ConvertListToTable(',', @PropertyNames)                      
    INSERT INTO @PropertyValuesTable SELECT * FROM {databaseOwner}{objectQualifier}ConvertListToTable(',', @PropertyValues)
                
    -- Gets filters that are on the User rather than Profile Properties
    DECLARE @UserFiltersTable TABLE (RowNumber Int, RowValue NVARCHAR(MAX))
    INSERT INTO @UserFiltersTable SELECT * FROM {databaseOwner}{objectQualifier}ConvertListToTable(',',@PropertyNames) WHERE RowValue IN (SELECT * FROM @UserColumns)


    DECLARE @sql nvarchar(max) SET @sql = ''
    DECLARE @filterSql nvarchar(max)SET @filterSql = ''

    -- ///////////////////////////////////////////////////
    -- FILTERING by PROFILE PROPERTY or USER PROPERTY
    -- ///////////////////////////////////////////////////
    --IF @PropertyNames IS NOT NULL AND @PropertyNames <> ''
    IF ((SELECT COUNT(*) FROM @PropertyNamesTable) > 0) AND ((SELECT COUNT(*) FROM @PropertyValuesTable)> 0) 
	    BEGIN
            DECLARE @propertyFilter nvarchar(max)
            DECLARE @userFilter nvarchar(max)
            DECLARE @userFilterJoin nvarchar(max) SET @userFilterJoin = ''
            DECLARE @profilePropertyCount INT
            DECLARE @userFilterCount INT
            DECLARE @propertyAndUserFilter nvarchar(10) SET @propertyAndUserFilter = ''
            DECLARE @groupBy NVARCHAR(300)

            -- Filters on Profile Properties    
            ;WITH CTE_PropertyNames(RowNumber, RowValue) AS
            (              SELECT * FROM @PropertyNamesTable
                            WHERE RowValue NOT IN (SELECT ColumnName FROM @UserColumns)),
            CTE_PropertyValues(RowNumber, RowValue) AS
            (              SELECT * FROM @PropertyValuesTable
                            WHERE RowValue NOT IN (SELECT ColumnName FROM @UserColumns))

            SELECT @propertyFilter = COALESCE(@propertyFilter + ' OR ' , ' ') 
                                        + ' (PropertyName=''' + N.RowValue 
                                        + ''' AND ((PropertyValue LIKE ''' + V.RowValue +'%'') OR (PropertyValue LIKE ''% ' + V.RowValue +'%'')))'
            FROM CTE_PropertyNames AS N INNER JOIN CTE_PropertyValues AS V ON N.RowNumber = V.RowNumber
                                
            -- Filters on User Property                           
            SELECT @userFilter = COALESCE(@userFilter + ' AND ', ' ')  
										+ ' ((u.' + N.RowValue + ' LIKE ''' + V.RowValue +'%'') OR (u.' + N.RowValue + ' LIKE ''% ' + V.RowValue +'%'')) '
            FROM @UserFiltersTable AS N  INNER JOIN @PropertyValuesTable AS V ON N.RowNumber = V.RowNumber
                                
            SELECT @userFilterCount = COUNT(*) FROM @UserFiltersTable
            IF @userFilterCount > 0 BEGIN SET @userFilterJoin = ' INNER JOIN {objectQualifier}vw_Users u ON u.UserId = p.UserId ' END

            -- Determining the Group By Clause -- dependant on types of filters used
            SELECT @profilePropertyCount = COUNT(*) FROM {databaseOwner}{objectQualifier}ConvertListToTable(',', @PropertyNames)
            WHERE RowValue IN (SELECT PropertyName FROM {databaseOwner}{objectQualifier}ProfilePropertyDefinition WHERE PortalID = @PortalId)
            AND RowValue NOT IN (SELECT ColumnName FROM @UserColumns)

            IF @profilePropertyCount > 0
                BEGIN SET @groupBy = ' GROUP BY p.UserId HAVING COUNT(*) = ' + CONVERT(nvarchar(20),@profilePropertyCount ) END
            ELSE
                BEGIN SET @groupBy = ' GROUP BY p.UserId HAVING COUNT(*) > 0 '     END

            IF ( @profilePropertyCount > 0 AND @userFilterCount > 0)
            BEGIN SET @propertyAndUserFilter = ' AND ' END

            -- CREATE FINAL FILTER
            SET @filterSql = ' DECLARE @MatchingUsers TABLE (UserID INT, Occurrances INT) INSERT INTO @MatchingUsers SELECT p.UserID, COUNT(*) AS occurances ' 
                                        + ' FROM {databaseOwner}{objectQualifier}vw_profile p ' + @userFilterJoin
                                        + ' WHERE ' + COALESCE(' ( ' + @propertyFilter + ') ', ' ') + @propertyAndUserFilter + COALESCE(@userFilter, ' ') 
										+ ' AND ((Visibility = 0) OR (Visibility = 1 AND ' + CONVERT(nvarchar(20), @UserId) + ' > 0) OR (Visibility = 2 AND ' + CONVERT(nvarchar(20), @IsAdmin) + ' = 1))' 
                                        + @groupBy
		END

        -- ///////////////////////////////////////////////////      
        -- SETUP ROLE AND RELATIONSHIP FILTERS
        -- ///////////////////////////////////////////////////
        DECLARE @roleAndRelationshipFilter nvarchar(1000)
        DECLARE @roleFilter nvarchar(500) SET @roleFilter = ''
        DECLARE @relationshipFilter nvarchar(1000) SET @relationshipFilter = ''
        DECLARE @roleAndRelationshipFlag bit SET @roleAndRelationshipFlag  = 0
        DECLARE @RoleAndRelationshipSelect nvarchar(100) SET @RoleAndRelationshipSelect = ''
                                
        -- Filter by Role
        IF @FilterRoleId <> -1 
            BEGIN
                SET @roleAndRelationshipFlag = 1
                SET @roleFilter = ' JOIN {databaseOwner}{objectQualifier}UserRoles UR ON U.UserID = UR.UserID AND UR.Status = 1 '
					+ ' AND (UR.EffectiveDate < GETDATE() OR UR.EffectiveDate IS NULL) '
                    + ' AND (UR.ExpiryDate > GETDATE() OR UR.ExpiryDate IS NULL) AND UR.RoleID = ' + CONVERT(nvarchar(20), @FilterRoleId)
            END

        -- Filter by Relationship
        IF @RelationshipTypeId <> -1  
            BEGIN
                SET @roleAndRelationshipFlag = 1
                SET @relationshipFilter = ' JOIN {databaseOwner}{objectQualifier}Relationships REL ON REL.PortalID = ' + CONVERT(nvarchar(20), @PortalID)
                                            + ' AND RelationshipTypeID = ' + CONVERT(nvarchar(20), @RelationshipTypeId) 
                                            + ' JOIN {databaseOwner}{objectQualifier}UserRelationships UREL ON REL.RelationshipID = UREL.RelationshipID AND
                                            ((UREL.UserID = ' + CONVERT(nvarchar(20), @FilterUserId) + ' AND UREL.RelatedUserID = U.UserID) OR
                                            (UREL.UserID = U.UserID AND UREL.RelatedUserID = ' + CONVERT(nvarchar(20), @FilterUserId) + '))'
                                            + ' WHERE UREL.Status = 2'
            END 

        IF @roleAndRelationshipFlag = 1 BEGIN SET @RoleAndRelationshipSelect = ' AND s.UserId IN (SELECT userID FROM  RoleAndRelationUsers) ' END

        SET @roleAndRelationshipFilter =  ', RoleAndRelationUsers AS ( SELECT U.userId FROM {databaseOwner}{objectQualifier}vw_Users U ' + @roleFilter + @relationshipFilter + ' )' 

        -- ///////////////////////////////////////////////////  
        -- SET UP SORT
        -- ///////////////////////////////////////////////////
        DECLARE @sortSql nvarchar(1000) SET @sortSql = ''
        DECLARE @propertySort nvarchar(1000) SET @propertySort = ''
        DECLARE @filterJoin nvarchar(100) SET @filterJoin = ''
        DECLARE @filterSortSql nvarchar(1000) SET @filterSortSql = ''
        DECLARE @sortByUserProperty BIT         
        SELECT @sortByUserProperty = COUNT(*) FROM @UserColumns WHERE ColumnName = @SortBy

        IF ( @profilePropertyCount > 0 OR @userFilterCount > 0)
	        BEGIN SET @filterJoin = ' INNER JOIN @MatchingUsers m ON m.UserID = s.UserID ' END

        -- Determine the Type of Sort
        IF (@SortBy IS NOT NULL AND @SortBy <> '') AND @sortByUserProperty <> 1
	        BEGIN -- Sort By Profile Property
                SET @sortSql = {databaseOwner}{objectQualifier}GetSortSql(@SortBy,@SortAscending,'UserID')
                SET @propertySort = {databaseOwner}{objectQualifier}GetSortSql('PropertyValue',@SortAscending,'UserID')
                SET @filterSortSql = ' ;WITH SortedUsers AS ( SELECT ROW_NUMBER() OVER( ' + @propertySort + ' ) AS RowNumber, *  ' 
                                                + ' FROM {databaseOwner}{objectQualifier}vw_Profile WHERE PortalId = ' + CONVERT(nvarchar(20), @PortalID) + ' AND PropertyName = ''' + @SortBy + ''' )'
                                                + ' , MatchingSorted AS ( SELECT ROW_NUMBER() OVER(ORDER BY [RowNumber]) AS RowNumber, s.UserId FROM SortedUsers s '
                                                + @filterJoin + ' ) '
	        END
        ELSE
		    BEGIN   
                -- Sort By User Property
                IF @sortByUserProperty = 1 BEGIN SET @sortSql = {databaseOwner}{objectQualifier}GetSortSql(@SortBy,@SortAscending,'UserID')END
                                
                -- Default: Sort By UserID
                ELSE BEGIN SET @sortSql = {databaseOwner}{objectQualifier}GetSortSql('UserID',@SortAscending,'UserID') END                        
                SET @filterSortSql = ' ;WITH SortedUsers AS ( SELECT ROW_NUMBER() OVER( ' + @sortSql + ' ) AS RowNumber, * '
                                                + ' FROM {databaseOwner}{objectQualifier}vw_Users WHERE (PortalID = ' + CONVERT(nvarchar(20), @PortalID) + ' OR PortalID Is NULL) AND IsDeleted = 0)'
                                                + ' , MatchingSorted AS ( SELECT ROW_NUMBER() OVER(ORDER BY [RowNumber]) AS RowNumber, s.UserId FROM SortedUsers s '
                                                + @filterJoin + ' ) '
	        END

		-- Check if any Profile Property Definitions exist for this portal
		IF @pivotSql is not null
			BEGIN
				-- SELECT with PIVOT
				SET @pivotSql = 'SELECT * FROM (SELECT * FROM PivotedUsers PIVOT (MAX(PropertyValue) for PropertyName in (' + @pivotSql + ') ) as pivotTable) T '
			END
		ELSE
			BEGIN
				-- SELECT with DISTINCT
				SET @pivotSql = 'SELECT distinct UserID, PortalID, Username, Email, DisplayName, IsSuperUser, IsDeleted, AffiliateID, UpdatePassword, Authorised FROM PivotedUsers '
			END

        -- ///////////////////////////////////////////////////
        -- CREATE FINAL QUERY
        -- ///////////////////////////////////////////////////
        SET @sql = @filterSql
                + ' DECLARE @TempUsers TABLE (SortOrder INT, UserID INT) '
                + @filterSortSql
                + @roleAndRelationshipFilter
                + ' INSERT INTO @TempUsers SELECT ' + @topSql + ' * FROM (SELECT '
                + ' ROW_NUMBER() OVER ( ORDER BY [RowNumber] ) AS RowNumber, s.UserId FROM MatchingSorted s ' 
                + ' WHERE 1=1 ' + @roleAndRelationshipSelect
				+ ') t WHERE RowNumber >= '+ @minRowNumberSql
                + ' ;WITH PivotedUsers AS ( SELECT U.UserID, U.PortalID, U.Username, U.Email, U.DisplayName, U.IsSuperUser, U.IsDeleted, U.CreatedOnDate,        
                                                U.AffiliateID, U.UpdatePassword, U.Authorised, Prop.PropertyName,
                                                CASE
                                                    WHEN (P.Visibility = 0) THEN P.PropertyValue
                                                    WHEN (P.Visibility = 1 AND ' + CONVERT(nvarchar(20), @IsAdmin) + ' = 1) THEN P.PropertyValue
                                                    WHEN (P.Visibility = 1 AND ' + CONVERT(nvarchar(20), @IsAdmin) + ' = 0 AND ' + CONVERT(nvarchar(20), @UserId) + ' > 0) THEN P.PropertyValue
                                                    WHEN U.UserID = ' + CONVERT(nvarchar(20), @UserId) + ' OR (P.Visibility = 2 AND ' + CONVERT(nvarchar(20), @IsAdmin) + ' = 1) THEN P.PropertyValue
                                                    ELSE NULL
                                                END AS PropertyValue
                                            FROM   {databaseOwner}{objectQualifier}vw_Users AS U
                                                INNER JOIN {databaseOwner}{objectQualifier}UserProfile AS P ON U.UserID = P.UserID
                                                LEFT OUTER JOIN {databaseOwner}{objectQualifier}ProfilePropertyDefinition AS Prop ON 
                                                (Prop.PropertyDefinitionID = P.PropertyDefinitionID and Prop.Deleted = 0 and Prop.PortalID = ' + CONVERT(nvarchar(20), @PortalID) + ')
                                            WHERE U.UserId IN (SELECT UserId FROM @TempUsers) AND (U.PortalId = ' + CONVERT(nvarchar(20), @PortalID) + ' OR U.PortalId IS NULL)
                                            )' +
                @pivotSql + @sortSql            

        EXEC(@sql)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteScopeType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteScopeType] 
	@ScopeTypeId			int
AS
	DELETE FROM {databaseOwner}{objectQualifier}Taxonomy_ScopeTypes
	WHERE ScopeTypeId = @ScopeTypeId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllTabs]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAllTabs] 
AS
	SELECT *
		FROM {databaseOwner}{objectQualifier}vw_Tabs
		ORDER BY Level, ParentID, TabOrder
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotification]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotification]
	@NotificationId int
AS
BEGIN
	SELECT
		M.[MessageID],
		M.[NotificationTypeId],
		M.[To],
		M.[From],
		M.[Subject],
		M.[Body],
		M.[SenderUserID],
		M.[ExpirationDate],
        M.[IncludeDismissAction],
		M.[CreatedByUserID],
		M.[CreatedOnDate],
		M.[LastModifiedByUserID],
		M.[LastModifiedOnDate],
        M.[Context]
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] AS M
	WHERE [NotificationTypeId] IS NOT NULL
	AND M.MessageID = @NotificationId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderPermission]
	
	@FolderPermissionID int

AS
SELECT *
FROM {databaseOwner}{objectQualifier}vw_FolderPermissions
WHERE FolderPermissionID = @FolderPermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPortalLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPortalLanguage]
    @PortalId			int,
    @LanguageId			int,
    @IsPublished		bit,
    @CreatedByUserID	int

AS
    DECLARE @PortalLanguageId INT
    DECLARE @CultureCode NVARCHAR(50)

    INSERT INTO {databaseOwner}{objectQualifier}PortalLanguages (
        PortalId,
        LanguageId,
        IsPublished,
        [CreatedByUserID],
        [CreatedOnDate],
        [LastModifiedByUserID],
        [LastModifiedOnDate]
    )
    VALUES (
        @PortalId,
        @LanguageId,
        @IsPublished,
        @CreatedByUserID,
        getdate(),
        @CreatedByUserID,
        getdate()
    )

    SELECT @PortalLanguageId = SCOPE_IDENTITY()

	SELECT @CultureCode = CultureCode FROM {databaseOwner}{objectQualifier}Languages WHERE LanguageID = @LanguageId

	EXEC {databaseOwner}{objectQualifier}EnsureLocalizationExists @PortalID = @PortalId, @CultureCode = @CultureCode
	
	SELECT @PortalLanguageId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePropertyDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePropertyDefinition]
	@PropertyDefinitionId int,
	@DataType int,
	@DefaultValue nvarchar(50),
	@PropertyCategory nvarchar(50),
	@PropertyName nvarchar(50),
	@ReadOnly bit,
	@Required bit,
	@ValidationExpression nvarchar(2000),
	@ViewOrder int,
	@Visible bit,
    @Length int,
    @DefaultVisibility int,
	@LastModifiedByUserID	int

AS
	UPDATE {databaseOwner}{objectQualifier}ProfilePropertyDefinition 
		SET DataType = @DataType,
			DefaultValue = @DefaultValue,
			PropertyCategory = @PropertyCategory,
			PropertyName = @PropertyName,
			ReadOnly = @ReadOnly,
			Required = @Required,
			ValidationExpression = @ValidationExpression,
			ViewOrder = @ViewOrder,
			Visible = @Visible,
			Length = @Length,
            DefaultVisibility = @DefaultVisibility,
			[LastModifiedByUserID] = @LastModifiedByUserID,	
			[LastModifiedOnDate] = getdate()
		WHERE PropertyDefinitionId = @PropertyDefinitionId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPropertyDefinition]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPropertyDefinition]

	@PropertyDefinitionID	int

AS
SELECT	{databaseOwner}{objectQualifier}ProfilePropertyDefinition.*
FROM	{databaseOwner}{objectQualifier}ProfilePropertyDefinition
WHERE PropertyDefinitionID = @PropertyDefinitionID
	AND Deleted = 0
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetHostSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetHostSettings]
AS
	IF NOT EXISTS ( select 1 from {databaseOwner}{objectQualifier}HostSettings where SettingName = 'GUID' )
	  INSERT INTO {databaseOwner}{objectQualifier}HostSettings ( SettingName, SettingValue, SettingIsSecure ) values ( 'GUID', newid(), 0 )

	SELECT SettingName,
		   SettingValue,
		   SettingIsSecure,
		   CreatedByUserID,
		   CreatedOnDate,
	       LastModifiedByUserID,
		   LastModifiedOnDate
	FROM   {databaseOwner}{objectQualifier}HostSettings
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabModuleSettings]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteTabModuleSettings]
@TabModuleId      int
as

DELETE FROM {databaseOwner}{objectQualifier}TabModuleSettings 
WHERE TabModuleId = @TabModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalLocalizations]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalLocalizations]
    @PortalId			int
AS
	SELECT * FROM {databaseOwner}[{objectQualifier}PortalLocalization] WHERE PortalId = @PortalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabModuleVersionByModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabModuleVersionByModule]
    @ModuleID	int
AS
    UPDATE {databaseOwner}{objectQualifier}TabModules
        SET    VersionGuid = NEWID()
    WHERE  ModuleID = @ModuleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetProfilePropertyDefinitionID]'
GO
-- optimized
CREATE FUNCTION {databaseOwner}[{objectQualifier}GetProfilePropertyDefinitionID]
(   @PortalID     Int,         -- might be 0
    @PropertyName nVarChar(50) -- required
)   
	RETURNS 	  Int
AS
	BEGIN
		DECLARE @DefinitionID Int = -1
		IF NOT IsNull(@PropertyName, '') = ''
			SELECT @DefinitionID = PropertyDefinitionID
			  FROM {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]
			  WHERE IsNull(PortalID, -1) = IsNull(@PortalID, -1) AND PropertyName = @PropertyName
		RETURN @DefinitionID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_MarkMessageAsDispatched]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_MarkMessageAsDispatched]
	@MessageId int
AS
BEGIN
	Update {objectQualifier}Messaging_Messages set EmailSent = 1, EmailSentDate =GETDATE()   where MessageID =@MessageId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_GetStatsForGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_GetStatsForGroup]
	@PortalId INT,
	@GroupId INT
AS
SELECT Count(j.JournalTypeId) as JournalTypeCount, 
	   jt.JournalType 
	   FROM {databaseOwner}[{objectQualifier}Journal] AS j 
	   INNER JOIN {databaseOwner}[{objectQualifier}Journal_Types] AS jt ON jt.JournalTypeId = j.JournalTypeId
	WHERE j.GroupId = @GroupId AND j.PortalId = @PortalId AND j.IsDeleted = 0
	Group BY j.JournalTypeId, jt.JournalType
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Messaging_GetInbox]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Messaging_GetInbox]
	@PortalID int,
	@UserID int,
	@PageNumber int,
	@PageSize int
AS
	-- Set the page bounds
	DECLARE 
		@PageLowerBound INT, 
		@PageUpperBound INT, 
		@RowsToReturn int, 
		@PageIndex int

		/* this is 1-based rather than 0-based indexing. Accomodating so that we are consistent with paging */
		SET @PageIndex = @PageNumber - 1

		exec {databaseOwner}[{objectQualifier}CalculatePagingInformation] @PageIndex, @PageSize, @RowsToReturn output, @PageLowerBound output, @PageUpperBound output

		begin 
			with UserInbox as (
				select * , ROW_NUMBER() over (order by Date desc) as RowNumber
					from {databaseOwner}{objectQualifier}Messaging_Messages 
					where (ToUserID = @UserID AND Status IN (1,2) AND SkipPortal = '0') 
						OR (FromUserID = @UserID AND Status = 0)
			)
			select * from UserInbox
				where RowNumber > @PageLowerBound AND RowNumber < @PageUpperBound
				order by RowNumber
		end
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUser]

	@PortalID int,
	@UserID int

AS
SELECT * FROM {databaseOwner}{objectQualifier}vw_Users U
WHERE  UserId = @UserID
	AND    (PortalId = @PortalID or IsSuperUser = 1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventLogConfig]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventLogConfig]
	@ID int
AS
SELECT c.*, t.LogTypeFriendlyName
FROM {databaseOwner}{objectQualifier}EventLogConfig AS c
	INNER JOIN {databaseOwner}{objectQualifier}EventLogTypes AS t ON t.LogTypeKey = c.LogTypeKey
WHERE (ID = @ID or @ID IS NULL)
ORDER BY t.LogTypeFriendlyName ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_MarkMessageAsSent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_MarkMessageAsSent]
	@MessageId int,
	@RecipientId int
AS
BEGIN
	Update {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients set EmailSent = 1  where MessageID =@MessageId AND RecipientId=@RecipientId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteDesktopModulePermissionsByUserID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteDesktopModulePermissionsByUserID]
    @UserId   INT,  -- required, not null!
	@PortalId INT -- Null affects all sites
AS
    DELETE FROM {databaseOwner}[{objectQualifier}DesktopModulePermission]
    WHERE UserID = @UserId
     AND (PortalDesktopModuleID IN (SELECT PortalDesktopModuleID 
									FROM {databaseOwner}[{objectQualifier}PortalDesktopModules] 
									WHERE PortalID = @PortalId) OR IsNull(@PortalId, -1) = -1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTermsByContent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTermsByContent] 
	@ContentItemID			int
AS
	SELECT TT.*
	FROM {databaseOwner}{objectQualifier}ContentItems_Tags TG
		INNER JOIN {databaseOwner}{objectQualifier}Taxonomy_Terms TT ON TG.TermID = TT.TermID
	WHERE TG.ContentItemID = @ContentItemID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveTabUrl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveTabUrl] 
	@TabID				int,
	@SeqNum				int,
	@PortalAliasID		int,
	@PortalAliasUsage	int,
	@Url				nvarchar(200),
	@QueryString		nvarchar(200),
	@CultureCode		nvarchar(50),
	@HttpStatus			nvarchar(50),
	@IsSystem			bit,
	@ModifiedByUserID	int
AS
	IF @HttpStatus = '200'
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}TabUrls
				SET HttpStatus = '301',
				[LastModifiedByUserID]= @ModifiedByUserID,
				[LastModifiedOnDate]= getdate()
				WHERE TabID = @TabID
					AND CultureCode = @CultureCode
					AND (@PortalAliasID = @PortalAliasID OR (PortalAliasId IS NULL AND @PortalAliasID IS NULL))
					AND HttpStatus = '200'
		END  
	IF EXISTS (SELECT * FROM {databaseOwner}{objectQualifier}TabUrls WHERE TabId = @TabID AND SeqNum = @SeqNum)
		BEGIN
			UPDATE {databaseOwner}{objectQualifier}TabUrls
				SET 
					PortalAliasId = @PortalAliasID,
					PortalAliasUsage = @PortalAliasUsage,
					Url = @Url,
					QueryString = @QueryString,
					CultureCode = @CultureCode,
					HttpStatus = @HttpStatus,
					IsSystem = @IsSystem,
					[LastModifiedByUserID]= @ModifiedByUserID,
					[LastModifiedOnDate]= getdate()
			WHERE TabId = @TabID AND SeqNum = @SeqNum 
		END
	ELSE
		BEGIN
			INSERT INTO {databaseOwner}{objectQualifier}TabUrls
					( TabId ,
					  SeqNum ,
					  Url ,
					  QueryString ,
					  HttpStatus ,
					  CultureCode ,
					  IsSystem,
					  PortalAliasId ,
					  PortalAliasUsage,
					  [CreatedByUserID],
					  [CreatedOnDate],
				  	  [LastModifiedByUserID],
					  [LastModifiedOnDate]
					)
			VALUES  ( @TabID ,
					  @SeqNum ,
					  @Url ,
					  @QueryString ,
					  @HttpStatus ,
					  @CultureCode ,
					  @IsSystem,
					  @PortalAliasID ,
					  0,
					  @ModifiedByUserID,
					  getdate(),
					  @ModifiedByUserID,
					  getdate()
					)
		END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllTabsModulesByModuleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAllTabsModulesByModuleID]
    @ModuleID	int
AS
	SELECT	* 
	FROM {databaseOwner}{objectQualifier}vw_Modules
	WHERE  ModuleID = @ModuleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PasswordHistory]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PasswordHistory]
(
[PasswordHistoryID] [int] NOT NULL IDENTITY(1, 1),
[UserID] [int] NOT NULL,
[Password] [nvarchar] (128) NOT NULL,
[PasswordSalt] [nvarchar] (128) NOT NULL,
[CreatedByUserID] [int] NULL,
[CreatedOnDate] [datetime] NULL,
[LastModifiedByUserID] [int] NULL,
[LastModifiedOnDate] [datetime] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PasswordHistory] on {databaseOwner}[{objectQualifier}PasswordHistory]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PasswordHistory] ADD CONSTRAINT [PK_{objectQualifier}PasswordHistory] PRIMARY KEY CLUSTERED  ([PasswordHistoryID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPasswordHistory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPasswordHistory]
    @UserId			int,
    @Password			nvarchar(128),
    @PasswordSalt		nvarchar(128),
	@Retained			int,
    @CreatedByUserID  	int
AS

        BEGIN
		
          INSERT INTO {databaseOwner}{objectQualifier}PasswordHistory (
            UserId,
            [Password],
            PasswordSalt,
			CreatedByUserID,
			CreatedOnDate,
			LastModifiedByUserID,
			LastModifiedOnDate
          )
          VALUES (
            @UserId,
            @Password,
            @PasswordSalt,
            
			@CreatedByUserID,
			getdate(),
			@CreatedByUserID,
			getdate()
          )

		  DELETE FROM {databaseOwner}{objectQualifier}PasswordHistory where UserID=@UserId and PasswordHistoryID NOT IN (
					SELECT TOP (@Retained) PasswordHistoryID from {databaseOwner}{objectQualifier}PasswordHistory
					WHERE UserID=@UserId order by CreatedOnDate desc
					)

        END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateUserRole]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateUserRole]
    @UserRoleId		int, 
	@Status			int,
	@IsOwner		bit,
	@EffectiveDate	datetime = null,
	@ExpiryDate		datetime = null,
	@LastModifiedByUserID			int
AS
	UPDATE {databaseOwner}{objectQualifier}UserRoles 
		SET 
			Status = @Status,
			IsOwner = @IsOwner,
			ExpiryDate = @ExpiryDate,
			EffectiveDate = @EffectiveDate,
			IsTrialUsed = 1,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
		WHERE  UserRoleId = @UserRoleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabModuleTranslationStatus]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabModuleTranslationStatus]
	@TabModuleId			int,
    @LocalizedVersionGuid	uniqueidentifier,
	@LastModifiedByUserID	int
AS
	UPDATE {databaseOwner}{objectQualifier}TabModules
		SET
		LocalizedVersionGuid	= @LocalizedVersionGuid,
		LastModifiedByUserID	= @LastModifiedByUserID,
		LastModifiedOnDate		= getdate()
	WHERE  TabModuleId = @TabModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}MasterPortalId]'
GO
-- new helper function
CREATE FUNCTION {databaseOwner}[{objectQualifier}MasterPortalId]
(
    @PortalId Int  -- ID of the portal or Null for Host
) 
	RETURNS   Int
AS
	BEGIN
		DECLARE @MasterPortalId  Int = Null
		IF IsNull(@PortalId, -1) >= 0
			SELECT @MasterPortalId = MasterPortalId FROM {databaseOwner}[{objectQualifier}vw_MasterPortals] WHERE PortalId = @PortalId
		RETURN @MasterPortalId
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteDesktopModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteDesktopModule]
	@DesktopModuleId int
AS
-- delete custom permissions
DELETE FROM {databaseOwner}{objectQualifier}Permission
WHERE moduledefid in 
	(SELECT moduledefid 
	FROM {databaseOwner}{objectQualifier}ModuleDefinitions
	WHERE desktopmoduleid = @DesktopModuleId)
	
DELETE FROM {databaseOwner}{objectQualifier}DesktopModules 
WHERE DesktopModuleId = @DesktopModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPasswordHistory]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPasswordHistory]
    @UserID			int
AS
        SELECT * from {databaseOwner}{objectQualifier}PasswordHistory where UserID=@UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SetFileHasBeenPublished]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SetFileHasBeenPublished] 
    @FileId                    int,
    @HasBeenPublished        bit
AS
BEGIN

    -- Change Files.HasBeenPublished to the passed value
    UPDATE {databaseOwner}[{objectQualifier}Files]
    SET     [HasBeenPublished] = @HasBeenPublished
    FROM {databaseOwner}[{objectQualifier}Files] f
    WHERE f.FileId = @FileId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateModuleLastContentModifiedOnDate]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateModuleLastContentModifiedOnDate]
    @ModuleID	int
AS
    UPDATE {databaseOwner}{objectQualifier}Modules
        SET    LastContentModifiedOnDate = GETDATE()
    WHERE  ModuleID = @ModuleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderByFolderPath]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderByFolderPath]
 @PortalID int,
 @FolderPath nvarchar(300)
AS
BEGIN
 if @PortalID is not null
 begin
  SELECT *
  FROM {databaseOwner}{objectQualifier}Folders
  WHERE PortalID = @PortalID AND FolderPath = @FolderPath
 end else begin
  SELECT *
  FROM {databaseOwner}{objectQualifier}Folders
  WHERE PortalID is null AND  FolderPath = @FolderPath
 end
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetEventMessagesBySubscriber]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetEventMessagesBySubscriber]
	
	@EventName nvarchar(100),
	@Subscriber nvarchar(100)

AS
	SELECT * 
	FROM {databaseOwner}{objectQualifier}EventQueue
	WHERE EventName = @EventName
		AND Subscriber = @Subscriber
		AND IsComplete = 0
	ORDER BY SentDate
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetScheduleNextTask]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetScheduleNextTask]
	@Server varchar(150)
AS
SELECT TOP 1
        S.[ScheduleID] ,
        S.[TypeFullName] ,
        S.[TimeLapse] ,
        S.[TimeLapseMeasurement] ,
        S.[RetryTimeLapse] ,
        S.[RetryTimeLapseMeasurement] ,
        S.[RetainHistoryNum] ,
        S.[AttachToEvent] ,
        S.[CatchUpEnabled] ,
        S.[Enabled] ,
        S.[ObjectDependencies] ,
        S.[Servers] ,
        S.[CreatedByUserID] ,
        S.[CreatedOnDate] ,
        S.[LastModifiedByUserID] ,
        S.[LastModifiedOnDate] ,
        S.[FriendlyName] ,
        H.[NextStart]
FROM    {databaseOwner}[{objectQualifier}Schedule] S
        CROSS APPLY ( SELECT TOP 1
                                [NextStart]
                      FROM      {databaseOwner}[{objectQualifier}ScheduleHistory]
                      WHERE     ( [ScheduleID] = S.[ScheduleID] )
                      ORDER BY  [NextStart] DESC
                    ) AS H ( [NextStart] )
WHERE   ( S.[Enabled] = 1 )
        AND ( ( S.[Servers] LIKE ( ',%' + @Server + '%,' ) )
              OR ( S.[Servers] IS NULL )
            )
ORDER BY H.[NextStart] ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessageRecipient]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessageRecipient]
    @RecipientID int
AS
	DELETE FROM {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
	WHERE  [RecipientID] = @RecipientID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFileVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFileVersion] 
    @FileId int,
    @Version int
AS
BEGIN
    DECLARE @PublishedVersion int

    -- Check there is at least one version
    IF NOT EXISTS(SELECT FileID FROM {objectQualifier}FileVersions WHERE FileId = @FileId)
    BEGIN
        SELECT 1 -- We need to return 1 in order to allow initial version
        RETURN
    END
        
    SELECT @PublishedVersion = PublishedVersion
    FROM {databaseOwner}{objectQualifier}Files
    WHERE FileId = @FileId

    IF @PublishedVersion = @Version 
    BEGIN
        -- Get the previous version
        SELECT @PublishedVersion = MAX(Version)
        FROM {databaseOwner}{objectQualifier}FileVersions 
        WHERE FileId = @FileId
            AND Version < @Version

        -- If there is no previous version, get the min exsisting version
        IF @PublishedVersion IS NULL 
            SELECT @PublishedVersion = MIN(Version)
            FROM {databaseOwner}{objectQualifier}FileVersions 
            WHERE FileId = @FileId

        -- Update the published version
        IF @PublishedVersion IS NOT NULL 
        BEGIN
            UPDATE {databaseOwner}{objectQualifier}Files
            SET [PublishedVersion] = @PublishedVersion,
                [Extension] = v.[Extension],
                [Size] = v.[Size],
                [Width] = v.Width,        
                [Height] = v.Height,
                [ContentType] = v.ContentType,
                [Content] = v.Content,
                [LastModifiedByUserID] = v.LastModifiedByUserID,
                [LastModifiedOnDate] = v.LastModifiedOnDate,
                [SHA1Hash] = v.SHA1Hash
            FROM {databaseOwner}{objectQualifier}files AS f
                INNER JOIN {databaseOwner}{objectQualifier}FileVersions AS v
                ON ( f.FileId = v.FileId AND v.Version = @PublishedVersion)        
            WHERE f.FileId = @FileId

            DELETE FROM {databaseOwner}{objectQualifier}FileVersions
            WHERE FileId = @FileId 
            AND Version = @PublishedVersion
        END
    END

    DELETE FROM {databaseOwner}{objectQualifier}FileVersions
    WHERE FileId = @FileId 
      AND Version = @Version

    SELECT @PublishedVersion
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Comment_Save]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Comment_Save]
	@JournalId int,
	@CommentId int,
	@UserId int,
	@Comment nvarchar(max),
	@CommentXML xml,
	@DateUpdated datetime
AS

DECLARE @cxml xml
DECLARE @xml xml
DECLARE @cdataComment nvarchar(max)

IF EXISTS(SELECT * FROM {databaseOwner}[{objectQualifier}Journal_Comments] WHERE JournalId = @JournalId AND CommentId = @CommentId)
BEGIN
	IF (LEN(@Comment) < 2000)
	BEGIN
		UPDATE {databaseOwner}[{objectQualifier}Journal_Comments]
		SET Comment = @Comment,
			CommentXML = @CommentXML,
			DateUpdated = IsNull(@DateUpdated, GETUTCDATE())
		WHERE JournalId = @JournalId AND CommentId = @CommentId
	END
	ELSE
	BEGIN		
		SET @cxml = (SELECT CommentXML FROM {databaseOwner}[{objectQualifier}Journal_Comments] WHERE CommentId = @CommentId AND JournalId = @JournalId)
		IF @cxml IS NULL 
		BEGIN
			SET @xml = '<root></root>';
			UPDATE {databaseOwner}[{objectQualifier}Journal_Comments]
			SET CommentXML = @xml
			WHERE JournalId = @JournalId AND CommentId = @CommentId
		END

		IF NOT EXISTS(SELECT CommentId FROM {databaseOwner}[{objectQualifier}Journal_Comments] WHERE JournalId = @JournalId AND CommentId = @CommentID AND CommentXML.exist('/root/comment') = 1)
		BEGIN
			UPDATE {databaseOwner}[{objectQualifier}Journal_Comments]
			SET CommentXML.modify('insert <comment>NULL</comment> as last into (/root)[1]') 
			WHERE JournalId = @JournalId AND CommentId = @CommentId AND CommentXML.exist('/root') = 1
		END
		
		SET @cdataComment = '<![CDATA[' + @Comment + ']]>'
		UPDATE {databaseOwner}[{objectQualifier}Journal_Comments]
		SET CommentXML.modify('replace value of (/root/comment[1]/text())[1] with sql:variable("@cdataComment")'),
			Comment = NULL,
			DateUpdated = IsNull(@DateUpdated, GETUTCDATE())
		WHERE JournalId = @JournalId AND CommentId = @CommentId AND CommentXML.exist('/root/comment') = 1
	END
END
ELSE
BEGIN
	IF (LEN(@Comment) < 2000)
	BEGIN
		INSERT INTO {databaseOwner}[{objectQualifier}Journal_Comments]
			(JournalId, UserId, Comment, CommentXML, DateCreated, DateUpdated)
			VALUES
			(@JournalId, @UserId, @Comment, @CommentXML, GETUTCDATE(), GETUTCDATE())
		SET @CommentId = SCOPE_IDENTITY()
	END
	ELSE
	BEGIN
		INSERT INTO {databaseOwner}[{objectQualifier}Journal_Comments]
			(JournalId, UserId, Comment, CommentXML, DateCreated, DateUpdated)
			VALUES
			(@JournalId, @UserId, NULL, NULL, GETUTCDATE(), GETUTCDATE())
		SET @CommentId = SCOPE_IDENTITY()		
		
		SET @cxml = (SELECT CommentXML FROM {databaseOwner}[{objectQualifier}Journal_Comments] WHERE CommentId = @CommentId AND JournalId = @JournalId)
		IF @cxml IS NULL 
		BEGIN			
			SET @xml = '<root></root>';
			UPDATE {databaseOwner}[{objectQualifier}Journal_Comments]
			SET CommentXML = @xml
			WHERE JournalId = @JournalId AND CommentId = @CommentId
		END

		IF NOT EXISTS(SELECT CommentId FROM {databaseOwner}[{objectQualifier}Journal_Comments] WHERE JournalId = @JournalId AND CommentId = @CommentID AND CommentXML.exist('/root/comment') = 1)
		BEGIN
			UPDATE {databaseOwner}[{objectQualifier}Journal_Comments]
			SET CommentXML.modify('insert <comment>NULL</comment> as last into (/root)[1]') 
			WHERE JournalId = @JournalId AND CommentId = @CommentId AND CommentXML.exist('/root') = 1
		END
		
		SET @cdataComment = '<![CDATA[' + @Comment + ']]>'
		UPDATE {databaseOwner}[{objectQualifier}Journal_Comments]
		SET CommentXML.modify('replace value of (/root/comment[1]/text())[1] with sql:variable("@cdataComment")'),
			Comment = NULL
		WHERE JournalId = @JournalId AND CommentId = @CommentId AND CommentXML.exist('/root/comment') = 1
	END		
END
SELECT @CommentId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UserIsInRole]'
GO
-- new helper function
CREATE FUNCTION {databaseOwner}[{objectQualifier}UserIsInRole]
(
	@UserId Int,
	@RoleId Int
)
RETURNS 	Bit
AS
	BEGIN
		RETURN CASE WHEN EXISTS (SELECT * FROM {databaseOwner}[{objectQualifier}UserRoles] WHERE UserID = @UserId AND RoleID = @RoleId 
														   AND IsNull(EffectiveDate, GetDate()) >= GetDate() 
														   AND IsNull(ExpiryDate, GetDate())    <= GetDate()) THEN 1 ELSE 0 END
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFolderPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFolderPermission]
	@FolderPermissionID int
AS

DELETE FROM {databaseOwner}{objectQualifier}FolderPermission
WHERE
	[FolderPermissionID] = @FolderPermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}fn_GetVersion]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}fn_GetVersion]
(
	@maj AS int,
	@min AS int,
	@bld AS int
)
RETURNS bit

AS
BEGIN
	IF Exists (SELECT * FROM {databaseOwner}{objectQualifier}Version
					WHERE Major = @maj
						AND Minor = @min
						AND Build = @bld
				)
		BEGIN
			RETURN 1
		END
	RETURN 0
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabModule]
	@TabId      int,
	@ModuleId   int,
	@SoftDelete	bit
AS
IF @SoftDelete = 1
	UPDATE {databaseOwner}{objectQualifier}TabModules
		SET	IsDeleted = 1,
			VersionGuid = newId(),
			LastModifiedOnDate=GETDATE()
	WHERE  TabId = @TabId
		AND    ModuleId = @ModuleId
ELSE
	DELETE
	FROM   {databaseOwner}{objectQualifier}TabModules 
	WHERE  TabId = @TabId
		AND    ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationByContext]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationByContext]
	@notificationTypeId int,
	@Context nvarchar(200)
AS
BEGIN
	SELECT
		M.[MessageID],
		M.[NotificationTypeId],
		M.[To],
		M.[From],
		M.[Subject],
		M.[Body],
		M.[SenderUserID],
		M.[ExpirationDate],
        M.[IncludeDismissAction],
		M.[CreatedByUserID],
		M.[CreatedOnDate],
		M.[LastModifiedByUserID],
		M.[LastModifiedOnDate],
        M.[Context]
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages] AS M
	WHERE [NotificationTypeId] IS NOT NULL
	AND M.NotificationTypeId = @notificationTypeId
	AND M.Context = @context
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ChangeUsername]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}ChangeUsername]
	@UserId         int,
	@NewUsername	nvarchar(256)
AS
BEGIN
	DECLARE @OldUsername NVARCHAR(256)
	SET @OldUsername = (SELECT UserName FROM {databaseOwner}{objectQualifier}Users WHERE UserId = @UserId)

	UPDATE {databaseOwner}{objectQualifier}Users
		SET		Username=@NewUsername
		WHERE	UserId=@UserId

	UPDATE {databaseOwner}aspnet_Users
		SET		UserName=@NewUsername,
				LoweredUserName=LOWER(@NewUsername) 
		WHERE	UserName=@OldUsername

END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}vw_PublishedFiles]'
GO
CREATE VIEW {databaseOwner}[{objectQualifier}vw_PublishedFiles]
AS
    SELECT     
       fi.[FileId]
      ,fi.[PortalId]
      ,fi.[FileName]
      ,fi.[Extension]
      ,fi.[Size]
      ,fi.[Width]
      ,fi.[Height]
      ,fi.[ContentType]
      ,fi.[FolderID]
      ,fi.[Content]
      ,fi.[CreatedByUserID]
      ,fi.[CreatedOnDate]
      ,fi.[LastModifiedByUserID]
      ,fi.[LastModifiedOnDate]
      ,fi.[UniqueId]
      ,fi.[VersionGuid]
      ,fi.[SHA1Hash]
      ,fi.[LastModificationTime]
      ,fi.[Title]
      ,fi.[StartDate]
      ,fi.[EnablePublishPeriod]
      ,fi.[EndDate]
      ,fi.[ContentItemID]
      ,fi.[PublishedVersion]
      ,fi.[Folder]
      ,fi.[IsCached]
      ,fi.[StorageLocation]
      ,fi.[FolderMappingID]
      ,fi.[HasBeenPublished]
    FROM       {databaseOwner}[{objectQualifier}vw_Files] fi
      WHERE ([EnablePublishPeriod] = 0 AND [HasBeenPublished] = 1)
         OR ([StartDate] <= GETDATE()
            AND ([EndDate] IS NULL OR GETDATE() <= [EndDate]) AND [HasBeenPublished] = 1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTermsByVocabulary]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTermsByVocabulary] 
	@VocabularyID			int
AS
	SELECT TT.*
	FROM {databaseOwner}{objectQualifier}Taxonomy_Terms TT
	WHERE VocabularyID = @VocabularyID
	ORDER BY TT.TermLeft Asc, TT.Weight Asc, TT.Name Asc
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetOnlineUsers]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetOnlineUsers]
	@PortalID int
AS
	SELECT *
		FROM {databaseOwner}{objectQualifier}UsersOnline UO
			INNER JOIN {databaseOwner}{objectQualifier}vw_Users U ON UO.UserID = U.UserID 
			INNER JOIN {databaseOwner}{objectQualifier}UserPortals UP ON U.UserID = UP.UserId
		WHERE  UP.PortalID = @PortalID AND U.PortalID = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SetPublishedVersion]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SetPublishedVersion] 
    @FileId                    int,
    @NewPublishedVersion    int
AS
BEGIN

    -- Insert a new record in the FileVersions table for the old published version
    INSERT {databaseOwner}[{objectQualifier}FileVersions]
                ([FileId]
                ,[Version]
                ,[FileName]
                ,[Extension]
                ,[Size]
                ,[Width]
                ,[Height]
                ,[ContentType]
                ,[Content]
                ,[CreatedByUserID]
                ,[CreatedOnDate]
                ,[LastModifiedByUserID]
                ,[LastModifiedOnDate]
                ,[SHA1Hash])
    SELECT        [FileId]
                ,[PublishedVersion]  [Version]                
                ,CONVERT(nvarchar, [FileId]) + '_' + CONVERT(nvarchar, [PublishedVersion]) +'.v.resources' 
                ,[Extension]
                ,[Size]
                ,[Width]
                ,[Height]
                ,[ContentType]
                ,[Content]
                ,[CreatedByUserID]
                ,[CreatedOnDate]
                ,[LastModifiedByUserID]
                ,[LastModifiedOnDate]
                ,[SHA1Hash]                    
    FROM {objectQualifier}Files
    WHERE FileId = @FileId

    -- Change Files.PublishedVersion to the new version number
    UPDATE {databaseOwner}[{objectQualifier}Files]
    SET     [PublishedVersion] = @NewPublishedVersion        
        ,[Extension] =v.[Extension]
        ,[Size] = v.[Size]
        ,[Width] = v.[Width]
        ,[Height] = v.[Height]
        ,[ContentType] = v.[ContentType]
        ,[Content] = v.[Content]
        ,[CreatedByUserID] = v.[CreatedByUserID]
        ,[CreatedOnDate] = v.[CreatedOnDate]
        ,[LastModifiedByUserID] = v.[LastModifiedByUserID]
        ,[LastModifiedOnDate] = v.[LastModifiedOnDate]
        ,[SHA1Hash] = v.[SHA1Hash]
        ,[HasBeenPublished] = 1
    FROM {databaseOwner}[{objectQualifier}Files] f
        JOIN {databaseOwner}[{objectQualifier}FileVersions] v ON f.FileId = v.FileId
    WHERE f.FileId = @FileId
        AND v.Version = @NewPublishedVersion

    -- Delete the FileVersions entry of the version being published
    DELETE {databaseOwner}[{objectQualifier}FileVersions]
    WHERE FileId = @FileId AND Version = @NewPublishedVersion
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteUrlTracking]'
GO
create procedure {databaseOwner}[{objectQualifier}DeleteUrlTracking]

@PortalID     int,
@Url          nvarchar(255),
@ModuleID     int

as

delete
from   {databaseOwner}{objectQualifier}UrlTracking
where  PortalID = @PortalID
and    Url = @Url
and    ((ModuleId = @ModuleId) or (ModuleId is null and @ModuleId is null))
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RestoreTabModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}RestoreTabModule]
	@TabId      int,
	@ModuleId   int
AS
	UPDATE {databaseOwner}{objectQualifier}TabModules
		SET IsDeleted = 0,
			VersionGuid = newId()
	WHERE  TabId = @TabId
		AND    ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddEventMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddEventMessage]

	@EventName nvarchar(100),
	@Priority int,
	@ProcessorType nvarchar(250),
	@ProcessorCommand nvarchar(250),
	@Body nvarchar(250),
	@Sender nvarchar(250),
	@Subscriber nvarchar(100),
	@AuthorizedRoles nvarchar(250),
	@ExceptionMessage nvarchar(250),
	@SentDate datetime,
	@ExpirationDate datetime,
	@Attributes ntext

AS
	INSERT {databaseOwner}{objectQualifier}EventQueue	(
			EventName,
			Priority,
			ProcessorType,
			ProcessorCommand,
			Body,
			Sender,
			Subscriber,
			AuthorizedRoles,
			ExceptionMessage,
			SentDate,
			ExpirationDate,
			Attributes
		)
		VALUES	(
			@EventName,
			@Priority,
			@ProcessorType,
			@ProcessorCommand,
			@Body,
			@Sender,
			@Subscriber,
			@AuthorizedRoles,
			@ExceptionMessage,
			@SentDate,
			@ExpirationDate,
			@Attributes
		)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalsByUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalsByUser]
	@userID		int 
AS

	SELECT     {databaseOwner}{objectQualifier}vw_Portals.*
FROM         {databaseOwner}{objectQualifier}UserPortals INNER JOIN
                      {databaseOwner}{objectQualifier}vw_Portals ON 
					  {databaseOwner}{objectQualifier}UserPortals.PortalId = {databaseOwner}{objectQualifier}vw_Portals.PortalID
WHERE     ({databaseOwner}{objectQualifier}UserPortals.UserId = @userID)
		AND ({databaseOwner}{objectQualifier}vw_Portals.DefaultLanguage = {databaseOwner}{objectQualifier}vw_Portals.CultureCode)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddModuleSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddModuleSetting]
	@ModuleId			int,
	@SettingName		nvarchar(50),
	@SettingValue		nvarchar(max),
	@CreatedByUserID	int
AS
	INSERT INTO {databaseOwner}{objectQualifier}ModuleSettings ( 
		ModuleId,
		SettingName,
		SettingValue,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	) 
	VALUES ( 
		@ModuleId, 
		@SettingName, 
		@SettingValue,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFile]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFile]
    @FileName nvarchar(246),
    @FolderID int,
    @RetrieveUnpublishedFiles bit = 0
AS
BEGIN
    IF @RetrieveUnpublishedFiles = 0 BEGIN
        SELECT FileId,
               PortalId,
               [FileName],
               Extension,
               Size,
               Width,
               Height,
               ContentType,
               FolderID,
               Folder,
               StorageLocation,
               IsCached,
               UniqueId,
               VersionGuid,       
               SHA1Hash,
               FolderMappingID,
               LastModificationTime,
               Title,
               EnablePublishPeriod,
               StartDate,
               EndDate,
               CreatedByUserID,
               CreatedOnDate,
               LastModifiedByUserID,
               LastModifiedOnDate,
               ContentItemID,
               PublishedVersion,
               HasBeenPublished
        FROM {databaseOwner}[{objectQualifier}vw_PublishedFiles]             
        WHERE [FileName] = @FileName AND FolderID = @FolderID
    END
    ELSE BEGIN
        SELECT FileId,
               PortalId,
               [FileName],
               Extension,
               Size,
               Width,
               Height,
               ContentType,
               FolderID,
               Folder,
               StorageLocation,
               IsCached,
               UniqueId,
               VersionGuid,       
               SHA1Hash,
               FolderMappingID,
               LastModificationTime,
               Title,
               EnablePublishPeriod,
               StartDate,
               EndDate,
               CreatedByUserID,
               CreatedOnDate,
               LastModifiedByUserID,
               LastModifiedOnDate,
               ContentItemID,
               PublishedVersion,
               HasBeenPublished
        FROM {databaseOwner}[{objectQualifier}vw_Files]
        WHERE [FileName] = @FileName AND FolderID = @FolderID
    END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetScopeTypes]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetScopeTypes] 
AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}Taxonomy_ScopeTypes
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RelationshipTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}RelationshipTypes]
(
[RelationshipTypeID] [int] NOT NULL IDENTITY(1, 1),
[Direction] [int] NOT NULL,
[Name] [nvarchar] (50) NOT NULL,
[Description] [nvarchar] (500) NULL,
[CreatedByUserID] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}RelationshipTypes_CreatedOnDate] DEFAULT (getdate()),
[LastModifiedByUserID] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL CONSTRAINT [DF_{objectQualifier}RelationshipTypes_LastModifiedOnDate] DEFAULT (getdate())
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}RelationshipTypes] on {databaseOwner}[{objectQualifier}RelationshipTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}RelationshipTypes] ADD CONSTRAINT [PK_{objectQualifier}RelationshipTypes] PRIMARY KEY CLUSTERED  ([RelationshipTypeID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllRelationshipTypes]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetAllRelationshipTypes]
AS 
    SELECT  RelationshipTypeID,
            Direction,
            Name ,            
            Description,
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}RelationshipTypes    
	ORDER BY RelationshipTypeID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserCountByPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserCountByPortal]
 @PortalId int
AS
begin
 SELECT count(*)
 FROM {databaseOwner}{objectQualifier}UserPortals AS UP
 WHERE UP.IsDeleted = 0 AND UP.PortalID = @PortalID
end
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddPortalGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddPortalGroup]
	@PortalGroupName			nvarchar(100),
	@PortalGroupDescription		nvarchar(2000),
	@MasterPortalID				int,
	@AuthenticationDomain		nvarchar(200),
	@CreatedByUserID			int
AS 
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}PortalGroups  
		( 
			PortalGroupName  , 
			PortalGroupDescription  ,
			MasterPortalID,
			AuthenticationDomain, 
			CreatedByUserID , 
			CreatedOnDate , 
			LastModifiedByUserID , 
			LastModifiedOnDate  
		)  
		VALUES  
		( 
			@PortalGroupName , 
			@PortalGroupDescription , 
			@MasterPortalID,
			@AuthenticationDomain, 
			@CreatedByUserID , 
			getdate() , 
			@CreatedByUserID , 
			getdate() 
		) 
		 
		SELECT SCOPE_IDENTITY()
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddModuleControl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddModuleControl]
	
	@ModuleDefID                int,
	@ControlKey                 nvarchar(50),
	@ControlTitle               nvarchar(50),
	@ControlSrc                 nvarchar(256),
	@IconFile                   nvarchar(100),
	@ControlType                int,
	@ViewOrder                  int,
	@HelpUrl                    nvarchar(200),
	@SupportsPartialRendering   bit,
	@SupportsPopUps				bit,
	@CreatedByUserID			int

AS
	INSERT INTO {databaseOwner}{objectQualifier}ModuleControls (
		ModuleDefID,
		ControlKey,
		ControlTitle,
		ControlSrc,
		IconFile,
		ControlType,
		ViewOrder,
		HelpUrl,
		SupportsPartialRendering,
		SupportsPopUps,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	)
	VALUES (
		@ModuleDefID,
		@ControlKey,
		@ControlTitle,
		@ControlSrc,
		@IconFile,
		@ControlType,
		@ViewOrder,
		@HelpUrl,
		@SupportsPartialRendering,
		@SupportsPopUps,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFileById]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFileById]
    @FileId int    ,
    @RetrieveUnpublishedFiles bit = 0
AS
BEGIN
    IF @RetrieveUnpublishedFiles = 0 BEGIN
        SELECT FileId,
               PortalId,
               [FileName],
               Extension,
               Size,
               Width,
               Height,
               ContentType,
               FolderID,
               Folder,
               StorageLocation,
               IsCached,
               UniqueId,
               VersionGuid,
               SHA1Hash,
               FolderMappingID,
               LastModificationTime,
               Title,
               EnablePublishPeriod,
               StartDate,
               EndDate,
               CreatedByUserID,
               CreatedOnDate,
               LastModifiedByUserID,
               LastModifiedOnDate,
               PublishedVersion,
               ContentItemID,
               HasBeenPublished
        FROM {databaseOwner}[{objectQualifier}vw_PublishedFiles]
        WHERE FileId = @FileId
    END
    ELSE BEGIN
        SELECT FileId,
               PortalId,
               [FileName],
               Extension,
               Size,
               Width,
               Height,
               ContentType,
               FolderID,
               Folder,
               StorageLocation,
               IsCached,
               [UniqueId],
               [VersionGuid],
               SHA1Hash,
               FolderMappingID,
               LastModificationTime,
               Title,
               EnablePublishPeriod,
               StartDate,
               EndDate,
               CreatedByUserID,
               CreatedOnDate,
               LastModifiedByUserID,
               LastModifiedOnDate,
               PublishedVersion,
               ContentItemID,
               HasBeenPublished
        FROM {databaseOwner}[{objectQualifier}vw_Files] 
        WHERE FileId = @FileId
    END    
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSimpleTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSimpleTerm] 
	@TermId			int
AS
	DELETE FROM {databaseOwner}{objectQualifier}Taxonomy_Terms
	WHERE TermID = @TermID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_IsToastPending]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_IsToastPending]	
    @NotificationId int
AS
BEGIN
    SELECT Sendtoast 
    FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
    WHERE MessageId = @NotificationId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentItem]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentItem] 
	@ContentItemId			int
AS
	SELECT *
	FROM {databaseOwner}{objectQualifier}ContentItems
	WHERE ContentItemId = @ContentItemId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddIPFilter]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddIPFilter]
	@IPAddress nvarchar(50),
	@SubnetMask nvarchar(50),
	@RuleType tinyint,
	@CreatedByUserID			int
AS 
	BEGIN
		INSERT INTO {databaseOwner}{objectQualifier}IPFilter  
		(
		[IPAddress]
           ,[SubnetMask]
           ,[RuleType]
           ,[CreatedByUserID]
           ,[CreatedOnDate]
           ,[LastModifiedByUserID]
           ,[LastModifiedOnDate]
		)  
		VALUES  
		( 
			@IPAddress , 
			@SubnetMask , 
			@RuleType,
			@CreatedByUserID , 
			getdate() , 
			@CreatedByUserID , 
			getdate() 
		) 
		 
		SELECT SCOPE_IDENTITY()
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessageRecipientByMessageAndUser]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteMessageRecipientByMessageAndUser]
    @MessageID int,
    @UserID int
AS
BEGIN
	DELETE
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
	WHERE [MessageID] = @MessageID AND [UserID] = @UserID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFiles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFiles]
    @FolderID Int,                      -- not null!
    @RetrieveUnpublishedFiles Bit = 0   -- include files, hidden by status or date?
AS
    IF @RetrieveUnpublishedFiles = 0 
    BEGIN
        SELECT
            F.FileId,
            F.PortalId,
            F.[FileName],
            F.Extension,
            F.[Size],
            F.Width,
            F.Height,
            F.ContentType,
            F.FolderID,
            F.Folder,
            F.StorageLocation,
            F.IsCached,
            F.FolderMappingID,
            F.UniqueId,
            F.VersionGuid,
            F.SHA1Hash,
            F.LastModificationTime,
            F.Title,
            F.EnablePublishPeriod,
            F.StartDate,
            F.EndDate,
            F.CreatedByUserID,
            F.CreatedOnDate,
            F.LastModifiedByUserID,
            F.LastModifiedOnDate,
            F.PublishedVersion,
            F.ContentItemID,
            F.HasBeenPublished
        FROM {databaseOwner}[{objectQualifier}vw_PublishedFiles] F            
        WHERE F.FolderID = @FolderID
        ORDER BY [FolderID], [FileName]
    END
    ELSE BEGIN
        SELECT
            F.FileId,
            F.PortalId,
            F.[FileName],
            F.Extension,
            F.[Size],
            F.Width,
            F.Height,
            F.ContentType,
            F.FolderID,
            F.Folder,
            F.StorageLocation,
            F.IsCached,
            F.FolderMappingID,
            F.UniqueId,
            F.VersionGuid,
            F.SHA1Hash,
            F.LastModificationTime,
            F.Title,
            F.EnablePublishPeriod,
            F.StartDate,
            F.EndDate,
            F.CreatedByUserID,
            F.CreatedOnDate,
            F.LastModifiedByUserID,
            F.LastModifiedOnDate,
            F.PublishedVersion,
            F.ContentItemID,
            F.HasBeenPublished
        FROM {databaseOwner}[{objectQualifier}vw_Files] F            
        WHERE F.FolderID = @FolderID
        ORDER BY [FolderID], [FileName]
    END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabPanes]'
GO
create procedure {databaseOwner}[{objectQualifier}GetTabPanes]

@TabId    int

as

select distinct(PaneName) as PaneName
from   {databaseOwner}{objectQualifier}TabModules
where  TabId = @TabId
order by PaneName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolders]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolders]
	@PortalID int -- Null|-1: Host Portal
AS
BEGIN
	SELECT *
	FROM {databaseOwner}{objectQualifier}Folders
	WHERE IsNull(PortalID, -1) = IsNull(@PortalID, -1) 
	ORDER BY PortalID, FolderPath -- include portalId to use proper index
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTermUsage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTermUsage] 
	@TermId int
AS
	SELECT
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = @TermId
			) AS TotalTermUsage ,
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = @TermId
			  AND	    CI.CreatedOnDate > DATEADD(day, -30, GETDATE())
		) AS MonthTermUsage ,
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = @TermId
			  AND	    CI.CreatedOnDate > DATEADD(day, -7, GETDATE())
		) AS WeekTermUsage ,
		(SELECT    COUNT(CI.ContentItemID)
			  FROM      {databaseOwner}[{objectQualifier}ContentItems_Tags] T
			  INNER JOIN {databaseOwner}[{objectQualifier}ContentItems] CI ON CI.ContentItemID = T.ContentItemID
			  WHERE     T.TermID = @TermId
			  AND	    CI.CreatedOnDate > DATEADD(day, -1, GETDATE())
		) AS DayTermUsage
	FROM {databaseOwner}{objectQualifier}Taxonomy_Terms TT
	WHERE TermID = @TermId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_MarkReadyForToast]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_MarkReadyForToast]	
    @MessageId int,
    @UserId int
AS
BEGIN	
    UPDATE {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]
    SET Sendtoast = 1,
    [LastModifiedOnDate] = GETDATE()
    WHERE MessageId = @MessageId
    AND UserId = @UserId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModuleByUniqueID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModuleByUniqueID]
    @UniqueID   uniqueidentifier
AS
	SELECT	* 
	FROM	{databaseOwner}{objectQualifier}vw_Modules
	WHERE	UniqueID = @UniqueID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateIPFilter]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateIPFilter]
	@IPFilterID		int,
	@IPAddress		nvarchar(50),
	@SubnetMask		nvarchar(50),
	@RuleType		tinyint,
	@LastModifiedByUserID		int
AS 
	BEGIN
		UPDATE {databaseOwner}{objectQualifier}IPFilter 
			SET 
				IPAddress = @IPAddress,
				SubnetMask = @SubnetMask,
				RuleType = @RuleType,
				LastModifiedByUserID = @LastModifiedByUserID,
				LastModifiedOnDate = getdate()
			WHERE IPFilterID = @IPFilterID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderMappings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderMappings]
	@PortalID int
AS
BEGIN
	SELECT *
	FROM {databaseOwner}[{objectQualifier}FolderMappings]
	WHERE ISNULL(PortalID, -1) = ISNULL(@PortalID, -1)
	ORDER BY Priority
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate]
    @FolderID	Int
AS
BEGIN
	SET NOCOUNT OFF;
	--Update the folder only if it has LastModifiedOnDate more than 59 secs old.
	--This is to avoid too many updates during massive sync
	UPDATE {databaseOwner}[{objectQualifier}Folders] SET LastModifiedOnDate=GETDATE() WHERE FolderID=@FolderID AND DATEDIFF(SECOND,LastModifiedOnDate,GETDATE())>=60
	IF(@@ROWCOUNT>0)
	BEGIN
		--Check if the parent also needs updation
		DECLARE @ParentID Int;
		SELECT @ParentID = ParentID FROM {databaseOwner}[{objectQualifier}Folders] WHERE FolderID=@FolderID
		IF(@ParentID>0)
		BEGIN
			EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @ParentID
		END
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSkinControlByKey]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSkinControlByKey]
	@ControlKey	nvarchar(50)
AS
    SELECT *
    FROM   {databaseOwner}{objectQualifier}SkinControls
	WHERE ControlKey = @ControlKey
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRelationshipType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRelationshipType] @RelationshipTypeID INT
AS 
    SELECT  RelationshipTypeID,
            Direction,
            Name ,            
            Description,
            CreatedByUserID ,
            CreatedOnDate ,
            LastModifiedByUserID ,
            LastModifiedOnDate
    FROM    {databaseOwner}{objectQualifier}RelationshipTypes    
	WHERE RelationshipTypeID = @RelationshipTypeID
	ORDER BY RelationshipTypeID ASC
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModulePermissionsByTabID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModulePermissionsByTabID]
    @TabId Int -- Not Null!
AS
    SELECT MP.*
    FROM        {databaseOwner}[{objectQualifier}Tabs]                 AS T
    INNER JOIN  {databaseOwner}[{objectQualifier}TabModules]           AS TM ON TM.TabID    = T.TabID
    INNER JOIN  {databaseOwner}[{objectQualifier}vw_ModulePermissions] AS MP ON TM.ModuleID = MP.ModuleID AND T.PortalID = MP.PortalID
    WHERE T.TabID = @TabId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_MarkToastSent]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_MarkToastSent]	
    @MessageId int,
	@UserId INT
AS
BEGIN	
    UPDATE {databaseOwner}{objectQualifier}CoreMessaging_MessageRecipients
    SET Sendtoast = 0,
    [LastModifiedOnDate] = GETDATE()
    WHERE MessageId = @MessageId
	AND UserId = @UserId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteIPFilter]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteIPFilter]
	@IPFilterID	int
AS 
	BEGIN
		DELETE FROM {databaseOwner}{objectQualifier}IPFilter  
			WHERE IPFilterID = @IPFilterID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddFile]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddFile]
	@PortalId   int,
	@UniqueId   uniqueidentifier,
	@VersionGuid  uniqueidentifier,
	@FileName   nvarchar(246),
	@Extension   nvarchar(100),
	@Size    int,
	@Width    int,
	@Height    int,
	@ContentType  nvarchar(200),
	@Folder    nvarchar(246),
	@FolderID   int,
	@CreatedByUserID   int,
	@Hash     varchar(40),
	@LastModificationTime	datetime, 
	@Title					nvarchar(256),
	@EnablePublishPeriod	bit,
	@StartDate				datetime,
	@EndDate				datetime,
	@ContentItemID			int
AS
BEGIN
	
	SET NOCOUNT OFF;
	DECLARE @FileID int

	UPDATE {databaseOwner}[{objectQualifier}Files]
	SET
		/* retrieves FileId from table */
		@FileID = FileId,
		FileName = @FileName,
		VersionGuid = @VersionGuid,
		Extension = @Extension,
		Size = @Size,
		Width = @Width,
		Height = @Height,
		ContentType = @ContentType,
		FolderID = @FolderID,
		LastModifiedByUserID = @CreatedByUserID,
		LastModifiedOnDate = getdate(),
		SHA1Hash = @Hash,
		LastModificationTime = @LastModificationTime, 
		Title = @Title,
		EnablePublishPeriod = @EnablePublishPeriod,
		StartDate = @StartDate,
		EndDate = @EndDate,
		ContentItemID = @ContentItemID
	WHERE
		FolderID = @FolderID AND FileName = @FileName
	
	DECLARE @RowCount int = @@ROWCOUNT;
	IF @RowCount = 0
	BEGIN
	INSERT INTO {databaseOwner}[{objectQualifier}Files] (
		PortalId,
		UniqueId,
		VersionGuid,
		FileName,
		Extension,
		Size,
		Width,
		Height,
		ContentType,
		FolderID,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate,
		SHA1Hash,
		LastModificationTime, 
		Title,
		EnablePublishPeriod,
		StartDate,
		EndDate,
		ContentItemID
	)
	VALUES (
		@PortalId,
		@UniqueId,
		@VersionGuid,
		@FileName,
		@Extension,
		@Size,
		@Width,
		@Height,
		@ContentType,
		@FolderID,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate(),
		@Hash,
		@LastModificationTime, 
		@Title,
		@EnablePublishPeriod,
		@StartDate,
		@EndDate,
		@ContentItemID
	)
	SELECT @FileID = SCOPE_IDENTITY()
	END

	--UPDATE THE PARENT FOLDERS UPDATED DATE TO LATEST DATE
	IF((@RowCount>0 OR @@ROWCOUNT>0) AND @FolderID IS NOT NULL)
	BEGIN
		EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @FolderID
	END
	
	SELECT @FileID

END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetHostSetting]'
GO
create procedure {databaseOwner}[{objectQualifier}GetHostSetting]

@SettingName nvarchar(50)

as

select SettingValue
from {databaseOwner}{objectQualifier}HostSettings
where  SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModulePermissionsByPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModulePermissionsByPortal]
    @PortalId Int -- Not Null!
AS
    SELECT *
    FROM {databaseOwner}[{objectQualifier}vw_ModulePermissions]
    WHERE PortalID = @PortalID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSearchCommonWordByID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSearchCommonWordByID]
	@CommonWordID int
	
AS

SELECT
	[CommonWordID],
	[CommonWord],
	[Locale]
FROM
	{databaseOwner}{objectQualifier}SearchCommonWords
WHERE
	[CommonWordID] = @CommonWordID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetIPFilters]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetIPFilters]

AS 
	SELECT * FROM {databaseOwner}{objectQualifier}IPFilter
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTabModuleSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTabModuleSetting]
	@TabModuleId   		int,
	@SettingName   		nvarchar(50),
	@SettingValue  		nvarchar(max),
	@CreatedByUserID  	int
AS
	INSERT INTO {databaseOwner}{objectQualifier}TabModuleSettings ( 
		TabModuleId,
		SettingName, 
		SettingValue,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	) 
	VALUES ( 
		@TabModuleId,
		@SettingName, 
		@SettingValue,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddFolder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddFolder]
	@PortalID 			int,
	@UniqueId	 		uniqueidentifier,
	@VersionGuid 		uniqueidentifier,
	@FolderPath 		nvarchar(300),
	@MappedPath 		nvarchar(300),
	@StorageLocation 	int,
	@IsProtected 		bit,
	@IsCached 			bit,
	@LastUpdated 		datetime,
	@CreatedByUserID  	int,
	@FolderMappingID	int = 0,
	@IsVersioned		bit = 0,
	@WorkflowID			int = NULL,
	@ParentID			int = NULL
AS
BEGIN
	IF @FolderMappingID = 0 BEGIN
		SELECT @FolderMappingID = FM.FolderMappingID
		FROM {databaseOwner}[{objectQualifier}FolderMappings] as FM
		WHERE ISNULL(FM.PortalID, -1) = ISNULL(@PortalID, -1)
		AND FolderProviderType = (
			CASE @StorageLocation
				WHEN 0 THEN 'StandardFolderProvider'
				WHEN 1 THEN 'SecureFolderProvider'
				WHEN 2 THEN 'DatabaseFolderProvider'
				ELSE 'StandardFolderProvider'
			END
		)
	END
	
	SET NOCOUNT OFF;
	INSERT INTO {databaseOwner}[{objectQualifier}Folders] (
		PortalID, 
		UniqueId,
		VersionGuid,
		FolderPath,
		MappedPath, 
		StorageLocation, 
		IsProtected, 
		IsCached, 
		LastUpdated,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate,
		FolderMappingID,
		IsVersioned,
		WorkflowID,
		ParentID
	)
	VALUES (
		@PortalID, 
		@UniqueId,
		@VersionGuid,
		@FolderPath,
		@MappedPath, 
		@StorageLocation, 
		@IsProtected, 
		@IsCached, 
		@LastUpdated,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate(),
		@FolderMappingID,
		@IsVersioned,
		@WorkflowID,
		@ParentID
	)
	--UPDATE THE PARENT FOLDERS UPDATED DATE TO LASTET DATE
	IF(@@ROWCOUNT>0 AND @ParentID IS NOT NULL)
	BEGIN
		EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @ParentID
	END

	DECLARE @FolderId INT
    SELECT @FolderId = SCOPE_IDENTITY()
    SELECT @FolderId
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentWorkflowStateUsageCount]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentWorkflowStateUsageCount]
	@StateId INT
AS
	SELECT COUNT(ci.ContentItemID)
	FROM {databaseOwner}[{objectQualifier}ContentItems] ci 
	WHERE ci.StateId = @StateId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModulePermissionsByModuleID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModulePermissionsByModuleID]
    @ModuleId       Int,   -- Null|-1 for all modules
    @PermissionId   Int    -- Null|-1 for all permissions
AS
BEGIN
	IF (IsNull(@ModuleId, -1) = -1) -- separate branches with individual query optimization
		SELECT *
		  FROM {databaseOwner}[{objectQualifier}vw_ModulePermissions]
		 WHERE (PermissionID = @PermissionId OR IsNull(@PermissionId, -1) = -1)
	 ELSE
		SELECT *
		FROM {databaseOwner}[{objectQualifier}vw_ModulePermissions]
		WHERE ((ModuleID = @ModuleId) OR (ModuleID IS NULL AND PermissionCode = 'SYSTEM_MODULE_DEFINITION'))
		AND (PermissionID = @PermissionId OR IsNull(@PermissionId, -1) = -1)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentItemsByContentType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentItemsByContentType] 
	@ContentTypeId int
AS
	SELECT * FROM {databaseOwner}{objectQualifier}ContentItems WHERE ContentTypeID = @ContentTypeId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDesktopModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDesktopModules]
AS
	SELECT *
	FROM  {databaseOwner}{objectQualifier}vw_DesktopModules
	ORDER BY FriendlyName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSkinControl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSkinControl]
	@SkinControlId int
AS
    DELETE
    FROM   {databaseOwner}{objectQualifier}SkinControls
    WHERE  SkinControlId = @SkinControlId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFile]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFile]	
    @PortalID int,
	@FileName nvarchar(246),
	@FolderID int
AS
BEGIN
	SET NOCOUNT OFF;
    IF @PortalID is null
    BEGIN
        DELETE FROM {databaseOwner}[{objectQualifier}Files] WHERE FileName = @FileName AND FolderID = @FolderID AND PortalId IS Null
    END 
	ELSE 
	BEGIN
        DELETE FROM {databaseOwner}[{objectQualifier}Files] WHERE FileName = @FileName AND FolderID = @FolderID AND PortalId = @PortalID
    END
	
	--UPDATE THE PARENT FOLDERS UPDATED DATE TO LASTET DATE
	IF(@@ROWCOUNT>0 AND @FolderID IS NOT NULL)
	BEGIN
		EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @FolderID
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUrlTracking]'
GO
create procedure {databaseOwner}[{objectQualifier}GetUrlTracking]

@PortalID     int,
@Url          nvarchar(255),
@ModuleId     int

as

select *
from   {databaseOwner}{objectQualifier}UrlTracking
where  PortalID = @PortalID
and    Url = @Url
and    ((ModuleId = @ModuleId) or (ModuleId is null and @ModuleId is null))
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetScheduleItemSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetScheduleItemSettings] 
@ScheduleID int
AS
SELECT *
FROM {databaseOwner}{objectQualifier}ScheduleItemSettings
WHERE ScheduleID = @ScheduleID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFolderPermissionsByUserID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFolderPermissionsByUserID]
    @PortalId Int,  -- Null|-1 for Host menu tabs
    @UserId   Int   -- Not Null
AS
    DELETE FROM {databaseOwner}[{objectQualifier}FolderPermission]
    WHERE UserID = @UserId
     AND FolderID IN (SELECT FolderID FROM {databaseOwner}[{objectQualifier}Folders] 
	                  WHERE (PortalID = @PortalId Or IsNull(@PortalId, -1) = IsNull(PortalID, -1)))
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateModuleOrder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateModuleOrder]
	@TabId              int,
	@ModuleId           int,
	@ModuleOrder        int,
	@PaneName           nvarchar(50)
AS
	UPDATE {databaseOwner}{objectQualifier}TabModules
		SET	ModuleOrder = @ModuleOrder,
			PaneName = @PaneName,
			VersionGuid = newId()
	WHERE TabId = @TabId
		AND ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}PackageTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}PackageTypes]
(
[PackageType] [nvarchar] (100) NOT NULL,
[Description] [nvarchar] (500) NOT NULL,
[SecurityAccessLevel] [int] NOT NULL,
[EditorControlSrc] [nvarchar] (250) NULL,
[SupportsSideBySideInstallation] [bit] NOT NULL DEFAULT ((0))
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}PackageTypes_1] on {databaseOwner}[{objectQualifier}PackageTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PackageTypes] ADD CONSTRAINT [PK_{objectQualifier}PackageTypes_1] PRIMARY KEY CLUSTERED  ([PackageType])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPackageTypes]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPackageTypes]
AS
	SELECT * FROM {databaseOwner}{objectQualifier}PackageTypes
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_DeleteNotification]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_DeleteNotification]
	@NotificationID int
AS
BEGIN
	DELETE
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_Messages]
	WHERE [MessageID] = @NotificationID AND [NotificationTypeID] IS NOT NULL
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_SaveMessageAttachment]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_SaveMessageAttachment]
    @MessageAttachmentID int,
    @MessageID int,
    @FileID int,
	@CreateUpdateUserID INT
AS
    IF ( @MessageAttachmentID = -1 )
        BEGIN
            INSERT {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments(
					[FileID],
					[MessageID],
                    [CreatedByUserID],
                    [CreatedOnDate],
                    [LastModifiedByUserID],
                    [LastModifiedOnDate]
                    )
            VALUES  (
					@FileID,
					@MessageID,
                    @CreateUpdateUserID , -- CreatedBy - int
                    GETDATE() , -- CreatedOn - datetime
                    @CreateUpdateUserID , -- LastModifiedBy - int
                    GETDATE() -- LastModifiedOn - datetime
                    )

            SELECT  @MessageAttachmentID = SCOPE_IDENTITY()
        END
    ELSE
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments
            SET     [FileID] = @FileID,
					[MessageID] = @MessageID,
                    LastModifiedByUserID = @CreateUpdateUserID,
                    LastModifiedOnDate = GETDATE()
            WHERE   MessageAttachmentID = @MessageAttachmentID
        END

    SELECT  @MessageAttachmentID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFiles]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFiles]	
    @PortalID int
AS
BEGIN
    SET NOCOUNT OFF;
	DECLARE @FolderID int;

    IF @PortalID is null
    BEGIN
		SELECT TOP 1 @FolderID=FolderID FROM {databaseOwner}[{objectQualifier}Files] WHERE PortalId is null
        DELETE FROM {databaseOwner}[{objectQualifier}Files] WHERE PortalId is null
    END 
	ELSE 
	BEGIN
		SELECT TOP 1 @FolderID=FolderID FROM {databaseOwner}[{objectQualifier}Files] WHERE PortalId = @PortalID
        DELETE FROM {databaseOwner}[{objectQualifier}Files] WHERE PortalId = @PortalID
    END

	--UPDATE THE PARENT FOLDERS UPDATED DATE TO LASTET DATE
	IF(@@ROWCOUNT>0 AND @FolderID IS NOT NULL)
	BEGIN
		EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @FolderID
	END

END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFolderPermissionsByFolderPath]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFolderPermissionsByFolderPath]
    @PortalId   Int,            -- Null for Host menu tabs
    @FolderPath nVarChar(300)   -- must be a valid path
AS
BEGIN
    DELETE FROM {databaseOwner}[{objectQualifier}FolderPermission]
    WHERE FolderID IN (SELECT FolderID FROM {databaseOwner}[{objectQualifier}Folders]
                                       WHERE FolderPath = @FolderPath AND (IsNull(PortalID, -1) = IsNull(@PortalId, -1)))
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSkinControls]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSkinControls]
AS
    SELECT *
    FROM   {databaseOwner}{objectQualifier}SkinControls
	ORDER BY  ControlKey
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabSetting]
	@TabID					INT,
	@SettingName			NVARCHAR(50),
	@SettingValue			NVARCHAR(2000),
	@LastModifiedByUserID  	INT
AS

	UPDATE 	{databaseOwner}{objectQualifier}TabSettings
	SET 	SettingValue = @SettingValue,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = GETDATE()
	WHERE TabID = @TabID
		AND SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteFolder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteFolder]	
    @PortalID int,
    @FolderPath nvarchar(300)
AS
BEGIN
    SET NOCOUNT OFF;
	DECLARE @ParentID int;

	IF @PortalID is null
    BEGIN
		SELECT @ParentID=ParentID FROM {databaseOwner}[{objectQualifier}Folders] WHERE PortalID = @PortalID AND FolderPath = @FolderPath;
	    DELETE FROM {databaseOwner}[{objectQualifier}Folders] WHERE PortalID is null AND FolderPath = @FolderPath
    END 
	ELSE 
	BEGIN
		SELECT @ParentID=ParentID FROM {databaseOwner}[{objectQualifier}Folders] WHERE PortalID is null AND FolderPath = @FolderPath;
        DELETE FROM {databaseOwner}[{objectQualifier}Folders] WHERE PortalID = @PortalID AND FolderPath = @FolderPath
    END

	--UPDATE THE PARENT FOLDERS UPDATED DATE TO LASTET DATE
	IF(@@ROWCOUNT>0 AND @ParentID IS NOT NULL)
	BEGIN
		EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @ParentID
	END

END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddAuthentication]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddAuthentication]
	@PackageID				int,
	@AuthenticationType     nvarchar(100),
	@IsEnabled				bit,
	@SettingsControlSrc     nvarchar(250),
	@LoginControlSrc		nvarchar(250),
	@LogoffControlSrc		nvarchar(250),
	@CreatedByUserID	int
AS
	INSERT INTO {objectQualifier}Authentication (
		PackageID,
		AuthenticationType,
		IsEnabled,
		SettingsControlSrc,
		LoginControlSrc,
		LogoffControlSrc,
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate]
	)
	VALUES (
		@PackageID,
		@AuthenticationType,
		@IsEnabled,
		@SettingsControlSrc,
		@LoginControlSrc,
		@LogoffControlSrc,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabPermissionsByTabID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabPermissionsByTabID]
	@TabID int, 
	@PermissionID int
AS

	SELECT  *
	FROM    {databaseOwner}{objectQualifier}vw_TabPermissions
	WHERE   (TabID = @TabID OR (TabID IS NULL AND PermissionCode = 'SYSTEM_TAB'))
		AND	(PermissionID = @PermissionID OR @PermissionID = -1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_UpdateSubscriptionDescription]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_UpdateSubscriptionDescription]
	@ObjectKey NVARCHAR(255), 
    @PortalId INT,
    @Description NVARCHAR(255)	
AS 
	BEGIN
		UPDATE {databaseOwner}{objectQualifier}CoreMessaging_Subscriptions
		SET [Description] = @Description
		WHERE PortalId = @PortalId 
		AND ObjectKey LIKE @ObjectKey		
		SELECT @@ROWCOUNT AS [ResultStatus]      
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentItemsByModuleId]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentItemsByModuleId] 
	@ModuleId int
AS
	SELECT * FROM {databaseOwner}{objectQualifier}ContentItems WHERE ModuleID = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeletePortalGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeletePortalGroup]
	@PortalGroupID	int
AS 
	BEGIN
		DELETE FROM {databaseOwner}{objectQualifier}PortalGroups  
			WHERE PortalGroupID = @PortalGroupID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetRoleGroups]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetRoleGroups]
	@PortalID		int
AS
	SELECT *
		FROM {databaseOwner}{objectQualifier}RoleGroups
		WHERE  PortalId = @PortalID
		ORDER BY RoleGroupName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetAllTabsModules]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}GetAllTabsModules]
	@PortalID int,
	@AllTabs bit
AS
	SELECT	* 
	FROM {databaseOwner}{objectQualifier}vw_Modules M
	WHERE  M.PortalID = @PortalID 
		AND M.IsDeleted = 0
		AND M.AllTabs = @AllTabs
		AND M.TabModuleID =(SELECT min(TabModuleID) 
			FROM {databaseOwner}{objectQualifier}TabModules
			WHERE ModuleID = M.ModuleID)
	ORDER BY M.ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFile]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFile]
    @FileId                 Int,
    @VersionGuid            UniqueIdentifier,
    @FileName               nVarChar(246),
    @Extension              nVarChar(100),
    @Size                   Int,
    @Width                  Int,
    @Height                 Int,
    @ContentType            nVarChar(200),
    @FolderID               Int,
    @LastModifiedByUserID   Int,
    @Hash                   VarChar(40),
    @LastModificationTime   DateTime,
    @Title                  nVarChar(256),
    @EnablePublishPeriod    Bit,
    @StartDate              DateTime,
    @EndDate                DateTime,
    @ContentItemID          Int
AS
BEGIN
    SET NOCOUNT OFF;
    DECLARE @PortalID int;
    SELECT @PortalID = PortalID FROM {databaseOwner}[{objectQualifier}Folders] WHERE FolderID = @FolderID;
    UPDATE {databaseOwner}[{objectQualifier}Files]
     SET   FileName             = @FileName,
           VersionGuid          = @VersionGuid,
           Extension            = @Extension,
           Size                 = @Size,
           Width                = @Width,
           Height               = @Height,
           ContentType          = @ContentType,
           FolderID             = @FolderID,
           PortalID             = @PortalID,
           LastModifiedByUserID = @LastModifiedByUserID,
           LastModifiedOnDate   = GetDate(),
           SHA1Hash             = @Hash,
           LastModificationTime = @LastModificationTime,
           Title                = @Title,
           EnablePublishPeriod  = @EnablePublishPeriod,
           StartDate            = @StartDate,
           EndDate              = @EndDate,
           ContentItemID        = @ContentItemID
     WHERE FileId = @FileId
    
	--UPDATE THE PARENT FOLDERS UPDATED DATE TO LASTET DATE
	IF(@@ROWCOUNT>0 AND @FolderID IS NOT NULL)
	BEGIN
		EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @FolderID
	END

END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteRoleGroup]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteRoleGroup]

	@RoleGroupId      int
	
AS

DELETE  
FROM {databaseOwner}{objectQualifier}RoleGroups
WHERE  RoleGroupId = @RoleGroupId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessage]
    @MessageID INT
AS 
	SELECT [MessageID], [PortalId], [NotificationTypeID], [To], [From], [Subject], [Body], [ConversationID], [ReplyAllAllowed], [SenderUserID], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate] 
	FROM   {databaseOwner}[{objectQualifier}CoreMessaging_Messages] 
	WHERE  [MessageID] = @MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteRelationshipType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteRelationshipType] @RelationshipTypeID INT	
AS 
	BEGIN
		DELETE FROM {databaseOwner}{objectQualifier}RelationshipTypes  
			WHERE RelationshipTypeID = @RelationshipTypeID
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderPermissionsByPortal]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderPermissionsByPortal]
    @PortalId Int   -- Null|-1 for Host menu tabs
AS
    SELECT *
    FROM {databaseOwner}[{objectQualifier}vw_FolderPermissions]
    WHERE IsNull(PortalID, -1) = IsNull(@PortalId, -1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetFolderMappingsSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetFolderMappingsSettings]
	@FolderMappingID int
AS
BEGIN
	SELECT SettingName, SettingValue
	FROM {databaseOwner}[{objectQualifier}FolderMappingsSettings]
	WHERE FolderMappingID = @FolderMappingID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateModuleSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateModuleSetting]
	@ModuleId				int,
	@SettingName			nvarchar(50),
	@SettingValue			nvarchar(max),
	@LastModifiedByUserID  	int
AS
	UPDATE 	{databaseOwner}{objectQualifier}ModuleSettings
		SET 	SettingValue = @SettingValue,
				LastModifiedByUserID = @LastModifiedByUserID,
				LastModifiedOnDate = getdate()
		WHERE ModuleId = @ModuleId
		AND SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFolder]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFolder]
	@PortalID 				int,
	@VersionGuid 			uniqueidentifier,	
	@FolderID 				int,
	@FolderPath 			nvarchar(300),
	@MappedPath 			nvarchar(300),
	@StorageLocation 		int,
	@IsProtected 			bit,
	@IsCached 				bit,
	@LastUpdated 			datetime,
	@LastModifiedByUserID  	int,
	@FolderMappingID		int,
	@IsVersioned			bit = 0,
	@WorkflowID				int = NULL,
	@ParentID				int = NULL
AS
BEGIN
	SET NOCOUNT OFF;
	UPDATE {databaseOwner}[{objectQualifier}Folders]
	SET
		FolderPath = @FolderPath,
		MappedPath = @MappedPath,
		VersionGuid = @VersionGuid,
		StorageLocation = @StorageLocation,
		IsProtected = @IsProtected,
		IsCached = @IsCached,
		LastUpdated = @LastUpdated,
		LastModifiedByUserID = @LastModifiedByUserID,
		LastModifiedOnDate = getdate(),
		FolderMappingID = @FolderMappingID,
		IsVersioned = @IsVersioned,
		WorkflowID = @WorkflowID,
		ParentID = @ParentID
	WHERE FolderID = @FolderID
	
	--UPDATE THE PARENT FOLDERS UPDATED DATE TO LASTET DATE
	IF(@@ROWCOUNT>0 AND @ParentID IS NOT NULL)
	BEGIN
		EXEC {databaseOwner}[{objectQualifier}UpdateFolderModifiedOnToCurrentDate] @ParentID
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSearchCommonWord]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddSearchCommonWord]
	@CommonWord nvarchar(255),
	@Locale nvarchar(10)
AS

INSERT INTO {databaseOwner}{objectQualifier}SearchCommonWords (
	[CommonWord],
	[Locale]
) VALUES (
	@CommonWord,
	@Locale
)

select SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddDesktopModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddDesktopModulePermission]
    @PortalDesktopModuleID Int, -- not null!
    @PermissionId          Int, -- not null!
    @RoleId                Int, -- might be negative for virtual roles
    @AllowAccess           Bit, -- false: deny, true: grant
    @UserId                Int, -- -1 is replaced by Null
    @CreatedByUserId       Int  -- -1 is replaced by Null
AS
BEGIN
    INSERT INTO {databaseOwner}[{objectQualifier}DesktopModulePermission] (
        [PortalDesktopModuleID],
        [PermissionID],
        [RoleID],
        [AllowAccess],
        [UserID],
        [CreatedByUserID],
        [CreatedOnDate],
        [LastModifiedByUserID],
        [LastModifiedOnDate]
    ) VALUES (
        @PortalDesktopModuleID,
        @PermissionID,
        @RoleId,
        @AllowAccess,
        CASE WHEN @UserId = -1 THEN Null ELSE @UserId END,
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate(),
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate()
    )
    SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}fn_CompareVersion]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}fn_CompareVersion]
(
	@Version		nvarchar(20),
	@CurrentVersion nvarchar(20)
)
RETURNS int

AS
	BEGIN
	
		DECLARE @Pos int
		DECLARE @String nvarchar(20)
		DECLARE @MajorVersion int
		DECLARE @MajorCurrentVersion int
		DECLARE @MinorVersion int
		DECLARE @MinorCurrentVersion int
		DECLARE @BuildVersion int
		DECLARE @BuildCurrentVersion int

		SET @String = @Version
		SET @Pos = CHARINDEX('.' , @String)
		SET @MajorVersion = CONVERT(int, LEFT(@String, @Pos - 1))
		SET @String = STUFF(@String, 1, @Pos, '')
		SET @Pos = CHARINDEX('.' , @String)
		SET @MinorVersion = CONVERT(int, LEFT(@String, @Pos - 1))
		SET @String = STUFF(@String, 1, @Pos, '')
		SET @BuildVersion = CONVERT(int, @String)
		
		SET @String = @CurrentVersion
		SET @Pos = CHARINDEX('.' , @String)
		SET @MajorCurrentVersion = CONVERT(int, LEFT(@String, @Pos - 1))
		SET @String = STUFF(@String, 1, @Pos, '')
		SET @Pos = CHARINDEX('.' , @String)
		SET @MinorCurrentVersion = CONVERT(int, LEFT(@String, @Pos - 1))
		SET @String = STUFF(@String, 1, @Pos, '')
		SET @BuildCurrentVersion = CONVERT(int, @String)
		
		IF @CurrentVersion IS NULL
			-- Assembly Not Registered -  Set ReturnCode = 0, so assembly is copied
			RETURN 0
		ELSE
			IF @Version = @CurrentVersion
				-- Same Version - Set ReturnCode = 2, so assembly is only copied on repair
				RETURN 2
			ELSE
				-- Different Version
				-- Compare Major, Minor, Revision
				IF @MajorVersion > @MajorCurrentVersion
					OR (@MajorVersion = @MajorCurrentVersion AND @MinorVersion > @MinorCurrentVersion)
						OR (@MajorVersion = @MajorCurrentVersion AND @MinorVersion = @MinorCurrentVersion AND @BuildVersion > @BuildCurrentVersion)
					-- Newer version - at least on of Major, Minor, Revision is larger - Set ReturnCode = 1, so assembly is copied
					RETURN 1
				ELSE
					-- Older Version - Set ReturnCode = 3, so assembly is not copied
					RETURN 3

		RETURN 3
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}RegisterAssembly]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}RegisterAssembly]
	@PackageID      int,
	@AssemblyName   nvarchar(250),
	@Version		nvarchar(20)
As
	DECLARE @AssemblyID int
	DECLARE @CurrentVersion nvarchar(20)
	/*	@ReturnCode Values
		0 - Assembly Does not Exist
		1 - Older Version of Assembly Exists
		2 - Assembly Already Registered - Version = CurrentVersion
		3 - Assembly Already Registered - Version < CurrentVersion
	*/
	DECLARE @CompareVersion int

	-- First check if this assembly is registered to this package
	SET @AssemblyID = (SELECT AssemblyID 
							FROM {databaseOwner}{objectQualifier}Assemblies
							WHERE PackageID = @PAckageID
								AND AssemblyName = @AssemblyName)

	IF @AssemblyID IS NULL
		BEGIN
			-- AssemblyID is null (not registered) 
			-- but assembly may be registerd by other packages so check for Max unstalled version
			SET @CurrentVersion  = (SELECT Max(Version )
										FROM {databaseOwner}{objectQualifier}Assemblies
										WHERE AssemblyName = @AssemblyName)

			SET @CompareVersion = {databaseOwner}{objectQualifier}fn_CompareVersion(@Version, @CurrentVersion)
			
			-- Add an assembly regsitration for this package
			INSERT INTO {databaseOwner}{objectQualifier}Assemblies (
				PackageID,
				AssemblyName,
				Version
			)
			VALUES (
				@PackageID,
				@AssemblyName,
				@Version
			)
		END
	ELSE
		BEGIN
			-- AssemblyID is not null - Assembly is registered - test for version
			SET @CurrentVersion  = (SELECT Version 
										FROM {databaseOwner}{objectQualifier}Assemblies
										WHERE AssemblyID = @AssemblyID)
			
			SET @CompareVersion = {databaseOwner}{objectQualifier}fn_CompareVersion(@Version, @CurrentVersion)
			
			IF @CompareVersion = 1
				BEGIN
					-- Newer version - Update Assembly registration
					UPDATE {databaseOwner}{objectQualifier}Assemblies
					SET    Version = @Version
					WHERE  AssemblyID = @AssemblyID
				END
		END

	SELECT @CompareVersion
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddUrl]'
GO
create procedure {databaseOwner}[{objectQualifier}AddUrl]

@PortalID     int,
@Url          nvarchar(255)

as

insert into {databaseOwner}{objectQualifier}Urls (
  PortalID,
  Url
)
values (
  @PortalID,
  @Url
)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteJavaScriptLibrary]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteJavaScriptLibrary]
	@JavaScriptLibraryID INT
AS
	DELETE FROM {databaseOwner}[{objectQualifier}JavaScriptLibraries]
	WHERE JavaScriptLibraryID = @JavaScriptLibraryID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetModules]

	@PortalID int
	
AS
SELECT	* 
FROM {databaseOwner}{objectQualifier}vw_Modules
WHERE  PortalId = @PortalID
ORDER BY ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateModuleControl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateModuleControl]
	@ModuleControlId				int,
	@ModuleDefID					int,
	@ControlKey						nvarchar(50),
	@ControlTitle					nvarchar(50),
	@ControlSrc						nvarchar(256),
	@IconFile						nvarchar(100),
	@ControlType					int,
	@ViewOrder						int,
	@HelpUrl						nvarchar(200),
	@SupportsPartialRendering		bit,
	@SupportsPopUps					bit,
	@LastModifiedByUserID  			int

AS
	UPDATE {databaseOwner}{objectQualifier}ModuleControls
	SET    
		ModuleDefId = @ModuleDefId,
		ControlKey = @ControlKey,
		ControlTitle = @ControlTitle,
		ControlSrc = @ControlSrc,
		IconFile = @IconFile,
		ControlType = @ControlType,
		ViewOrder = ViewOrder,
		HelpUrl = @HelpUrl,
		SupportsPartialRendering = @SupportsPartialRendering,
		SupportsPopUps = @SupportsPopUps,
		LastModifiedByUserID = @LastModifiedByUserID,
		LastModifiedOnDate = getdate()
	WHERE  ModuleControlId = @ModuleControlId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetNonExpiredUsersByRoleName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetNonExpiredUsersByRoleName]
	@PortalID	INT,
	@Rolename	NVARCHAR(50)
AS
	DECLARE @UserPortalId INT
	DECLARE @PortalGroupId INT
	SELECT @PortalGroupId = PortalGroupId FROM {databaseOwner}[{objectQualifier}Portals] WHERE PortalID = @PortalID
	IF EXISTS(SELECT PortalGroupID FROM {databaseOwner}[{objectQualifier}PortalGroups] WHERE PortalGroupID = @PortalGroupId)
	BEGIN
		SELECT @UserPortalId = MasterPortalID FROM {databaseOwner}[{objectQualifier}PortalGroups] WHERE PortalGroupID = @PortalGroupId
	END
	ELSE
	BEGIN
		SELECT @UserPortalId = @PortalID
	END
	SELECT     
		U.*, 
		UP.PortalId, 
		UP.Authorised, 
		UP.IsDeleted,
		UP.RefreshRoles,
		UP.VanityUrl
	FROM {databaseOwner}{objectQualifier}UserPortals AS UP 
			RIGHT OUTER JOIN {databaseOwner}{objectQualifier}UserRoles  UR 
			INNER JOIN {databaseOwner}{objectQualifier}Roles R ON UR.RoleID = R.RoleID 
			RIGHT OUTER JOIN {databaseOwner}{objectQualifier}Users AS U ON UR.UserID = U.UserID 
		ON UP.UserId = U.UserID	
	WHERE ( UP.PortalId = @UserPortalId OR @UserPortalId IS Null )
		AND (UP.IsDeleted = 0 OR UP.IsDeleted Is NULL)
		AND (R.RoleName = @Rolename)
		AND (R.PortalId = @PortalID OR @PortalID IS Null )
		AND (UR.ExpiryDate >= GETDATE() OR UR.ExpiryDate IS NULL)
	ORDER BY U.FirstName + ' ' + U.LastName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalDefaultLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalDefaultLanguage]

	@PortalId            int

AS
	SELECT defaultlanguage
		FROM {databaseOwner}{objectQualifier}Portals
		where portalid=@PortalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CreateNotificationType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CreateNotificationType]
	@Name nvarchar(100),
	@Description nvarchar(2000),
	@TTL int,
	@DesktopModuleId int,
	@CreatedUpdatedUserID int,
	@IsTask bit
AS
BEGIN
	INSERT INTO {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes] (
		[Name],
		[Description],
		[TTL],
		[DesktopModuleId],
		[CreatedByUserID],
		[CreatedOnDate],
		[LastModifiedByUserID],
		[LastModifiedOnDate],
		[IsTask]
	) VALUES (
		@Name,
		@Description,
		@TTL,
		@DesktopModuleId,
		@CreatedUpdatedUserID,
		GETDATE(),
		@CreatedUpdatedUserID,
		GETDATE(),
		@IsTask
	)
		
	SELECT SCOPE_IDENTITY()	
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSkinPackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSkinPackage]
	@PortalID   int,
	@SkinName   nvarchar(50),
	@SkinType   nvarchar(50)

AS
	SELECT *
		FROM  {databaseOwner}{objectQualifier}SkinPackages
		WHERE (PortalID = @PortalID OR @PortalID IS NULL Or PortalID IS Null)
			AND SkinName = @SkinName
			AND SkinType = @SkinType
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddFolderPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddFolderPermission]
    @FolderID           Int, -- not Null!
    @PermissionId       Int, -- not Null!
    @RoleId             Int, -- might be negative for virtual roles
    @AllowAccess        Bit, -- false: deny, true: grant
    @UserId             Int, -- -1 is replaced by Null
    @CreatedByUserId    Int  -- -1 is replaced by Null
AS
BEGIN
    INSERT INTO {databaseOwner}[{objectQualifier}FolderPermission] (
        [FolderID],
        [PermissionID],
        [RoleId],
        [AllowAccess],
        [UserId],
        [CreatedByUserId],
        [CreatedOnDate],
        [LastModifiedByUserId],
        [LastModifiedOnDate]
    ) VALUES (
        @FolderID,
        @PermissionID,
        @RoleId,
        @AllowAccess,
        CASE WHEN @UserId = -1 THEN Null ELSE @UserId END,
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate(),
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate()
    )
    SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetJavaScriptLibraries]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetJavaScriptLibraries]
AS
	SELECT * FROM {databaseOwner}{objectQualifier}JavaScriptLibraries
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageAttachment]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageAttachment]
    @MessageAttachmentID INT
AS
	SELECT [MessageID], [FileID], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM   {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments
	WHERE  [MessageAttachmentID] = @MessageAttachmentID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetUserByPasswordResetToken]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetUserByPasswordResetToken]
	@PortalID int,
	@PasswordResetToken UNIQUEIDENTIFIER

AS
	SELECT * FROM {databaseOwner}{objectQualifier}vw_Users
	WHERE  PasswordResetToken = @PasswordResetToken
		AND  ((@PortalId IS NULL) OR (PortalId = @PortalID) OR IsSuperUser = 1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateAuthentication]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateAuthentication]
	@AuthenticationID       int,
	@PackageID				int,
	@AuthenticationType     nvarchar(100),
	@IsEnabled				bit,
	@SettingsControlSrc     nvarchar(250),
	@LoginControlSrc		nvarchar(250),
	@LogoffControlSrc		nvarchar(250),
	@LastModifiedByUserID	int
AS
	UPDATE {databaseOwner}{objectQualifier}Authentication
	SET    PackageID = @PackageID,
		   AuthenticationType = @AuthenticationType,
		   IsEnabled = @IsEnabled,
		   SettingsControlSrc = @SettingsControlSrc,
		   LoginControlSrc = @LoginControlSrc,
		   LogoffControlSrc = @LogoffControlSrc,
		   [LastModifiedByUserID] = @LastModifiedByUserID,	
		   [LastModifiedOnDate] = getdate()
	WHERE  AuthenticationID = @AuthenticationID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationType]
	@NotificationTypeID int
AS
BEGIN
	SELECT [NotificationTypeID], [Name], [Description], [TTL], [DesktopModuleId], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate], [IsTask]
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]
	WHERE [NotificationTypeID] = @NotificationTypeID
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddModulePermission]
    @ModuleID           Int, -- not null!
    @PortalID           Int, -- not null!
    @PermissionId       Int, -- not null!
    @RoleId             Int, -- might be negative for virtual roles
    @AllowAccess        Bit, -- false: deny, true: grant
    @UserId             Int, -- -1 is replaced by Null
    @CreatedByUserId    Int  -- -1 is replaced by Null
AS
BEGIN
    INSERT INTO {databaseOwner}[{objectQualifier}ModulePermission] (
        [ModuleID],
        [PortalID],
        [PermissionID],
        [RoleId],
        [AllowAccess],
        [UserId],
        [CreatedByUserId],
        [CreatedOnDate],
        [LastModifiedByUserId],
        [LastModifiedOnDate]
    ) VALUES (
        @ModuleID,
        @PortalID,
        @PermissionID,
        @RoleId,
        @AllowAccess,
        CASE WHEN @UserId = -1 THEN Null ELSE @UserId END,
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate(),
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate()
    )
    SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddModule]
	@ContentItemID				int,
	@PortalID					int,
	@ModuleDefId				int,
	@AllTabs					bit,
	@StartDate					datetime,
	@EndDate					datetime,
	@InheritViewPermissions     bit,
	@IsShareable				bit,
	@IsShareableViewOnly		bit,
	@IsDeleted					bit,
	@CreatedByUserID  			int
	
AS
	INSERT INTO {databaseOwner}{objectQualifier}Modules (
		ContentItemID, 
		PortalId,
		ModuleDefId,
		AllTabs,
		StartDate,
		EndDate,
		InheritViewPermissions,
		IsShareable,
		IsShareableViewOnly,
		IsDeleted,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	)
	VALUES (
		@ContentItemID,
		@PortalID,
		@ModuleDefId,
		@AllTabs,
		@StartDate,
		@EndDate,
		@InheritViewPermissions,
		@IsShareable,
		@IsShareableViewOnly,
		@IsDeleted,
		@CreatedByUserID,
		getdate(),
		@CreatedByUserID,
		getdate()
	)

	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}OutputCacheGetKeys]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}OutputCacheGetKeys]
	@ItemId Int
AS
BEGIN
    SELECT CacheKey
     FROM  {databaseOwner}{objectQualifier}OutputCache
     WHERE ItemId = @ItemId OR @ItemId IS NULL
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdatePortalDefaultLanguage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdatePortalDefaultLanguage]

	@PortalId            int,
	@CultureCode   nvarchar(50)
AS
	UPDATE {databaseOwner}{objectQualifier}Portals
		SET defaultlanguage=@CultureCode
		where portalid=@PortalId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeByName]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetNotificationTypeByName]
	@Name nvarchar(100)
AS
BEGIN
	SELECT [NotificationTypeID], [Name], [Description], [TTL], [DesktopModuleId], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate], [IsTask]
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]
	WHERE [Name] LIKE @Name
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddTabPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddTabPermission]
    @TabID              Int, -- not null!
    @PermissionId       Int, -- not null!
    @RoleId             Int, -- might be negative for virtual roles
    @AllowAccess        Bit, -- false: deny, true: grant
    @UserId             Int, -- -1 is replaced by Null
    @CreatedByUserId    Int  -- -1 is replaced by Null
AS
BEGIN
    INSERT INTO {databaseOwner}[{objectQualifier}TabPermission] (
        [TabID],
        [PermissionID],
        [RoleId],
        [AllowAccess],
        [UserId],
        [CreatedByUserId],
        [CreatedOnDate],
        [LastModifiedByUserId],
        [LastModifiedOnDate]
    ) VALUES (
        @TabID,
        @PermissionID,
        @RoleId,
        @AllowAccess,
        CASE WHEN @UserId = -1 THEN Null ELSE @UserId END,
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate(),
        CASE WHEN @CreatedByUserID = -1 THEN Null ELSE @CreatedByUserID END,
        GetDate()
    )
    SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_CountNotifications]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_CountNotifications]
	@UserID int,
	@PortalID INT
AS
BEGIN
	-- Return total notifications for user
	SELECT COUNT(*) AS TotalNotifications
	FROM {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] MR
	JOIN {databaseOwner}[{objectQualifier}CoreMessaging_Messages] M ON MR.MessageID = M.MessageID
	WHERE M.NotificationTypeId IS NOT NULL
	AND M.PortalID=@PortalID
	AND MR.UserID = @UserID
	AND (M.ExpirationDate IS NULL OR (M.ExpirationDate IS NOT NULL AND M.ExpirationDate > GETDATE())) -- Do not return expired notifications
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabModuleSetting]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabModuleSetting]
	@TabModuleId			int,
	@SettingName			nvarchar(50),
	@SettingValue			nvarchar(max),
	@LastModifiedByUserID	int

AS
	UPDATE {databaseOwner}{objectQualifier}TabModuleSettings
		SET    SettingValue = @SettingValue,
			   LastModifiedByUserID = @LastModifiedByUserID,
			   LastModifiedOnDate = getdate()
		WHERE  TabModuleId = @TabModuleId
		AND    SettingName = @SettingName
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabVersionDetailByModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteTabVersionDetailByModule]
	@ModuleId   INT
AS
DELETE FROM   {databaseOwner}{objectQualifier}TabVersionDetails
WHERE  ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateUrlTracking]'
GO
create procedure {databaseOwner}[{objectQualifier}UpdateUrlTracking]

@PortalID     int,
@Url          nvarchar(255),
@LogActivity  bit,
@TrackClicks  bit,
@ModuleId     int,
@NewWindow    bit

as

update {databaseOwner}{objectQualifier}UrlTracking
set    LogActivity = @LogActivity,
       TrackClicks = @TrackClicks,
       NewWindow = @NewWindow
where  PortalID = @PortalID
and    Url = @Url
and    ((ModuleId = @ModuleId) or (ModuleId is null and @ModuleId is null))
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSearchSettings]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSearchSettings]

	@ModuleID	int

AS
	SELECT     	settings.SettingName, 
				settings.SettingValue
	FROM	{databaseOwner}{objectQualifier}Modules m 
		INNER JOIN {databaseOwner}{objectQualifier}Portals p ON m.PortalID = p.PortalID 
		INNER JOIN {databaseOwner}{objectQualifier}PortalSettings settings ON p.PortalID = settings.PortalID
	WHERE   m.ModuleID = @ModuleID
		AND settings.SettingName LIKE 'Search%'
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateDesktopModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateDesktopModulePermission]
    @DesktopModulePermissionId Int, -- not null!
    @PortalDesktopModuleId     Int, -- not null!
    @PermissionId              Int, -- not null!
    @RoleId                    Int, -- might be negative for virtual roles
    @AllowAccess               Bit, -- false: deny, true: grant
    @UserId                    Int, -- -1 is replaced by Null
    @LastModifiedByUserId      Int  -- -1 is replaced by Null
AS
    UPDATE {databaseOwner}[{objectQualifier}DesktopModulePermission]
    SET
        [PortalDesktopModuleId] = @PortalDesktopModuleId,
        [PermissionId]          = @PermissionId,
        [RoleId]                = @RoleId,
        [AllowAccess]           = @AllowAccess,
        [UserId]                = CASE WHEN @UserId = -1 THEN Null ELSE @UserId  END,
        [LastModifiedByUserId]  = CASE WHEN @LastModifiedByUserId = -1 THEN Null ELSE @LastModifiedByUserId  END,
        [LastModifiedOnDate]    = GetDate()
    WHERE [DesktopModulePermissionId] = @DesktopModulePermissionId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPortalGroups]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPortalGroups]

AS 
	SELECT * FROM {databaseOwner}{objectQualifier}PortalGroups
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Get]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}Journal_Get]
    @PortalId INT,
    @CurrentUserId INT,
    @JournalId INT,
    @IncludeAllItems INT = 0,
    @IsDeleted INT = 0,
    @SecurityCheck BIT = 0
    AS
    DECLARE @RegisteredRoleId INT
	SELECT @RegisteredRoleId = RegisteredRoleId FROM {databaseOwner}[{objectQualifier}Portals] WHERE PortalID = @PortalId
    SELECT     j.JournalId, j.JournalTypeId, j.Title, j.Summary, j.UserId, j.DateCreated, j.DateUpdated, j.PortalId,
                j.ProfileId, j.GroupId, j.ObjectKey, j.AccessKey,
                "JournalOwner" = '<entity><id>' + CAST(p.UserId as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name></entity>',
                "JournalAuthor" = CASE WHEN ISNULL(a.UserId,-1) >0 THEN '<entity><id>' + CAST(a.UserId as nvarchar(150)) + '</id><name><![CDATA[' + a.DisplayName + ']]></name></entity>' ELSE '' END,
                "JournalOwnerId" = ISNULL(j.ProfileId,j.UserId),
                 jt.Icon, jt.JournalType,
                "Profile" = CASE WHEN j.ProfileId > 0 THEN '<entity><id>' + CAST(p.UserID as nvarchar(150)) + '</id><name><![CDATA[' + p.DisplayName + ']]></name><vanity></vanity></entity>' ELSE '' END,
				"SimilarCount" = (SELECT COUNT(JournalId) FROM {databaseOwner}{objectQualifier}Journal WHERE ContentItemId = j.ContentItemId AND JournalTypeId = j.JournalTypeId),
                jd.JournalXML, ContentItemId, j.ItemData, j.IsDeleted, j.CommentsDisabled, j.CommentsHidden
    FROM        {databaseOwner}[{objectQualifier}Journal] AS j
                INNER JOIN {databaseOwner}[{objectQualifier}Journal_Types] as jt ON jt.JournalTypeId = j.JournalTypeId
                INNER JOIN {databaseOwner}[{objectQualifier}Journal_Security] AS js ON js.JournalId = j.JournalId
                INNER JOIN {databaseOwner}[{objectQualifier}Journal_User_Permissions](@PortalId,@CurrentUserId, @RegisteredRoleId) as t ON t.seckey = js.SecurityKey OR @SecurityCheck = 0
                LEFT OUTER JOIN {databaseOwner}[{objectQualifier}Journal_Data] as jd on jd.JournalId = j.JournalId 
                LEFT OUTER JOIN {databaseOwner}[{objectQualifier}Users] AS p ON j.ProfileId = p.UserID 
                LEFT OUTER JOIN {databaseOwner}[{objectQualifier}Users] AS a ON j.UserId = a.UserID
    WHERE       ((@IncludeAllItems = 0) AND (j.JournalId = @JournalId AND j.IsDeleted = @IsDeleted)) 
                OR 
                ((@IncludeAllItems = 1) AND (j.JournalId = @JournalId))
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateSkinControl]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateSkinControl]
	
	@SkinControlID					int,
	@PackageID						int,
	@ControlKey						nvarchar(50),
	@ControlSrc						nvarchar(256),
	@SupportsPartialRendering		bit,
	@LastModifiedByUserID	int

AS
	UPDATE {databaseOwner}{objectQualifier}SkinControls
	SET    
		PackageID = @PackageID,
		ControlKey = @ControlKey,
		ControlSrc = @ControlSrc,
		SupportsPartialRendering = @SupportsPartialRendering,
 		[LastModifiedByUserID] = @LastModifiedByUserID,	
		[LastModifiedOnDate] = getdate()
	WHERE  SkinControlID = @SkinControlID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDuplicateEmailCount]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDuplicateEmailCount]
    @PortalId INT
AS 
	SELECT ISNULL((SELECT COUNT(*) TotalCount FROM {databaseOwner}[{objectQualifier}Users] U Inner Join {databaseOwner}[{objectQualifier}UserPortals] UP on UP.[UserId] = U.[UserId] WHERE UP.PortalId = @PortalId  GROUP BY U.[Email] HAVING COUNT(*) > 1), 0)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetContentItemsByTerm]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetContentItemsByTerm]
 @Term nvarchar(250)
AS
BEGIN
DECLARE @TermID int
  , @TermLeft int
  , @TermRight int
  , @VocabularyID int

 SELECT
  @TermID = TermID
  , @TermLeft = TermLeft
  , @TermRight = TermRight
  , @VocabularyID = VocabularyID
 FROM
  {databaseOwner}{objectQualifier}Taxonomy_Terms
 WHERE
  Name = @Term

 IF @TermLeft = 0 AND @TermRight = 0
 BEGIN
  -- Simple Term
  SELECT c.*
  FROM {databaseOwner}{objectQualifier}ContentItems As c
   INNER JOIN {databaseOwner}{objectQualifier}ContentItems_Tags ct ON ct.ContentItemID = c.ContentItemID
   INNER JOIN {databaseOwner}{objectQualifier}Taxonomy_Terms t ON t.TermID = ct.TermID
  WHERE t.TermID = @TermID
 END ELSE BEGIN
  -- Hierarchical Term
  SELECT c.*
  FROM {databaseOwner}{objectQualifier}ContentItems As c
   INNER JOIN {databaseOwner}{objectQualifier}ContentItems_Tags ct ON ct.ContentItemID = c.ContentItemID
   INNER JOIN {databaseOwner}{objectQualifier}Taxonomy_Terms t ON t.TermID = ct.TermID
  WHERE t.TermLeft >= @TermLeft
   AND t.TermRight <= @TermRight
   AND t.VocabularyID = @VocabularyID
 END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateFolderPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateFolderPermission]
    @FolderPermissionID     Int, -- not null!
    @FolderID               Int, -- not null!
    @PermissionId           Int, -- not null!
    @RoleId                 Int, -- might be negative for virtual roles
    @AllowAccess            Bit, -- false: deny, true: grant
    @UserId                 Int, -- -1 is replaced by Null
    @LastModifiedByUserId   Int  -- -1 is replaced by Null
AS
    UPDATE {databaseOwner}[{objectQualifier}FolderPermission] SET
        [FolderID]             = @FolderID,
        [PermissionID]         = @PermissionID,
        [RoleId]               = @RoleId,
        [AllowAccess]          = @AllowAccess,
        [UserId]               = CASE WHEN @UserId = -1 THEN Null ELSE @UserId  END,
        [LastModifiedByUserId] = CASE WHEN @LastModifiedByUserId = -1 THEN Null ELSE @LastModifiedByUserId  END,
        [LastModifiedOnDate]   = GetDate()
    WHERE
        [FolderPermissionID]   = @FolderPermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteTabPermissionsByUserID]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}DeleteTabPermissionsByUserID]
	@PortalID int,
	@UserID int
AS
	DELETE FROM {databaseOwner}{objectQualifier}TabPermission
		FROM {databaseOwner}{objectQualifier}TabPermission TP
			INNER JOIN {databaseOwner}{objectQualifier}Tabs AS T ON TP.TabID = T.TabID
		WHERE T.PortalID = @PortalID
		AND TP.UserID = @UserID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddSkinPackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddSkinPackage]
	@PackageID  int,
	@PortalID   int,
	@SkinName   nvarchar(50),
	@SkinType   nvarchar(20),
	@CreatedByUserID	int
AS
	INSERT INTO {databaseOwner}{objectQualifier}SkinPackages (
	  PackageID,
	  PortalID,
	  SkinName,
	  SkinType,
	[CreatedByUserID],
	[CreatedOnDate],
	[LastModifiedByUserID],
	[LastModifiedOnDate]
	)
	VALUES (
	  @PackageID,
	  @PortalID,
	  @SkinName,
	  @SkinType,
	  @CreatedByUserID,
	  getdate(),
	  @CreatedByUserID,
	  getdate()
	)
	SELECT SCOPE_IDENTITY()
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageAttachmentsByMessage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}CoreMessaging_GetMessageAttachmentsByMessage]
    @MessageID INT
AS
	SELECT [MessageID], [FileID], [CreatedByUserID], [CreatedOnDate], [LastModifiedByUserID], [LastModifiedOnDate]
	FROM   {databaseOwner}{objectQualifier}CoreMessaging_MessageAttachments
	WHERE  [MessageID] = @MessageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetSingleUserByEmail]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetSingleUserByEmail]
    @PortalId INT,
	@Email nvarchar(255)
AS 
	SELECT ISNULL((SELECT TOP 1 U.UserId from {databaseOwner}[{objectQualifier}Users] U Inner Join {databaseOwner}[{objectQualifier}UserPortals] UP on UP.[UserId] = U.[UserId] Where U.Email = @Email and UP.[PortalId] = @PortalId), -1)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SaveRelationshipType]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}SaveRelationshipType]
    @RelationshipTypeID INT ,
    @Direction INT ,
    @Name NVARCHAR(50) ,
    @Description NVARCHAR(500) ,
    @UserID INT
AS 
    IF ( @RelationshipTypeID = -1 ) 
        BEGIN
            INSERT  {databaseOwner}{objectQualifier}RelationshipTypes
                    ( Direction,
                      Name ,            
                      Description,					
                      CreatedByUserID ,
                      CreatedOnDate ,
                      LastModifiedByUserID ,
                      LastModifiedOnDate
			        
                    )
            VALUES  ( @Direction , --  @Direction INT 
                      @Name , -- Name - nvarchar(50)
                      @Description , -- @Description NVARCHAR(500)
                      @UserID , -- CreatedBy - int
                      GETDATE() , -- CreatedOn - datetime
                      @UserID , -- LastModifiedBy - int
                      GETDATE() -- LastModifiedOn - datetime
			        
                    )
                    
            SELECT  @RelationshipTypeID = SCOPE_IDENTITY()
        END
    ELSE 
        BEGIN
            UPDATE  {databaseOwner}{objectQualifier}RelationshipTypes
            SET     Name = @Name ,
                    Direction = @Direction ,
                    Description = @Description ,
                    LastModifiedByUserID = @UserID ,
                    LastModifiedOnDate = GETDATE()
            WHERE   RelationshipTypeID = @RelationshipTypeID
        END
        
    SELECT  @RelationshipTypeID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateModulePermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateModulePermission]
    @ModulePermissionId     Int, -- not null!
    @PortalId               Int, -- not null!
    @ModuleId               Int, -- not null!
    @PermissionId           Int, -- not null!
    @RoleId                 Int, -- might be negative for virtual roles
    @AllowAccess            Bit, -- false: deny, true: grant
    @UserId                 Int, -- -1 is replaced by Null
    @LastModifiedByUserId   Int  -- -1 is replaced by Null
AS
    UPDATE {databaseOwner}[{objectQualifier}ModulePermission] SET
        [ModuleId]             = @ModuleId,
        [PortalId]             = @PortalId,
        [PermissionId]         = @PermissionId,
        [RoleId]               = @RoleId,
        [AllowAccess]          = @AllowAccess,
        [UserId]               = CASE WHEN @UserId = -1 THEN Null ELSE @UserId  END,
        [LastModifiedByUserId] = CASE WHEN @LastModifiedByUserId = -1 THEN Null ELSE @LastModifiedByUserId  END,
        [LastModifiedOnDate]   = GetDate()
    WHERE
        [ModulePermissionID]   = @ModulePermissionID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateDatabaseVersionAndName]'
GO
create procedure {databaseOwner}[{objectQualifier}UpdateDatabaseVersionAndName]

	@Major  int,
	@Minor  int,
	@Build  int,
	@Name	nvarchar(50)

AS

	INSERT INTO {databaseOwner}{objectQualifier}Version (
		Major,
		Minor,
		Build,
		[Name],
		CreatedDate
	)
		VALUES (
			@Major,
			@Minor,
			@Build,
			@Name,
			getdate()
		)
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetPackageDependencies]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetPackageDependencies]
AS
	SELECT * FROM {databaseOwner}[{objectQualifier}PackageDependencies]
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabByUniqueID]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabByUniqueID]
    @UniqueID   uniqueidentifier
AS
	SELECT	* 
	FROM	{databaseOwner}{objectQualifier}vw_Tabs
	WHERE	UniqueID = @UniqueID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteListEntryByID]'
GO
CREATE procedure {databaseOwner}[{objectQualifier}DeleteListEntryByID]

@EntryId   int,
@DeleteChild bit

as

Delete
From {databaseOwner}{objectQualifier}Lists
Where  [EntryID] = @EntryID

If @DeleteChild = 1
Begin
	Delete 
	From {databaseOwner}{objectQualifier}Lists
	Where [ParentID] = @EntryID
End
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateTabPermission]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateTabPermission]
    @TabPermissionId        Int, -- not null!
    @TabId                  Int, -- not null!
    @PermissionId           Int, -- not null!
    @RoleId                 Int, -- might be negative for virtual roles
    @AllowAccess            Bit, -- false: deny, true: grant
    @UserId                 Int, -- -1 is replaced by Null
    @LastModifiedByUserId   Int  -- -1 is replaced by Null
AS
    UPDATE {databaseOwner}[{objectQualifier}TabPermission] SET
        [TabID]                = @TabId,
        [PermissionID]         = @PermissionId,
        [RoleID]               = @RoleId,
        [AllowAccess]          = @AllowAccess,
        [UserID]               = CASE WHEN @UserId = -1 THEN Null ELSE @UserId  END,
        [LastModifiedByUserId] = CASE WHEN @LastModifiedByUserId = -1 THEN Null ELSE @LastModifiedByUserId  END,
        [LastModifiedOnDate]   = GetDate()
    WHERE
        [TabPermissionID]      = @TabPermissionId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSkinPackage]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSkinPackage]

	@SkinPackageID		int

AS
    DELETE
	    FROM	{databaseOwner}{objectQualifier}SkinPackages
	WHERE   SkinPackageID = @SkinPackageID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDeletedUsers]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDeletedUsers]
	@PortalID			int
AS
 IF @PortalID is null
  BEGIN
	SELECT  *
	FROM	{databaseOwner}{objectQualifier}vw_Users
	WHERE  PortalId IS Null
		AND IsDeleted = 1
	ORDER BY UserName
  END ELSE BEGIN
	SELECT  *
	FROM	{databaseOwner}{objectQualifier}vw_Users
	WHERE  PortalId = @PortalID		
		AND IsDeleted = 1
	ORDER BY UserName
  END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AddFolderMapping]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}AddFolderMapping]
	@PortalID int,
	@MappingName nvarchar(50),
	@FolderProviderType nvarchar(50),
	@CreatedByUserID int
AS
BEGIN
	DECLARE @Priority int

	SELECT TOP 1 @Priority = Priority + 1
	FROM {databaseOwner}[{objectQualifier}FolderMappings]
	WHERE [PortalID] = @PortalID
	ORDER BY Priority DESC

	INSERT INTO {databaseOwner}[{objectQualifier}FolderMappings] (
		PortalID,
		MappingName,
		FolderProviderType,
		Priority,
		CreatedByUserID,
		CreatedOnDate,
		LastModifiedByUserID,
		LastModifiedOnDate
	)
	VALUES (
		@PortalID,
		@MappingName,
		@FolderProviderType,
		@Priority,
		@CreatedByUserID,
		GETDATE(),
		@CreatedByUserID,
		GETDATE()
	)

	SELECT SCOPE_IDENTITY()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetTabModules]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetTabModules]
	@TabId int -- not null!
AS
BEGIN
	SELECT	* 
	FROM {databaseOwner}{objectQualifier}vw_TabModules
	WHERE  TabId = @TabId
	ORDER BY TabId, PaneName, ModuleOrder -- optimized for index used
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}UpdateModule]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}UpdateModule]
	@ModuleId					int,
    @ModuleDefId                int,
	@ContentItemID				int,
	@AllTabs					bit, 
	@StartDate					datetime,
	@EndDate					datetime,
	@InheritViewPermissions		bit,
	@IsShareable				bit,
	@IsShareableViewOnly		bit,
	@IsDeleted					bit,
	@LastModifiedByUserID  		int
	
AS
	UPDATE	{databaseOwner}{objectQualifier}Modules
		SET		
			ModuleDefId = @ModuleDefId,
            ContentItemID = @ContentItemID,
			AllTabs = @AllTabs,
			StartDate = @StartDate,
			EndDate = @EndDate,
			InheritViewPermissions = @InheritViewPermissions,
			IsShareable = @IsShareable,
			IsShareableViewOnly = @IsShareableViewOnly,
			IsDeleted = @IsDeleted,
			LastModifiedByUserID = @LastModifiedByUserID,
			LastModifiedOnDate = getdate()
	WHERE  ModuleId = @ModuleId
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}ContentWorkflowActions]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}ContentWorkflowActions]
(
[ActionId] [int] NOT NULL IDENTITY(1, 1),
[ContentTypeId] [int] NOT NULL,
[ActionType] [nvarchar] (50) NOT NULL,
[ActionSource] [nvarchar] (256) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}ContentWorkflowActions] on {databaseOwner}[{objectQualifier}ContentWorkflowActions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowActions] ADD CONSTRAINT [PK_{objectQualifier}ContentWorkflowActions] PRIMARY KEY CLUSTERED  ([ActionId])
GO
PRINT N'Creating index [ContentTypeId_ActionType] on {databaseOwner}[{objectQualifier}ContentWorkflowActions]'
GO
CREATE UNIQUE NONCLUSTERED INDEX [ContentTypeId_ActionType] ON {databaseOwner}[{objectQualifier}ContentWorkflowActions] ([ContentTypeId], [ActionType])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SiteLog]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SiteLog]
(
[SiteLogId] [int] NOT NULL IDENTITY(1, 1),
[DateTime] [smalldatetime] NOT NULL,
[PortalId] [int] NOT NULL,
[UserId] [int] NULL,
[Referrer] [nvarchar] (255) NULL,
[Url] [nvarchar] (255) NULL,
[UserAgent] [nvarchar] (255) NULL,
[UserHostAddress] [nvarchar] (255) NULL,
[UserHostName] [nvarchar] (255) NULL,
[TabId] [int] NULL,
[AffiliateId] [int] NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SiteLog] on {databaseOwner}[{objectQualifier}SiteLog]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SiteLog] ADD CONSTRAINT [PK_{objectQualifier}SiteLog] PRIMARY KEY CLUSTERED  ([SiteLogId])
GO
PRINT N'Creating index [IX_{objectQualifier}SiteLog] on {databaseOwner}[{objectQualifier}SiteLog]'
GO
CREATE NONCLUSTERED INDEX [IX_{objectQualifier}SiteLog] ON {databaseOwner}[{objectQualifier}SiteLog] ([PortalId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Taxonomy_VocabularyTypes]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Taxonomy_VocabularyTypes]
(
[VocabularyTypeID] [int] NOT NULL IDENTITY(1, 1),
[VocabularyType] [nvarchar] (50) NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Taxonomy_VocabularyType] on {databaseOwner}[{objectQualifier}Taxonomy_VocabularyTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_VocabularyTypes] ADD CONSTRAINT [PK_{objectQualifier}Taxonomy_VocabularyType] PRIMARY KEY CLUSTERED  ([VocabularyTypeID])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}AdjustedReferrer]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}AdjustedReferrer](
	@Referrer 	 nVarChar(2000),
	@PortalAlias nVarChar( 255)
	)
RETURNS nVarChar(2000)
AS
BEGIN
	RETURN CASE 
		WHEN @Referrer LIKE '%' + @PortalAlias + '%' THEN Null 
		ELSE @Referrer
	END
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}BrowserFromUserAgent]'
GO
CREATE FUNCTION {databaseOwner}[{objectQualifier}BrowserFromUserAgent]
	(@UserAgent nVarChar(2000))
RETURNS nVarChar(2000)
AS
BEGIN
	DECLARE @ident1		 nVarChar( 20) = '';
	DECLARE @ident2		 nVarChar( 20) = '';
	DECLARE @Browser     nVarChar(100) = '';
	DECLARE @Version	 nVarChar( 10) = '';
	DECLARE @Pos         Smallint = -1;
	DECLARE @End		 Smallint =  0;
	
	-- Detect Browser family (Name|Version Prefix):
	SET @Browser =	CASE
		WHEN @UserAgent LIKE '%Opera Mini/%'	THEN 'Opera Mini|Opera Mini/|Version/'
		WHEN @UserAgent LIKE '%Opera Mobi/%'	THEN 'Opera Mobile|Version/|Opera Mobi/'
		WHEN @UserAgent LIKE '%Opera/%'			THEN 'Opera|Version/|Opera/'
		WHEN @UserAgent LIKE '%Opera %'			THEN 'Opera|Opera '
		WHEN @UserAgent LIKE '%Opera'			THEN 'Opera|Opera'
		WHEN @UserAgent LIKE '%Firefox/%'		THEN 'Mozilla Firefox|Firefox/'
		WHEN @UserAgent LIKE '%Firebird/%'		THEN 'Mozilla Firebird|Firebird/'
		WHEN @UserAgent LIKE '%SeaMonkey/%'		THEN 'Mozilla SeaMonkey|SeaMonkey/'
		WHEN @UserAgent LIKE '%Kindle/%'		THEN 'Amazon Kindle|Kindle/'
		WHEN @UserAgent LIKE '%Kindle %'		THEN 'Amazon Kindle|Version/'
		WHEN @UserAgent LIKE '%Silk/%'			THEN 'Amazon Kindle|Version/'
		WHEN @UserAgent LIKE '%Chrome/%'		THEN 'Google Chrome|Chrome/'
		WHEN @UserAgent Like '%Blackberry'		THEN 'Blackberry|Mobile Safari/'
		WHEN @UserAgent LIKE '%Android%' 		THEN 'Android|Mobile Safari/'
		WHEN @UserAgent LIKE '%Safari/%'		THEN 'Apple Safari|Safari/'
		WHEN @UserAgent LIKE '%ChromePlus/%'	THEN 'ChromePlus|ChromePlus/'
		WHEN @UserAgent LIKE '%AOL %'			THEN 'AOL Browser|AOL '
		WHEN @USerAgent LIKE '%Crazy Browser %' THEN 'Crazy Browser|Crazy Browser '
		WHEN @USerAgent LIKE '%Maxthon/%'		THEN 'Maxthon|Maxthon/'
		WHEN @USerAgent LIKE '%IEMobile %'		THEN 'IE Mobile|IEMobile '
		WHEN @USerAgent LIKE '%IEMobile/%'		THEN 'IE Mobile|IEMobile/'
		WHEN @UserAgent LIKE '%MSIE %'      	THEN 'Internet Explorer|MSIE '
		WHEN @UserAgent LIKE '%(IE %'      		THEN 'Internet Explorer|(IE '
		WHEN @UserAgent LIKE '%Netscape/%' 		THEN 'Netscape Navigator|Netscape/'
		WHEN @UserAgent LIKE '%Navigator/%'		THEN 'Netscape Navigator|Navigator/'
		WHEN @UserAgent LIKE '%PLAYSTATION %' 	THEN 'Sony Playstation|PLAYSTATION '
		WHEN @UserAgent LIKE '%WGet/%'			THEN 'WGet|WGet/'
	END
	IF @Browser <> '' -- separate elements:
		SET @Pos = CharIndex('|', @Browser)
		IF @Pos > 0 BEGIN	
			SET @ident1  = SubString(@Browser, @Pos + 1, 100)
			SET @Browser = Left(@Browser, @Pos - 1)
			SET @Pos     = CharIndex('|', @ident1)
			IF  @Pos > 0 BEGIN
				SET @Ident2 = SubString(@Ident1, @Pos + 1, 100)
				SET @Ident1 = Left(@Ident1, @Pos - 1)
			END 
			-- get major version number from UserAgent string:
			SET @Pos = CharIndex(@ident1, @UserAgent) + Len(@ident1 + '|') - 1 -- correct to catch trailing space
			IF @Pos = 0 SET @Pos = CharIndex(@ident2, @UserAgent) + Len(@ident2 + '|') - 1 -- again
			IF @Pos > 0 BEGIN
				WHILE SubString(@UserAgent, @Pos + @End, 1) >= '0' AND SubString(@UserAgent, @Pos + @End, 1) <= 9
					SET @End = @End + 1
				IF @End > 0 SET @Version = SubString(@UserAgent, @Pos, @End)
			END
		END
	ELSE -- Search bots, ignore version
		SET @Browser = CASE 
		WHEN @UserAgent LIKE '%GoogleBot%'		THEN 'Google Bot'
		WHEN @UserAgent LIKE 'BingBot%'			THEN 'Bing Bot'
		WHEN @UserAgent LIKE 'MSNBot%'			THEN 'MSN Bot'
		WHEN @UserAgent LIKE '%BaiduSpider%'	THEN 'Baidu Spider'
		WHEN @UserAgent LIKE '%Arachmo%'		THEN 'Arachmo Bot'
		WHEN @UserAgent LIKE '%NewsGator%'		THEN 'NewsGator Bot'
		WHEN @UserAgent LIKE '%Seekbot%'		THEN 'SeekPort Bot'
		WHEN @UserAgent LIKE '%Yahoo%'			THEN 'Yahoo Bot'
		WHEN @UserAgent LIKE '%Yandex%'			THEN 'Yandex Bot'
		WHEN @UserAgent LIKE '%Bot%'			THEN 'Other Bot'
		ELSE 'Other'
	END
	RETURN RTRIM(@Browser + ' ' + @Version)
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SplitDelimitedIDs]'
GO
-- new helper function to return a table with id's, passed as a single string with delimiter
CREATE FUNCTION {databaseOwner}[{objectQualifier}SplitDelimitedIDs]
(
	@RecordIDList VarChar(2000),
	@Delimiter    VarChar(   2) = ','
)
RETURNS 
	@IntegerList Table (RecordID Int)
AS
	BEGIN
		DECLARE @RecordID VarChar(10)
		DECLARE @Start    Int        = 0
		DECLARE @Pos      Int        = 1

		SET @RecordIDList = @RecordIDList + @Delimiter
		SET @Pos = CHARINDEX(@Delimiter, @RecordIDList, 1)

		WHILE @Pos > 0 BEGIN
			SET @RecordID = LTRIM(RTRIM(SUBSTRING(@RecordIDList, @Start, @Pos - @Start)))
			IF @RecordID <> ''
				INSERT INTO @IntegerList (RecordID) VALUES (CAST(@RecordID AS Int)) -- use appropriate conversion
			SET @Start = @Pos + len(@Delimiter)
			SET @Pos = CHARINDEX(@Delimiter, @RecordIDList, @Start)
		END
		RETURN
	END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}TemplatedString]'
GO
-- added for easier string handling
CREATE FUNCTION {databaseOwner}[{objectQualifier}TemplatedString]
(
    @template nVarChar(3500), -- use tokens @1, @2, @3, @4, @5 to be replaced by param1 .. param5
    @param1   nVarChar( 100) = '', -- empty param values will just remove token!
	@param2	  nVarChar( 100) = '',
	@param3	  nVarChar( 100) = '',
	@param4	  nVarChar( 100) = '',
	@param5	  nVarChar( 100) = ''
)
	RETURNS   nVarChar(4000)
AS
BEGIN
    RETURN REPLACE(
			REPLACE(
			 REPLACE(
			  REPLACE(
			   REPLACE(IsNull(@template, ''), 
					   N'@1', IsNull(@param1,'')), 
					  N'@2', IsNull(@param2,'')), 
					 N'@3', IsNull(@param3,'')), 
					N'@4', IsNull(@param4,'')), 
				   N'@5', IsNull(@param5,''))
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}Journal_Access]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}Journal_Access]
(
[JournalAccessId] [int] NOT NULL IDENTITY(1, 1),
[JournalTypeId] [int] NOT NULL,
[PortalId] [int] NOT NULL,
[Name] [nvarchar] (50) NOT NULL,
[AccessKey] [uniqueidentifier] NOT NULL,
[IsEnabled] [bit] NOT NULL,
[DateCreated] [datetime] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}Journal_Access] on {databaseOwner}[{objectQualifier}Journal_Access]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Access] ADD CONSTRAINT [PK_{objectQualifier}Journal_Access] PRIMARY KEY CLUSTERED  ([JournalAccessId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}SQLQueries]'
GO
CREATE TABLE {databaseOwner}[{objectQualifier}SQLQueries]
(
[QueryId] [int] NOT NULL IDENTITY(1, 1),
[Name] [nvarchar] (200) NOT NULL,
[Query] [nvarchar] (max) NOT NULL,
[ConnectionStringName] [nvarchar] (50) NOT NULL,
[CreatedByUserId] [int] NOT NULL,
[CreatedOnDate] [datetime] NOT NULL,
[LastModifiedByUserId] [int] NOT NULL,
[LastModifiedOnDate] [datetime] NOT NULL
)
GO
PRINT N'Creating primary key [PK_{objectQualifier}SavedQueries] on {databaseOwner}[{objectQualifier}SQLQueries]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SQLQueries] ADD CONSTRAINT [PK_{objectQualifier}SavedQueries] PRIMARY KEY CLUSTERED  ([QueryId])
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}DeleteSearchWord]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}DeleteSearchWord]
	@SearchWordsID int
AS

DELETE FROM {databaseOwner}{objectQualifier}SearchWord
WHERE
	[SearchWordsID] = @SearchWordsID
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDatabaseServer]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDatabaseServer]
AS
	SELECT ServerProperty('Edition') AS ProductName,
           ServerProperty('ProductVersion') AS Version
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDatabaseTimeUtc]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDatabaseTimeUtc]
AS
BEGIN
	SELECT GETUTCDATE()
END
GO
PRINT N'Creating {databaseOwner}[{objectQualifier}GetDatabaseTime]'
GO
CREATE PROCEDURE {databaseOwner}[{objectQualifier}GetDatabaseTime]
AS
BEGIN
	SELECT GETDATE()
END
GO
PRINT N'Adding constraints to {databaseOwner}[{objectQualifier}UserRoles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRoles] WITH NOCHECK ADD CONSTRAINT [CK_{objectQualifier}UserRoles_RoleId] CHECK (([RoleId]>=(0)))
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Authentication]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Authentication] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Authentication_{objectQualifier}Packages] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentItems_MetaData]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems_MetaData] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ContentItems_MetaData_{objectQualifier}ContentItems] FOREIGN KEY ([ContentItemID]) REFERENCES {databaseOwner}[{objectQualifier}ContentItems] ([ContentItemID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems_MetaData] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ContentItems_MetaData{objectQualifier}MetaData] FOREIGN KEY ([MetaDataID]) REFERENCES {databaseOwner}[{objectQualifier}MetaData] ([MetaDataID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}CoreMessaging_Messages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Messages] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_Messages_{objectQualifier}CoreMessaging_NotificationTypes] FOREIGN KEY ([NotificationTypeID]) REFERENCES {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes] ([NotificationTypeID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}DesktopModulePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModulePermission] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}DesktopModulePermission_{objectQualifier}Permission] FOREIGN KEY ([PermissionID]) REFERENCES {databaseOwner}[{objectQualifier}Permission] ([PermissionID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ModuleDefinitions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModuleDefinitions] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ModuleDefinitions_{objectQualifier}DesktopModules] FOREIGN KEY ([DesktopModuleID]) REFERENCES {databaseOwner}[{objectQualifier}DesktopModules] ([DesktopModuleID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PortalDesktopModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalDesktopModules] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}PortalDesktopModules_{objectQualifier}DesktopModules] FOREIGN KEY ([DesktopModuleID]) REFERENCES {databaseOwner}[{objectQualifier}DesktopModules] ([DesktopModuleID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}DesktopModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModules] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}DesktopModules_{objectQualifier}Packages] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}EventLog]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}EventLog] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}EventLog_{objectQualifier}EventLogConfig] FOREIGN KEY ([LogConfigID]) REFERENCES {databaseOwner}[{objectQualifier}EventLogConfig] ([ID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}EventLog] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}EventLog_{objectQualifier}EventLogTypes] FOREIGN KEY ([LogTypeKey]) REFERENCES {databaseOwner}[{objectQualifier}EventLogTypes] ([LogTypeKey])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}EventLogConfig]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}EventLogConfig] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}EventLogConfig_{objectQualifier}EventLogTypes] FOREIGN KEY ([LogTypeKey]) REFERENCES {databaseOwner}[{objectQualifier}EventLogTypes] ([LogTypeKey])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}FolderMappingsSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderMappingsSettings] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}FolderMappingsSettings_{objectQualifier}FolderMappings] FOREIGN KEY ([FolderMappingID]) REFERENCES {databaseOwner}[{objectQualifier}FolderMappings] ([FolderMappingID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}FolderPermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderPermission] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}FolderPermission_{objectQualifier}Permission] FOREIGN KEY ([PermissionID]) REFERENCES {databaseOwner}[{objectQualifier}Permission] ([PermissionID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Journal_Data]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Data] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Journal_Data_Journal] FOREIGN KEY ([JournalId]) REFERENCES {databaseOwner}[{objectQualifier}Journal] ([JournalId]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Journal_Comments]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Comments] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}JournalComments_Journal] FOREIGN KEY ([JournalId]) REFERENCES {databaseOwner}[{objectQualifier}Journal] ([JournalId]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Journal]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Journal_JournalTypes] FOREIGN KEY ([JournalTypeId]) REFERENCES {databaseOwner}[{objectQualifier}Journal_Types] ([JournalTypeId])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}LanguagePacks]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}LanguagePacks] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}LanguagePacks_{objectQualifier}Packages] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PortalLanguages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalLanguages] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}PortalLanguages_{objectQualifier}PortalLanguages] FOREIGN KEY ([LanguageID]) REFERENCES {databaseOwner}[{objectQualifier}Languages] ([LanguageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ModulePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModulePermission] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ModulePermission_{objectQualifier}Modules] FOREIGN KEY ([ModuleID]) REFERENCES {databaseOwner}[{objectQualifier}Modules] ([ModuleID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModulePermission] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ModulePermission_{objectQualifier}Permission] FOREIGN KEY ([PermissionID]) REFERENCES {databaseOwner}[{objectQualifier}Permission] ([PermissionID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabModules] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}TabModules_{objectQualifier}Modules] FOREIGN KEY ([ModuleID]) REFERENCES {databaseOwner}[{objectQualifier}Modules] ([ModuleID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabModules] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}TabModules_{objectQualifier}Tabs] FOREIGN KEY ([TabID]) REFERENCES {databaseOwner}[{objectQualifier}Tabs] ([TabID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Packages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Packages] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Packages_{objectQualifier}PackageTypes] FOREIGN KEY ([PackageType]) REFERENCES {databaseOwner}[{objectQualifier}PackageTypes] ([PackageType]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}SkinControls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SkinControls] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}SkinControls_{objectQualifier}Packages] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}SkinPackages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SkinPackages] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}SkinPackages_{objectQualifier}Packages] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabPermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabPermission] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}TabPermission_{objectQualifier}Permission] FOREIGN KEY ([PermissionID]) REFERENCES {databaseOwner}[{objectQualifier}Permission] ([PermissionID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabPermission] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}TabPermission_{objectQualifier}Tabs] FOREIGN KEY ([TabID]) REFERENCES {databaseOwner}[{objectQualifier}Tabs] ([TabID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ProfilePropertyDefinition]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ProfilePropertyDefinition_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Tabs]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Tabs] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Tabs_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Tabs] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Tabs_{objectQualifier}Tabs] FOREIGN KEY ([ParentId]) REFERENCES {databaseOwner}[{objectQualifier}Tabs] ([TabID])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UserProfile]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserProfile] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}UserProfile_{objectQualifier}ProfilePropertyDefinition] FOREIGN KEY ([PropertyDefinitionID]) REFERENCES {databaseOwner}[{objectQualifier}ProfilePropertyDefinition] ([PropertyDefinitionID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Relationships]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Relationships] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Relationships_{objectQualifier}RelationshipTypes] FOREIGN KEY ([RelationshipTypeID]) REFERENCES {databaseOwner}[{objectQualifier}RelationshipTypes] ([RelationshipTypeID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ScheduleHistory]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ScheduleHistory] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ScheduleHistory_{objectQualifier}Schedule] FOREIGN KEY ([ScheduleID]) REFERENCES {databaseOwner}[{objectQualifier}Schedule] ([ScheduleID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ScheduleItemSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ScheduleItemSettings] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}ScheduleItemSettings_{objectQualifier}Schedule] FOREIGN KEY ([ScheduleID]) REFERENCES {databaseOwner}[{objectQualifier}Schedule] ([ScheduleID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Skins]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Skins] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}Skins_{objectQualifier}SkinPackages] FOREIGN KEY ([SkinPackageID]) REFERENCES {databaseOwner}[{objectQualifier}SkinPackages] ([SkinPackageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabSettings] WITH NOCHECK  ADD CONSTRAINT [FK_{objectQualifier}TabSettings_{objectQualifier}Tabs] FOREIGN KEY ([TabID]) REFERENCES {databaseOwner}[{objectQualifier}Tabs] ([TabID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}AnonymousUsers]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}AnonymousUsers] ADD CONSTRAINT [FK_{objectQualifier}AnonymousUsers_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Assemblies]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Assemblies] ADD CONSTRAINT [FK_{objectQualifier}PackageAssemblies_PackageAssemblies] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentItems_Tags]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems_Tags] ADD CONSTRAINT [FK_{objectQualifier}ContentItems_Tags_{objectQualifier}ContentItems] FOREIGN KEY ([ContentItemID]) REFERENCES {databaseOwner}[{objectQualifier}ContentItems] ([ContentItemID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems_Tags] ADD CONSTRAINT [FK_{objectQualifier}ContentItems_Tags_{objectQualifier}Taxonomy_Terms] FOREIGN KEY ([TermID]) REFERENCES {databaseOwner}[{objectQualifier}Taxonomy_Terms] ([TermID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentWorkflowLogs]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowLogs] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowLogs_{objectQualifier}ContentItems] FOREIGN KEY ([ContentItemID]) REFERENCES {databaseOwner}[{objectQualifier}ContentItems] ([ContentItemID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowLogs] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowLogs_{objectQualifier}ContentWorkflows] FOREIGN KEY ([WorkflowID]) REFERENCES {databaseOwner}[{objectQualifier}ContentWorkflows] ([WorkflowID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Files]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Files] ADD CONSTRAINT [FK_{objectQualifier}Files_{objectQualifier}ContentItems] FOREIGN KEY ([ContentItemID]) REFERENCES {databaseOwner}[{objectQualifier}ContentItems] ([ContentItemID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Files] ADD CONSTRAINT [FK_{objectQualifier}Files_{objectQualifier}Portals] FOREIGN KEY ([PortalId]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Files] ADD CONSTRAINT [FK_{objectQualifier}Files_{objectQualifier}Folders] FOREIGN KEY ([FolderID]) REFERENCES {databaseOwner}[{objectQualifier}Folders] ([FolderID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Modules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Modules] ADD CONSTRAINT [FK_{objectQualifier}Modules_{objectQualifier}ContentItems] FOREIGN KEY ([ContentItemID]) REFERENCES {databaseOwner}[{objectQualifier}ContentItems] ([ContentItemID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Modules] ADD CONSTRAINT [FK_{objectQualifier}Modules_{objectQualifier}ModuleDefinitions] FOREIGN KEY ([ModuleDefID]) REFERENCES {databaseOwner}[{objectQualifier}ModuleDefinitions] ([ModuleDefID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Tabs]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Tabs] ADD CONSTRAINT [FK_{objectQualifier}Tabs_{objectQualifier}ContentItems] FOREIGN KEY ([ContentItemID]) REFERENCES {databaseOwner}[{objectQualifier}ContentItems] ([ContentItemID])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentItems]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems] ADD CONSTRAINT [FK_{objectQualifier}ContentItems_{objectQualifier}ContentTypes] FOREIGN KEY ([ContentTypeID]) REFERENCES {databaseOwner}[{objectQualifier}ContentTypes] ([ContentTypeID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentItems] ADD CONSTRAINT [FK_{objectQualifier}ContentItems_{objectQualifier}ContentWorkflowStates] FOREIGN KEY ([StateID]) REFERENCES {databaseOwner}[{objectQualifier}ContentWorkflowStates] ([StateID]) ON DELETE SET NULL
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentWorkflowActions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowActions] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowActions_{objectQualifier}ContentTypes] FOREIGN KEY ([ContentTypeId]) REFERENCES {databaseOwner}[{objectQualifier}ContentTypes] ([ContentTypeID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentWorkflowSources]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowSources] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowSources_{objectQualifier}ContentWorkflows] FOREIGN KEY ([WorkflowID]) REFERENCES {databaseOwner}[{objectQualifier}ContentWorkflows] ([WorkflowID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowStatePermission_{objectQualifier}ContentWorkflowStates] FOREIGN KEY ([StateID]) REFERENCES {databaseOwner}[{objectQualifier}ContentWorkflowStates] ([StateID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowStatePermission_{objectQualifier}Permission] FOREIGN KEY ([PermissionID]) REFERENCES {databaseOwner}[{objectQualifier}Permission] ([PermissionID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStatePermission] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowStatePermission_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ContentWorkflowStates]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ContentWorkflowStates] ADD CONSTRAINT [FK_{objectQualifier}ContentWorkflowStates_{objectQualifier}ContentWorkflows] FOREIGN KEY ([WorkflowID]) REFERENCES {databaseOwner}[{objectQualifier}ContentWorkflows] ([WorkflowID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Folders]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Folders] ADD CONSTRAINT [FK_{objectQualifier}Folders_{objectQualifier}ContentWorkflows] FOREIGN KEY ([WorkflowID]) REFERENCES {databaseOwner}[{objectQualifier}ContentWorkflows] ([WorkflowID]) ON DELETE SET NULL
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Folders] ADD CONSTRAINT [FK_{objectQualifier}Folders_{objectQualifier}FolderMappings] FOREIGN KEY ([FolderMappingID]) REFERENCES {databaseOwner}[{objectQualifier}FolderMappings] ([FolderMappingID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Folders] ADD CONSTRAINT [FK_{objectQualifier}Folders_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_MessageAttachments] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_MessageAttachments_{objectQualifier}CoreMessaging_Messages] FOREIGN KEY ([MessageID]) REFERENCES {databaseOwner}[{objectQualifier}CoreMessaging_Messages] ([MessageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_MessageRecipients] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_MessageRecipients_{objectQualifier}CoreMessaging_Messages] FOREIGN KEY ([MessageID]) REFERENCES {databaseOwner}[{objectQualifier}CoreMessaging_Messages] ([MessageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypeActions] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_NotificationTypeActions_{objectQualifier}CoreMessaging_NotificationTypes] FOREIGN KEY ([NotificationTypeID]) REFERENCES {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes] ([NotificationTypeID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_NotificationTypes] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_NotificationTypes_{objectQualifier}DesktopModules] FOREIGN KEY ([DesktopModuleID]) REFERENCES {databaseOwner}[{objectQualifier}DesktopModules] ([DesktopModuleID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_Subscriptions_{objectQualifier}Subscriptions_Type] FOREIGN KEY ([SubscriptionTypeId]) REFERENCES {databaseOwner}[{objectQualifier}CoreMessaging_SubscriptionTypes] ([SubscriptionTypeId]) ON DELETE CASCADE ON UPDATE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_Subscriptions_{objectQualifier}Users] FOREIGN KEY ([UserId]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_Subscriptions_{objectQualifier}Portals] FOREIGN KEY ([PortalId]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}CoreMessaging_Subscriptions] ADD CONSTRAINT [FK_{objectQualifier}CoreMessaging_Subscriptions_{objectQualifier}Modules] FOREIGN KEY ([ModuleId]) REFERENCES {databaseOwner}[{objectQualifier}Modules] ([ModuleID]) ON DELETE CASCADE ON UPDATE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}DesktopModulePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModulePermission] ADD CONSTRAINT [FK_{objectQualifier}DesktopModulePermission_{objectQualifier}PortalDesktopModules] FOREIGN KEY ([PortalDesktopModuleID]) REFERENCES {databaseOwner}[{objectQualifier}PortalDesktopModules] ([PortalDesktopModuleID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModulePermission] ADD CONSTRAINT [FK_{objectQualifier}DesktopModulePermission_{objectQualifier}Roles] FOREIGN KEY ([RoleID]) REFERENCES {databaseOwner}[{objectQualifier}Roles] ([RoleID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}DesktopModulePermission] ADD CONSTRAINT [FK_{objectQualifier}DesktopModulePermission_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ExceptionEvents]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ExceptionEvents] ADD CONSTRAINT [FK_{objectQualifier}ExceptionEvents_LogEventId] FOREIGN KEY ([LogEventID]) REFERENCES {databaseOwner}[{objectQualifier}EventLog] ([LogEventID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}FileVersions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FileVersions] ADD CONSTRAINT [FK_{objectQualifier}FileVersions_Files] FOREIGN KEY ([FileId]) REFERENCES {databaseOwner}[{objectQualifier}Files] ([FileId]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}FolderMappings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderMappings] ADD CONSTRAINT [FK_{objectQualifier}FolderMappings_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}FolderPermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderPermission] ADD CONSTRAINT [FK_{objectQualifier}FolderPermission_{objectQualifier}Folders] FOREIGN KEY ([FolderID]) REFERENCES {databaseOwner}[{objectQualifier}Folders] ([FolderID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderPermission] ADD CONSTRAINT [FK_{objectQualifier}FolderPermission_{objectQualifier}Roles] FOREIGN KEY ([RoleID]) REFERENCES {databaseOwner}[{objectQualifier}Roles] ([RoleID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}FolderPermission] ADD CONSTRAINT [FK_{objectQualifier}FolderPermission_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}JavaScriptLibraries]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}JavaScriptLibraries] ADD CONSTRAINT [FK_{objectQualifier}JavaScriptLibraries{objectQualifier}Packages] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Mobile_PreviewProfiles] ADD CONSTRAINT [FK_{objectQualifier}Mobile_PreviewProfiles_{objectQualifier}Portals] FOREIGN KEY ([PortalId]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Mobile_RedirectionRules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Mobile_RedirectionRules] ADD CONSTRAINT [FK_{objectQualifier}Mobile_RedirectionRules_{objectQualifier}Mobile_Redirections] FOREIGN KEY ([RedirectionId]) REFERENCES {databaseOwner}[{objectQualifier}Mobile_Redirections] ([Id]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Mobile_Redirections]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Mobile_Redirections] ADD CONSTRAINT [FK_{objectQualifier}Mobile_Redirections_{objectQualifier}Portals] FOREIGN KEY ([PortalId]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ModuleControls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModuleControls] ADD CONSTRAINT [FK_{objectQualifier}ModuleControls_{objectQualifier}ModuleDefinitions] FOREIGN KEY ([ModuleDefID]) REFERENCES {databaseOwner}[{objectQualifier}ModuleDefinitions] ([ModuleDefID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ModulePermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModulePermission] ADD CONSTRAINT [FK_{objectQualifier}ModulePermission_{objectQualifier}Roles] FOREIGN KEY ([RoleID]) REFERENCES {databaseOwner}[{objectQualifier}Roles] ([RoleID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModulePermission] ADD CONSTRAINT [FK_{objectQualifier}ModulePermission_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}ModuleSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}ModuleSettings] ADD CONSTRAINT [FK_{objectQualifier}ModuleSettings_{objectQualifier}Modules] FOREIGN KEY ([ModuleID]) REFERENCES {databaseOwner}[{objectQualifier}Modules] ([ModuleID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PackageDependencies]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PackageDependencies] ADD CONSTRAINT [FK_{objectQualifier}PackageDependencies_{objectQualifier}Packages] FOREIGN KEY ([PackageID]) REFERENCES {databaseOwner}[{objectQualifier}Packages] ([PackageID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PasswordHistory]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PasswordHistory] ADD CONSTRAINT [FK_{objectQualifier}PasswordHistory_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PortalAlias]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalAlias] ADD CONSTRAINT [FK_{objectQualifier}PortalAlias_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PortalDesktopModules]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalDesktopModules] ADD CONSTRAINT [FK_{objectQualifier}PortalDesktopModules_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PortalLanguages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalLanguages] ADD CONSTRAINT [FK_{objectQualifier}PortalLanguages_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PortalLocalization]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalLocalization] ADD CONSTRAINT [FK_{objectQualifier}PortalLocalization_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}PortalSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}PortalSettings] ADD CONSTRAINT [FK_{objectQualifier}PortalSettings_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Profile]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Profile] ADD CONSTRAINT [FK_{objectQualifier}Profile_{objectQualifier}Portals] FOREIGN KEY ([PortalId]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Profile] ADD CONSTRAINT [FK_{objectQualifier}Profile_{objectQualifier}Users] FOREIGN KEY ([UserId]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Relationships]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Relationships] ADD CONSTRAINT [FK_{objectQualifier}Relationships_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Relationships] ADD CONSTRAINT [FK_{objectQualifier}Relationships_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}RoleGroups]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}RoleGroups] ADD CONSTRAINT [FK_{objectQualifier}RoleGroups_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Roles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Roles] ADD CONSTRAINT [FK_{objectQualifier}Roles_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Roles] ADD CONSTRAINT [FK_{objectQualifier}Roles_{objectQualifier}RoleGroups] FOREIGN KEY ([RoleGroupID]) REFERENCES {databaseOwner}[{objectQualifier}RoleGroups] ([RoleGroupID])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}SiteLog]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SiteLog] ADD CONSTRAINT [FK_{objectQualifier}SiteLog_{objectQualifier}Portals] FOREIGN KEY ([PortalId]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}SystemMessages]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}SystemMessages] ADD CONSTRAINT [FK_{objectQualifier}SystemMessages_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Urls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Urls] ADD CONSTRAINT [FK_{objectQualifier}Urls_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UrlTracking]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UrlTracking] ADD CONSTRAINT [FK_{objectQualifier}UrlTracking_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UserPortals]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserPortals] ADD CONSTRAINT [FK_{objectQualifier}UserPortals_{objectQualifier}Portals] FOREIGN KEY ([PortalId]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserPortals] ADD CONSTRAINT [FK_{objectQualifier}UserPortals_{objectQualifier}Users] FOREIGN KEY ([UserId]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UsersOnline]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UsersOnline] ADD CONSTRAINT [FK_{objectQualifier}UsersOnline_{objectQualifier}Portals] FOREIGN KEY ([PortalID]) REFERENCES {databaseOwner}[{objectQualifier}Portals] ([PortalID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UsersOnline] ADD CONSTRAINT [FK_{objectQualifier}UsersOnline_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UserRelationshipPreferences]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRelationshipPreferences] ADD CONSTRAINT [FK_{objectQualifier}UserRelationshipPreferences_{objectQualifier}Relationships] FOREIGN KEY ([RelationshipID]) REFERENCES {databaseOwner}[{objectQualifier}Relationships] ([RelationshipID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRelationshipPreferences] ADD CONSTRAINT [FK_{objectQualifier}UserRelationshipPreferences_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UserRelationships]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRelationships] ADD CONSTRAINT [FK_{objectQualifier}UserRelationships_{objectQualifier}Relationships] FOREIGN KEY ([RelationshipID]) REFERENCES {databaseOwner}[{objectQualifier}Relationships] ([RelationshipID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRelationships] ADD CONSTRAINT [FK_{objectQualifier}UserRelationships_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRelationships] ADD CONSTRAINT [FK_{objectQualifier}UserRelationships_{objectQualifier}Users_OnRelatedUser] FOREIGN KEY ([RelatedUserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabPermission]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabPermission] ADD CONSTRAINT [FK_{objectQualifier}TabPermission_{objectQualifier}Roles] FOREIGN KEY ([RoleID]) REFERENCES {databaseOwner}[{objectQualifier}Roles] ([RoleID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabPermission] ADD CONSTRAINT [FK_{objectQualifier}TabPermission_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UserRoles]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRoles] ADD CONSTRAINT [FK_{objectQualifier}UserRoles_{objectQualifier}Roles] FOREIGN KEY ([RoleID]) REFERENCES {databaseOwner}[{objectQualifier}Roles] ([RoleID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserRoles] ADD CONSTRAINT [FK_{objectQualifier}UserRoles_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabModuleSettings]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabModuleSettings] ADD CONSTRAINT [FK_{objectQualifier}TabModuleSettings_{objectQualifier}TabModules] FOREIGN KEY ([TabModuleID]) REFERENCES {databaseOwner}[{objectQualifier}TabModules] ([TabModuleID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabUrls]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabUrls] ADD CONSTRAINT [FK_{objectQualifier}TabUrls_Tabs] FOREIGN KEY ([TabId]) REFERENCES {databaseOwner}[{objectQualifier}Tabs] ([TabID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabVersionDetails]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabVersionDetails] ADD CONSTRAINT [FK_{objectQualifier}TabVersionDetails_{objectQualifier}TabVersionId] FOREIGN KEY ([TabVersionId]) REFERENCES {databaseOwner}[{objectQualifier}TabVersions] ([TabVersionId]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}TabVersions]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}TabVersions] ADD CONSTRAINT [FK_{objectQualifier}TabVersions_{objectQualifier}TabId] FOREIGN KEY ([TabId]) REFERENCES {databaseOwner}[{objectQualifier}Tabs] ([TabID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies] ADD CONSTRAINT [FK_{objectQualifier}Taxonomy_Vocabularies_{objectQualifier}Taxonomy_ScopeTypes] FOREIGN KEY ([ScopeTypeID]) REFERENCES {databaseOwner}[{objectQualifier}Taxonomy_ScopeTypes] ([ScopeTypeID]) ON DELETE CASCADE
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies] ADD CONSTRAINT [FK_{objectQualifier}Taxonomy_Vocabularies_{objectQualifier}Taxonomy_VocabularyTypes] FOREIGN KEY ([VocabularyTypeID]) REFERENCES {databaseOwner}[{objectQualifier}Taxonomy_VocabularyTypes] ([VocabularyTypeID])
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}Taxonomy_Terms]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_Terms] ADD CONSTRAINT [FK_{objectQualifier}Taxonomy_Terms_{objectQualifier}Taxonomy_Terms] FOREIGN KEY ([ParentTermID]) REFERENCES {databaseOwner}[{objectQualifier}Taxonomy_Terms] ([TermID])
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Taxonomy_Terms] ADD CONSTRAINT [FK_{objectQualifier}Taxonomy_Terms_{objectQualifier}Taxonomy_Vocabularies] FOREIGN KEY ([VocabularyID]) REFERENCES {databaseOwner}[{objectQualifier}Taxonomy_Vocabularies] ([VocabularyID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UrlLog]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UrlLog] ADD CONSTRAINT [FK_{objectQualifier}UrlLog_{objectQualifier}UrlTracking] FOREIGN KEY ([UrlTrackingID]) REFERENCES {databaseOwner}[{objectQualifier}UrlTracking] ([UrlTrackingID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UserAuthentication]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserAuthentication] ADD CONSTRAINT [FK_{objectQualifier}UserAuthentication_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Adding foreign keys to {databaseOwner}[{objectQualifier}UserProfile]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}UserProfile] ADD CONSTRAINT [FK_{objectQualifier}UserProfile_{objectQualifier}Users] FOREIGN KEY ([UserID]) REFERENCES {databaseOwner}[{objectQualifier}Users] ([UserID]) ON DELETE CASCADE
GO
PRINT N'Disabling constraints on {databaseOwner}[{objectQualifier}Journal_Data]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Data] NOCHECK CONSTRAINT [FK_{objectQualifier}Journal_Data_Journal]
GO
PRINT N'Disabling constraints on {databaseOwner}[{objectQualifier}Journal_Comments]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal_Comments] NOCHECK CONSTRAINT [FK_{objectQualifier}JournalComments_Journal]
GO
PRINT N'Disabling constraints on {databaseOwner}[{objectQualifier}Journal]'
GO
ALTER TABLE {databaseOwner}[{objectQualifier}Journal] NOCHECK CONSTRAINT [FK_{objectQualifier}Journal_JournalTypes]
GO

/************************************************************/
/*****              SqlDataProvider                     *****/
/************************************************************/